var jn=Object.defineProperty;var vn=(s,a,t)=>a in s?jn(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t;var et=(s,a,t)=>vn(s,typeof a!="symbol"?a+"":a,t);import{r as i,j as e,T as bs,X as xe,D as he,E as Be,F as zt,L as $s,H as wn,Q as Nn,G as Ht,U as De,I as Gs,J as qe,K as ms,M as be,N as Na,O as Me,P as Ms,W as it,Y as ka,Z as kn,$ as us,a0 as Bt,a1 as or,a2 as Pe,a3 as cr,a4 as xs,a5 as we,a6 as os,a7 as dr,a8 as Sn,a9 as Cn,R as ot,aa as Ye,ab as _n,ac as En,ad as Xe,ae as Bs,af as Sa,ag as Ca,ah as fs,ai as mr,aj as An,ak as Es,al as Ae,am as Mn,an as Ln,ao as Fe,ap as Ut,aq as ge,ar as ye,as as ds,at as Le,au as Ws,av as Ks,aw as Je,ax as xt,ay as ct,az as Gt,aA as Wt,aB as Rn,aC as Te,aD as Kt,aE as _a,aF as ur,aG as Tn,aH as Dt,aI as Vs,aJ as In,aK as Ze,aL as Dn,aM as Pn,aN as qn,aO as Fn,aP as Vt,aQ as Os,aR as $n,aS as On,aT as vs,aU as Qe,aV as dt,aW as ht,aX as is,aY as Yt,aZ as xr,a_ as gs,a$ as Qt,b0 as zn,b1 as Ea,b2 as Ls,b3 as Hn,b4 as Jt,b5 as hr,b6 as Bn,b7 as Aa,b8 as Un,b9 as Zt,ba as pt,bb as Xt,bc as ea,bd as sa,be as ta,bf as gt,bg as ft,bh as aa,bi as bt,bj as ra,bk as Gn,bl as Wn,bm as Kn,bn as Vn,bo as na,bp as mt,bq as la,v as Yn,br as Qn,bs as kt,bt as Jn,bu as Ie,bv as zs,bw as ia,bx as Zn,by as Xn,bz as el,bA as sl,bB as tl,bC as al,bD as oa,bE as rl,bF as Us,bG as nl,bH as ll,bI as il,bJ as yt,bK as ca,bL as ol,bM as pr,bN as gr,bO as Ma,bP as cl,bQ as dl,bR as ml,bS as ul,bT as fr,bU as Pt,bV as br,bW as xl,bX as hl,bY as pl,bZ as gl,b_ as fl,b$ as La,c0 as He,c1 as bl,c2 as yr,c3 as yl}from"./vendor-BGCOMdjc.js";import{a as jl}from"./supabase-p26Nnirx.js";import{i as Ns,j as ks,k as vl,l as Ss,m as wl,o as Nl,q as kl}from"./markdown-BIFaS5wZ.js";import{E as qt,b as jr,i as vr,s as wr,h as Nr,d as Cs,t as kr,q as Sr,a as Cr,e as _r,l as Er,f as Ar}from"./editor-DE902M0e.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(n){if(n.ep)return;n.ep=!0;const l=t(n);fetch(n.href,l)}})();const Sl="https://tkenxulvmzhhkuhfvcpt.supabase.co",Cl="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZW54dWx2bXpoaGt1aGZ2Y3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgwOTEwNzgsImV4cCI6MjA1MzY2NzA3OH0.UJPzvtHD6k6rJ09BlFYkdYEyHC3sx3h1rpAG8DULSHI",St={maxRetries:3,retryDelay:1e3,retryCondition:s=>{var a,t,r,n,l;return(s==null?void 0:s.status)===500||(s==null?void 0:s.status)===503||(s==null?void 0:s.status)===504||(s==null?void 0:s.status)===429||((a=s==null?void 0:s.message)==null?void 0:a.includes("Database error"))||((t=s==null?void 0:s.message)==null?void 0:t.includes("unexpected_failure"))||((r=s==null?void 0:s.message)==null?void 0:r.includes("schema"))||((n=s==null?void 0:s.message)==null?void 0:n.includes("network"))||((l=s==null?void 0:s.message)==null?void 0:l.includes("timeout"))}},H=jl(Sl,Cl,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storage:window.localStorage,storageKey:"dragonbane_auth",flowType:"implicit"},global:{headers:{"X-Client-Info":"dragonbane-character-manager"}},db:{schema:"public"},realtime:{params:{eventsPerSecond:10}},maxRetries:St.maxRetries,retryDelay:St.retryDelay,retryCondition:St.retryCondition});H.auth.onAuthStateChange((s,a)=>{(s==="USER_DELETED"||s==="SIGNED_OUT")&&console.log("Auth event:",s),s==="TOKEN_REFRESHED"&&console.log("Token refreshed successfully"),s==="SIGNED_OUT"&&!a&&console.error("Auth error: Session ended unexpectedly")});window.addEventListener("online",()=>{H.auth.startAutoRefresh()});window.addEventListener("offline",()=>{H.auth.stopAutoRefresh()});const Mr=i.createContext(void 0);function _l({children:s}){const[a,t]=i.useState(null),[r,n]=i.useState(!1),[l,o]=i.useState(null);return e.jsxs(Mr.Provider,{value:{setGlobalError:t,setGlobalLoading:n,setGlobalWarning:o},children:[r&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg p-6 shadow-xl",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"})})}),l&&e.jsx("div",{className:"fixed top-4 right-4 max-w-sm z-50",children:e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg shadow-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(bs,{className:"w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-yellow-700",children:l})}),e.jsx("button",{onClick:()=>o(null),className:"text-yellow-500 hover:text-yellow-700",children:e.jsx(xe,{className:"w-5 h-5"})})]})})}),a&&e.jsx("div",{className:"fixed top-4 right-4 max-w-sm z-50",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg shadow-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-red-700",children:a})}),e.jsx("button",{onClick:()=>t(null),className:"text-red-500 hover:text-red-700",children:e.jsx(xe,{className:"w-5 h-5"})})]})})}),s]})}function Lr(){const s=i.useContext(Mr);if(s===void 0)throw new Error("useApp must be used within an AppProvider");return s}async function El(s,a,t,r){const{data:n,error:l}=await H.auth.signUp({email:s,password:a,options:{data:{username:t.trim(),role:r}}});if(l)throw l.message.includes("User already registered")?new Error("An account with this email already exists."):(console.error("Sign up error (auth):",l.message),new Error(`Authentication error: ${l.message}`));if(!n.user)throw console.error("Sign up error: User object not returned after sign up."),new Error("Sign up failed: Could not retrieve user information.");const{error:o}=await H.from("users").insert({id:n.user.id,username:t.trim(),role:r,email:s});if(o)throw console.error("Sign up error (profile creation):",o.message),new Error(`Account created, but failed to set up user profile: ${o.message}. Please contact support.`);return n.user}async function Al(s,a){const{data:t,error:r}=await H.auth.signInWithPassword({email:s,password:a});if(r)throw r;if(t.user){const{error:n}=await H.from("users").update({last_login:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t.user.id);n&&console.error("Failed to update user timestamps on login:",n.message)}if(!t.session){const{data:n,error:l}=await H.auth.getSession();if(l)throw l;return{user:t.user,session:n.session}}return{user:t.user,session:t.session}}async function Ml(){const{error:s}=await H.auth.signOut();if(s)throw console.error("Sign out error:",s.message),s}const Ra=["player","dm","admin"],Rr=i.createContext(void 0);function Ce(){const s=i.useContext(Rr);if(!s)throw new Error("useAuth must be used within an AuthProvider");return s}function Ll({children:s}){const[a,t]=i.useState(null),[r,n]=i.useState(null),[l,o]=i.useState(null),[c,x]=i.useState(!0),[g,m]=i.useState(!1),b=Be(),{setGlobalError:p}=Lr(),h=i.useCallback(async j=>{var q,C,_;try{const{data:y}=await H.auth.getSession(),w=(_=(C=(q=y==null?void 0:y.session)==null?void 0:q.user)==null?void 0:C.user_metadata)==null?void 0:_.role;if(w&&Ra.includes(w))return w;const{data:L,error:E}=await H.from("users").select("role").eq("id",j).single();if(E)return console.error("Error fetching user role from table:",E.message),"player";const P=L==null?void 0:L.role;return P&&Ra.includes(P)?P:"player"}catch(y){return console.error("Unexpected error in fetchUserRole:",y),"player"}},[]);i.useEffect(()=>{H.auth.getSession().then(({data:{session:q}})=>{n(q),t((q==null?void 0:q.user)??null)}).catch(q=>{console.error("Error getting initial session:",q),t(null),n(null),x(!1)});const{data:j}=H.auth.onAuthStateChange((q,C)=>{n(C),t((C==null?void 0:C.user)??null)});return()=>{var q;(q=j==null?void 0:j.subscription)==null||q.unsubscribe()}},[]),i.useEffect(()=>{a?h(a.id).then(o).finally(()=>{x(!1)}):(o(null),x(!1))},[a,h]);const d=async(j,q,C,_)=>{try{m(!0),p(null),await El(j,q,C,_)}catch(y){throw p(y instanceof Error?y.message:"Signup failed"),y}finally{m(!1)}},v=async(j,q)=>{try{m(!0),p(null),await Al(j,q),b("/")}catch(C){let _="Authentication failed. Please check your credentials.";throw C instanceof Error&&(C.message.includes("Invalid login credentials")?_="Incorrect email or password.":C.message.includes("Email not confirmed")?_="Please verify your email address before logging in.":C.message.includes("network error")||C.message.includes("Failed to fetch")?_="Network error. Please check your connection and try again.":_=C.message.length>100?"An unexpected authentication error occurred.":C.message),p(_),new Error(_)}finally{m(!1)}},f=i.useCallback(async()=>{if(!g)try{m(!0),await Ml(),t(null),n(null),o(null),p(null),b("/login")}catch(j){console.error("Sign out error:",j),p("Failed to sign out")}finally{m(!1)}},[g,b,p]),u=()=>l==="admin",N=()=>l==="dm"||l==="admin",S=()=>l==="player",A=c||g;return e.jsx(Rr.Provider,{value:{user:a,session:r,role:l,isLoading:A,signIn:v,signUp:d,signOut:f,isAdmin:u,isDM:N,isPlayer:S},children:s})}const Tr=i.createContext(void 0),st=30*60*1e3,Ta=30*1e3,Rl=10*1e3;function Tl({children:s}){const{signOut:a}=Ce(),t=Be(),r=i.useRef(Date.now()),n=i.useRef(null),l=i.useRef(null),[o,c]=i.useState(!1),x=i.useCallback(()=>{n.current&&clearTimeout(n.current),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{c(!0)},st-Ta),n.current=setTimeout(async()=>{await a(),t("/login",{state:{message:"Your session has expired due to inactivity."}})},st),r.current=Date.now(),c(!1)},[a,t]),g=i.useCallback(()=>{x()},[x]);return i.useEffect(()=>{const m=["mousedown","keydown","scroll","mousemove","click","touchstart"];let b;function p(d,v){let f;return function(...N){const S=()=>{clearTimeout(f),d(...N)};clearTimeout(f),f=setTimeout(S,v)}}const h=p(()=>{Date.now()-r.current>1e3&&x()},1e3);return m.forEach(d=>{document.addEventListener(d,h)}),b=window.setInterval(()=>{const d=Date.now()-r.current;d>=st-Ta&&c(!0),d>=st&&(a(),t("/login",{state:{message:"Your session has expired due to inactivity."}}))},Rl),x(),()=>{m.forEach(d=>{document.removeEventListener(d,h)}),n.current&&clearTimeout(n.current),l.current&&clearTimeout(l.current),window.clearInterval(b)}},[x,a,t]),e.jsx(Tr.Provider,{value:{showWarning:o,extendSession:g},children:s})}function Il(){const s=i.useContext(Tr);if(s===void 0)throw new Error("useSessionTimeout must be used within a SessionTimeoutProvider");return s}const Ve=class Ve{constructor(){et(this,"environment");this.environment="production"}static getInstance(){return Ve.instance||(Ve.instance=new Ve),Ve.instance}logError(a,t={},r="medium"){const n={error:a,context:{...t,timestamp:new Date().toISOString(),path:window.location.pathname},severity:r};this.environment==="development"&&console.error("Error Report:",{message:a.message,stack:a.stack,...n.context,severity:r}),this.environment==="production"&&this.sendToErrorTrackingService(n)}async sendToErrorTrackingService(a){try{console.error("Production Error:",a)}catch(t){console.error("Failed to send error report:",t)}}static handleError(a,t){const r=Ve.getInstance();a instanceof Error?r.logError(a,t):r.logError(new Error(String(a)),t)}static handleNetworkError(a,t){const r=Ve.getInstance();if(a instanceof Error){const n=a.message.toLowerCase().includes("network")||a.message.toLowerCase().includes("connection")||a.message.toLowerCase().includes("offline");r.logError(a,{...t,additionalData:{isNetworkError:n}},n?"high":"medium")}}static handleAuthError(a,t){const r=Ve.getInstance();if(a instanceof Error){const n=a.message.toLowerCase().includes("auth")||a.message.toLowerCase().includes("unauthorized")||a.message.toLowerCase().includes("forbidden");r.logError(a,{...t,additionalData:{isAuthError:n}},n?"high":"medium")}}};et(Ve,"instance");let _s=Ve;class Dl extends i.Component{constructor(t){super(t);et(this,"handleRefresh",()=>{window.location.reload()});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t,errorInfo:null}}componentDidCatch(t,r){_s.handleError(t,{action:"render",additionalData:{componentStack:r.componentStack}})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(bs,{className:"w-8 h-8 text-red-500"}),e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Something went wrong"})]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"We apologize for the inconvenience. The application has encountered an unexpected error."}),this.state.error&&e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"bg-red-50 border border-red-100 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm font-medium text-red-800 mb-2",children:"Error Details:"}),e.jsx("p",{className:"text-sm text-red-700 font-mono break-all",children:this.state.error.message||"No error message available"})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("button",{onClick:this.handleRefresh,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(zt,{className:"w-5 h-5"}),"Refresh Page"]}),e.jsxs($s,{to:"/",className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:[e.jsx(wn,{className:"w-5 h-5"}),"Go Home"]})]})]})}):this.props.children}}const Ir=new Nn({defaultOptions:{queries:{staleTime:1e3*60*5,refetchOnWindowFocus:!1,retry:1}}}),Pl=/(\d+)?d(\d+)/i;function ql(s){const a=s.match(Pl);if(!a){const l=`d${s.replace(/\D/g,"")}`;return["d4","d6","d8","d10","d12","d20"].includes(l)?[l]:(console.warn(`Invalid dice string format: "${s}". Could not parse.`),[])}const t=parseInt(a[1]||"1",10),r=parseInt(a[2],10),n=`d${r}`;return["d4","d6","d8","d10","d12","d20"].includes(n)?Array(t).fill(n):(console.warn(`Invalid die type in string: "d${r}" from "${s}".`),[])}const Dr=i.createContext(void 0),Fl=20;function $l({children:s}){const[a,t]=i.useState(!1),[r,n]=i.useState(null),[l,o]=i.useState([]),[c,x]=i.useState([]),[g,m]=i.useState(!1),[b,p]=i.useState(!1),h=i.useCallback(j=>{t(q=>{const C=!q;if(C){const _={...j};_.label&&!_.description&&(_.description=_.label),n(_||null);let y=[];j!=null&&j.dice?y=ql(j.dice):j!=null&&j.initialDice&&(y=j.initialDice),(j==null?void 0:j.rollMode)==="deathRoll"?y=["d20"]:(j==null?void 0:j.rollMode)==="recoveryRoll"?y=["d6"]:(j==null?void 0:j.rollMode)==="rallyRoll"?y=["d20"]:(j==null?void 0:j.rollMode)==="skillCheck"&&y.length===0?y=["d20"]:(j==null?void 0:j.rollMode)==="advancementRoll"&&(y=["d20"]),o(y),m(!1),p((j==null?void 0:j.requiresBane)||(j==null?void 0:j.rollMode)==="rallyRoll"||!1)}else n(null),o([]),m(!1),p(!1);return C})},[]),d=i.useCallback(j=>{r!=null&&r.rollMode&&["deathRoll","recoveryRoll","rallyRoll","advancementRoll"].includes(r.rollMode)||(o(q=>[...q,j]),(g||b)&&(m(!1),p(!1)))},[g,b,r]),v=i.useCallback(j=>{r!=null&&r.rollMode&&["deathRoll","recoveryRoll","rallyRoll","advancementRoll"].includes(r.rollMode)||o(q=>{if(q.length===0)return[];if(j){const C=q.lastIndexOf(j);if(C!==-1){const _=[...q];return _.splice(C,1),_}}return q.slice(0,-1)})},[r]),f=i.useCallback(()=>{r!=null&&r.rollMode&&["deathRoll","recoveryRoll","rallyRoll","advancementRoll"].includes(r.rollMode)||(o([]),m(!1),p(!1))},[r]),u=i.useCallback(j=>{r!=null&&r.rollMode&&["deathRoll","recoveryRoll","rallyRoll","advancementRoll"].includes(r.rollMode)||(j?(m(!0),p(!1),o(["d20"])):m(!1))},[r]),N=i.useCallback(j=>{r!=null&&r.rollMode&&["deathRoll","recoveryRoll","rallyRoll","advancementRoll"].includes(r.rollMode)||(j?(p(!0),m(!1),o(["d20"])):(r==null?void 0:r.rollMode)!=="rallyRoll"&&p(!1))},[r]),S=i.useCallback(j=>{x(q=>{const _=[{...j,id:crypto.randomUUID(),timestamp:Date.now()},...q];return _.length>Fl&&_.pop(),_})},[]),A=i.useCallback(()=>{x([])},[]);return e.jsx(Dr.Provider,{value:{showDiceRoller:a,currentConfig:r,dicePool:l,rollHistory:c,isBoonActive:g,isBaneActive:b,toggleDiceRoller:h,addDie:d,removeLastDie:v,clearDicePool:f,setBoon:u,setBane:N,addRollToHistory:S,clearHistory:A},children:s})}function ze(){const s=i.useContext(Dr);if(s===void 0)throw new Error("useDice must be used within a DiceProvider");return s}function Ol(){const s=Ht(),{signOut:a,isAdmin:t,isDM:r,role:n,user:l}=Ce(),{toggleDiceRoller:o}=ze(),[c,x]=i.useState(!1),[g,m]=i.useState(!1),b=i.useRef(null),p=i.useRef(null),h=f=>s.pathname===f,d=[{path:"/",label:"Characters",icon:De,roles:["player","dm","admin"]},{path:"/compendium",label:"Compendium",icon:Gs,roles:["player","dm","admin"]},{path:"/adventure-party",label:"Adventure Party",icon:qe,roles:["player","dm","admin"]},{path:"/notes",label:"Notes",icon:ms,roles:["player","dm","admin"]}],v=()=>{c&&x(!1)};return i.useEffect(()=>{const f=u=>{b.current&&!b.current.contains(u.target)&&x(!1),p.current&&!p.current.contains(u.target)&&m(!1)};return document.addEventListener("mousedown",f),()=>{document.removeEventListener("mousedown",f)}},[]),e.jsxs("nav",{className:"bg-gray-800 text-white",ref:b,children:[e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsx("div",{className:"flex-shrink-0"}),e.jsxs("div",{className:"hidden md:flex flex-1 items-center justify-between",children:[e.jsx("div",{className:"flex items-center space-x-4",children:d.filter(f=>f.roles.includes(n||"player")).map(({path:f,label:u,icon:N})=>e.jsxs($s,{to:f,onClick:v,className:`flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium ${h(f)?"bg-gray-900 text-white":"text-gray-300 hover:bg-gray-700 hover:text-white"}`,children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("span",{children:u})]},f))}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{onClick:o,className:"flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white",title:"Open Dice Roller",children:[e.jsx(be,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden lg:inline",children:"Dice"})]}),e.jsxs("div",{className:"flex items-center space-x-2 px-3 py-2 rounded-md bg-gray-700",title:`Current role: ${n}`,children:[t()?e.jsx(Na,{className:"w-5 h-5 text-yellow-400"}):r()?e.jsx(Me,{className:"w-5 h-5 text-blue-400"}):e.jsx(De,{className:"w-5 h-5 text-green-400"}),e.jsx("span",{className:"text-sm font-medium hidden lg:inline",children:t()?"Admin":r()?"DM":"Player"})]}),e.jsxs("div",{className:"relative",ref:p,children:[e.jsxs("button",{onClick:()=>m(!g),className:"flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white",children:[e.jsx("span",{children:(l==null?void 0:l.username)||"Account"}),e.jsx(Ms,{className:`w-4 h-4 transition-transform ${g?"rotate-180":""}`})]}),g&&e.jsx("div",{className:"absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg z-50 ring-1 ring-black ring-opacity-5",children:e.jsxs("div",{className:"py-1",children:[e.jsxs($s,{to:"/settings",onClick:()=>m(!1),className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white",children:[e.jsx(it,{className:"w-5 h-5 mr-3"}),e.jsx("span",{children:"Settings"})]}),e.jsxs("button",{onClick:()=>{a(),m(!1)},className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white",children:[e.jsx(ka,{className:"w-5 h-5 mr-3"}),e.jsx("span",{children:"Log Out"})]})]})})]})]})]}),e.jsxs("div",{className:"md:hidden flex items-center",children:[e.jsx("button",{onClick:o,className:"p-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white mr-2",title:"Open Dice Roller",children:e.jsx(be,{className:"w-6 h-6"})}),e.jsxs("button",{onClick:()=>x(!c),className:"p-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white","aria-expanded":c,"aria-controls":"mobile-menu",children:[e.jsx("span",{className:"sr-only",children:"Open main menu"}),c?e.jsx(xe,{className:"block h-6 w-6"}):e.jsx(kn,{className:"block h-6 w-6"})]})]})]})}),c&&e.jsx("div",{className:"md:hidden absolute top-16 inset-x-0 bg-gray-800 z-50 shadow-lg",id:"mobile-menu",children:e.jsxs("div",{className:"px-2 pt-2 pb-3 space-y-1 sm:px-3",children:[d.filter(f=>f.roles.includes(n||"player")).map(({path:f,label:u,icon:N})=>e.jsxs($s,{to:f,onClick:v,className:`flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium ${h(f)?"bg-gray-900 text-white":"text-gray-300 hover:bg-gray-700 hover:text-white"}`,children:[e.jsx(N,{className:"w-6 h-6"}),e.jsx("span",{children:u})]},f)),e.jsx("hr",{className:"border-gray-700 my-2"}),e.jsxs($s,{to:"/settings",onClick:v,className:`flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium ${h("/settings")?"bg-gray-900 text-white":"text-gray-300 hover:bg-gray-700 hover:text-white"}`,children:[e.jsx(it,{className:"w-6 h-6"}),e.jsx("span",{children:"Settings"})]}),e.jsxs("button",{onClick:()=>{a(),v()},className:"w-full flex items-center space-x-3 px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:bg-gray-700 hover:text-white",children:[e.jsx(ka,{className:"w-6 h-6"}),e.jsx("span",{children:"Log Out"})]}),e.jsx("div",{className:"px-3 pt-4",children:e.jsx("div",{className:"flex items-center space-x-2 px-3 py-2 rounded-md bg-gray-700 w-full",children:t()?e.jsxs(e.Fragment,{children:[e.jsx(Na,{className:"w-5 h-5 text-yellow-400"}),e.jsxs("span",{className:"text-sm font-medium",children:["Admin: ",(l==null?void 0:l.username)||""]})]}):r()?e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"w-5 h-5 text-blue-400"}),e.jsxs("span",{className:"text-sm font-medium",children:["DM: ",(l==null?void 0:l.username)||""]})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-5 h-5 text-green-400"}),e.jsxs("span",{className:"text-sm font-medium",children:["Player: ",(l==null?void 0:l.username)||""]})]})})})]})})]})}function zl({character:s}){const a=t=>t>=16?"text-purple-600":t>=14?"text-blue-600":t>=12?"text-green-600":t>=10?"text-yellow-600":"text-gray-600";return e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.kin," ",s.profession]})]}),e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800",children:s.age})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:a(s.attributes.STR),children:s.attributes.STR})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(us,{className:"w-4 h-4 text-pink-600"}),e.jsx("span",{className:a(s.attributes.CON),children:s.attributes.CON})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bt,{className:"w-4 h-4 text-yellow-600"}),e.jsx("span",{className:a(s.attributes.AGL),children:s.attributes.AGL})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(or,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:a(s.attributes.INT),children:s.attributes.INT})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"w-4 h-4 text-purple-600"}),e.jsx("span",{className:a(s.attributes.WIL),children:s.attributes.WIL})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:a(s.attributes.CHA),children:s.attributes.CHA})]})]}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsx("p",{className:"line-clamp-2",children:s.appearance||"No appearance set"})})]})})}const es=cr(s=>({step:0,character:{},setStep:a=>s({step:a}),updateCharacter:a=>s(t=>({character:{...t.character,...a}})),resetCharacter:()=>s({character:{},step:0})}));async function Hl(){const{data:s,error:a}=await H.from("kin").select("id, name, description, heroic_ability");if(a)throw console.error("Error fetching kin list:",a),new Error(a.message||"Failed to fetch kin list");return s||[]}async function Bl(s){if(!s||s.length===0)return[];const a=s.map(n=>n.trim()).filter(n=>n);if(a.length===0)return[];const{data:t,error:r}=await H.from("heroic_abilities").select("id, name, description, willpower_cost, requirement").in("name",a);if(r)throw console.error("Error fetching ability details by names:",r),new Error(r.message||"Failed to fetch ability details");return(t||[]).map(n=>({id:n.id,name:n.name,description:n.description,willpower_cost:n.willpower_cost,requirement:n.requirement}))}function oe({size:s="md",className:a=""}){const t={sm:"w-4 h-4 border-2",md:"w-8 h-8 border-4",lg:"w-12 h-12 border-4"};return e.jsx("div",{className:`flex items-center justify-center ${a}`,role:"status",children:e.jsx("div",{className:`${t[s]} animate-spin rounded-full border-gray-200 border-t-blue-600`,"aria-label":"Loading..."})})}function ie({message:s,onClose:a}){return s?e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 flex items-start justify-between",role:"alert",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(xs,{className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"block sm:inline",children:s})]}),a&&e.jsx("button",{onClick:a,className:"ml-4 p-1 text-red-500 hover:text-red-700 hover:bg-red-200 rounded-full transition-colors","aria-label":"Close error message",children:e.jsx(xe,{className:"w-4 h-4"})})]}):null}const Ia=s=>s?s.split(",").map(a=>a.trim()).filter(a=>a):[];function Ul(){const{character:s,updateCharacter:a}=es(),[t,r]=i.useState(null),{data:n=[],isLoading:l,error:o}=we({queryKey:["kinListWithHeroicAbility"],queryFn:Hl,retry:!1});i.useEffect(()=>{if(s.kin&&n.length>0&&!t){const d=n.find(v=>v.name===s.kin);if(d){r(d.id);const v=Ia(d.heroic_ability);JSON.stringify(s.kinAbilityNames)!==JSON.stringify(v)&&a({kinAbilityNames:v})}}},[s.kin,n,t,s.kinAbilityNames,a]);const c=d=>{r(d.id);const v=Ia(d.heroic_ability);a({kin:d.name,kinAbilityNames:v})},x=i.useMemo(()=>n.find(d=>d.id===t),[n,t]),g=i.useMemo(()=>s.kinAbilityNames||[],[s.kinAbilityNames]),{data:m=[],isLoading:b,error:p}=we({queryKey:["abilityDetails",g.sort().join(",")],queryFn:()=>Bl(g),enabled:g.length>0,staleTime:10*60*1e3,retry:!1}),h=d=>e.jsxs("div",{className:"mb-4 p-3 border rounded bg-gray-50 shadow-sm",children:[e.jsx("h4",{className:"font-semibold text-md text-gray-800",children:d.name}),d.willpower_cost!=null&&e.jsxs("p",{className:"text-xs text-purple-700 font-medium mt-1",children:["Willpower Cost: ",d.willpower_cost]}),d.requirement&&e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Requirement: ",d.requirement]}),e.jsx("p",{className:"text-sm text-gray-700 mt-2",children:d.description})]},d.id);if(l)return e.jsx("div",{className:"flex justify-center items-center h-[60vh]",children:e.jsx(oe,{size:"lg"})});if(o){const d=o instanceof Error?o.message:"Failed to load Kin options.";return console.error("Error loading Kin:",o),e.jsx(ie,{title:"Error Loading Kin",message:d})}return e.jsxs("div",{className:"flex space-x-6 h-[60vh]",children:[e.jsxs("div",{className:"w-1/3 border-r pr-4 overflow-y-auto",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 sticky top-0 bg-white pb-2 z-10",children:"Kin List"}),e.jsx("ul",{className:"space-y-1",children:n.map(d=>e.jsx("li",{className:`cursor-pointer p-2 rounded-md text-sm ${t===d.id?"bg-blue-100 font-semibold text-blue-800":"hover:bg-gray-100 text-gray-700"}`,onClick:()=>c(d),children:d.name},d.id))})]}),e.jsx("div",{className:"w-2/3 pl-4 overflow-y-auto",children:x?e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-1",children:x.name}),e.jsx("p",{className:"text-gray-700 mb-4 text-sm",children:x.description}),e.jsx("hr",{className:"my-4 border-gray-300"}),e.jsx("h3",{className:"text-lg font-semibold mb-3 text-gray-800",children:"Kin Abilities"}),b?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(oe,{})}):p?e.jsx(ie,{title:"Error Loading Abilities",message:p.message||"Failed to load ability details."}):m.length>0?m.map(h):g.length>0&&!b?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-orange-600 italic mb-2",children:"Could not fetch full details for the following abilities (check names in database):"}),e.jsx("ul",{className:"list-disc list-inside text-sm text-gray-600",children:g.map(d=>e.jsx("li",{children:d},d))})]}):e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No specific heroic abilities listed for this Kin."})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-500",children:"Select a kin from the list to view details and abilities."})})})]})}async function Gl(){const{data:s,error:a}=await H.from("professions").select("*").order("name");if(a)throw console.error("Error fetching profession list:",a),new Error(a.message||"Failed to fetch profession list");return s||[]}async function Wl(s){const{data:a,error:t}=await H.from("heroic_abilities").select("*").eq("profession",s);if(t)throw console.error("Error fetching heroic abilities:",t),new Error(t.message||"Failed to fetch heroic abilities");return a||[]}async function Kl(){const{data:s,error:a}=await H.from("game_spells").select(`
      *,
      magic_schools ( name )
    `).order("name",{ascending:!0});if(a)throw console.error("Error fetching spells:",a),new Error(a.message||"Failed to fetch spells");return s||[]}async function Pr(){const{data:s,error:a}=await H.from("magic_schools").select("id, name, description").order("name",{ascending:!0});if(a)throw console.error("Error fetching magic schools:",a),new Error(a.message||"Failed to fetch magic schools");return s||[]}function Vl(){const{character:s,updateCharacter:a}=es(),[t,r]=i.useState(null),[n,l]=i.useState([]),[o,c]=i.useState(null),[x,g]=i.useState(!1),[m,b]=i.useState(null),{data:p=[],isLoading:h,error:d}=we({queryKey:["professions"],queryFn:Gl}),{data:v=[],isLoading:f,error:u}=we({queryKey:["magicSchools"],queryFn:Pr});i.useEffect(()=>{if(s.profession&&p.length>0){const C=p.find(_=>_.name===s.profession);if(C&&(r(C),C.magic_school_id===null&&s.professionHeroicAbilityName&&N(C.name,s.professionHeroicAbilityName),s.professionHeroicAbilityName&&n.length>0)){const _=n.find(y=>y.name===s.professionHeroicAbilityName);_&&c(_)}}},[s.profession,p,s.professionHeroicAbilityName]);const N=async(C,_)=>{g(!0),b(null);try{const w=await Wl(C);l(w);const L=_??s.professionHeroicAbilityName;if(L){const E=w.find(P=>P.name===L);c(E||null)}else c(null)}catch(y){b(y instanceof Error?y.message:"Failed to load heroic abilities"),l([]),c(null)}finally{g(!1)}};i.useEffect(()=>{t&&t.magic_school_id===null?N(t.name):(l([]),c(null),s.professionHeroicAbilityName&&a({professionHeroicAbilityName:null}))},[t]);const S=C=>{var y;r(C),C.magic_school_id!==null&&((y=v.find(w=>w.id===C.magic_school_id))==null||y.name);const _={profession:C.name,key_attribute:C.key_attribute,magicSchool:C.magic_school_id??null,professionHeroicAbilityName:null};C.magic_school_id!==null&&c(null),a(_)},A=C=>{c(C),a({professionHeroicAbilityName:C.name})},j=C=>{var _;return C===null||v.length===0?null:((_=v.find(y=>y.id===C))==null?void 0:_.name)??`ID: ${C}`},q=(C,_)=>{if(!Array.isArray(C)||C.length===0)return e.jsxs("p",{className:"text-sm text-gray-500",children:["No ",_.toLowerCase()," listed."]});const y=C.filter(w=>typeof w=="string");return y.length===0?e.jsxs("p",{className:"text-sm text-gray-500",children:["No valid ",_.toLowerCase()," listed."]}):e.jsx("ul",{className:"list-disc list-inside text-sm text-gray-600",children:y.map((w,L)=>e.jsx("li",{children:w},L))})};return h||f?e.jsx("div",{className:"flex justify-center items-center h-[80vh]",children:e.jsx(oe,{size:"lg"})}):d||u?e.jsx(ie,{message:(d==null?void 0:d.message)||(u==null?void 0:u.message)||"Failed to load required data."}):(t&&console.log("Selected Profession Data:",t),e.jsxs("div",{className:"flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6 h-[80vh]",children:[e.jsxs("div",{className:"w-full md:w-1/3 border-b md:border-b-0 md:border-r pb-4 md:pb-0 md:pr-4 overflow-y-auto max-h-[30vh] md:max-h-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 sticky top-0 bg-white pb-2 z-10",children:"Profession List"}),e.jsx("ul",{className:"space-y-2",children:p.map(C=>e.jsx("li",{className:`cursor-pointer p-2 rounded-md border ${(t==null?void 0:t.id)===C.id?"bg-blue-100 border-blue-300 font-semibold":"border-gray-200 hover:border-blue-300 hover:bg-blue-50"}`,onClick:()=>S(C),children:C.name},C.id))})]}),e.jsx("div",{className:"w-full md:w-2/3 md:pl-4 overflow-y-auto max-h-[calc(80vh-30vh-2rem)] md:max-h-full",children:t?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:t.name}),e.jsx("p",{className:"text-gray-600 mb-4",children:t.description})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-lg",children:"Key Attribute"}),e.jsx("p",{className:"text-gray-700",children:t.key_attribute})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:"Skills"}),q(t.skills,"Skills")]}),t.starting_equipment&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:"Starting Equipment"}),q(t.starting_equipment,"Starting Equipment")]}),t.equipment_description&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:"Equipment Notes"}),q(t.equipment_description,"Equipment Notes")]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-lg mb-1",children:"Heroic Ability / Magic"}),t.magic_school_id!==null?e.jsxs("p",{className:"text-gray-600",children:["As a mage of the ",e.jsx("strong",{children:j(t.magic_school_id)??"Unknown School"})," school, you don't get a starting heroic ability. Instead, you get your magic."]}):e.jsxs(e.Fragment,{children:[x&&e.jsx(oe,{size:"sm"}),m&&e.jsx(ie,{message:m}),!x&&!m&&n.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:n.map(C=>e.jsxs("div",{className:`border rounded-lg p-4 cursor-pointer transition-all ${(o==null?void 0:o.id)===C.id?"border-green-500 bg-green-50 ring-2 ring-green-300":"border-gray-200 hover:border-green-300 hover:bg-green-50"}`,onClick:()=>A(C),children:[e.jsx("h5",{className:"font-semibold text-lg mb-2",children:C.name}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:C.description}),e.jsxs("p",{className:"text-sm text-blue-600",children:["Willpower Cost: ",C.willpower_cost??"N/A"," WP"]}),C.requirement&&typeof C.requirement=="string"&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Requirement: ",C.requirement]})]},C.id))}):!x&&!m&&e.jsx("p",{className:"text-gray-600",children:"No specific heroic abilities listed for this profession, or none available."})]})]}),e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg sticky bottom-0",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["Selected: ",e.jsx("strong",{children:t.name}),t.magic_school_id!==null&&e.jsxs(e.Fragment,{children:[" (Magic School: ",e.jsx("strong",{children:j(t.magic_school_id)??"N/A"}),")"]}),t.magic_school_id===null&&s.professionHeroicAbilityName&&e.jsxs(e.Fragment,{children:[" with Heroic Ability: ",e.jsx("strong",{children:s.professionHeroicAbilityName})]})]}),t.magic_school_id===null&&!s.professionHeroicAbilityName&&n.length>0&&!x&&e.jsx("p",{className:"text-amber-700 mt-2 text-sm",children:"Please select a heroic ability above to continue."}),t.magic_school_id===null&&n.length===0&&!x&&!m&&e.jsx("p",{className:"text-gray-600 mt-2 text-sm",children:"No heroic ability selection required for this profession."})]})]}):e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx("p",{className:"text-gray-500 text-lg",children:"Select a profession from the list to view details."})})})]}))}const tt={Young:{attributes:{STR:0,CON:1,AGL:1,INT:0,WIL:0,CHA:0},skillPoints:8},Adult:{attributes:{STR:0,CON:0,AGL:0,INT:0,WIL:0,CHA:0},skillPoints:10},Old:{attributes:{STR:-2,CON:-2,AGL:-2,INT:1,WIL:1,CHA:0},skillPoints:12}};function Yl(){const{character:s,updateCharacter:a}=es(),t=r=>r===0?"No change":r>0?`+${r}`:r;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"prose",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Character Details"}),e.jsx("p",{className:"text-gray-600",children:"Choose a name that fits your character's background and select their age category. Age affects your starting attributes and the number of skill points available during character creation."})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Character Name"}),e.jsxs("div",{className:"relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(os,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",value:s.name||"",onChange:r=>a({name:r.target.value}),className:"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter character name"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Age Category"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:["Young","Adult","Old"].map(r=>e.jsxs("div",{className:`relative rounded-lg border p-6 cursor-pointer transition-all ${s.age===r?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,onClick:()=>a({age:r}),children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(dr,{className:`h-5 w-5 ${s.age===r?"text-blue-500":"text-gray-400"}`}),e.jsx("h4",{className:"text-lg font-medium",children:r})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-medium text-gray-700 mb-1",children:"Attribute Modifiers"}),e.jsx("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1 text-sm",children:Object.entries(tt[r].attributes).map(([n,l])=>l!==0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600",children:[n,":"]}),e.jsx("span",{className:l>0?"text-green-600":"text-red-600",children:t(l)})]},n))})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-medium text-gray-700 mb-1",children:"Skill Points"}),e.jsxs("p",{className:"text-sm text-blue-600 font-medium",children:[tt[r].skillPoints," points"]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[r==="Young"&&"Quick to learn, physically developing",r==="Adult"&&"Balanced attributes and experience",r==="Old"&&"Wise and knowledgeable, physically declining"]})]})]},r))})]})]}),(s.name||s.age)&&e.jsx("div",{className:"mt-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"space-y-2",children:[s.name&&e.jsxs("p",{className:"text-green-800",children:["Name: ",e.jsx("strong",{children:s.name})]}),s.age&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-green-800",children:["Age Category: ",e.jsx("strong",{children:s.age})]}),e.jsxs("p",{className:"text-sm text-green-700",children:["Starting Skill Points: ",e.jsx("strong",{children:tt[s.age].skillPoints})]}),Object.entries(tt[s.age].attributes).filter(([r,n])=>n!==0).map(([r,n])=>e.jsxs("p",{className:"text-sm text-green-700",children:[r," Modifier: ",e.jsx("strong",{children:t(n)})]},r))]})]})})]})}function Ql(...s){return Sn(Cn(s))}const Jl=_n("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{primary:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline",danger:"bg-red-600 text-white hover:bg-red-700",danger_outline:"border border-red-500 text-red-600 hover:bg-red-50"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"primary",size:"default"}}),M=ot.forwardRef(({className:s,variant:a,size:t,icon:r,iconPosition:n="left",fullWidth:l,loading:o,children:c,...x},g)=>{const m=o||x.disabled;return e.jsxs("button",{className:Ql(Jl({variant:a,size:t,className:s}),l&&"w-full",o&&"relative"),ref:g,disabled:m,...x,children:[o&&e.jsx(Ye,{className:`animate-spin h-4 w-4 ${c?n==="left"?"mr-2":"ml-2":""}`}),!o&&r&&n==="left"&&e.jsx(r,{className:`h-4 w-4 ${c?"mr-2":""}`}),!o&&c,!o&&r&&n==="right"&&e.jsx(r,{className:`h-4 w-4 ${c?"ml-2":""}`})]})});M.displayName="Button";const Ct=s=>s<=5?3:s<=8?4:s<=12?5:s<=15?6:7,_t=s=>s<=12?"None":s<=15?"+D4":"+D6",ws=()=>{const s=Array.from({length:4},()=>Math.floor(Math.random()*6)+1);return s.sort((a,t)=>t-a),s.slice(0,3).reduce((a,t)=>a+t,0)},Zl=()=>({STR:ws(),CON:ws(),AGL:ws(),INT:ws(),WIL:ws(),CHA:ws()}),Xl={Young:{STR:0,CON:1,AGL:1,INT:0,WIL:0,CHA:0},Adult:{STR:0,CON:0,AGL:0,INT:0,WIL:0,CHA:0},Old:{STR:-2,CON:-2,AGL:-2,INT:1,WIL:1,CHA:0}};function ei(){var S,A,j,q,C,_;const{character:s,updateCharacter:a}=es(),[t,r]=i.useState({STR:{value:((S=s.attributes)==null?void 0:S.STR)||0,baseChance:0},CON:{value:((A=s.attributes)==null?void 0:A.CON)||0,baseChance:0},AGL:{value:((j=s.attributes)==null?void 0:j.AGL)||0,baseChance:0},INT:{value:((q=s.attributes)==null?void 0:q.INT)||0,baseChance:0},WIL:{value:((C=s.attributes)==null?void 0:C.WIL)||0,baseChance:0},CHA:{value:((_=s.attributes)==null?void 0:_.CHA)||0,baseChance:0}}),[n,l]=i.useState(!1),[o,c]=i.useState(null),[x,g]=i.useState(""),m=y=>s.age?Xl[s.age][y]:0,b=(y,w)=>w+m(y),p=()=>{l(!0);const y=Zl(),w=Object.entries(y).reduce((E,[P,k])=>({...E,[P]:b(P,k)}),{}),L=Object.entries(y).reduce((E,[P,k])=>({...E,[P]:{value:k,baseChance:Ct(b(P,k))}}),{});r(L),a({attributes:w,current_hp:w.CON,current_wp:w.WIL,magic_school:s.magicSchool??null}),l(!1)},h=(y,w)=>{const L=b(y,w),E={...t,[y]:{value:w,baseChance:Ct(L)}};r(E);const P=Object.entries(E).reduce((k,[R,{value:O}])=>({...k,[R]:b(R,O)}),{});a({attributes:P,current_hp:P.CON,current_wp:P.WIL,magic_school:s.magicSchool??null})},d=(y,w)=>{c(y),g(w>0?w.toString():"")},v=()=>{c(null),g("")},f=y=>{if(y.preventDefault(),!o)return;const w=Math.max(3,Math.min(18,parseInt(x,10)||3));h(o,w),v()},u=()=>{if(!s.kin||!t.AGL.value)return 0;const y={Human:10,Halfling:8,Dwarf:8,Elf:10,Mallard:8,Wolfkin:12}[s.kin],w=b("AGL",t.AGL.value);let L=0;return w<=6?L=-4:w<=9?L=-2:w<=12?L=0:w<=15?L=2:L=4,y+L},N=s.key_attribute;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"prose",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Assign Attributes"}),e.jsxs("p",{className:"text-gray-600",children:["Roll or manually enter your character's attributes. Scores range from 3 to 18.",s.age&&" Age modifiers will be automatically applied."]}),s.profession&&e.jsx("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-blue-800",children:["Selected Profession: ",e.jsx("strong",{children:s.profession}),N&&e.jsxs(e.Fragment,{children:[" (Key Attribute: ",e.jsx("strong",{children:N}),")"]})]})})]}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("button",{onClick:p,disabled:n,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:[n?e.jsx(zt,{className:"w-5 h-5 animate-spin"}):e.jsx(be,{className:"w-5 h-5"}),"Roll All Attributes"]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Object.entries(t).map(([y,{value:w}])=>{const L=m(y),E=b(y,w),P=N===y;return e.jsxs("div",{className:`p-4 border rounded-lg shadow-sm bg-white ${P?"bg-yellow-100 border-yellow-500":""}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("label",{className:"text-lg font-medium",children:y}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Base Chance: ",Ct(E)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:w>0?w:"",onClick:()=>d(y,w),placeholder:"Click to set value",className:"w-full px-3 py-2 border rounded-md cursor-pointer focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),L!==0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Age Modifier:"}),e.jsx("span",{className:L>0?"text-green-600":"text-red-600",children:L>0?`+${L}`:L})]}),w>0&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Final Value:"}),e.jsx("span",{className:"font-medium text-blue-600",children:E})]})]}),(y==="STR"||y==="AGL")&&E>12&&e.jsxs("p",{className:"mt-2 text-sm text-blue-600",children:["Damage Bonus: ",_t(E)]})]},y)})}),s.kin&&Object.values(t).every(y=>y.value>0)&&e.jsx("div",{className:"mt-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-700",children:"Movement"}),e.jsx("p",{className:"text-2xl font-bold text-green-700",children:u()})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-700",children:"STR Damage Bonus"}),e.jsx("p",{className:"text-2xl font-bold text-blue-700",children:_t(b("STR",t.STR.value))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-700",children:"AGL Damage Bonus"}),e.jsx("p",{className:"text-2xl font-bold text-blue-700",children:_t(b("AGL",t.AGL.value))})]})]})}),s.age&&e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-amber-800",children:"Age Modifiers Applied"}),e.jsxs("p",{className:"text-sm text-amber-700",children:[s.age==="Young"&&"Young: +1 CON, +1 AGL",s.age==="Adult"&&"Adult: No attribute modifiers",s.age==="Old"&&"Old: -2 STR, -2 CON, -2 AGL, +1 INT, +1 WIL"]})]})]}),o&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:v,children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-xs",onClick:y=>y.stopPropagation(),children:[e.jsxs("h3",{className:"text-lg font-bold mb-4",children:["Set ",o," Score (3-18)"]}),e.jsxs("form",{onSubmit:f,children:[e.jsx("input",{type:"number",value:x,onChange:y=>g(y.target.value),onKeyDown:y=>y.key==="Enter"&&f(y),className:"w-full px-3 py-2 border rounded-md text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",autoFocus:!0}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx(M,{type:"button",variant:"outline",onClick:v,children:"Cancel"}),e.jsx(M,{type:"submit",children:"OK"})]})]})]})})]})}function si(s){const[a,t]=i.useState([]),[r,n]=i.useState([]),[l,o]=i.useState(!0),[c,x]=i.useState(null);return i.useEffect(()=>{async function g(){try{o(!0),x(null);const{data:m,error:b}=await H.from("game_spells").select("*").eq("rank",0).order("name");if(b)throw b;t(m||[]);let p=H.from("game_spells").select(`
            *,
            magic_schools ( name )
          `).eq("rank",1).order("name");s?p=p.or(`school_id.is.null,school_id.eq.${s}`):p=p.is("school_id",null);const{data:h,error:d}=await p;if(d)throw d;n(h||[])}catch(m){console.error("Error loading spells:",m),x(m instanceof Error?m.message:"Failed to load spells")}finally{o(!1)}}g()},[s]),{tricks:a,spells:r,loading:l,error:c}}function ti(){var E;const{character:s,updateCharacter:a}=es(),[t,r]=i.useState([]),[n,l]=i.useState([]),[o,c]=i.useState("all"),[x,g]=i.useState(null),[m,b]=i.useState(null),[p,h]=i.useState([]),[d,v]=i.useState(!0),[f,u]=i.useState(null),N=(E=s.profession)==null?void 0:E.includes("Mage"),S=N&&s.magicSchool?s.magicSchool:null,{tricks:A,spells:j,loading:q,error:C}=si(S);i.useEffect(()=>{(async()=>{v(!0),u(null);const{data:k,error:R}=await H.from("magic_schools").select("id, name");R?(console.error("Error fetching magic schools:",R),u("Failed to load magic school data. Please try refreshing.")):h(k||[]),v(!1)})()},[]);const _=i.useMemo(()=>p.reduce((P,k)=>(P[k.id]=k.name,P),{}),[p]);i.useMemo(()=>q||!A?[]:A.filter(P=>P.school_id===null||P.school_id===S),[A,S,q]),i.useMemo(()=>q||!j?[]:j.filter(P=>o==="general"?P.school_id===null:o==="school"?P.school_id===S:P.rank===1),[j,o,S,q]);const y=q||d;if(!N)return e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-gray-600",children:"Only mages can learn and cast spells. Continue to the next step."})});if(S===null)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-amber-800",children:"Magic School Required"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Please go back to the Profession step and select a magic school before choosing spells."})]})]})});if(y)return e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx(En,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading magic data..."})]});if(C||f)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700",children:C||f})]})]})});const w=()=>{},L=_[S]||"General";return e.jsxs("div",{className:"space-y-6",onClick:w,children:[e.jsxs("div",{className:"prose",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Select Magic"}),e.jsxs("p",{className:"text-gray-600",children:["As a new mage, choose three rank 1 spells and three magic tricks from General Magic and your chosen school (",L,")."]})]}),e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(Xe,{className:"w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-800",children:"Your Magic School"}),e.jsx("p",{className:"text-sm text-blue-700",children:L})]})]})]})}function qr(){const[s,a]=i.useState([]),[t,r]=i.useState(!0),[n,l]=i.useState(null);return i.useEffect(()=>{async function o(){r(!0),l(null),console.log("useSkills: Fetching skills...");try{const{data:c,error:x}=await H.from("game_skills").select("*").order("name");if(x)throw console.error("useSkills: Supabase error fetching skills:",x),new Error(x.message||"Failed to fetch skills from database");if(console.log("useSkills: Raw data received from Supabase:",c),Array.isArray(c)){let m=!1;c.forEach((b,p)=>{if(b&&typeof b=="object"){const h=Object.keys(b);h.length>0&&/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(h[0])&&(!("id"in b)||!("name"in b))&&(console.warn(`useSkills: Potential problematic object structure found at index ${p}:`,b),m=!0),(typeof b.id!="string"||typeof b.name!="string")&&console.warn(`useSkills: Item at index ${p} missing 'id' or 'name', or they have wrong types:`,b)}else console.warn(`useSkills: Invalid non-object item found in fetched data at index ${p}:`,b),m=!0}),m||console.log("useSkills: Initial check of fetched data structure passed.")}else console.warn("useSkills: Fetched data is not an array:",c);const g=Array.isArray(c)?c:[];a(g),console.log(`useSkills: Successfully processed and set ${g.length} skills.`)}catch(c){console.error("useSkills: Error during fetch or processing:",c);const x=c instanceof Error?c.message:"An unknown error occurred while fetching skills";l(x),a([])}finally{r(!1),console.log("useSkills: Fetch finished.")}}o()},[]),{skills:s,loading:t,error:n}}const at=s=>{switch(s){case"Young":return 2;case"Adult":return 4;case"Old":return 6;default:return 0}},ai={Acrobatics:"AGL",Awareness:"INT",Bartering:"CHA","Beast Lore":"INT",Bluffing:"CHA",Bushcraft:"INT",Crafting:"STR",Evade:"AGL",Healing:"INT","Hunting & Fishing":"AGL",Languages:"INT","Myths & Legends":"INT",Performance:"CHA",Persuasion:"CHA",Riding:"AGL",Seamanship:"INT","Sleight of Hand":"AGL",Sneaking:"AGL","Spot Hidden":"INT",Swimming:"AGL",Axes:"STR",Bows:"AGL",Brawling:"STR",Crossbows:"AGL",Hammers:"STR",Knives:"AGL",Slings:"AGL",Spears:"STR",Staves:"AGL",Swords:"STR",Mentalism:"WIL",Animism:"WIL",Elementalism:"WIL"},ri=["Axes","Bows","Brawling","Crossbows","Hammers","Knives","Slings","Spears","Staves","Swords"],Da=["Animism","Elementalism","Mentalism"];function ni(){const{character:s,updateCharacter:a}=es(),{skills:t,loading:r,error:n}=qr(),[l,o]=i.useState([]),[c,x]=i.useState([]),[g,m]=i.useState("profession"),[b,p]=i.useState("all"),[h,d]=i.useState([]),[v,f]=i.useState(!1),[u,N]=i.useState(null),[S,A]=i.useState([]),[j,q]=i.useState(!1),[C,_]=i.useState(null),[y,w]=i.useState(null),L=i.useMemo(()=>{var W;return(W=s.profession)==null?void 0:W.toLowerCase().includes("mage")},[s.profession]);i.useEffect(()=>{L&&(q(!0),H.from("magic_schools").select("id, name").then(({data:W,error:se})=>{if(se)throw se;A(W||[])}).catch(W=>console.error("Failed to fetch magic schools:",W)).finally(()=>q(!1)))},[L]);const E=i.useMemo(()=>{var se;const W=s.magicSchool;return typeof W=="object"&&W!==null&&"name"in W?W.name:typeof W=="string"&&S.length>0?((se=S.find(le=>le.id===W))==null?void 0:se.name)??null:null},[s.magicSchool,S]);i.useEffect(()=>{async function W(){if(s.profession){f(!0),N(null);try{const{data:se,error:le}=await H.from("professions").select("skills").eq("name",s.profession).single();if(le)throw le;d(Array.isArray(se==null?void 0:se.skills)?se.skills.filter(je=>typeof je=="string"):[])}catch(se){N(se instanceof Error?se.message:"Failed to load skills.")}finally{f(!1)}}}W()},[s.profession]);const P=i.useMemo(()=>r||v||!Array.isArray(t)?[]:t.filter(W=>W&&h.includes(W.name)),[t,r,v,h]),k=i.useMemo(()=>{if(r||!Array.isArray(t))return[];const W=t.filter(se=>se&&!l.includes(se.name));return L&&E?W.filter(se=>!Da.includes(se.name)||se.name===E):W.filter(se=>!Da.includes(se.name))},[t,r,l,L,E]),R=(W,se)=>W.filter(le=>ri.includes(le.name)===se),O=i.useMemo(()=>R(P,!1),[P]),z=i.useMemo(()=>R(P,!0),[P]),F=i.useMemo(()=>R(k,!1),[k]),U=i.useMemo(()=>R(k,!0),[k]),T=(W,se)=>{const le=se==="profession"?6:at(s.age||"");(se==="profession"?o:x)(pe=>pe.includes(W)?pe.filter(de=>de!==W):pe.length<le?[...pe,W]:pe)},I=()=>{g==="profession"&&l.length===6?m("additional"):g==="additional"&&c.length===at(s.age||"")&&a({trainedSkills:[...new Set([...l,...c])]})},B=(W,se)=>{const le=W.currentTarget.getBoundingClientRect();_(se),w({top:le.top,left:le.left+le.width/2})},Y=()=>{_(null),w(null)},Q=(W,se)=>{W.stopPropagation(),C===se?Y():B(W,se)},D=(W,se)=>{if(!(W!=null&&W.id)||!W.name)return null;const le=se==="profession"?l.includes(W.name):c.includes(W.name),je=se==="profession"?6:at(s.age||""),de=(se==="profession"?l.length:c.length)>=je&&!le;return e.jsxs("div",{onClick:()=>!de&&T(W.name,se),className:`flex items-center justify-between p-3 border-b transition-colors ${de?"bg-gray-50 opacity-60 cursor-not-allowed":"cursor-pointer"} ${le?"bg-blue-50":"hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Bs,{className:`w-6 h-6 flex-shrink-0 ${le?"text-blue-500":"text-gray-300"}`}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h5",{className:"font-medium text-gray-800",children:W.name}),W.description&&e.jsx("div",{className:"p-1",onClick:me=>Q(me,W.description),onMouseEnter:me=>B(me,W.description),onMouseLeave:Y,children:e.jsx(Xe,{className:"w-4 h-4 text-blue-500 cursor-help"})})]})]}),e.jsx("span",{className:"text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full",children:ai[W.name]||"N/A"})]},W.id)};if(r||j)return e.jsx(oe,{size:"lg",className:"my-8"});if(n)return e.jsx(ie,{message:`Skills Error: ${n}`});if(!s.profession||!s.age)return e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-gray-600",children:"Please select a profession and age first."})});if(L&&!E)return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-amber-800",children:"Magic School Required"}),e.jsx("p",{className:"text-sm text-amber-700",children:"As a Mage, please select a magic school first."})]})]})});const G=l.length,$=c.length,Z=6,ee=at(s.age),re=G===Z,K=$===ee;return e.jsxs("div",{className:"space-y-6",onClick:Y,children:[e.jsxs("div",{className:"prose max-w-none",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Select Skills"}),s.profession&&e.jsxs("div",{className:"mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm",children:[" ",e.jsxs("p",{className:"text-indigo-800",children:["Profession: ",e.jsx("strong",{children:s.profession}),s.key_attribute&&` (Key Attribute: ${s.key_attribute})`,L&&E&&` (School: ${E})`]})," ",e.jsxs("p",{className:"text-indigo-700 mt-1",children:["Age: ",e.jsx("strong",{children:s.age})," (Grants ",ee," additional skill points)"]})," "]}),e.jsx("p",{className:"text-gray-600 text-sm",children:g==="profession"?`Choose ${Z} skills from your profession's list below.`:`Choose ${ee} additional skills based on your age (${s.age}).`})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[" ",e.jsx(Xe,{className:"w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"})," ",e.jsxs("div",{children:[" ",e.jsx("h4",{className:"font-medium text-blue-800 text-sm",children:"Selection Progress"})," ",e.jsx("p",{className:"text-sm text-blue-700",children:g==="profession"?`Professional Skills: ${G}/${Z}`:`Additional Skills: ${$}/${ee}`})," "]})," "]}),e.jsx("div",{className:"border rounded-lg bg-white shadow-sm overflow-hidden",onClick:W=>W.stopPropagation(),children:g==="profession"?e.jsxs(e.Fragment,{children:[O.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-700 p-3 bg-gray-50 border-b",children:"General Skills"}),O.map(W=>D(W,"profession"))]}),z.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-700 p-3 bg-gray-50 border-b border-t",children:"Combat Skills"}),z.map(W=>D(W,"profession"))]})]}):e.jsxs(e.Fragment,{children:[F.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-700 p-3 bg-gray-50 border-b",children:"General Skills"}),F.map(W=>D(W,"additional"))]}),U.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-700 p-3 bg-gray-50 border-b border-t",children:"Combat Skills"}),U.map(W=>D(W,"additional"))]})]})}),(g==="profession"&&!re&&G>0||g==="additional"&&!K&&$>0)&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:[" ",e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"})," ",e.jsxs("div",{children:[" ",e.jsx("h4",{className:"font-medium text-amber-800 text-sm",children:"Incomplete Selection"})," ",e.jsx("p",{className:"text-sm text-amber-700",children:g==="profession"?`Please select ${Z-G} more skill(s).`:`Please select ${ee-$} more skill(s).`})," "]})," "]}),e.jsxs("button",{onClick:I,disabled:g==="profession"&&!re||g==="additional"&&!K||v,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-sm hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[" ",v?e.jsx(Ye,{className:"w-5 h-5 animate-spin"}):e.jsx(Bs,{className:"w-5 h-5"})," ",g==="profession"?"Continue to Additional Skills":"Confirm Skill Selections"," "]}),C&&y&&e.jsxs("div",{style:{top:`${y.top}px`,left:`${y.left}px`},className:"fixed -translate-x-1/2 -translate-y-full mb-2 w-72 p-3 bg-gray-800 text-white text-sm rounded-lg shadow-lg z-[60] pointer-events-none",children:[" ",e.jsx("p",{children:C})," "]})]})}async function Ys(s){let a=H.from("game_items").select("*");s&&s!=="all"&&typeof s=="string"&&(a=a.eq("category",s.toUpperCase()));const{data:t,error:r}=await a.order("category").order("name");if(r)throw console.error("Error fetching game items:",r),new Error(r.message||"Failed to fetch game items");return t||[]}function Et(s){const a={gold:0,silver:0,copper:0};if(!s||typeof s!="string")return a;const t=s.toLowerCase().split(/,\s*|\s+/);for(let r=0;r<t.length;r++){const n=parseInt(t[r]);if(!isNaN(n)&&r+1<t.length){const l=t[r+1];l.startsWith("gold")||l.startsWith("g")?(a.gold=n,r++):l.startsWith("silver")||l.startsWith("s")?(a.silver=n,r++):(l.startsWith("copper")||l.startsWith("c"))&&(a.copper=n,r++)}}return da(a)}function Fr(s){if(!s)return"0 copper";const a=[];return s.gold>0&&a.push(`${s.gold} gold`),s.silver>0&&a.push(`${s.silver} silver`),s.copper>0&&a.push(`${s.copper} copper`),a.length>0?a.join(", "):"0 copper"}function da(s){let{gold:a,silver:t,copper:r}=s;return t+=Math.floor(r/100),r%=100,a+=Math.floor(t/100),t%=100,{gold:a,silver:t,copper:r}}function li(s,a){const t=s.gold*1e4+s.silver*100+s.copper,r=a.gold*1e4+a.silver*100+a.copper;if(t<r)return{success:!1,newMoney:s};let n=t-r;const l=Math.floor(n/1e4);n%=1e4;const o=Math.floor(n/100);return n%=100,{success:!0,newMoney:{gold:l,silver:o,copper:n}}}function ii(){var w,L;const{character:s,updateCharacter:a}=es(),[t,r]=i.useState(null),[n,l]=i.useState([]),[o,c]=i.useState(!1),[x,g]=i.useState(!1),[m,b]=i.useState({}),[p,h]=i.useState(!0),[d,v]=i.useState(""),{data:f=[],isLoading:u,error:N}=we({queryKey:["gameItems"],queryFn:Ys,staleTime:1e3*60*10});i.useEffect(()=>{async function E(){if(!s.profession){v("Profession not selected."),h(!1);return}try{h(!0),v("");const{data:P,error:k}=await H.from("professions").select("starting_equipment, equipment_description").eq("name",s.profession).single();if(k)throw k;if(P){const R=P,O=(R.starting_equipment||[]).map((z,F)=>({option:F+1,items:z.split(",").map(U=>U.trim()).filter(Boolean),description:(R.equipment_description||[])[F]||""}));l(O)}}catch{v("Failed to load equipment options.")}finally{h(!1)}}E()},[s.profession]);const S=E=>{const k=E.split(" or ")[0].trim().replace(/^\d+\s+/,"");return f.find(R=>R.name.toLowerCase()===k.toLowerCase())},A=E=>{const P=E.match(/^(\d*D\d+)/i);if(!P)return null;const k=P[1],R=k.toUpperCase().split("D"),O=R[0]===""?1:parseInt(R[0]),z=parseInt(R[1]),F=E.slice(k.length).trim();return{count:O,sides:z,rest:F}},j=(E,P)=>{let k=0;for(let R=0;R<E;R++)k+=Math.floor(Math.random()*P)+1;return k},q=E=>{r(E),c(!1)},C=()=>{var k,R;if(t===null)return;const E=n.find(O=>O.option===t);if(!E)return;if(E.items.some(O=>A(O)||O.toLowerCase().includes(" or "))){const O=E.items.reduce((z,F,U)=>(F.toLowerCase().includes(" or ")?z[U]=F.split(/\s+or\s+/i)[0].trim():z[U]="",z),{});b(O),g(!0)}else a({startingEquipment:{option:t,items:E.items},equipment:{money:((k=s.equipment)==null?void 0:k.money)||{gold:0,silver:0,copper:0},equipped:((R=s.equipment)==null?void 0:R.equipped)||{weapons:[]},inventory:[...E.items]}}),c(!0)},_=()=>{var O,z;if(t===null)return;const E=n.find(F=>F.option===t);if(!E)return;const k={...((O=s.equipment)==null?void 0:O.money)||{gold:0,silver:0,copper:0}},R=[];E.items.forEach((F,U)=>{if(F.toLowerCase().includes(" or "))R.push(m[U]||F.split(/\s+or\s+/i)[0].trim());else{const T=A(F);if(T){const I=m[U]?parseInt(m[U]):j(T.count,T.sides),B=T.rest.toLowerCase();B.includes("gold")?k.gold+=I:B.includes("silver")?k.silver+=I:B.includes("copper")?k.copper+=I:R.push(`${I} ${T.rest}`)}else R.push(F)}}),a({startingEquipment:{option:t,items:R},equipment:{money:da(k),equipped:((z=s.equipment)==null?void 0:z.equipped)||{weapons:[]},inventory:[...R]}}),g(!1),c(!0)},y=t!==null&&((w=n.find(E=>E.option===t))==null?void 0:w.items.every((E,P)=>E.toLowerCase().includes(" or ")||A(E)?!!m[P]:!0));return p||u?e.jsx(oe,{}):d||N?e.jsx(ie,{message:d||(N==null?void 0:N.message)||"Failed to load data."}):s.profession?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"prose",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Choose Starting Equipment"}),e.jsxs("p",{className:"text-gray-600",children:["Select one of the equipment packages for your ",s.profession,"."]})]}),e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(Xe,{className:"w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-800",children:"Equipment Selection"}),e.jsxs("p",{className:"text-sm text-blue-700",children:["Items with ",e.jsx(Sa,{className:"inline w-4 h-4 text-amber-600"})," require a roll, items with ",e.jsx(Ca,{className:"inline w-4 h-4 text-purple-600"})," offer a choice."]})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:n.map(E=>e.jsxs("div",{onClick:()=>q(E.option),className:`p-6 border rounded-lg cursor-pointer transition-all ${t===E.option?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(fs,{className:"w-6 h-6 text-gray-500"}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold",children:["Option ",E.option]}),e.jsx("p",{className:"text-sm text-gray-600",children:E.description})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"font-medium text-gray-700",children:"Equipment List:"}),e.jsx("ul",{className:"space-y-1.5",children:E.items.map((P,k)=>{const R=!!A(P),O=P.toLowerCase().includes(" or "),z=S(P);return e.jsxs("li",{className:"flex items-center gap-2 text-sm text-gray-600",children:[R?e.jsx(Sa,{className:"w-4 h-4 text-amber-500 flex-shrink-0"}):O?e.jsx(Ca,{className:"w-4 h-4 text-purple-500 flex-shrink-0"}):e.jsx(Bs,{className:"w-4 h-4 text-green-500 flex-shrink-0"}),e.jsx("span",{children:P}),(z==null?void 0:z.effect)&&e.jsxs("span",{className:"relative group flex items-center",children:[e.jsx(Xe,{className:"w-4 h-4 text-gray-400 hover:text-gray-600 cursor-help"}),e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-gray-800 text-white text-xs p-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-normal z-20 pointer-events-none",children:[e.jsx("p",{className:"font-bold",children:z.name}),e.jsx("p",{children:z.effect}),e.jsxs("p",{className:"mt-1 text-gray-300",children:["Weight: ",z.weight,", Cost: ",z.cost]})]})]})]},k)})})]}),t===E.option&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 text-blue-600",children:[e.jsx(Bs,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Selected"})]})]},E.option))}),!t&&e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-amber-800",children:"Equipment Required"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Please select a starting equipment package."})]})]}),e.jsxs("button",{onClick:C,disabled:!t||o,className:`w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition-colors ${o?"bg-green-600 text-white cursor-default":"bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"}`,children:[e.jsx(mr,{className:"w-5 h-5"}),o?"Equipment Confirmed":"Confirm Equipment Selection"]}),x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"Resolve Dice Rolls & Selections"}),e.jsx("button",{onClick:()=>g(!1),className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-5 h-5"})})]}),(((L=n.find(E=>E.option===t))==null?void 0:L.items)||[]).map((E,P)=>{if(E.toLowerCase().includes(" or ")){const R=E.split(/\s+or\s+/i).map(O=>O.trim());return e.jsxs("div",{className:"mb-4 p-3 border rounded bg-purple-50 border-purple-200",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:E}),e.jsxs("select",{value:m[P]||"",onChange:O=>b(z=>({...z,[P]:O.target.value})),className:"mt-1 w-full border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"Select one..."}),R.map((O,z)=>e.jsx("option",{value:O,children:O},z))]})]},P)}const k=A(E);return k?e.jsxs("div",{className:"mb-4 p-3 border rounded bg-amber-50 border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium",children:E}),e.jsxs(M,{size:"sm",variant:"secondary",onClick:()=>{const R=j(k.count,k.sides);b(O=>({...O,[P]:R.toString()}))},children:["Roll ",k.count,"D",k.sides]})]}),e.jsx("input",{type:"number",min:k.count,max:k.count*k.sides,value:m[P]||"",onChange:R=>{const O=R.target.value;if(O==="")b(z=>({...z,[P]:""}));else{const z=parseInt(O);if(!isNaN(z)){const F=Math.max(k.count,Math.min(k.count*k.sides,z));b(U=>({...U,[P]:F.toString()}))}}},className:"mt-1 w-full border rounded px-2 py-1 text-sm",placeholder:`Enter result (${k.count}-${k.count*k.sides})`})]},P):null}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx(M,{variant:"secondary",onClick:()=>g(!1),children:"Cancel"}),e.jsx(M,{variant:"primary",onClick:_,disabled:!y,children:"Confirm Rolls/Choices"})]})]})})]}):e.jsx("div",{className:"p-6 text-center",children:e.jsx("p",{className:"text-gray-600",children:"Please select a profession first."})})}async function oi(){const{data:s,error:a}=await H.from("compendium").select("*").order("category").order("title");if(a)throw console.error("Error fetching compendium entries:",a),new Error(a.message||"Failed to load compendium entries");return s||[]}async function ci(){const{data:s,error:a}=await H.from("bio_data").select("appearance, mementos, flaws");if(a)throw console.error("Error fetching bio data:",a),new Error(a.message||"Failed to load bio data");const t=new Set,r=new Set,n=new Set;return(s||[]).forEach(l=>{(l.appearance||[]).forEach(o=>t.add(o)),(l.mementos||[]).forEach(o=>r.add(o)),(l.flaws||[]).forEach(o=>n.add(o))}),{appearance:Array.from(t).sort(),mementos:Array.from(r).sort(),flaws:Array.from(n).sort()}}const Pa=["Diminutive","Short","Below Average","Average","Above Average","Tall","Towering"],qa=["Gaunt","Slight","Lean","Wiry","Average","Athletic","Muscular","Stocky","Heavy"],Fa=["Raven Black","Chestnut Brown","Sandy Blonde","Fiery Red","Ash Gray","Snow White","Auburn"],$a=["Slicked Back","Short & Spiky","Long & Flowing","Ornate Braids","Messy Bun","Curly Mop","Shaved Sides","Tonsure","Bald"],Oa=["Chocolate Brown","Sky Blue","Emerald Green","Stormy Gray","Warm Hazel","Amber"],za=["Pale","Fair","Light","Olive","Ruddy","Tan","Dark","Ebony"],Ha=["Deep Blue","Crimson","Silver","Violet","Pastel Pink"],Ba=["Lilac","Gold","Silver","Blood Red","All White (No Pupil)"],Ua=["Simple traveler's clothes","Ragged commoner's garb","Well-made leather armor","Sturdy chainmail hauberk","Flamboyant noble's attire","Scholar's robes and spectacles","Mysterious hooded cloak","Practical hunter's leathers","Grim ritual vestments","Colorful entertainer's outfit","Tailored city guard uniform","Patched and worn adventurer's gear"],rt=({label:s,placeholder:a,options:t,value:r,onChange:n,mode:l,onModeChange:o,onRandomize:c,isLoading:x=!1,rows:g=3})=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:s}),e.jsxs("button",{onClick:()=>o(l==="manual"?"select":"manual"),className:"flex items-center gap-1 text-xs text-gray-600 hover:text-blue-600",title:`Switch to ${l==="manual"?"selection":"manual"} mode`,children:[l==="manual"?e.jsx(Mn,{className:"w-4 h-4"}):e.jsx(Ln,{className:"w-4 h-4"}),e.jsx("span",{children:l==="manual"?"Manual":"Select"})]})]}),l==="manual"?e.jsx("textarea",{value:r,onChange:m=>n(m.target.value),placeholder:a,className:"w-full px-3 py-2 border border-gray-300 rounded-md",rows:g}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:r,onChange:m=>n(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",disabled:x||t.length===0,children:[e.jsx("option",{value:"",children:x?"Loading...":"Select an option..."}),t.map(m=>e.jsx("option",{value:m,children:m},m))]}),e.jsx(M,{variant:"secondary",size:"icon",onClick:c,disabled:x||t.length===0,"aria-label":`Randomize ${s}`,icon:be})]})]});function di(){const{character:s,updateCharacter:a}=es(),{data:t,isLoading:r}=we({queryKey:["bioData"],queryFn:ci,staleTime:1e3*60*5}),[n,l]=i.useState({height:"",build:"",hairColor:"",hairStyle:"",eyeColor:"",skinTone:"",distinctiveFeatures:"",clothing:"",memento:"",flaw:""}),[o,c]=i.useState({distinctiveFeatures:"select",clothing:"select",memento:"select",flaw:"select"}),x=(u,N)=>{l(S=>({...S,[u]:N}))},g=(u,N)=>{c(S=>({...S,[u]:N})),l(S=>({...S,[u]:""}))},m=u=>!u||u.length===0?"":u[Math.floor(Math.random()*u.length)],b=(u,N)=>{N&&N.length>0&&l(S=>({...S,[u]:m(N)}))},p=()=>{l(u=>({...u,height:m(Pa),build:m(qa)}))},h=()=>{const u=Math.random()<.05?m(Ha):m(Fa),N=Math.random()<.05?m(Ba):m(Oa);l(S=>({...S,hairColor:u,hairStyle:m($a),eyeColor:N,skinTone:m(za)}))},d=()=>{const u=[];n.height&&n.build&&u.push(`A ${n.height.toLowerCase()}, ${n.build.toLowerCase()} individual`),n.hairStyle&&n.hairColor&&(n.hairStyle.toLowerCase()==="bald"?u.push("with a bald head"):u.push(`with ${n.hairStyle.toLowerCase()} ${n.hairColor.toLowerCase()} hair`)),n.eyeColor&&u.push(`${n.eyeColor.toLowerCase()} eyes`),n.skinTone&&u.push(`and ${n.skinTone.toLowerCase()} skin`);let N=u.join(", ").replace(/,([^,]*)$/," and$1")+".";return n.distinctiveFeatures&&(N+=` They are notable for ${n.distinctiveFeatures.toLowerCase()}.`),n.clothing&&(N+=` They typically wear ${n.clothing.toLowerCase()}.`),N},v=()=>{const u=d();a({appearance:u,mementos:n.memento?[n.memento]:[],weak_spot:n.flaw})},f=()=>Object.values(n).every(u=>u.trim()!=="");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Character Appearance"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Describe your character's physical appearance, clothing, and defining traits."})]}),e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(Xe,{className:"w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-blue-800",children:"Character Details"}),e.jsxs("p",{className:"text-sm text-blue-700",children:[s.kin,"  ",s.age,"  ",s.profession]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium flex items-center gap-2 text-gray-800",children:[e.jsx(An,{className:"w-5 h-5 text-gray-500"}),"Physical Characteristics"]}),e.jsx(M,{variant:"secondary",size:"sm",icon:be,onClick:p,children:"Randomize"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Height"}),e.jsxs("select",{value:n.height,onChange:u=>x("height",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select height..."}),Pa.map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Build"}),e.jsxs("select",{value:n.build,onChange:u=>x("build",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select build..."}),qa.map(u=>e.jsx("option",{value:u,children:u},u))]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"font-medium flex items-center gap-2 text-gray-800",children:[e.jsx(os,{className:"w-5 h-5 text-gray-500"}),"Hair and Face"]}),e.jsx(M,{variant:"secondary",size:"sm",icon:be,onClick:h,children:"Randomize"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Hair Color"}),e.jsxs("select",{value:n.hairColor,onChange:u=>x("hairColor",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select color..."}),[...Fa,...Ha].map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Hair Style"}),e.jsxs("select",{value:n.hairStyle,onChange:u=>x("hairStyle",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select style..."}),$a.map(u=>e.jsx("option",{value:u,children:u},u))]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Eye Color"}),e.jsxs("select",{value:n.eyeColor,onChange:u=>x("eyeColor",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select color..."}),[...Oa,...Ba].map(u=>e.jsx("option",{value:u,children:u},u))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Skin Tone"}),e.jsxs("select",{value:n.skinTone,onChange:u=>x("skinTone",u.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Select tone..."}),za.map(u=>e.jsx("option",{value:u,children:u},u))]})]})]})]}),e.jsx("div",{className:"space-y-4 md:col-span-2",children:e.jsxs("h4",{className:"font-medium flex items-center gap-2 text-gray-800 border-b pb-2",children:[e.jsx(Es,{className:"w-5 h-5 text-gray-500"}),"Traits & Possessions"]})}),e.jsx(rt,{label:"Distinctive Feature",placeholder:"Scars, tattoos, birthmarks...",options:(t==null?void 0:t.appearance)||[],value:n.distinctiveFeatures,onChange:u=>x("distinctiveFeatures",u),mode:o.distinctiveFeatures,onModeChange:u=>g("distinctiveFeatures",u),onRandomize:()=>b("distinctiveFeatures",t==null?void 0:t.appearance),isLoading:r}),e.jsx(rt,{label:"Typical Clothing",placeholder:"Describe typical clothing...",options:Ua,value:n.clothing,onChange:u=>x("clothing",u),mode:o.clothing,onModeChange:u=>g("clothing",u),onRandomize:()=>b("clothing",Ua)}),e.jsx(rt,{label:"Memento",placeholder:"A locket, a worn coin...",options:(t==null?void 0:t.mementos)||[],value:n.memento,onChange:u=>x("memento",u),mode:o.memento,onModeChange:u=>g("memento",u),onRandomize:()=>b("memento",t==null?void 0:t.mementos),isLoading:r}),e.jsx(rt,{label:"Flaw / Weak Spot",placeholder:"A fear of heights, a gambling problem...",options:(t==null?void 0:t.flaws)||[],value:n.flaw,onChange:u=>x("flaw",u),mode:o.flaw,onModeChange:u=>g("flaw",u),onRandomize:()=>b("flaw",t==null?void 0:t.flaws),isLoading:r})]}),f()?e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg space-y-3",children:[e.jsx("h4",{className:"font-medium text-green-800 mb-1",children:"Appearance Preview"}),e.jsx("p",{className:"text-sm text-green-700",children:d()})]}):e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-amber-800",children:"Incomplete Description"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Please fill in all appearance details to see a preview and save."})]})]}),e.jsx(M,{onClick:v,disabled:!f(),icon:Ae,className:"w-full justify-center",children:"Save Appearance"})]})}const Ps=[{title:"Kin",component:Ul},{title:"Profession",component:Vl},{title:"Name & Age",component:Yl},{title:"Attributes",component:ei},{title:"Magic",component:ti},{title:"Trained Skills",component:ni},{title:"Gear",component:ii},{title:"Appearance",component:di}],mi=s=>s<=5?3:s<=8?4:s<=12?5:s<=15?6:7,Ga={Acrobatics:"AGL",Awareness:"INT",Bartering:"CHA","Beast Lore":"INT",Bluffing:"CHA",Bushcraft:"INT",Crafting:"STR",Evade:"AGL",Healing:"INT","Hunting & Fishing":"AGL",Languages:"INT","Myths & Legends":"INT",Performance:"CHA",Persuasion:"CHA",Riding:"AGL",Seamanship:"INT","Sleight of Hand":"AGL",Sneaking:"AGL","Spot Hidden":"INT",Swimming:"AGL",Axes:"STR",Bows:"AGL",Brawling:"STR",Crossbows:"AGL",Hammers:"STR",Knives:"AGL",Slings:"AGL",Spears:"STR",Staves:"AGL",Swords:"STR",Mentalism:"WIL",Animism:"WIL",Elementalism:"WIL"},ui=["Mentalism","Animism","Elementalism"];function xi(){const{user:s}=Ce(),{step:a,setStep:t,character:r,resetCharacter:n}=es(),[l,o]=ot.useState(null),[c,x]=ot.useState(!1),g=Be(),m=Fe(),b=Ps[a].component,[p,h]=i.useState([]);i.useEffect(()=>{H.from("magic_schools").select("id, name").then(({data:f,error:u})=>{u?console.error("Failed to fetch magic schools in wizard:",u):h(f||[])})},[]);const d=()=>{var f;switch(a){case 0:return!!r.kin&&r.kinAbilityNames!==void 0&&r.kinAbilityNames.length>0;case 1:const u=r.magicSchool!==null&&r.magicSchool!==void 0;return!!r.profession&&(u||r.professionHeroicAbilityName!==void 0);case 2:return!!r.name&&r.name.trim().length>0&&!!r.age;case 3:return r.attributes&&Object.values(r.attributes).every(N=>N>0);case 4:return r.magicSchool?((f=r.spells)==null?void 0:f.general)&&r.spells.general.length>=3:!0;case 5:return r.trainedSkills&&r.trainedSkills.length>=6&&!!r.attributes;case 6:return r.startingEquipment&&r.startingEquipment.items.length>=0;case 7:return!!r.appearance&&r.appearance.trim().length>0&&!!r.mementos&&r.mementos.length>0&&!!r.weak_spot&&r.weak_spot.trim().length>0;default:return!1}},v=async()=>{var u,N,S,A,j;const f=es.getState().character;if(!s||!f.attributes){o("User or attributes missing.");return}if(!d()){o("Please complete all required fields for the final step before saving.");return}try{x(!0),o(null);const q={},C=new Set(f.trainedSkills||[]),_=(u=f.profession)==null?void 0:u.toLowerCase().includes("mage"),y=_&&typeof f.magicSchool=="string"?(N=p.find(k=>k.id===f.magicSchool))==null?void 0:N.name:null;for(const k in Ga){const R=Ga[k];if(!ui.includes(k)||_&&k===y){const z=f.attributes[R]??10,F=mi(z);q[k]=C.has(k)?F*2:F}}const w=[...f.kinAbilityNames||[],...f.professionHeroicAbilityName?[f.professionHeroicAbilityName]:[]].filter(Boolean),L={user_id:s.id,name:(S=f.name)==null?void 0:S.trim(),kin:f.kin,profession:f.profession,magic_school:_?f.magicSchool:null,age:f.age,attributes:f.attributes,trained_skills:f.trainedSkills||[],skill_levels:q,equipment:f.equipment||{inventory:[],equipped:{weapons:[]},money:{gold:0,silver:0,copper:0}},appearance:(A=f.appearance)==null?void 0:A.trim(),conditions:{exhausted:!1,sickly:!1,dazed:!1,angry:!1,scared:!1,disheartened:!1},spells:f.spells||null,starting_equipment:f.startingEquipment||{items:[],money:{gold:0,silver:0,copper:0}},experience:{marked_skills:[]},max_hp:f.attributes.CON,current_hp:f.attributes.CON,max_wp:f.attributes.WIL,current_wp:f.attributes.WIL,heroic_ability:w,memento:((j=f.mementos)==null?void 0:j[0])||null,weak_spot:f.weak_spot||null},{data:E,error:P}=await H.from("characters").insert(L).select().single();if(P)throw P;await m.invalidateQueries({queryKey:["characters",s.id]}),n(),g(`/characters/${E.id}`)}catch(q){const C=q instanceof Error?q.message:"Failed to save character";o(`Failed to save character: ${C}`)}finally{x(!1)}};return e.jsxs("div",{className:"max-w-4xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8 my-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:"Create New Character"}),e.jsxs("span",{className:"text-sm font-medium text-gray-500",children:["Step ",a+1," of ",Ps.length]})]}),e.jsx("div",{className:"flex space-x-1",children:Ps.map((f,u)=>e.jsx("div",{className:"flex-1 h-2 rounded-full overflow-hidden bg-gray-200",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-300 ${u<a?"bg-blue-500":u===a?"bg-blue-300":"bg-gray-200"}`,style:{width:u===a?"50%":"100%"}})},f.title))}),e.jsx("p",{className:"text-center text-lg font-semibold mt-3 text-gray-700",children:Ps[a].title})]}),l&&e.jsxs("div",{className:"mb-6 flex items-start gap-3 p-4 bg-red-50 border border-red-300 rounded-lg shadow-sm",children:[e.jsx(he,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-800",children:"Creation Error"}),e.jsx("p",{className:"text-sm text-red-700",children:l})]})]}),e.jsx("div",{className:"min-h-[400px] mb-8",children:e.jsx(b,{})}),e.jsxs("div",{className:"flex justify-between items-center mt-8 border-t pt-6",children:[e.jsx("button",{onClick:()=>t(a-1),disabled:a===0||c,className:"px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),a===Ps.length-1?e.jsxs("button",{onClick:v,disabled:!d()||c,className:`inline-flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-150 ${c?"bg-gray-400 cursor-not-allowed":d()?"bg-green-600 hover:bg-green-700":"bg-gray-300 cursor-not-allowed"}`,children:[e.jsx(Ae,{className:`w-4 h-4 ${c?"animate-spin":""}`}),c?"Saving Character...":"Create Character"]}):e.jsx("button",{onClick:()=>t(a+1),disabled:!d()||c,className:`inline-flex items-center px-5 py-2 text-sm font-medium text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150 ${!d()||c?"bg-gray-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}`,children:"Next Step"})]})]})}function Ft({icon:s,title:a,description:t,action:r}){return e.jsxs("div",{className:"text-center py-12",children:[e.jsx(s,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:a}),e.jsx("p",{className:"text-gray-500 mb-6",children:t}),r]})}const $r="*, magic_school:magic_schools!left(*)",Rs=s=>{const a={STR:10,AGL:10,INT:10,CON:10,WIL:10,CHA:10},t=s.attributes||{},r={STR:t.STR??a.STR,AGL:t.AGL??a.AGL,INT:t.INT??a.INT,CHA:t.CHA??a.CHA,CON:t.CON??a.CON,WIL:t.WIL??a.WIL},n=s.max_hp??r.CON,l=s.max_wp??r.WIL;let o={};if(typeof s.skill_levels=="string")try{o=JSON.parse(s.skill_levels)}catch{}else typeof s.skill_levels=="object"&&s.skill_levels!==null&&(o=s.skill_levels);const c=s.equipment||{};return{id:s.id,user_id:s.user_id,name:s.name||"Unnamed Character",kin:s.kin||"Unknown",profession:s.profession||"Unknown",age:s.age,appearance:s.appearance||"",background:s.background||"",notes:s.notes||"",portrait_url:s.portrait_url,magicSchool:s.magic_school||null,memento:s.memento||"",flaw:s.weak_spot||"",attributes:r,max_hp:n,current_hp:s.current_hp??n,max_wp:l,current_wp:s.current_wp??l,skill_levels:o,trainedSkills:s.trained_skills||[],spells:s.spells||{known:[]},heroic_abilities:s.heroic_ability||[],equipment:{inventory:c.inventory||[],equipped:c.equipped||{weapons:[]},money:c.money||{gold:0,silver:0,copper:0}},conditions:s.conditions||{exhausted:!1,sickly:!1,dazed:!1,angry:!1,scared:!1,disheartened:!1},is_rallied:s.is_rallied??!1,death_rolls_passed:s.death_rolls_passed??0,death_rolls_failed:s.death_rolls_failed??0,experience:s.experience??0,teacher:s.teacher||null,reputation:s.reputation??0,corruption:s.corruption??0,created_at:s.created_at,updated_at:s.updated_at,party_id:s.party_id,party_info:s.party_info}};async function hi(s){if(!s)return[];const{data:a,error:t}=await H.from("characters").select($r).eq("user_id",s).order("created_at",{ascending:!1});if(t)throw new Error(t.message||"Failed to fetch characters");return(a||[]).map(Rs)}async function pi(s,a){if(!s||!a)return console.warn("fetchCharacterById requires both character ID and user ID."),null;try{const{data:t,error:r}=await H.rpc("get_character_details_with_party",{p_character_id:s,p_user_id:a});return r?(console.error("Error fetching character via RPC:",r),null):t?Rs(t):null}catch(t){return console.error("Unexpected error in fetchCharacterById:",t),null}}async function Or(s,a){const t={...a};t.heroic_abilities&&(t.heroic_ability=t.heroic_abilities,delete t.heroic_abilities),t.trainedSkills&&(t.trained_skills=t.trainedSkills,delete t.trainedSkills),t.magicSchool&&(t.magic_school=t.magicSchool,delete t.magicSchool),t.updated_at=new Date().toISOString();const{data:r,error:n}=await H.from("characters").update(t).eq("id",s).select($r).single();if(n)throw new Error(n.message||"Failed to update character");return r?Rs(r):null}async function gi(s){if(s.length===0)return;const{error:a}=await H.from("characters").delete().in("id",s);if(a)throw new Error(a.message||"Failed to delete characters")}const zr=ot.forwardRef(({className:s,...a},t)=>e.jsx("input",{ref:t,className:`block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-50 disabled:cursor-not-allowed ${s}`,...a}));zr.displayName="Input";function fi({isOpen:s,onClose:a,onJoin:t}){const[r,n]=i.useState(""),[l,o]=i.useState(""),[c,x]=i.useState(!1),g=async()=>{o("");const b=r.match(/party\/join\/([^/?]+)/);if(b&&b[1]){const p=b[1];x(!0);try{await t(p),m()}catch(h){console.error("Join operation failed:",h)}finally{x(!1)}}else o("Invalid party invite link. Please paste the full link.")},m=()=>{n(""),o(""),x(!1),a()};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity","aria-labelledby":"join-party-title",role:"dialog","aria-modal":"true",onClick:m,children:e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4 transform transition-all",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{id:"join-party-title",className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(Ut,{className:"w-6 h-6 text-blue-600"}),"Join an Adventure Party"]}),e.jsx("button",{onClick:m,className:"p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600","aria-label":"Close dialog",disabled:c,children:e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Paste the invite link you received from your Dungeon Master to join their party."}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"party-link",className:"sr-only",children:"Party Invite Link"}),e.jsx(zr,{id:"party-link",type:"text",value:r,onChange:b=>n(b.target.value),placeholder:"https://.../party/join/...",className:"w-full","aria-describedby":"link-error",disabled:c}),l&&e.jsx("p",{id:"link-error",className:"text-red-500 text-sm mt-2",children:l})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx(M,{variant:"secondary",onClick:m,disabled:c,children:"Cancel"}),e.jsx(M,{variant:"primary",onClick:g,disabled:!r||c,children:c?"Joining...":"Join Party"})]})]})}):null}function $t({isOpen:s,onClose:a,onConfirm:t,title:r,description:n,confirmText:l="Confirm",cancelText:o="Cancel",isLoading:c=!1,isDestructive:x=!1,icon:g}){return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm",onClick:a,"aria-modal":"true",role:"dialog",children:e.jsxs("div",{className:"relative bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[g&&e.jsx("div",{className:`mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full ${x?"bg-red-100":"bg-blue-100"}`,children:g}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",id:"modal-title",children:r}),e.jsx("div",{className:"mt-2",children:e.jsx("p",{className:"text-sm text-gray-600",children:n})})]})]}),e.jsxs("div",{className:"mt-6 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3",children:[e.jsx(M,{variant:"secondary",onClick:a,disabled:c,className:"mt-3 sm:mt-0 w-full sm:w-auto",children:o}),e.jsx(M,{variant:x?"danger":"primary",onClick:t,loading:c,className:"w-full sm:w-auto",children:l})]})]})}):null}function bi(){const{user:s}=Ce(),a=Be(),t=Fe(),[r,n]=i.useState(!1),[l,o]=i.useState(!1),[c,x]=i.useState(!1),[g,m]=i.useState([]),[b,p]=i.useState(!1),{data:h=[],isLoading:d,error:v}=we({queryKey:["characters",s==null?void 0:s.id],queryFn:()=>hi(s==null?void 0:s.id),enabled:!!s}),f=ge({mutationFn:gi,onSuccess:()=>{t.invalidateQueries({queryKey:["characters",s==null?void 0:s.id]}),m([]),x(!1),p(!1)},onError:A=>{console.error("Failed to delete characters:",A),p(!1)}}),u=A=>{m(j=>j.includes(A)?j.filter(q=>q!==A):[...j,A])},N=(A,j)=>{c||A.shiftKey||g.length>0?(A.preventDefault(),c||x(!0),u(j)):a(`/character/${j}`)},S=()=>{m([]),x(!1)};return d?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(oe,{size:"lg"})}):v?e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:v.message})}):s?e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto space-y-8 min-h-[calc(100vh-4rem)] relative pb-24",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold text-gray-900 tracking-tight",children:"My Characters"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage your roster or create a new hero."})]}),!r&&h.length>0&&e.jsx("div",{className:"flex items-center gap-3 w-full md:w-auto",children:c?e.jsx(M,{variant:"ghost",onClick:S,children:"Cancel Selection"}):e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"ghost",onClick:()=>x(!0),className:"text-gray-500 hover:text-gray-900",children:"Select..."}),e.jsx("div",{className:"h-6 w-px bg-gray-300 mx-1 hidden md:block"}),e.jsx(M,{variant:"secondary",icon:Ut,onClick:()=>o(!0),children:"Join Party"}),e.jsx(M,{variant:"primary",icon:ye,onClick:()=>n(!0),children:"Create New"})]})})]}),r?e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden animate-in fade-in slide-in-from-bottom-4",children:e.jsx(xi,{onComplete:()=>{n(!1),t.invalidateQueries({queryKey:["characters",s==null?void 0:s.id]})}})}):h.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:h.map(A=>{const j=g.includes(A.id);return e.jsxs("div",{className:`
                  group relative cursor-pointer rounded-xl transition-all duration-200
                  ${j?"ring-4 ring-indigo-500 ring-offset-2 transform scale-[0.98]":c?"hover:ring-4 hover:ring-gray-200 hover:ring-offset-2":"hover:-translate-y-1 hover:shadow-lg"}
                `,onClick:q=>N(q,A.id),children:[c&&e.jsx("div",{className:`absolute top-3 right-3 z-10 rounded-full p-1 transition-colors ${j?"bg-indigo-600 text-white":"bg-gray-200 text-gray-400 group-hover:bg-gray-300"}`,children:e.jsx(ds,{size:16,className:j?"opacity-100":"opacity-0 group-hover:opacity-50"})}),e.jsx(zl,{character:A}),c&&e.jsx("div",{className:"absolute inset-0 z-0 rounded-xl bg-white/0"})]},A.id)})}):e.jsx("div",{className:"mt-12",children:e.jsx(Ft,{icon:Me,title:"The Tavern is Empty",description:"You haven't created any characters yet. Start your journey today!",action:e.jsx(M,{variant:"primary",size:"lg",icon:ye,onClick:()=>n(!0),children:"Create Your First Character"})})}),g.length>0&&e.jsx("div",{className:"fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-md px-4 animate-in slide-in-from-bottom-6 fade-in",children:e.jsxs("div",{className:"bg-white border border-gray-200 shadow-2xl rounded-2xl p-3 flex items-center justify-between ring-1 ring-black/5",children:[e.jsxs("div",{className:"flex items-center gap-3 pl-2",children:[e.jsx("div",{className:"bg-indigo-600 text-white text-xs font-bold px-2.5 py-1 rounded-full",children:g.length}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Selected"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:S,children:"Cancel"}),e.jsx(M,{variant:"danger",size:"sm",icon:Le,onClick:()=>p(!0),loading:f.isPending,children:"Delete"})]})]})}),e.jsx(fi,{isOpen:l,onClose:()=>o(!1),onJoin:A=>{o(!1),a(`/party/join/${A}`)}}),e.jsx($t,{isOpen:b,onClose:()=>p(!1),onConfirm:()=>{g.length>0&&f.mutate(g)},title:`Delete ${g.length} Character${g.length>1?"s":""}?`,description:"These heroes will be lost to the void forever. This action cannot be undone.",confirmText:"Yes, Delete Forever",isDestructive:!0,isLoading:f.isPending,icon:e.jsx(bs,{className:"h-6 w-6 text-red-600"})})]}):e.jsx("div",{className:"p-8",children:e.jsx(Ft,{icon:he,title:"Authentication Required",description:"Please sign in."})})}async function yi(s){const{data:a,error:t}=await H.from("encounters").select("*").eq("party_id",s).order("created_at",{ascending:!1});if(t)throw t;return a||[]}async function ji(s){const{data:a,error:t}=await H.from("encounters").select("*").eq("id",s).single();if(t)throw t;return a}async function Hr(s){const{data:a,error:t}=await H.from("encounter_combatants").select("*").eq("encounter_id",s).order("initiative_roll",{ascending:!1,nullsLast:!0}).order("created_at",{ascending:!0});if(t)throw console.error("Error fetching encounter combatants:",t),t;return a||[]}async function vi(s){const{data:a,error:t}=await H.from("encounters").select("*").eq("party_id",s).order("created_at",{ascending:!1}).limit(1).single();if(t&&t.code!=="PGRST116")throw t;return a}async function wi(s,a,t){const{data:r,error:n}=await H.from("encounters").insert({party_id:s,name:a,description:t,status:"planning",log:[]}).select().single();if(n)throw n;return r}async function Ni(s,a){const{data:t,error:r}=await H.rpc("duplicate_encounter_with_combatants",{p_encounter_id:s,p_new_name:a});if(r)throw r;return t}async function ki(s){const{data:a,error:t}=await H.rpc("add_character_to_encounter",{p_encounter_id:s.encounterId,p_character_id:s.characterId,p_initiative_roll:s.initiativeRoll});if(t)throw t;return a}async function Si(s){const{data:a,error:t}=await H.rpc("add_monster_to_encounter",{p_encounter_id:s.encounterId,p_monster_id:s.monsterId,p_custom_name:s.customName,p_initiative_roll:s.initiativeRoll});if(t)throw t;return a}async function jt(s,a){const{data:t,error:r}=await H.from("encounters").update(a).eq("id",s).select().single();if(r)throw r;return t}async function lt(s,a){const{data:t,error:r}=await H.from("encounter_combatants").update(a).eq("id",s).select().single();if(r)throw r;return t}async function Ci(s,a){const{error:t}=await H.rpc("append_to_log",{p_encounter_id:s,p_log_entry:a});if(t)throw t}const _i=s=>jt(s,{status:"active",current_round:1}),Ei=s=>jt(s,{status:"completed"}),Ai=async s=>{const{data:a}=await H.from("encounters").select("current_round").eq("id",s).single();if(!a)throw new Error("Encounter not found");return jt(s,{current_round:(a.current_round??0)+1})};async function Mi(s){const{error:a}=await H.from("encounters").delete().eq("id",s);if(a)throw a}async function Li(s){const{error:a}=await H.from("encounter_combatants").delete().eq("id",s);if(a)throw a}async function Ri(s,a){const{data:t,error:r}=await H.rpc("swap_combatant_initiative",{p_combatant_id_1:s,p_combatant_id_2:a});if(r)throw r;return t}const Se=cr((s,a)=>({character:null,isLoading:!0,isSaving:!1,error:null,saveError:null,markedSkillsThisSession:new Set,allGameItems:[],isLoadingGameItems:!1,allHeroicAbilities:[],isLoadingAbilities:!1,activeStatusMessage:null,statusMessageTimeoutId:null,activeEncounter:null,currentCombatant:null,encounterCombatants:[],isLoadingEncounter:!1,encounterError:null,fetchCharacter:async(t,r)=>{s({isLoading:!0,error:null});try{await Promise.all([a()._loadGameItems(),a()._loadAllHeroicAbilities()]);const n=await pi(t,r);if(!n)throw new Error(`Character with ID ${t} not found.`);s({character:n,isLoading:!1}),n!=null&&n.party_id?a().fetchActiveEncounter(n.party_id,n.id):a().clearActiveEncounter()}catch(n){const l=n instanceof Error?n.message:"Failed to fetch character";s({error:l,isLoading:!1})}},fetchActiveEncounter:async(t,r)=>{s({isLoadingEncounter:!0});try{const n=await vi(t);if(n&&n.status==="active"){const l=await Hr(n.id),o=l.find(x=>x.character_id===r),c=l.sort((x,g)=>(x.initiative_roll??100)-(g.initiative_roll??100));s({activeEncounter:n,currentCombatant:o??null,encounterCombatants:c})}else a().clearActiveEncounter()}catch(n){const l=n instanceof Error?n.message:"Failed to fetch encounter";s({encounterError:l})}finally{s({isLoadingEncounter:!1})}},setCharacter:t=>{s({character:t}),!t||!t.party_id?a().clearActiveEncounter():a().fetchActiveEncounter(t.party_id,t.id)},_saveCharacter:async t=>{var n;const r=(n=a().character)==null?void 0:n.id;if(!r){const l="Cannot save: Character ID is missing.";throw s({saveError:l}),new Error(l)}s({isSaving:!0,saveError:null});try{await Or(r,t),s(l=>l.character?{character:{...l.character,...t,updated_at:new Date().toISOString()},isSaving:!1}:{})}catch(l){const o=l instanceof Error?l.message:"Failed to save character";throw s({saveError:o,isSaving:!1}),l}},_loadGameItems:async()=>{if(!(a().isLoadingGameItems||a().allGameItems.length>0)){s({isLoadingGameItems:!0});try{const t=await Ys();s({allGameItems:t,isLoadingGameItems:!1})}catch(t){const r=t instanceof Error?t.message:"Failed to load game items";s({isLoadingGameItems:!1,error:r})}}},_loadAllHeroicAbilities:async()=>{if(!(a().isLoadingAbilities||a().allHeroicAbilities.length>0)){s({isLoadingAbilities:!0});try{const{data:t,error:r}=await H.from("heroic_abilities").select("*").order("name");if(r)throw r;s({allHeroicAbilities:t||[],isLoadingAbilities:!1})}catch(t){const r=t instanceof Error?t.message:"Failed to load heroic abilities";s({isLoadingAbilities:!1,error:r})}}},updateCharacterData:async t=>a()._saveCharacter(t),adjustStat:async(t,r)=>{const n=a().character;if(n){if(t==="current_hp"){const l=n.current_hp??0,o=n.max_hp??10,c=Math.max(0,Math.min(o,l+r));if(c!==l){const x={current_hp:c};l<=0&&c>0&&(x.death_rolls_passed=0,x.death_rolls_failed=0,x.is_rallied=!1),await a()._saveCharacter(x)}}else if(t==="current_wp"){const l=n.current_wp??0,o=n.max_wp??10,c=Math.max(0,Math.min(o,l+r));c!==l&&await a()._saveCharacter({current_wp:c})}}},toggleCondition:async t=>{const r=a().character;if(!r)return;const n=r.conditions??{exhausted:!1,sickly:!1,dazed:!1,angry:!1,scared:!1,disheartened:!1},l={...n,[t]:!n[t]};await a()._saveCharacter({conditions:l})},performRest:async(t,r)=>{const n=a().character;if(!n)return;const l={},o=n.current_hp??0,c=n.max_hp??10,x=n.current_wp??0,g=n.max_wp??10,m=()=>Math.floor(Math.random()*6)+1;if(t==="round")l.current_wp=Math.min(g,x+m());else if(t==="stretch"){if(o<=0){a().setActiveStatusMessage("Cannot take Stretch Rest while dying.",3e3);return}const b=r?m()+m():m();l.current_hp=Math.min(c,o+b),l.current_wp=Math.min(g,x+m());const h={...n.conditions??{}};for(const d of Object.keys(h))if(h[d]===!0){h[d]=!1,l.conditions=h;break}}else t==="shift"&&(l.current_hp=c,l.current_wp=g,l.conditions={exhausted:!1,sickly:!1,dazed:!1,angry:!1,scared:!1,disheartened:!1},l.death_rolls_failed=0,l.death_rolls_passed=0,l.is_rallied=!1);Object.keys(l).length>0&&await a()._saveCharacter(l)},setDeathRollState:async(t,r,n)=>{const l={death_rolls_passed:t,death_rolls_failed:r};n!==void 0&&(l.is_rallied=n),await a()._saveCharacter(l)},updateAttribute:async(t,r)=>{const n=a().character;if(!n)return;const o={attributes:{...n.attributes||{},[t]:r}};t==="CON"&&n.max_hp==null&&(o.max_hp=r,o.current_hp=Math.min(n.current_hp??0,r)),t==="WIL"&&n.max_wp==null&&(o.max_wp=r,o.current_wp=Math.min(n.current_wp??0,r)),await a()._saveCharacter(o)},updateCurrentHP:async t=>{var n;const r=((n=a().character)==null?void 0:n.max_hp)??10;if(t>r){console.warn("Attempted to set current_hp higher than max_hp. Operation blocked.");return}await a()._saveCharacter({current_hp:t})},updateWillpowerPoints:async t=>{var n;const r=((n=a().character)==null?void 0:n.max_wp)??10;if(t>r){console.warn("Attempted to set current_wp higher than max_wp. Operation blocked.");return}await a()._saveCharacter({current_wp:t})},updateConditions:async t=>a()._saveCharacter({conditions:t}),updateInventory:async t=>{var r;return a()._saveCharacter({equipment:{...(r=a().character)==null?void 0:r.equipment,inventory:t}})},updateEquipped:async t=>{var r;return a()._saveCharacter({equipment:{...(r=a().character)==null?void 0:r.equipment,equipped:t}})},updateMoney:async t=>{var r;return a()._saveCharacter({equipment:{...(r=a().character)==null?void 0:r.equipment,money:t}})},updateNotes:async t=>a()._saveCharacter({notes:t}),updateExperience:async t=>a()._saveCharacter({experience:t}),updateReputation:async t=>a()._saveCharacter({reputation:t}),updateCorruption:async t=>a()._saveCharacter({corruption:t}),updateAppearance:async t=>a()._saveCharacter({appearance:t}),updateDeathRolls:async(t,r)=>{const n=a().character;n&&(t==="failed"?await a().setDeathRollState(n.death_rolls_passed??0,r,n.is_rallied):await a().setDeathRollState(r,n.death_rolls_failed??0,n.is_rallied))},updateSkillLevel:async(t,r)=>{const n=a().character;if(!n)return;const o={...n.skill_levels||{},[t]:r};await a()._saveCharacter({skill_levels:o})},increaseSkillLevel:async t=>{var x;const r=a().character;if(!r)return;const n=r.skill_levels||{},l=n[t]??0;if(l>=18)return;const o=Math.min(l+1,18),c={skill_levels:{...n,[t]:o}};((x=r.teacher)==null?void 0:x.skillUnderStudy)===t&&(c.teacher=null),await a()._saveCharacter(c)},addHeroicAbility:async t=>{const r=a().character;if(!r)return;const n=r.heroic_abilities||[];await a()._saveCharacter({heroic_abilities:[...n,t]})},increaseMaxStat:async(t,r)=>{const n=a().character;if(!(n!=null&&n.id))throw new Error("Character ID not found for RPC call.");s({isSaving:!0,saveError:null});try{const{error:l}=await H.rpc("increase_character_max_stat",{character_id_input:n.id,stat_name:t,amount_increase:r});if(l)throw new Error(`PostgreSQL Function Error: ${l.message}`);s({isSaving:!1})}catch(l){const o=l instanceof Error?l.message:"A failure occurred in increaseMaxStat";throw s({saveError:o,isSaving:!1}),l}},learnSpell:async t=>{const{character:r,_saveCharacter:n}=a();if(!r)throw new Error("Cannot learn spell: No active character.");if(!t||typeof t.name!="string")throw console.error("learnSpell was called with an invalid object:",t),new Error("Invalid spell data provided.");const l=JSON.parse(JSON.stringify(r.spells??{}));l.school||(l.school={name:null,spells:[]}),l.school.spells||(l.school.spells=[]),l.general||(l.general=[]);let o=!1;if(t.school_id){const c=l.school.spells;c.includes(t.name)||(c.push(t.name),o=!0)}else{const c=l.general;c.includes(t.name)||(c.push(t.name),o=!0)}o&&(await n({spells:l}),s(c=>({character:c.character?{...c.character,spells:l}:null})))},addMagicSchool:async(t,r)=>{const n=a().character;if(!n)return;const o={skill_levels:{...n.skill_levels,[t.name]:r}};n.magic_school||(o.magic_school=t.id),await a()._saveCharacter(o)},setSkillUnderStudy:async t=>{await a()._saveCharacter({teacher:t?{skillUnderStudy:t}:null})},markSkillThisSession:t=>{s(r=>({markedSkillsThisSession:new Set(r.markedSkillsThisSession).add(t)}))},clearMarkedSkillsThisSession:()=>s({markedSkillsThisSession:new Set}),setActiveStatusMessage:(t,r=3e4)=>{clearTimeout(a().statusMessageTimeoutId),s({activeStatusMessage:t});const n=setTimeout(()=>{s({activeStatusMessage:null,statusMessageTimeoutId:null})},r);s({statusMessageTimeoutId:n})},clearActiveStatusMessage:()=>{clearTimeout(a().statusMessageTimeoutId),s({activeStatusMessage:null,statusMessageTimeoutId:null})},drawInitiative:async()=>{const{currentCombatant:t}=a();if(t){const r=Math.floor(Math.random()*10)+1;await a().setInitiativeForCombatant(t.id,r)}},setInitiativeForCombatant:async(t,r)=>{s({isSaving:!0,saveError:null});try{await lt(t,{initiative_roll:r}),a().setActiveStatusMessage(`Initiative set to ${r}`,4e3)}catch(n){const l=n instanceof Error?n.message:"Failed to set initiative";s({saveError:l})}finally{s({isSaving:!1})}},clearActiveEncounter:()=>{s({activeEncounter:null,currentCombatant:null,isLoadingEncounter:!1,encounterError:null,encounterCombatants:[]})}})),Ti=[{kin:"Human",movement:10},{kin:"Halfling",movement:8},{kin:"Dwarf",movement:8},{kin:"Elf",movement:10},{kin:"Mallard",movement:8},{kin:"Wolfkin",movement:12}];function Ii(s,a){var n;const t=((n=Ti.find(l=>l.kin===s))==null?void 0:n.movement)||10;let r=0;return a<=6?r=-4:a<=9?r=-2:a<=12?r=0:a<=15?r=2:r=4,t+r}const At={Acrobatics:"AGL",Awareness:"INT",Bartering:"CHA","Beast Lore":"INT",Bluffing:"CHA",Bushcraft:"INT",Crafting:"STR",Evade:"AGL",Healing:"INT","Hunting & Fishing":"AGL",Languages:"INT","Myths & Legends":"INT",Performance:"CHA",Persuasion:"CHA",Riding:"AGL",Seamanship:"INT","Sleight of Hand":"AGL",Sneaking:"AGL","Spot Hidden":"INT",Swimming:"AGL",Axes:"STR",Bows:"AGL",Brawling:"STR",Crossbows:"AGL",Hammers:"STR",Knives:"AGL",Slings:"AGL",Spears:"STR",Staves:"AGL",Swords:"STR",Mentalism:"WIL",Animism:"WIL",Elementalism:"WIL"},Wa=["Acrobatics","Awareness","Bartering","Beast Lore","Bluffing","Bushcraft","Crafting","Evade","Healing","Hunting & Fishing","Languages","Myths & Legends","Performance","Persuasion","Riding","Seamanship","Sleight of Hand","Sneaking","Spot Hidden","Swimming"],Ka=["Axes","Bows","Brawling","Crossbows","Hammers","Knives","Slings","Spears","Staves","Swords"],Di=s=>s<=5?3:s<=8?4:s<=12?5:s<=15?6:7,Pi=(s,a,t)=>{var o,c;const r=((o=s.trainedSkills)==null?void 0:o.includes(a))??!1,n=((c=s.attributes)==null?void 0:c[t])??10,l=Di(n);return r?l*2:l};function qi({onClose:s}){const{toggleDiceRoller:a}=ze(),{character:t,updateCharacterData:r,markSkillThisSession:n}=Se(),[l,o]=i.useState({}),[c,x]=i.useState(!0),[g,m]=i.useState(null),[b,p]=i.useState(null),[h,d]=i.useState(new Set((t==null?void 0:t.marked_skills)||[]));i.useEffect(()=>{(async()=>{x(!0);const{data:w}=await H.from("game_skills").select("name, description");if(w){const L=w.reduce((E,P)=>(E[P.name]={description:P.description},E),{});o(L)}x(!1)})()},[]);const v=i.useMemo(()=>Wa.map(y=>({name:y,attr:At[y]})).sort((y,w)=>y.name.localeCompare(w.name)),[]),f=i.useMemo(()=>Ka.map(y=>({name:y,attr:At[y]})).sort((y,w)=>y.name.localeCompare(w.name)),[]),u=i.useMemo(()=>t!=null&&t.skill_levels?Object.keys(t.skill_levels).filter(L=>!Wa.includes(L)&&!Ka.includes(L)).map(L=>({name:L,attr:At[L]})).sort((L,E)=>L.name.localeCompare(E.name)):[],[t==null?void 0:t.skill_levels]);if(!t)return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg p-6",children:e.jsx(oe,{})})});const N=y=>({STR:"exhausted",CON:"sickly",AGL:"dazed",INT:"angry",WIL:"scared",CHA:"disheartened"})[y],S=(y,w,L)=>{a({initialDice:["d20"],rollMode:"skillCheck",targetValue:w,description:`${y} Check`,requiresBane:L,skillName:y}),s()},A=(y,w)=>{const L=y.currentTarget.getBoundingClientRect();m(w),p({top:L.top,left:L.left+L.width/2})},j=()=>{m(null),p(null)},q=(y,w)=>{y.stopPropagation(),g===w?j():A(y,w)},C=(y,w)=>{y.stopPropagation();const L=new Set(h);y.target.checked?(L.add(w),n(w)):L.delete(w),d(L),r({marked_skills:Array.from(L)})},_=y=>{var O,z,F,U;const w=((O=t.trainedSkills)==null?void 0:O.includes(y.name))??!1,L=((z=t.skill_levels)==null?void 0:z[y.name])??Pi(t,y.name,y.attr),E=N(y.attr),P=((F=t.conditions)==null?void 0:F[E])??!1,k=(U=l[y.name])==null?void 0:U.description,R=h.has(y.name);return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded cursor-pointer transition-colors ${P?"bg-red-50 hover:bg-red-100 ring-1 ring-red-200":"hover:bg-gray-100"}`,onClick:()=>S(y.name,L,P),title:`Click to roll ${y.name} (Target  ${L}${P?", Bane":""})`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:T=>C(T,y.name),onClick:T=>T.stopPropagation(),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500",title:"Mark this skill for advancement"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:`${w?"font-bold":""} ${P?"text-red-700":"text-gray-800"}`,children:y.name}),k&&e.jsx("div",{className:"flex items-center ml-2 p-1",onClick:T=>q(T,k),onMouseEnter:T=>A(T,k),onMouseLeave:j,children:e.jsx(Xe,{className:"w-4 h-4 text-blue-500"})}),e.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["(",y.attr,")"]}),P&&e.jsx("span",{className:"text-xs text-red-600 font-semibold ml-2",children:"(Bane)"})]})]}),e.jsxs("span",{className:`font-medium text-sm ${P?"text-red-700":"text-gray-600"}`,children:["Target: ",L]})]},y.name)};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:j,children:[e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-xl",onClick:y=>y.stopPropagation(),children:[e.jsxs("div",{className:"p-6 border-b bg-white flex-shrink-0",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Skills (D20 Check)"}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Click a skill to roll a D20 check. Roll  Skill Level for success. Trained skills are bolded."}),e.jsxs("div",{className:"mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 flex items-start gap-2",children:[e.jsx(Ws,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{children:"When you have rolled a Dragon (1) or a Demon (20) when using a skill, tick the checkbox next to that skill."})]})]}),c?e.jsx("div",{className:"flex-grow flex items-center justify-center",children:e.jsx(oe,{})}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 p-4 pt-2 overflow-y-auto flex-grow",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-0 text-gray-700 sticky top-0 bg-white",children:"General Skills"}),e.jsx("div",{className:"space-y-0.5",children:v.map(_)})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-0 text-gray-700 sticky top-0 bg-white",children:"Weapon Skills"}),e.jsx("div",{className:"space-y-0.5",children:f.map(_)})]}),u.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-0 text-gray-700 sticky top-0 bg-white",children:"Secondary Skills"}),e.jsx("div",{className:"space-y-0.5",children:u.map(_)})]})]})]}),e.jsx("div",{className:"p-4 border-t bg-white flex justify-end",children:e.jsx(M,{variant:"outline",onClick:s,children:"Close"})})]}),g&&b&&e.jsx("div",{style:{top:`${b.top}px`,left:`${b.left}px`},className:"fixed -translate-x-1/2 -translate-y-full mb-2 w-72 p-3 bg-gray-800 text-white text-sm rounded-lg shadow-lg z-[60] pointer-events-none",children:e.jsx("p",{children:g})})]})}function Fi(s){var b,p;const[a,t]=i.useState([]),[r,n]=i.useState(!0),[l,o]=i.useState(null),c=Se(h=>h.character),x=i.useMemo(()=>{if(!(c!=null&&c.spells))return[];let h=[];if(c.spells.general&&(Array.isArray(c.spells.general)?h=h.concat(c.spells.general):console.warn("[useSpells] character.spells.general is not an array:",c.spells.general)),c.spells.school&&c.spells.school.spells){const d=c.spells.school.spells;Array.isArray(d)?h=h.concat(d):console.warn("[useSpells] character.spells.school.spells is not an array:",d)}return Array.from(new Set(h))},[c==null?void 0:c.spells]);i.useEffect(()=>{if(!s||x.length===0){n(!1),t([]);return}async function h(){n(!0),o(null);try{const{data:d,error:v}=await H.from("game_spells").select(`
            *,
            power_level,
						dice,
            magic_schools ( name )
          `).in("name",x).order("rank",{ascending:!0}).order("name",{ascending:!0});if(v)throw v;t(d||[])}catch(d){console.error("Error loading learned spell details:",d),o(d instanceof Error?d.message:"Failed to load spell details"),t([])}finally{n(!1)}}h()},[s,x]);const g=i.useMemo(()=>a.map(h=>({id:h.id,name:h.name,schoolId:h.school_id,rank:h.rank,requirement:h.requirement,castingTime:h.casting_time,range:h.range,duration:h.duration,description:h.description,willpowerCost:h.willpower_cost,createdAt:h.created_at,powerLevel:h.power_level,dice:h.dice})),[a]),m=i.useMemo(()=>{var h,d;return((d=(h=c==null?void 0:c.spells)==null?void 0:h.school)==null?void 0:d.name)??null},[(p=(b=c==null?void 0:c.spells)==null?void 0:b.school)==null?void 0:p.name]);return{learnedSpells:g,characterSchoolName:m,loading:r,error:l}}const Va={Word:"The spell is activated with a chant or power word.",Gesture:"The spell is activated by making specific hand movements.",Focus:"The spell is activated with an item held in your hand.",Ingredient:"The spell is activated using a certain ingredient."},$i={Instant:"The effect occurs instantly and has no lasting effect.",Round:"The effect lasts until your turn in the next round.",Stretch:"The effect lasts for one stretch of time (15 mins).",Shift:"The effect lasts until the end of the current shift (6 hours).",Concentration:"The effect ceases if you perform another action, take damage, or fail a WIL roll."},Oi=s=>["d4","d6","d8","d10","d12","d20"].includes(s.toLowerCase()),Ya=(s,a)=>{if(!s)return{display:"",roller:[]};const t=s.trim().match(/(\d+)?d(\d+)/i);if(!t)return{display:s,roller:[]};const r=t[1]?parseInt(t[1],10):1,n=`d${t[2]}`;if(!Oi(n))return{display:s,roller:[]};const l=r+(a-1),o=`${l}D${t[2]}`,c=Array(l).fill(n);return{display:o,roller:c}},Br=s=>s<=5?3:s<=8?4:s<=12?5:s<=15?6:7,zi=(s,a)=>{var o,c;const t="WIL",r=((o=s.trainedSkills)==null?void 0:o.includes(a))??!1,n=((c=s.attributes)==null?void 0:c[t])??10,l=Br(n);return r?l*2:l},Hi=({spell:s,onClose:a})=>{if(!s)return null;const t=Object.keys(Va).filter(r=>{var n;return(n=s.requirement)==null?void 0:n.includes(r)});return e.jsxs("div",{className:"fixed inset-0 z-[60] overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto",onClick:a}),e.jsxs("div",{className:"absolute inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl flex flex-col pointer-events-auto border-l border-stone-200 animate-in slide-in-from-right duration-300",children:[e.jsxs("div",{className:"p-6 border-b bg-stone-50 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold uppercase tracking-wider text-stone-500 mb-1",children:"Spell Details"}),e.jsx("h3",{className:"text-2xl font-serif font-bold text-stone-900 leading-none",children:s.name})]}),e.jsx("button",{onClick:a,className:"text-stone-400 hover:text-stone-600 transition-colors",children:e.jsx(xe,{size:24})})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto p-6 space-y-6 bg-white",children:[e.jsx("div",{className:"prose prose-stone prose-sm max-w-none text-stone-600 leading-relaxed italic border-l-4 border-stone-300 pl-4",children:s.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"p-3 bg-stone-50 rounded border border-stone-100",children:[e.jsx("span",{className:"block text-xs font-bold text-stone-400 uppercase",children:"Rank"}),e.jsx("span",{className:"font-medium text-stone-800",children:s.rank===0?"Trick":`Rank ${s.rank}`})]}),e.jsxs("div",{className:"p-3 bg-stone-50 rounded border border-stone-100",children:[e.jsx("span",{className:"block text-xs font-bold text-stone-400 uppercase",children:"Cost"}),e.jsxs("span",{className:"font-medium text-stone-800",children:[s.willpowerCost," WP"]})]}),e.jsxs("div",{className:"p-3 bg-stone-50 rounded border border-stone-100",children:[e.jsx("span",{className:"block text-xs font-bold text-stone-400 uppercase",children:"Time"}),e.jsx("span",{className:"font-medium text-stone-800",children:s.castingTime})]}),e.jsxs("div",{className:"p-3 bg-stone-50 rounded border border-stone-100",children:[e.jsx("span",{className:"block text-xs font-bold text-stone-400 uppercase",children:"Range"}),e.jsx("span",{className:"font-medium text-stone-800",children:s.range})]}),s.dice&&e.jsxs("div",{className:"col-span-2 p-3 bg-purple-50 rounded border border-purple-100",children:[e.jsx("span",{className:"block text-xs font-bold text-purple-400 uppercase",children:"Damage / Effect"}),e.jsxs("span",{className:"font-bold text-purple-800 flex items-center gap-2",children:[e.jsx(be,{size:14})," ",s.dice]})]})]}),s.requirement&&e.jsxs("div",{className:"bg-amber-50 border border-amber-100 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-xs font-bold text-amber-800 uppercase mb-3 flex items-center gap-2",children:[e.jsx(he,{size:14})," Requirements"]}),e.jsx("div",{className:"space-y-2 text-sm text-amber-900",children:t.length>0?t.map(r=>{let n=Va[r];if(r==="Ingredient"&&s.requirement){const l=s.requirement.match(/Ingredient\s*\(([^)]+)\)/i);l&&l[1]&&(n=`Requires: ${l[1]}.`)}return e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsxs("span",{className:"font-bold whitespace-nowrap",children:[r,":"]}),e.jsx("span",{className:"opacity-90",children:n})]},r)}):e.jsx("p",{children:s.requirement})})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-100 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-xs font-bold text-blue-800 uppercase mb-1 flex items-center gap-2",children:[e.jsx(xt,{size:14})," Duration: ",s.duration]}),e.jsx("p",{className:"text-xs text-blue-700 opacity-90",children:$i[s.duration]||"See description."})]})]})]})]})};function Bi({onClose:s}){var T;const[a,t]=i.useState(null),[r,n]=i.useState(null),[l,o]=i.useState(null),[c,x]=i.useState("prepared"),[g,m]=i.useState("all"),[b,p]=i.useState(null),{toggleDiceRoller:h}=ze(),{character:d,updateCharacterData:v,isSaving:f,setActiveStatusMessage:u}=Se(),{learnedSpells:N,loading:S}=Fi(d==null?void 0:d.id),A=((T=d==null?void 0:d.attributes)==null?void 0:T.INT)??10,j=Br(A),q=i.useMemo(()=>new Set((d==null?void 0:d.prepared_spells)??[]),[d==null?void 0:d.prepared_spells]),C=i.useMemo(()=>N.filter(I=>I.rank>0&&q.has(I.id)).length,[N,q]),_=C<j,{preparedSpellsList:y,grimoireSpellsList:w}=i.useMemo(()=>{const I=N.filter(D=>D.rank===0),B=N.filter(D=>D.rank>0&&q.has(D.id)),Y=[...I,...B].sort((D,G)=>D.rank-G.rank||D.name.localeCompare(G.name)),Q=N.filter(D=>D.rank>0).sort((D,G)=>D.rank-G.rank||D.name.localeCompare(G.name));return{preparedSpellsList:Y,grimoireSpellsList:Q}},[N,q]),L=i.useMemo(()=>Array.from(new Set(N.map(I=>I.rank))).sort((I,B)=>I-B),[N]),E=i.useMemo(()=>{const I=c==="prepared"?y:w;return g==="all"?I:I.filter(B=>B.rank===g)},[c,y,w,g]),{actualMagicSkillName:P,magicSkillValue:k,isMagicSkillAffected:R}=i.useMemo(()=>{var G;if(!d)return{actualMagicSkillName:null,magicSkillValue:null,isMagicSkillAffected:!1};const I=["Animism","Elementalism","Mentalism","Symbolism"],B=d.skill_levels||{},Y=d.trainedSkills||[],Q=new Set([...Y,...Object.keys(B)]);let D=I.find($=>Q.has($));if(!D&&Q.has("General Magic")&&(D="General Magic"),D){const $=B[D],Z=$!==void 0?$:zi(d,D),ee=((G=d.conditions)==null?void 0:G.scared)??!1;return{actualMagicSkillName:D,magicSkillValue:Z,isMagicSkillAffected:ee}}return{actualMagicSkillName:null,magicSkillValue:null,isMagicSkillAffected:!1}},[d]);if(!d)return null;const O=async(I,B)=>{if(n(null),!d)return;const Y=d.prepared_spells??[];let Q;if(B)Q=Y.filter(D=>D!==I);else{if(!_){n(`Limit reached (${j}).`);return}Q=[...Y,I]}try{await v({prepared_spells:Q})}catch(D){n(D instanceof Error?D.message:"Failed.")}},z=async(I,B,Y)=>{o(I.id),t(null);try{const Q=d.current_wp??d.attributes.WIL,D=Number(I.willpowerCost??0),G=I.powerLevel==="yes",$=G?D+(B-1)*2:D;if(Q<$)throw new Error(`Need ${$} WP`);await v({current_wp:Q-$});let Z=`Casted ${I.name}${G?` (Lvl ${B})`:""} for ${$} WP.`;if(Y&&(Z+=" (Double time)"),u(Z),I.dice){const ee=Ya(I.dice,B);ee.roller.length>0&&setTimeout(()=>{h({initialDice:ee.roller,description:`Casting ${I.name} (Level ${B})`,rollMode:"generic"})},100)}}catch(Q){t(Q instanceof Error?Q.message:"Failed.")}finally{o(null)}},F=()=>{!P||k===null||h({initialDice:["d20"],rollMode:"skillCheck",targetValue:k,description:`${P} Check`,requiresBane:R,skillName:P})},U=({spell:I})=>{const B=q.has(I.id),Y=I.rank===0,Q=I.powerLevel==="yes",[D,G]=i.useState(1),$=Number(I.willpowerCost??0),Z=Q?$+(D-1)*2:$,ee=(d.current_wp??d.attributes.WIL)<Z,re=I.castingTime==="Reaction",K=Ya(I.dice,D),W=se=>G(le=>Math.max(1,Math.min(3,le+se)));return e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center p-4 border-b border-stone-100 hover:bg-stone-50 transition-colors group",children:[e.jsx("div",{className:"mr-4 hidden sm:flex flex-col items-center justify-center w-12 h-12 bg-stone-100 rounded-lg text-stone-500",children:Y?e.jsx(Es,{size:20}):e.jsx("span",{className:"font-serif font-bold text-lg",children:I.rank})}),e.jsxs("div",{className:"flex-grow min-w-0 cursor-pointer",onClick:()=>p(I),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-bold text-stone-800 group-hover:text-indigo-700 transition-colors truncate",children:I.name}),re&&e.jsx("span",{className:"text-[10px] font-bold uppercase bg-amber-100 text-amber-800 px-1.5 rounded",children:"Reaction"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-stone-500",children:[e.jsxs("div",{className:"flex items-center gap-1",title:"Casting Time",children:[e.jsx(xt,{size:12})," ",I.castingTime]}),e.jsxs("div",{className:"flex items-center gap-1",title:"Range",children:[e.jsx(ct,{size:12})," ",I.range]}),e.jsxs("div",{className:"flex items-center gap-1 font-medium text-indigo-600",children:[e.jsx(Pe,{size:12})," ",Z," WP"]}),I.dice&&e.jsxs("span",{className:"flex items-center gap-1 font-bold text-purple-600 bg-purple-50 px-1.5 rounded",children:[e.jsx(be,{size:12})," ",K.display]})]})]}),e.jsxs("div",{className:"mt-3 sm:mt-0 flex items-center gap-3 sm:border-l sm:border-stone-200 sm:pl-4",children:[c==="grimoire"&&e.jsx("button",{onClick:se=>{se.stopPropagation(),O(I.id,B)},disabled:!B&&!_||f,className:`p-2 rounded-lg transition-all ${B?"bg-blue-100 text-blue-700":"text-stone-300 hover:bg-stone-100 hover:text-stone-500"}`,title:B?"Unprepare":"Prepare Spell",children:B?e.jsx(Ws,{size:20}):e.jsx(Gt,{size:20})}),e.jsxs("div",{className:"flex items-center bg-stone-100 rounded-lg p-0.5 shadow-inner",children:[Q&&e.jsx("button",{disabled:D<=1,onClick:se=>{se.stopPropagation(),W(-1)},className:"p-1 text-stone-400 hover:text-stone-700 disabled:opacity-30",children:e.jsx(Wt,{size:14})}),e.jsx("button",{onClick:se=>{se.stopPropagation(),z(I,D,c==="grimoire")},disabled:!!l||f||ee||re&&c==="grimoire",className:`
                    px-3 py-1.5 text-xs font-bold uppercase rounded-md shadow-sm transition-all min-w-[70px] flex items-center justify-center gap-1.5
                    ${ee?"bg-stone-200 text-stone-400 cursor-not-allowed":"bg-white text-indigo-600 hover:bg-indigo-50 hover:text-indigo-700 border border-indigo-100"}
                  `,children:l===I.id?e.jsx(oe,{size:"sm"}):e.jsxs(e.Fragment,{children:[I.dice&&e.jsx(be,{size:12}),Q?`Lvl ${D}`:"Cast"]})}),Q&&e.jsx("button",{disabled:D>=3,onClick:se=>{se.stopPropagation(),W(1)},className:"p-1 text-stone-400 hover:text-stone-700 disabled:opacity-30",children:e.jsx(ye,{size:14})})]})]})]})};return S?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:e.jsx(oe,{size:"lg"})}):e.jsxs("div",{className:"fixed inset-0 z-40 flex items-center justify-center p-4 sm:p-6",children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:s}),e.jsxs("div",{className:"relative bg-white w-full max-w-4xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden border border-stone-200 animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"p-6 border-b border-stone-200 bg-stone-50 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-serif font-bold text-stone-900 flex items-center gap-2",children:[e.jsx(Es,{className:"text-purple-600"})," Spellbook"]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-stone-600",children:[e.jsxs("div",{className:"flex items-center gap-1 bg-white px-2 py-1 rounded border border-stone-200 shadow-sm",children:[e.jsx(Pe,{size:14,className:"text-indigo-500"}),e.jsx("span",{className:"font-bold",children:d.current_wp??d.attributes.WIL}),e.jsx("span",{className:"text-stone-400",children:"/"}),e.jsxs("span",{children:[d.attributes.WIL," WP"]})]}),P&&e.jsxs("button",{onClick:F,className:`flex items-center gap-1 px-2 py-1 rounded border shadow-sm transition-colors ${R?"bg-red-50 border-red-200 text-red-700 hover:bg-red-100":"bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100"}`,children:[e.jsx(be,{size:14}),e.jsx("span",{className:"font-bold",children:P}),e.jsx("span",{className:"bg-white/50 px-1.5 rounded text-xs",children:k})]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-stone-200 rounded-full text-stone-400 transition-colors",children:e.jsx(xe,{})})]}),(a||r)&&e.jsx("div",{className:`px-6 py-2 text-xs font-bold text-center ${a?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}`,children:a||r}),e.jsxs("div",{className:"bg-white px-6 py-2 border-b border-stone-200 flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex gap-1 bg-stone-100 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>x("prepared"),className:`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${c==="prepared"?"bg-white text-indigo-600 shadow-sm":"text-stone-500 hover:text-stone-700"}`,children:["Prepared (",y.length,")"]}),e.jsxs("button",{onClick:()=>x("grimoire"),className:`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${c==="grimoire"?"bg-white text-indigo-600 shadow-sm":"text-stone-500 hover:text-stone-700"}`,children:["Grimoire (",w.length,")"]})]}),L.length>0&&e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto no-scrollbar",children:[e.jsx(Ks,{size:14,className:"text-stone-400"}),e.jsx("button",{onClick:()=>m("all"),className:`text-xs px-2 py-1 rounded border ${g==="all"?"bg-stone-800 text-white border-stone-800":"bg-white text-stone-600 border-stone-200 hover:border-stone-300"}`,children:"All"}),L.map(I=>e.jsx("button",{onClick:()=>m(I),className:`text-xs px-2 py-1 rounded border ${g===I?"bg-stone-800 text-white border-stone-800":"bg-white text-stone-600 border-stone-200 hover:border-stone-300"}`,children:I===0?"T":`R${I}`},I))]})]}),e.jsx("div",{className:"flex-grow overflow-y-auto bg-stone-50/30",children:E.length>0?e.jsx("div",{className:"divide-y divide-stone-100",children:E.map(I=>e.jsx(U,{spell:I},I.id))}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-stone-400",children:[e.jsx(Je,{size:48,className:"mb-4 opacity-20"}),e.jsx("p",{children:"No spells found."})]})}),e.jsxs("div",{className:"p-3 border-t bg-stone-50 text-center text-xs text-stone-400 font-medium",children:["Prep Limit: ",C," / ",j,"  Tricks don't count against limit"]})]}),e.jsx(Hi,{spell:b,onClose:()=>p(null)})]})}const Ui=s=>{if(!(s!=null&&s.attributes))return null;let a=s.attributes;if(typeof a=="string")try{a=JSON.parse(a)}catch{return null}return typeof(a==null?void 0:a.STR)=="number"?a.STR:null},Mt=s=>{const a=/^(.*)\s\((\d+)\)$/,t=/^(.*)\s(\d+)\s([a-zA-Z\s]+)$/;let r=s.match(a);return r?{baseName:r[1].trim(),quantity:parseInt(r[2]),unit:null}:(r=s.match(t),r?{baseName:r[1].trim(),quantity:parseInt(r[2]),unit:r[3].trim()}:{baseName:s,quantity:null,unit:null})},Gi=(s,a)=>{var x,g,m;const t=Ui(s),r=typeof s.equipment=="string"?JSON.parse(s.equipment):s.equipment;if(t===null||!r)return{capacity:0,load:0,isEncumbered:!1};const n=b=>a.find(p=>p.name.toLowerCase()===b.toLowerCase());let l=Math.ceil(t/2);[...r.equipped.armor?[r.equipped.armor]:[],...r.equipped.helmet?[r.equipped.helmet]:[],...((x=r.equipped.weapons)==null?void 0:x.map(b=>b.name))||[],...r.equipped.wornClothes||[],...((g=r.equipped.containers)==null?void 0:g.map(b=>b.name))||[],...((m=r.equipped.animals)==null?void 0:m.map(b=>b.name))||[]].forEach(b=>{const p=n(b);p!=null&&p.encumbrance_modifier&&(l+=p.encumbrance_modifier)});let c=0;return(r.inventory||[]).forEach(b=>{const p=typeof b.weight=="number"?b.weight:1;p>0&&(c+=p*(b.quantity||1))}),{capacity:l,load:c,isEncumbered:c>l}},Wi=()=>e.jsxs("div",{className:"p-3 mt-4 border border-orange-300 bg-orange-50 rounded-lg flex items-center gap-3",children:[e.jsx(bs,{className:"w-6 h-6 text-orange-500 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-orange-800",children:"Cannot Calculate Encumbrance"}),e.jsx("p",{className:"text-sm text-orange-700",children:"Character's Strength (STR) value is missing."})]})]}),Ki=({load:s,capacity:a,isEncumbered:t})=>{const r=a>0?s/a*100:0;let n="bg-green-500";return r>=100?n="bg-red-500":r>75&&(n="bg-yellow-500"),e.jsxs("div",{className:"p-3 border rounded-lg bg-white mt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-medium text-sm text-gray-700 flex items-center gap-2",children:[e.jsx(qn,{size:16})," Encumbrance"]}),e.jsxs("span",{className:"font-mono font-semibold text-sm",children:[s," / ",a]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:`${n} h-2.5 rounded-full`,style:{width:`${Math.min(r,100)}%`}})}),t&&e.jsxs("div",{className:"mt-3 p-2 bg-red-50 border border-red-200 rounded-lg text-xs text-red-800 flex items-center gap-2",children:[e.jsx(bs,{size:16}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Over-encumbered:"})," You must make a STR roll to move."]})]})]})},Vi=({onClose:s,currentMoney:a,onUpdateMoney:t})=>{const[r,n]=i.useState(0),[l,o]=i.useState(0),[c,x]=i.useState(0),[g,m]=i.useState(null),b=p=>{if(m(null),r===0&&l===0&&c===0){m("Please enter an amount.");return}const h={gold:(a.gold||0)+r*p,silver:(a.silver||0)+l*p,copper:(a.copper||0)+c*p};if(h.gold<0||h.silver<0||h.copper<0){m("Cannot remove more money than is available.");return}t(da(h)),s()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Manage Money"}),e.jsx("button",{onClick:s,className:"p-1 rounded-full hover:bg-gray-200",children:e.jsx(xe,{size:20})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6 p-4 bg-yellow-50 text-center rounded-lg",children:[e.jsx("p",{className:"text-sm",children:"Current Balance"}),e.jsx("p",{className:"text-2xl font-bold",children:Fr(a)})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-center",children:"Gold"}),e.jsx("input",{type:"number",min:"0",value:r,onChange:p=>n(Math.max(0,parseInt(p.target.value)||0)),className:"w-full p-2 border rounded-lg text-center"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-center",children:"Silver"}),e.jsx("input",{type:"number",min:"0",value:l,onChange:p=>o(Math.max(0,parseInt(p.target.value)||0)),className:"w-full p-2 border rounded-lg text-center"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-center",children:"Copper"}),e.jsx("input",{type:"number",min:"0",value:c,onChange:p=>x(Math.max(0,parseInt(p.target.value)||0)),className:"w-full p-2 border rounded-lg text-center"})]})]}),g&&e.jsx(ie,{message:g}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx(M,{variant:"secondary",className:"w-full",onClick:()=>b(-1),children:"Remove"}),e.jsx(M,{variant:"primary",className:"w-full",onClick:()=>b(1),children:"Add"})]})]})]})})},Yi=s=>`${s.name}${s.quantity>1?` (x${s.quantity})`:""}`,ts=(s,a)=>{const t=s.findIndex(n=>n.name===a.name);let r=[...s];return t>-1?r[t].quantity+=a.quantity:r.push({...a,id:a.id||`item-${Date.now()}`}),r},ps=({icon:s,label:a,value:t})=>t==null||t===""?null:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(s,{className:"w-3.5 h-3.5 flex-shrink-0 text-gray-400"}),e.jsxs("span",{className:"font-medium",children:[a,":"]}),e.jsx("span",{className:"text-gray-800 font-mono",children:String(t)})]}),Qi=({item:s,onBuy:a})=>e.jsxs("div",{className:"flex flex-col p-4 border rounded-lg shadow-sm hover:shadow-lg transition-shadow bg-white",children:[e.jsxs("div",{className:"flex-1 mb-4",children:[e.jsx("h4",{className:"font-bold text-gray-800",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:s.category}),s.effect&&e.jsxs("p",{className:"text-sm text-blue-800 bg-blue-50 p-2 rounded-md mt-2 italic",children:['"',s.effect,'"']})]}),e.jsxs("div",{className:"space-y-1.5 mb-4 text-sm",children:[e.jsx(ps,{icon:ur,label:"Weight",value:s.weight}),e.jsx(ps,{icon:Me,label:"Armor",value:s.armor_rating}),e.jsx(ps,{icon:qe,label:"Damage",value:s.damage}),e.jsx(ps,{icon:ct,label:"Range",value:s.range}),e.jsx(ps,{icon:us,label:"Durability",value:s.durability}),e.jsx(ps,{icon:Ze,label:"Features",value:s.features}),e.jsx(ps,{icon:Pe,label:"Skill",value:s.skill})]}),e.jsxs("div",{className:"flex justify-between items-center mt-auto pt-3 border-t",children:[e.jsx("span",{className:"text-sm font-semibold text-green-800 bg-green-100 px-2.5 py-1 rounded-full",children:s.cost||"N/A"}),e.jsx(M,{variant:"primary",size:"sm",onClick:()=>a(s),disabled:!s.cost,children:"Buy"})]})]}),Qa=["ARMOR & HELMETS","MELEE WEAPONS","RANGED WEAPONS","CLOTHES"],Ji=[{name:"Armor & Weapons",categories:["ARMOR & HELMETS","MELEE WEAPONS","RANGED WEAPONS"],Icon:Me},{name:"Clothing & Accessories",categories:["CLOTHES"],Icon:fs},{name:"Musical & Trade Goods",categories:["MUSICAL INSTRUMENTS","TRADE GOODS"],Icon:_a},{name:"Magic & Studies",categories:["STUDIES & MAGIC"],Icon:ur},{name:"Light & Tools",categories:["LIGHT SOURCES","TOOLS"],Icon:Tn},{name:"Containers & Medicine",categories:["CONTAINERS","MEDICINE"],Icon:fs},{name:"Services",categories:["SERVICES"],Icon:_a},{name:"Hunting & Travel",categories:["HUNTING & FISHING","MEANS OF TRAVEL"],Icon:Dt},{name:"Animals",categories:["ANIMALS"],Icon:Vs}];function Zi({onClose:s}){var k,R,O,z;const[a,t]=i.useState(!0),{character:r,updateCharacterData:n,isSaving:l}=Se(),{data:o=[]}=we({queryKey:["gameItems"],queryFn:Ys,staleTime:1/0}),[c,x]=i.useState("inventory"),[g,m]=i.useState({search:""}),[b,p]=i.useState(null),[h,d]=i.useState(!1),[v,f]=i.useState(null),[u,N]=i.useState("name-asc"),S=i.useMemo(()=>{if(!r)return null;try{const F=typeof r.equipment=="string"?JSON.parse(r.equipment):r.equipment;return F.equipped||(F.equipped={}),["weapons","wornClothes","animals","containers"].forEach(U=>{F.equipped[U]||(F.equipped[U]=[])}),{...r,attributes:typeof r.attributes=="string"?JSON.parse(r.attributes):r.attributes,equipment:F}}catch(F){return console.error("Failed to parse data:",F),r}},[r]),A=F=>o.find(U=>{var T;return((T=U.name)==null?void 0:T.toLowerCase())===F.toLowerCase()||Mt(U.name).baseName.toLowerCase()===Mt(F).baseName.toLowerCase()}),j=i.useMemo(()=>S&&o.length>0?Gi(S,o):{capacity:0,load:0,isEncumbered:!1},[S,o]),q=i.useMemo(()=>(S==null?void 0:S.attributes)&&typeof S.attributes.STR=="number",[S]);if(!S)return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(oe,{})});const C=F=>n({...S,equipment:F}),_=F=>{p(null);const U=A(F.name);if(!U)return;let T=structuredClone(S.equipment),I=T.inventory;const B=I.findIndex(G=>G.id===F.id);if(B===-1)return;const Y={...I[B],quantity:1};I[B].quantity>1?I[B].quantity-=1:I.splice(B,1);const{category:Q,name:D}=U;if(Q==="CLOTHES"){if(T.equipped.wornClothes.includes(D)){p("Already wearing one."),T.inventory=ts(I,Y),C(T);return}T.equipped.wornClothes.push(D)}else if(Qa.includes(Q)){const G=Q!=="ARMOR & HELMETS"||D.toLowerCase().includes("shield"),$=Q==="ARMOR & HELMETS"&&!G;if(G){if(T.equipped.weapons.length>=3){p("Max 3 at hand."),T.inventory=ts(I,Y),C(T);return}const Z={name:U.name,grip:U.grip,range:U.range,damage:U.damage,durability:U.durability,features:U.features};T.equipped.weapons.push(Z)}else $?(T.equipped.armor&&(I=ts(I,{name:T.equipped.armor,quantity:1,id:`item-${Date.now()}`})),T.equipped.armor=D):(T.equipped.helmet&&(I=ts(I,{name:T.equipped.helmet,quantity:1,id:`item-${Date.now()}`})),T.equipped.helmet=D)}else if(Q==="ANIMALS")T.equipped.animals.push(Y);else if(Q==="CONTAINERS"){if(D.toLowerCase().includes("backpack")&&T.equipped.containers.some(G=>G.name.toLowerCase().includes("backpack"))){p("Only one backpack equipped."),T.inventory=ts(I,Y),C(T);return}if(D.toLowerCase().includes("saddle bag")){const G=T.equipped.animals.find($=>T.equipped.containers.filter(Z=>Z.equippedOn===$.id).length<2);if(!G){p("No animal has space."),T.inventory=ts(I,Y),C(T);return}Y.equippedOn=G.id}T.equipped.containers.push(Y)}T.inventory=I,C(T)},y=(F,U,T,I)=>{let B=structuredClone(S.equipment),Y={id:T||`unequipped-${Date.now()}`,name:F,quantity:1};if(U==="armor"||U==="helmet")B.equipped[U]=void 0;else{const Q=U==="clothing"?"wornClothes":U+"s",D=B.equipped[Q];let G=-1;if(I!==void 0&&(U==="weapon"||U==="clothing")?G=I:T?G=D.findIndex($=>$.id===T):G=D.findIndex($=>($.name||$)===F),G>-1){const[$]=D.splice(G,1);Y=typeof $=="string"?Y:{...$,quantity:1,equippedOn:void 0},U==="animal"&&T&&(B.equipped.containers=B.equipped.containers.filter(Z=>Z.equippedOn===T?(B.inventory=ts(B.inventory,Z),!1):!0))}}B.inventory=ts(B.inventory,Y),C(B)},w=F=>{let U=structuredClone(S.equipment);const T=U.inventory.findIndex(B=>B.id===F.id);if(T===-1)return;const I=Mt(F.name);if(I.quantity!==null){const B=I.quantity-1;B>0?U.inventory[T].name=`${I.baseName} ${I.unit?"":"("}${B}${I.unit?` ${I.unit}`:")"}`:U.inventory.splice(T,1)}else U.inventory[T].quantity>1?U.inventory[T].quantity-=1:U.inventory.splice(T,1);C(U)},L=F=>w(F),E=F=>{const U=Et(F.cost);if(!U){p("Invalid item cost.");return}const{success:T,newMoney:I}=li(S.equipment.money,U);if(!T){p("Not enough money.");return}const B={name:F.name,quantity:1,weight:F.weight,id:`item-${Date.now()}`},Y=ts(S.equipment.inventory,B);C({...S.equipment,inventory:Y,money:I})},P=()=>{var T,I,B,Y,Q;const F=(T=S.equipment)==null?void 0:T.equipped;if(!F)return null;const U=[...F.armor?[{id:"armor",name:F.armor,type:"armor"}]:[],...F.helmet?[{id:"helmet",name:F.helmet,type:"helmet"}]:[],...((I=F.weapons)==null?void 0:I.map((D,G)=>({id:`w-${G}-${D.name}`,name:D.name,type:"weapon",index:G})))||[],...((B=F.wornClothes)==null?void 0:B.map((D,G)=>({id:`c-${G}-${D}`,name:D,type:"clothing",index:G})))||[],...((Y=F.containers)==null?void 0:Y.map(D=>({...D,type:"container"})))||[],...((Q=F.animals)==null?void 0:Q.map(D=>({...D,type:"animal"})))||[]];return U.length===0?null:e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("button",{onClick:()=>t(!a),className:"w-full flex justify-between items-center text-left mb-2",children:[e.jsxs("h3",{className:"font-medium text-sm text-gray-600",children:["Equipped Items (",U.length,")"]}),a?e.jsx(Dn,{className:"w-5 h-5 text-gray-500"}):e.jsx(Ms,{className:"w-5 h-5 text-gray-500"})]}),a&&e.jsx("div",{className:"space-y-2 pl-2 border-l-2",children:U.map(D=>e.jsxs("div",{className:"p-2 bg-gray-100 rounded",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:[D.name," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(",D.type,")"]})]}),e.jsx(M,{variant:"secondary",size:"xs",icon:Pn,onClick:()=>y(D.name,D.type,D.id,D.index),disabled:l,children:"Unequip"})]}),D.type==="animal"&&e.jsx("div",{className:"mt-2 pl-4 border-l-2 border-gray-300 space-y-1",children:F.containers.filter(G=>G.equippedOn===D.id).map(G=>e.jsxs("div",{className:"text-xs text-gray-600 flex items-center justify-between",children:[e.jsxs("span",{children:["- ",G.name]}),e.jsx(M,{variant:"outline",size:"xs",onClick:()=>y(G.name,"container",G.id),children:"Remove"})]},G.id))})]},D.id))})]})};return e.jsxs(e.Fragment,{children:[h&&e.jsx(Vi,{onClose:()=>d(!1),currentMoney:((k=S.equipment)==null?void 0:k.money)||{},onUpdateMoney:F=>C({...S.equipment,money:F})}),e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-6xl w-full max-h-[90vh] flex flex-col shadow-xl",children:[e.jsxs("div",{className:"p-4 md:p-6 border-b flex-shrink-0 bg-gray-50 rounded-t-lg",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-center gap-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-gray-800",children:c.charAt(0).toUpperCase()+c.slice(1)}),e.jsxs("button",{onClick:()=>d(!0),className:"flex items-center gap-1.5 px-3 py-1.5 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium hover:bg-yellow-200 transition-colors",children:[e.jsx(Rn,{className:"w-4 h-4"}),Fr(((R=S.equipment)==null?void 0:R.money)||{})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{size:"sm",variant:c==="inventory"?"primary":"secondary",onClick:()=>x("inventory"),children:"Inventory"}),e.jsx(M,{size:"sm",variant:c==="shop"?"primary":"secondary",onClick:()=>x("shop"),children:"Shop"}),e.jsx("button",{onClick:s,className:"p-1 text-gray-500 hover:text-gray-800 rounded-full hover:bg-gray-200",children:e.jsx(xe,{className:"w-5 h-5"})})]})]}),c==="inventory"&&e.jsx("div",{className:"flex items-center gap-3 mt-3",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Search carried items...",value:g.search,onChange:F=>m({search:F.target.value}),className:"w-full pl-9 pr-4 py-2 border rounded-lg text-sm"})]})}),c==="shop"&&e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-3",children:[v?e.jsx(M,{variant:"secondary",size:"sm",icon:Kt,onClick:()=>f(null),children:"Back"}):e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:v?`Search in ${v.name}...`:"Search shop...",value:g.search,onChange:F=>m({...g,search:F.target.value}),className:"w-full pl-9 pr-4 py-2 border rounded-lg text-sm"})]}),v&&e.jsx("div",{className:"relative",children:e.jsxs("select",{value:u,onChange:F=>N(F.target.value),className:"appearance-none w-full bg-white border rounded-lg text-sm px-4 py-2 pr-8",children:[e.jsx("option",{value:"name-asc",children:"Name (A-Z)"}),e.jsx("option",{value:"name-desc",children:"Name (Z-A)"}),e.jsx("option",{value:"cost-asc",children:"Cost (Low-High)"}),e.jsx("option",{value:"cost-desc",children:"Cost (High-Low)"})]})})]})]}),e.jsxs("div",{className:"p-4 md:p-6 overflow-y-auto flex-1 bg-gray-50",children:[l&&e.jsx("div",{className:"flex justify-center py-10",children:e.jsx(oe,{})}),c==="shop"&&!l?v?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4",children:o.filter(F=>v.categories.includes(F.category||"")&&F.name.toLowerCase().includes(g.search.toLowerCase())).sort((F,U)=>{var B,Y;const T=((B=Et(F.cost))==null?void 0:B.totalCopper)||0,I=((Y=Et(U.cost))==null?void 0:Y.totalCopper)||0;switch(u){case"cost-asc":return T-I;case"cost-desc":return I-T;case"name-desc":return U.name.localeCompare(F.name);case"name-asc":default:return F.name.localeCompare(U.name)}}).map(F=>e.jsx(Qi,{item:F,onBuy:E},F.id))}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:Ji.map(F=>e.jsxs("div",{className:"flex flex-col items-center justify-center p-4 border bg-white rounded-lg hover:shadow-xl hover:scale-105 transition-transform cursor-pointer",onClick:()=>f(F),children:[e.jsx(F.Icon,{className:"w-12 h-12 text-blue-600 mb-3"}),e.jsx("span",{className:"font-medium text-center text-sm",children:F.name})]},F.name))}):!l&&e.jsxs(e.Fragment,{children:[P(),q?e.jsx(Ki,{load:j.load,capacity:j.capacity,isEncumbered:j.isEncumbered}):e.jsx(Wi,{}),e.jsx("h3",{className:"font-medium text-sm text-gray-600 mt-6 mb-3 pt-4 border-t",children:"Carried Items"}),e.jsxs("div",{className:"space-y-3",children:[(((O=S.equipment)==null?void 0:O.inventory)||[]).filter(F=>F.name.toLowerCase().includes(g.search.toLowerCase())).map(F=>{const U=A(F.name);if(!U)return null;const T=U.equippable||Qa.includes(U.category),I=!T;return e.jsxs("div",{className:"p-3 border rounded-lg flex items-center justify-between gap-2 bg-white",children:[e.jsx("h3",{className:"font-medium text-sm truncate",children:Yi(F)}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[I&&e.jsx(M,{variant:"outline",size:"xs",icon:In,onClick:()=>w(F),children:"Use"}),T&&e.jsx(M,{variant:"secondary",size:"xs",icon:Ws,onClick:()=>_(F),children:"Equip"}),e.jsx(M,{variant:"dangerOutline",size:"xs",icon:Le,onClick:()=>L(F),children:"Drop"}),e.jsxs("span",{className:"relative group flex items-center",children:[e.jsx(Xe,{className:"w-4 h-4 text-gray-400 hover:text-gray-600 cursor-help"}),e.jsxs("div",{className:"absolute bottom-full right-0 mb-2 w-60 bg-gray-800 text-white text-xs p-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-20 pointer-events-none",children:[e.jsx("h5",{className:"font-bold mb-1 border-b pb-1",children:U.name}),e.jsx("p",{children:U.effect||U.description}),e.jsxs("p",{className:"mt-1 text-gray-300",children:["W: ",U.weight??"N/A",", Cost: ",U.cost||"N/A"]})]})]})]})]},F.id)}),(((z=S.equipment)==null?void 0:z.inventory)||[]).length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(fs,{className:"w-12 h-12 mx-auto text-gray-300"}),e.jsx("p",{children:"Your pack is empty."})]})]})]})]})]})})]})}const Lt={Axes:"STR",Bows:"AGL",Brawling:"STR",Crossbows:"AGL",Hammers:"STR",Knives:"AGL",Slings:"AGL",Spears:"STR",Staves:"AGL",Swords:"STR"},Xi=s=>s<=5?3:s<=8?4:s<=12?5:s<=15?6:7,eo=(s,a,t)=>{var o,c;const r=((o=s.trainedSkills)==null?void 0:o.includes(a))??!1,n=((c=s.attributes)==null?void 0:c[t])??10,l=Xi(n);return r?l*2:l},so=s=>({STR:"exhausted",CON:"sickly",AGL:"dazed",INT:"angry",WIL:"scared",CHA:"disheartened"})[s],to=s=>typeof s=="object"&&s!==null?s:{},Ja=s=>s?s.split("(")[0].trim():null,Za=s=>["d4","d6","d8","d10","d12","d20"].includes(s),ao=s=>s?Array.isArray(s)?s.join(", "):s:"-",ro=({item:s,category:a,character:t,onClose:r,onSave:n})=>{const[l,o]=i.useState(!1),[c,x]=i.useState("");i.useEffect(()=>{var h;const p=(h=(t.item_notes||{})[a])==null?void 0:h[s.id];p&&(o(p.enhanced||!1),x(p.bonus||""))},[s,a,t.item_notes]);const g=()=>{const b=JSON.parse(JSON.stringify(t.item_notes||{}));b[a]||(b[a]={}),b[a][s.id]={enhanced:l,bonus:l?c:""},n(b),r()},m=b=>{o(b),b||x("")};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-lg w-full p-6 shadow-xl flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 border-b pb-2",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Notes for ",s.name]}),e.jsx("button",{onClick:r,children:e.jsx(xe,{className:"w-6 h-6 text-gray-500 hover:text-gray-800"})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-800 flex items-start gap-3",children:[e.jsx(Fn,{className:"w-6 h-6 text-indigo-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:"Enhancement Opportunity"}),e.jsxs("p",{className:"mt-1",children:["With the help of a ",e.jsx("strong",{children:"MASTER BLACKSMITH"})," or ",e.jsx("strong",{children:"MASTER TANNER"}),", this item can be enhanced. Armor can gain a bonus to its rating (e.g., +1), while weapons can gain a damage bonus (e.g., +D4). This requires GM approval."]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"enhanced",checked:l,onChange:b=>m(b.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"enhanced",className:"ml-2 block text-sm font-medium text-gray-700",children:"Mark as Enhanced ()"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bonusText",className:"block text-sm font-medium text-gray-700",children:"Bonus / Modifier"}),e.jsx("input",{type:"text",id:"bonusText",value:c,onChange:b=>x(b.target.value),disabled:!l,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:l?a==="armor"?"e.g., +1":"e.g., +D4":"Must be enhanced first"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Record the GM-approved bonus here."})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 border-t pt-4",children:[e.jsx(M,{variant:"outline",onClick:r,children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:g,children:"Save Notes"})]})]})})};function no({character:s}){var A,j,q,C,_,y;const{toggleDiceRoller:a}=ze(),{updateCharacterData:t}=Se(),[r,n]=i.useState(null),{data:l=[],isLoading:o,error:c}=we({queryKey:["gameItems"],queryFn:Ys,staleTime:1e3*60*10}),x=w=>l.find(L=>{var E;return((E=L.name)==null?void 0:E.toLowerCase())===w.toLowerCase()}),g=(w,L)=>{var E,P;return w&&((P=(E=s.item_notes)==null?void 0:E[L])==null?void 0:P[w.id])||null},m=(w,L)=>{var E;return((E=g(w,L))==null?void 0:E.enhanced)||!1},b=()=>{var P,k,R,O,z,F,U,T;let w=0;const L=x(((k=(P=s.equipment)==null?void 0:P.equipped)==null?void 0:k.armor)||""),E=x(((O=(R=s.equipment)==null?void 0:R.equipped)==null?void 0:O.helmet)||"");if(L){const I=g(L,"armor");let B=0;I!=null&&I.enhanced&&(B=parseInt(((F=(z=I.bonus)==null?void 0:z.match(/\d+/))==null?void 0:F[0])||"0")),w+=(Number(L.armor_rating)||0)+B}if(E){const I=g(E,"armor");let B=0;I!=null&&I.enhanced&&(B=parseInt(((T=(U=I.bonus)==null?void 0:U.match(/\d+/))==null?void 0:T[0])||"0")),w+=(Number(E.armor_rating)||0)+B}return w},p=(w,L)=>{var T;const E=x(w),P=g(E,"weapon");let k=[],R=[];const O=L==null?void 0:L.match(/(\d+)?d(\d+)/i);if(O){const I=O[1]?parseInt(O[1],10):1,B=`d${O[2]}`;Za(B)&&(k.push(...Array(I).fill(B)),R.push(`${I}d${O[2]}`))}const z=Ja(E==null?void 0:E.skill),F=z?Lt[z]:null;let U=null;if(F==="STR"&&s.attributes.STR>15?U="d6":F==="STR"&&s.attributes.STR>12&&(U="d4"),F==="AGL"&&s.attributes.AGL>15?U="d6":F==="AGL"&&s.attributes.AGL>12&&(U="d4"),U&&(k.push(U),R.push(U.toUpperCase())),P!=null&&P.enhanced){const I=(T=P==null?void 0:P.bonus)==null?void 0:T.match(/d(\d+)/i);if(I){const B=`d${I[1]}`;Za(B)&&(k.push(B),R.push(B.toUpperCase()))}}a({rollMode:"attackDamage",initialDice:k,description:`Damage for ${w} (${R.join(" + ")})`})},h=(w,L,E)=>{a({initialDice:["d20"],rollMode:"skillCheck",targetValue:L,description:`${w} Check`,requiresBane:E,skillName:w})},d=async w=>{try{await t({item_notes:w})}catch(L){console.error("Failed to save item notes:",L)}},v=b(),f=((j=(A=s.equipment)==null?void 0:A.equipped)==null?void 0:j.weapons)||[],u=to(s.skill_levels),N=x(((C=(q=s.equipment)==null?void 0:q.equipped)==null?void 0:C.armor)||""),S=x(((y=(_=s.equipment)==null?void 0:_.equipped)==null?void 0:y.helmet)||"");return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2 text-gray-700",children:[e.jsx(Me,{className:"w-5 h-5 text-blue-600"})," Armor"]}),o?e.jsx(oe,{size:"sm"}):c?e.jsx(ie,{message:"Could not load item details."}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("div",{children:e.jsxs("button",{onClick:()=>N&&n({item:N,category:"armor"}),className:"text-left font-medium disabled:cursor-default",disabled:!N,children:["Body: ",(N==null?void 0:N.name)||e.jsx("span",{className:"italic text-gray-500 font-normal",children:"None"})," ",m(N,"armor")&&e.jsx(Ze,{className:"w-3 h-3 inline text-yellow-500 fill-current"})]})}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>S&&n({item:S,category:"armor"}),className:"text-left font-medium disabled:cursor-default",disabled:!S,children:["Helmet: ",(S==null?void 0:S.name)||e.jsx("span",{className:"italic text-gray-500 font-normal",children:"None"})," ",m(S,"armor")&&e.jsx(Ze,{className:"w-3 h-3 inline text-yellow-500 fill-current"})]})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-md text-sm font-medium mt-2",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsxs("span",{children:["Total Armor Rating: ",v]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2 text-gray-700",children:[e.jsx(qe,{className:"w-5 h-5 text-red-600"})," Weapons"]}),o?e.jsx(oe,{size:"sm"}):c?e.jsx(ie,{message:"Could not load item details."}):f.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No weapons equipped."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Weapon / Shield"}),e.jsx("th",{className:"px-4 py-2",children:"Grip"}),e.jsx("th",{className:"px-4 py-2",children:"Range"}),e.jsx("th",{className:"px-4 py-2",children:"Damage"}),e.jsx("th",{className:"px-4 py-2",children:"Durability"}),e.jsx("th",{className:"px-4 py-2",children:"Features"}),e.jsx("th",{className:"px-4 py-2",children:"Actions"})]})}),e.jsx("tbody",{children:f.map((w,L)=>{var O;const E=x(w.name),P=Ja(E==null?void 0:E.skill);let k=null,R=!1;if(P&&Lt[P]){const z=Lt[P];k=(u==null?void 0:u[P])??eo(s,P,z),R=((O=s.conditions)==null?void 0:O[so(z)])??!1}return e.jsxs("tr",{className:"bg-white border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:e.jsxs("button",{onClick:()=>E&&n({item:E,category:"weapon"}),className:"text-left disabled:cursor-default",disabled:!E,children:[w.name," ",m(E,"weapon")&&e.jsx(Ze,{className:"w-3 h-3 inline text-yellow-500 fill-current"})]})}),e.jsx("td",{className:"px-4 py-2",children:w.grip||"-"}),e.jsx("td",{className:"px-4 py-2",children:w.range||"-"}),e.jsx("td",{className:"px-4 py-2",children:w.damage||"-"}),e.jsx("td",{className:"px-4 py-2",children:(E==null?void 0:E.durability)||"-"}),e.jsx("td",{className:"px-4 py-2",children:ao(w.features)}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[w.damage&&e.jsxs(M,{variant:"link",size:"xs",onClick:()=>p(w.name,w.damage),className:"text-red-600 p-0 flex items-center gap-1",title:"Roll damage",children:[e.jsx(be,{className:"w-3 h-3"}),"Damage"]}),P&&k!==null&&e.jsxs(M,{variant:"link",size:"xs",onClick:()=>h(P,k,R),className:`${R?"text-red-600":"text-indigo-600"} p-0 flex items-center gap-1`,title:`Roll ${P}`,children:[e.jsx(be,{className:"w-3 h-3"}),P,": ",k]})]})})]},`${w.name}-${L}`)})})]})})]}),r&&e.jsx(ro,{item:r.item,category:r.category,character:s,onClose:()=>n(null),onSave:d})]})}function ma(s){return typeof s!="object"||s===null||Array.isArray(s)?!1:Object.values(s).every(a=>typeof a=="number"||a===null)}function Xa(s){return typeof s!="object"||s===null?!1:typeof s.skill_id=="string"&&(s.minimumValue===void 0||typeof s.minimumValue=="number")}const lo=({ability:s,onClose:a})=>{if(!s)return null;const t=oo(s.requirement);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25 z-50",onClick:a,"aria-hidden":"true"}),e.jsx("div",{className:`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl transform transition-transform duration-300 ease-in-out z-50 ${s?"translate-x-0":"translate-x-full"}`,children:e.jsxs("div",{className:"p-6 h-full flex flex-col",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-4",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800",children:s.name}),e.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"overflow-y-auto mt-4 flex-grow space-y-4 text-gray-700",children:[e.jsx("p",{className:"text-sm italic border-l-4 border-gray-200 pl-4 py-1",children:s.description}),t&&e.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-amber-800 text-sm",children:"Requirement"}),e.jsx("p",{className:"text-sm text-amber-700",children:t})]})]})]})})]})},io=s=>Object.entries(s).map(([a,t])=>t!==null?`${a} (Lvl ${t})`:a).join(", "),oo=s=>s?typeof s=="string"?s:ma(s)?io(s):"Complex requirement":null;function co(){const{character:s,allHeroicAbilities:a,isLoading:t,error:r,updateCharacterData:n,isSaving:l,setActiveStatusMessage:o}=Se(),[c,x]=i.useState(null),[g,m]=i.useState(null),b=i.useMemo(()=>{if(!a||!(s!=null&&s.heroic_abilities))return[];const v=new Set(Array.isArray(s.heroic_abilities)?s.heroic_abilities:[]);return a.filter(f=>v.has(f.name))},[a,s==null?void 0:s.heroic_abilities]),p=async v=>{if(!s)return;x(null);const f=v.willpower_cost,u=s.current_wp;if(f===null||f<=0){o(`Used: ${v.name}`);return}if(typeof u!="number"){x("Invalid WP.");return}if(u>=f)try{await n({current_wp:u-f}),o(`Used ${v.name} for ${f} WP.`)}catch(N){x(`Failed to update WP: ${N.message}`)}else x(`Not enough WP. Need ${f}, have ${u}`)},h=({ability:v})=>{const f=v.willpower_cost,u=s==null?void 0:s.current_wp,N=f===null||f<=0||typeof u=="number"&&u>=f;return e.jsxs("div",{className:"flex items-center justify-between p-3 border-b bg-white hover:bg-gray-50/50 last:border-b-0",children:[e.jsx("button",{onClick:S=>{S.stopPropagation(),m(v)},className:"text-left",children:e.jsx("h4",{className:"font-semibold text-gray-800 hover:text-blue-600 transition-colors",children:v.name})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm font-medium text-gray-600 w-20 justify-end",children:f!==null&&f>0?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{children:[f," WP"]})]}):e.jsx("span",{className:"text-green-600",children:"Free"})}),e.jsxs(M,{onClick:S=>{S.stopPropagation(),p(v)},disabled:!N||l,loading:l,variant:"secondary",size:"xs",className:"w-28",children:[e.jsx(Pe,{className:"w-4 h-4 mr-1"})," Activate"]})]})]})},d=()=>t?e.jsx(oe,{size:"sm"}):r?e.jsx(ie,{message:r}):(s==null?void 0:s.profession)==="Mage"?e.jsx("p",{className:"text-sm text-gray-500 italic p-4",children:"Mages use spells instead of heroic abilities."}):b.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic p-4",children:"No heroic abilities learned."}):e.jsxs("div",{className:"space-y-2",children:[c&&e.jsx("div",{className:"p-2 mx-2 bg-red-50 border border-red-200 rounded-md text-xs text-red-700",children:c}),e.jsx("div",{className:"border rounded-lg bg-white shadow-sm overflow-hidden",children:b.map(v=>e.jsx(h,{ability:v},v.id))})]});return e.jsxs("div",{className:"relative",onClick:()=>m(null),children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg border",onClick:v=>v.stopPropagation(),children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2 text-gray-700",children:[e.jsx(Vt,{className:"w-5 h-5 text-orange-600"})," Heroic Abilities"]}),d()]}),e.jsx(lo,{ability:g,onClose:()=>m(null)})]})}async function mo(){const{data:s,error:a}=await H.from("heroic_abilities").select(`
      id,
      name,
      description,
      willpower_cost,
      requirement,
      kin,        
      profession  
    `);if(a)throw console.error("Error fetching heroic abilities:",a),new Error(a.message||"Failed to fetch heroic abilities");return(s||[]).map(r=>({id:r.id,name:r.name,description:r.description,willpower_cost:r.willpower_cost,requirement:r.requirement,kin:r.kin,profession:r.profession}))}const ut={Mentalism:"WIL",Animism:"WIL",Elementalism:"WIL"},uo=["Axes","Bows","Brawling","Crossbows","Hammers","Knives","Slings","Spears","Staves","Swords"],ke=s=>{if(typeof s=="string")try{return JSON.parse(s)}catch{return s}return s},as=s=>{const a=Se.getState().character,t=ke(a==null?void 0:a.skill_levels)||{};return(t==null?void 0:t[s])??0};function xo(s){const a={Acrobatics:"AGL",Awareness:"INT",Bartering:"CHA","Beast Lore":"INT",Bluffing:"CHA",Bushcraft:"INT",Crafting:"STR",Evade:"AGL",Healing:"INT","Hunting & Fishing":"AGL",Languages:"INT","Myths & Legends":"INT",Performance:"CHA",Persuasion:"CHA",Riding:"AGL",Seamanship:"INT","Sleight of Hand":"AGL",Sneaking:"AGL","Spot Hidden":"INT",Swimming:"AGL",Axes:"STR",Bows:"AGL",Brawling:"STR",Crossbows:"AGL",Hammers:"STR",Knives:"AGL",Slings:"AGL",Spears:"STR",Staves:"AGL",Swords:"STR",...ut},t=[],r=ke(s.skill_levels)||{},n=ke(s.trained_skills)||[];for(const l in r){const o=a[l];if(!o){console.warn(`[AdvancementSystem] Skill "${l}" missing from attribute map.`);continue}const c=r[l],x=n.includes(l);t.push({name:l,attribute:o,level:c,isTrained:x})}return t.sort((l,o)=>l.name.localeCompare(o.name)),t}const Ur=s=>{var n;if(!s)return[];const a=ke(s),t=((n=a.school)==null?void 0:n.spells)??[],r=a.general??[];return Array.from(new Set([...t,...r].map(l=>l.toUpperCase())))},Ot=s=>{const a=ke(s.skill_levels);return a?Object.keys(a).filter(t=>ut[t]):[]},ho=(s,a)=>{const t=s.requirement,r=ke(t);if(!r||typeof r!="object"||Object.keys(r).length===0)return!0;const n=new Map,l=ke(a.skill_levels)||{};for(const[x,g]of Object.entries(l))typeof g=="number"&&n.set(x.toUpperCase(),g);const o=new Map,c=ke(a.attributes)||{};for(const[x,g]of Object.entries(c))typeof g=="number"&&o.set(x.toUpperCase(),g);for(const[x,g]of Object.entries(r)){const m=Number(g);if(g===null||isNaN(m))continue;const b=x.toUpperCase();if(n.has(b)&&n.get(b)>=m)return!0;if(o.has(b)&&o.get(b)>=m)return!0}return!1},po=(s,a)=>{if(!s||s.trim()==="")return!0;const t=s.trim().toUpperCase(),r=Ur(a.spells),n=Ot(a).map(l=>l.toUpperCase());return t==="ANYSCHOOL"?n.length>0:!!(n.includes(t)||r.includes(t))};function go({character:s,onClose:a}){var ba;const{character:t,markedSkillsThisSession:r,clearMarkedSkillsThisSession:n,increaseSkillLevel:l,addHeroicAbility:o,increaseMaxStat:c,setSkillUnderStudy:x,learnSpell:g,addMagicSchool:m,isSaving:b,saveError:p}=Se(),{toggleDiceRoller:h}=ze(),[d,v]=i.useState(!1),[f,u]=i.useState(null),[N,S]=i.useState("initial"),[A,j]=i.useState(null),[q,C]=i.useState(0),[_,y]=i.useState(new Set),[w,L]=i.useState([]),[E,P]=i.useState(0),[k,R]=i.useState(null),[O,z]=i.useState(null),[F,U]=i.useState([]),[T,I]=i.useState(!1),[B,Y]=i.useState(null),[Q,D]=i.useState(null),[G,$]=i.useState(null),[Z,ee]=i.useState(null),[re,K]=i.useState([]),[W,se]=i.useState([]),[le,je]=i.useState([]),[pe,de]=i.useState(null),[me,Ue]=i.useState(null),[$e,hs]=i.useState(!1),Ge=t||s,ys=i.useMemo(()=>Ge?xo(Ge):[],[Ge]),We=(ba=t==null?void 0:t.teacher)==null?void 0:ba.skillUnderStudy,{generalSkills:Qs,weaponSkills:Ts,magicSkills:V}=i.useMemo(()=>{const X=[],te=[],ne=[];return ys.forEach(ue=>{ut[ue.name]?ne.push(ue):uo.includes(ue.name)?te.push(ue):X.push(ue)}),{generalSkills:X,weaponSkills:te,magicSkills:ne}},[ys]),ae=()=>{j(null),R(null),$(null),C(0),y(new Set),L([]),P(0),z(null),Y(null),D(null),je([]),de(null),Ue(null),hs(!1),I(!1)},ce=()=>{ae(),S("enterMarks")},fe=()=>{ae(),S("selectStudyType")},Re=async()=>{if(!t){j("Character data not found."),S("selectStudyType");return}if(Ot(t).length===0){j("Character does not know any magic schools."),S("selectStudyType");return}hs(!0),j(null);try{let te=re.length>0?re:await Kl();re.length===0&&K(te);const ne=Ur(t.spells),ue=te.filter(ve=>!ne.includes(ve.name.toUpperCase())&&po(ve.prerequisite,t));je(ue),S("studyMagicSelectSpell")}catch(te){console.error("Error loading magic data:",te),j(te instanceof Error?te.message:"Failed to load magic study data."),S("selectStudyType")}finally{hs(!1)}},_e=async X=>{if(X==="teacher")S("studyTeacherSelectSkill");else if(X==="magic")Re();else if(X==="learnSchool"){hs(!0),j(null);try{const te=await Pr();se(te),S("studyMagicSelectSchool")}catch(te){console.error("Error loading magic schools:",te),j(te instanceof Error?te.message:"Failed to load magic schools.")}finally{hs(!1)}}},Oe=X=>{if(X.preventDefault(),q>0){const te=new Set;let ne=0;const ue=ys.map(ve=>ve.name);for(const ve of r)ne<q&&ue.includes(ve)&&(te.add(ve),ne++);y(te),j(null),S("selectSkills")}else j("Please enter at least one Advancement Mark.")},cs=X=>{y(te=>{const ne=new Set(te);return ne.has(X)?ne.delete(X):ne.size<q&&ne.add(X),ne})},Is=()=>{if(_.size!==q){j(`Please select exactly ${q} skill(s).`);return}j(null),L(Array.from(_)),P(0),R(null),S("rollSkills")},Ds=i.useCallback(async(X,te,ne)=>{const ue=ne==="study"?$:R,ve=as(X);let Ee=`Manual result for ${X}: `;if(te){Ee+="Success! Skill increased.",await l(X);const Ne=as(X);Ee+=` New Level: ${Ne}.`,Ne===18&&ve<18&&(ne==="endSession"&&z(X),Ee+=" Reached level 18!")}else Ee+="Failure. Skill did not increase.";ue(Ee)},[l]),Xr=i.useCallback(async X=>{if(!t||!X.results||X.results.length===0){R("Error: Roll failed due to missing data."),h();return}const{value:te}=X.results[0],{skillName:ne,targetValue:ue}=X;if(!ne||ue===void 0){R("Error: Roll context missing skill information."),h();return}const ve=te>ue;let Ee=`Rolled ${te} vs ${ne} (Target > ${ue}). `;await Ds(ne,ve,"endSession"),R(Ne=>Ee+(Ne||"")),h()},[t,Ds,h]),xa=(X,te)=>{const ne=as(X),ue=te==="study"?$:R;if(ne>=18){ue(`Skill ${X} is already at max level (18).`);return}ue(null),h({rollMode:"advancementRoll",targetValue:ne,skillName:X,description:`Advancement Roll: ${X} (D20 vs > ${ne})`,onRollComplete:te==="study"?ln:Xr})},ha=(X,te)=>{const ne=as(X),ue=te==="study"?$:R;if(ne>=18){ue(`Skill ${X} is already at max level (18).`);return}u({skillName:X,context:te}),v(!0)},pa=async X=>{if(!f)return;const{skillName:te,context:ne}=f;v(!1),await Ds(te,X,ne),u(null)},en=()=>{R(null),O?(sn(),S("selectAbility")):E<w.length-1?P(X=>X+1):ga()},sn=async()=>{I(!0),j(null);try{const X=await mo(),te=Se.getState().character;if(!te)throw new Error("Character data not available for ability filtering.");const ne=ke(te.heroic_abilities)||[],ue=new Set(ne.map(Ne=>Ne.toUpperCase())),ve=new Set(["ROBUST","FOCUSED","MAGIC TALENT"]),Ee=X.filter(Ne=>{const Js=Ne.name.toUpperCase();return!(ue.has(Js)&&!ve.has(Js)||Ne.kin||!ho(Ne,te))});U(Ee)}catch(X){console.error("Error fetching abilities:",X),j(X instanceof Error?X.message:"Failed to load heroic abilities.")}finally{I(!1)}},tn=X=>{Y(X)},an=async()=>{if(!B){j("Please select a heroic ability.");return}j(null),await o(B.name);const X=B.name.toUpperCase();X==="ROBUST"?await c("max_hp",2):X==="FOCUSED"&&await c("max_wp",2),z(null),Y(null),E<w.length-1?(P(te=>te+1),S("rollSkills")):ga()},ga=()=>{n(),S("finished")},rn=X=>{D(X)},nn=async()=>{if(!Q){j("Please select a skill to study.");return}j(null),$(null),await x(Q),S("studyTeacherRollSkill")},ln=i.useCallback(async X=>{if(!t||!X.results||!X.results.length){$("Error: Roll failed due to missing data."),h();return}const{value:te}=X.results[0],{skillName:ne,targetValue:ue}=X;if(!ne||ue===void 0){$("Error: Roll context missing skill information."),h();return}const ve=te>ue;let Ee=`Studied ${ne}. Rolled ${te} vs Target > ${ue}. `;await Ds(ne,ve,"study"),$(Ne=>Ee+(Ne||"")),h()},[t,Ds,h]),on=i.useCallback(async X=>{var Ne;if(!t||!((Ne=X.results)!=null&&Ne.length)||!me){$("Error: Roll failed due to missing data."),h();return}const{value:te}=X.results[0],ne=X.targetValue,ue=ke(t.attributes);if(ne===void 0||!ue){$("Error: Character INT value not found for roll."),h();return}const ve=te>ne;let Ee=`Attempting to learn ${me.name}. Rolled ${te} vs INT > ${ne}. `;ve?(Ee+=`Success! You have learned the basics of ${me.name}. The skill is added at your base chance of ${ne}.`,await m(me,ne)):Ee+="Failure. You must study for another week to try again.",$(Ee),h()},[t,me,m,h]),cn=()=>{if(!t||!me)return;const te=ke(t.attributes).INT;$(null),h({rollMode:"advancementRoll",targetValue:te,skillName:`Learn ${me.name}`,description:`Learn Magic School: ${me.name} (D20 vs > ${te})`,onRollComplete:on})},dn=async()=>{if(!t||!me)return;const te=ke(t.attributes).INT;$(null);let ne=`Manually learned ${me.name}. Success! The skill is added at your base chance of ${te}.`;await m(me,te),$(ne)},mn=X=>{de(X)},un=async()=>{if(!pe){j("Please select a spell to learn.");return}j(null);try{await g(pe),a()}catch(X){console.error("Error learning spell:",X),j(X instanceof Error?X.message:"Failed to learn the spell.")}},fa=()=>{D(null),$(null),de(null),Ue(null),je([]),a()},xn=()=>{if(!Ge&&N!=="initial")return e.jsx(oe,{text:"Loading character data..."});switch(N){case"initial":return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsx("p",{className:"text-gray-600",children:"Choose an action to proceed."})," ",e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[" ",e.jsxs(M,{onClick:ce,className:"flex-1",children:[e.jsx(Os,{className:"w-5 h-5 mr-2"})," End Session & Advance"]})," ",e.jsxs(M,{onClick:fe,variant:"outline",className:"flex-1",children:[e.jsx(Je,{className:"w-5 h-5 mr-2"})," Study"]})," "]})," "]});case"enterMarks":return e.jsxs("form",{onSubmit:Oe,className:"space-y-4",children:[" ",e.jsx("h4",{className:"font-medium text-gray-800",children:"End Session Advancement"})," ",e.jsx("label",{htmlFor:"advancementMarks",className:"block font-medium text-gray-700",children:"How many Advancement Marks did you gain this session?"})," ",e.jsx("input",{type:"number",id:"advancementMarks",name:"advancementMarks",min:"1",value:q===0?"":q,onChange:J=>C(parseInt(J.target.value,10)||0),className:"w-full p-2 border rounded focus:ring-blue-500 focus:border-blue-500",required:!0})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>S("initial"),children:[e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back"]}),e.jsxs(M,{type:"submit",disabled:q<=0,children:["Next ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})]})]})," "]});case"selectSkills":if(!Ge)return e.jsx(oe,{});const X=({skill:J})=>{const Ke=as(J.name),ss=Ke>=18,Xs=J.name===We;return e.jsxs("label",{className:`flex items-center space-x-3 p-2 rounded ${ss?"opacity-60 cursor-not-allowed":"hover:bg-gray-100 cursor-pointer"}`,children:[e.jsx("input",{type:"checkbox",checked:_.has(J.name),onChange:()=>cs(J.name),disabled:ss||!_.has(J.name)&&_.size>=q,className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 disabled:opacity-50"}),e.jsx("span",{className:`flex-grow ${J.isTrained?"font-semibold":""}`,children:J.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",J.attribute,")"]}),e.jsxs("span",{className:"text-sm text-gray-600 font-medium",children:["Lvl ",Ke]}),ss&&e.jsx("span",{className:"text-xs text-yellow-600 font-semibold ml-1",children:"(Max)"}),r.has(J.name)&&!ss&&e.jsx(Ze,{className:"w-4 h-4 text-yellow-500",title:"Marked this session"}),Xs&&e.jsx(Os,{className:"w-4 h-4 text-purple-600 ml-1",title:"Currently studying"})]},J.name)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"font-medium text-gray-800",children:["Select ",q," skill(s) to attempt advancement:"]}),e.jsxs("div",{className:"max-h-80 overflow-y-auto space-y-4 border rounded p-3 bg-gray-50",children:[Qs.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-600 mb-1",children:"General Skills"}),e.jsx("div",{className:"space-y-1",children:Qs.map(J=>e.jsx(X,{skill:J},J.name))})]}),Ts.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-600 mb-1 pt-2 border-t",children:"Weapon Skills"}),e.jsx("div",{className:"space-y-1",children:Ts.map(J=>e.jsx(X,{skill:J},J.name))})]}),V.length>0&&e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-600 mb-1 pt-2 border-t",children:"Magic Skills"}),e.jsx("div",{className:"space-y-1",children:V.map(J=>e.jsx(X,{skill:J},J.name))})]})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Selected: ",_.size," / ",q]}),A&&e.jsx(ie,{message:A}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>S("enterMarks"),children:[e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back"]}),e.jsxs(M,{onClick:Is,disabled:_.size!==q,children:["Confirm Selection ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})]})]})]});case"rollSkills":if(w.length===0||!Ge)return e.jsx(oe,{text:"Preparing skill roll..."});const te=w[E],ne=as(te),ue=ne>=18,ve=!!k;return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-gray-800",children:[" Attempting Advancement (",E+1," / ",w.length,") "]})," ",e.jsxs("div",{className:"p-4 border rounded bg-gray-50 text-center",children:[" ",e.jsx("p",{className:"text-lg font-semibold",children:te})," ",e.jsxs("p",{className:"text-gray-600",children:["Current Level: ",ne]})," ",ue&&!ve&&e.jsx("p",{className:"text-yellow-600 font-medium mt-1",children:"Max Level Reached. Skipped."})," "]})," ",k&&e.jsxs("div",{className:`p-3 rounded border text-center ${k.includes("Success")?"bg-green-50 border-green-200 text-green-800":k.includes("Failed")?"bg-red-50 border-red-200 text-red-800":"bg-blue-50 border-blue-200 text-blue-800"}`,children:[" ",k," "]})," ",p&&e.jsx(ie,{message:p})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-center gap-4 pt-2",children:[" ",!ve&&!ue&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(M,{onClick:()=>xa(te,"endSession"),disabled:b,loading:b,children:[" ",e.jsx(be,{className:"w-4 h-4 mr-1"})," Roll (D20 vs ",">"," ",ne,") "]})," ",e.jsxs(M,{variant:"outline",onClick:()=>ha(te,"endSession"),disabled:b,loading:b,children:[" ",e.jsx(Pe,{className:"w-4 h-4 mr-1"})," Enter Manual Result "]})," "]})," ",(ve||ue&&!ve)&&e.jsxs(M,{onClick:en,disabled:b,loading:b,children:[" ",O?"Select Heroic Ability":E<w.length-1?"Next Skill":"Finish Session"," ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]});case"selectAbility":return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-green-700 flex items-center gap-2",children:[" ",e.jsx(ht,{className:"w-5 h-5"})," Skill ",e.jsx("span",{className:"font-bold",children:O})," reached level 18! "]})," ",e.jsx("p",{className:"text-gray-700",children:"Select a new Heroic Ability:"})," ",T&&e.jsx(oe,{text:"Loading available abilities..."})," ",A&&e.jsx(ie,{message:A})," ",!T&&F.length===0&&!A&&e.jsx("p",{className:"text-center text-gray-500 italic py-4",children:"No eligible heroic abilities found for this character."})," ",!T&&F.length>0&&e.jsxs("div",{className:"max-h-60 overflow-y-auto space-y-2 border rounded p-3 bg-gray-50",children:[" ",F.map(J=>e.jsxs("div",{onClick:()=>tn(J),className:`p-3 rounded border cursor-pointer ${(B==null?void 0:B.id)===J.id?"bg-blue-100 border-blue-300 ring-2 ring-blue-400":"bg-white hover:bg-blue-50 border-gray-200"}`,children:[" ",e.jsx("p",{className:"font-semibold",children:J.name})," ",e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:J.description})," ",e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex flex-wrap gap-x-2 gap-y-1",children:[" ",J.willpower_cost&&e.jsxs("span",{children:["WP: ",J.willpower_cost]})," ",J.requirement&&typeof ke(J.requirement)=="object"&&Object.keys(ke(J.requirement)).length>0&&e.jsxs("span",{children:["Req: ",Object.entries(ke(J.requirement)).filter(([,Ke])=>Ke!=null).map(([Ke,ss])=>`${Ke} ${ss}`).join(", ")]})," ",J.requirement&&typeof J.requirement=="string"&&!J.requirement.startsWith("{")&&e.jsxs("span",{children:["Req: ",J.requirement]})," "]})," "]},J.id))," "]})," ",p&&e.jsx(ie,{message:p})," ",e.jsxs("div",{className:"flex justify-end pt-2",children:[" ",e.jsxs(M,{onClick:an,disabled:!B||T||b||F.length===0&&!A&&!T,loading:b,children:[" Confirm Ability & Continue ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]});case"selectStudyType":const Ee=(t&&Ot(t).length>0)??!1,Ne=t?ke(t.heroic_abilities):[],Js=(Ne==null?void 0:Ne.filter(J=>J.toUpperCase()==="MAGIC TALENT").length)??0,pn=t?ke(t.skill_levels):{},gn=Object.keys(pn??{}).filter(J=>ut[J]).length,ya=Js>gn;return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsx("h4",{className:"font-medium text-gray-800",children:"Choose Study Method"})," ",e.jsx("p",{className:"text-gray-600",children:"How would you like to study to improve a skill or learn magic?"})," ",e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[" ",e.jsxs(M,{onClick:()=>_e("teacher"),className:"w-full",children:[" ",e.jsx(Os,{className:"w-5 h-5 mr-2"})," Find a Teacher (Skills) "]})," ",e.jsxs(M,{onClick:()=>_e("magic"),variant:"outline",className:"w-full",disabled:!Ee||$e,loading:$e,children:[" ",e.jsx(dt,{className:"w-5 h-5 mr-2"})," Study Magic (Spells) "]})," ",e.jsxs(M,{onClick:()=>_e("learnSchool"),variant:"outline",className:"w-full sm:col-span-2",disabled:!ya||$e,loading:$e,children:[" ",e.jsx(Je,{className:"w-5 h-5 mr-2"})," Learn a New Magic School "]})," "]})," ",!Ee&&e.jsxs("p",{className:"text-sm text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200 flex items-center gap-1",children:[" ",e.jsx(he,{className:"w-4 h-4 flex-shrink-0"})," Character must know a Magic School to study its spells. "]})," ",!ya&&e.jsxs("p",{className:"text-sm text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200 flex items-center gap-1",children:[" ",e.jsx(he,{className:"w-4 h-4 flex-shrink-0"})," Requires the 'Magic Talent' heroic ability. You must have one use of this ability for each school you wish to learn. "]})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-start",children:[" ",e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>S("initial"),children:[" ",e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back "]})," "]})," "]});case"studyTeacherSelectSkill":return Ge?e.jsxs("div",{className:"space-y-4",children:[" ",e.jsx("h4",{className:"font-medium text-gray-800",children:"Study with a Teacher"})," ",e.jsx("p",{className:"text-gray-600",children:"Select one skill to focus on improving. You cannot study a skill currently being studied until it has been advanced or study is completed."})," ",We&&e.jsxs("div",{className:"p-3 bg-purple-50 border border-purple-200 rounded text-purple-800 text-sm flex items-center gap-2",children:[" ",e.jsx(Xe,{className:"w-4 h-4 flex-shrink-0"})," Currently studying: ",e.jsx("span",{className:"font-semibold",children:We}),". Complete or advance this study first to pick another skill. "]})," ",e.jsxs("div",{className:"max-h-72 overflow-y-auto space-y-1 border rounded p-3 bg-gray-50",children:[" ",ys.map(J=>{const Ke=as(J.name),ss=Ke>=18,Xs=ss||!!We&&We!==J.name;return e.jsxs("label",{className:`flex items-center space-x-3 p-2 rounded ${Xs?"opacity-60 cursor-not-allowed":Q===J.name?"bg-blue-100 border border-blue-300":"hover:bg-gray-100 cursor-pointer"}`,children:[" ",e.jsx("input",{type:"radio",name:"studySkill",checked:Q===J.name,onChange:()=>rn(J.name),disabled:Xs,className:"h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"})," ",e.jsx("span",{className:`flex-grow ${J.isTrained?"font-semibold":""}`,children:J.name})," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(",J.attribute,")"]})," ",e.jsxs("span",{className:"text-sm text-gray-600 font-medium",children:["Lvl ",Ke]})," ",ss&&e.jsx("span",{className:"text-xs text-yellow-600 font-semibold ml-1",children:"(Max)"})," "]},J.name)})," "]})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-between",children:[" ",e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>S("selectStudyType"),children:[" ",e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back "]})," ",e.jsxs(M,{onClick:nn,disabled:!Q||!!We||b,loading:b,children:[" Confirm Study Skill ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]}):e.jsx(oe,{});case"studyTeacherRollSkill":const js=We||Q;if(!js||!Ge)return e.jsx(ie,{message:"Error: No skill selected or found for study, or character data missing."});const wt=as(js),Nt=wt>=18,Zs=!!G;return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-gray-800",children:["Study Session: ",js]})," ",e.jsxs("div",{className:"p-4 border rounded bg-gray-50 text-center",children:[" ",e.jsx("p",{className:"text-lg font-semibold",children:js})," ",e.jsxs("p",{className:"text-gray-600",children:["Current Level: ",wt]})," ",Nt&&!Zs&&e.jsx("p",{className:"text-yellow-600 font-medium mt-1",children:"Max Level Reached. Study complete."})," "]})," ",G&&e.jsxs("div",{className:`p-3 rounded border text-center ${G.includes("Success")?"bg-green-50 border-green-200 text-green-800":G.includes("Failed")?"bg-red-50 border-red-200 text-red-800":"bg-blue-50 border-blue-200 text-blue-800"}`,children:[" ",G," "]})," ",p&&e.jsx(ie,{message:p})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-center gap-4 pt-2",children:[" ",!Zs&&!Nt&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(M,{onClick:()=>xa(js,"study"),disabled:b,loading:b,children:[" ",e.jsx(be,{className:"w-4 h-4 mr-1"})," Roll (D20 vs ",">"," ",wt,") "]})," ",e.jsxs(M,{variant:"outline",onClick:()=>ha(js,"study"),disabled:b,loading:b,children:[" ",e.jsx(Pe,{className:"w-4 h-4 mr-1"})," Enter Manual Result "]})," "]})," ",(Zs||Nt&&!Zs)&&e.jsxs(M,{onClick:fa,disabled:b,loading:b,children:[" Finish Study ",e.jsx(ds,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]});case"studyMagicSelectSpell":return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-gray-800 flex items-center gap-2",children:[" ",e.jsx(dt,{className:"w-5 h-5 text-purple-600"})," Study Magic (Spells) "]})," ",Z&&e.jsxs("p",{className:"text-gray-600",children:["School: ",e.jsx("span",{className:"font-semibold",children:Z})]})," ",e.jsx("p",{className:"text-gray-600",children:"Select a spell to learn:"})," ",$e&&e.jsx(oe,{text:"Loading spells..."})," ",A&&e.jsx(ie,{message:A})," ",!$e&&le.length===0&&!A&&e.jsx("p",{className:"text-center text-gray-500 italic py-4",children:"No new spells available to learn at this time, or prerequisites not met."})," ",!$e&&le.length>0&&e.jsxs("div",{className:"max-h-72 overflow-y-auto space-y-2 border rounded p-3 bg-gray-50",children:[" ",le.map(J=>e.jsxs("label",{className:`flex items-start space-x-3 p-3 rounded border cursor-pointer ${(pe==null?void 0:pe.id)===J.id?"bg-blue-100 border-blue-300 ring-2 ring-blue-400":"bg-white hover:bg-blue-50 border-gray-200"}`,children:[" ",e.jsx("input",{type:"radio",name:"learnSpell",checked:(pe==null?void 0:pe.id)===J.id,onChange:()=>mn(J),className:"h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mt-1 flex-shrink-0"})," ",e.jsxs("div",{className:"flex-grow",children:[" ",e.jsxs("p",{className:"font-semibold",children:[J.name," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(Rank ",J.rank??"N/A",")"]})]})," ",e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:J.description})," ",e.jsxs("div",{className:"text-xs text-gray-500 mt-1 flex flex-wrap gap-x-2 gap-y-1",children:[" ",J.casting_time&&e.jsxs("span",{children:["Cast: ",J.casting_time]})," ",J.range&&e.jsxs("span",{children:["Range: ",J.range]})," ",J.duration&&e.jsxs("span",{children:["Duration: ",J.duration]})," ",J.willpower_cost&&e.jsxs("span",{children:["WP: ",J.willpower_cost]})," ",J.prerequisite&&e.jsxs("span",{className:"italic",children:["(Learn Req: ",J.prerequisite,")"]})," ",J.casting_requirement&&e.jsxs("span",{className:"italic",children:["(Cast Req: ",J.casting_requirement,")"]})," "]})," "]})," "]},J.id))," "]})," ",p&&e.jsx(ie,{message:p})," ",e.jsxs("div",{className:"flex justify-between pt-2",children:[" ",e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>{S("selectStudyType"),j(null)},children:[" ",e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back "]})," ",e.jsxs(M,{onClick:un,disabled:!pe||$e||b||le.length===0&&!A&&!$e,loading:b,children:[" Learn Selected Spell ",e.jsx(ds,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]});case"studyMagicSelectSchool":const fn=t?ke(t.skill_levels):{},bn=Object.keys(fn??{}),ja=W.filter(J=>!bn.includes(J.name));return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-gray-800 flex items-center gap-2",children:[" ",e.jsx(Je,{className:"w-5 h-5 text-purple-600"})," Learn a New Magic School "]})," ",e.jsx("p",{className:"text-gray-600",children:"Select a school of magic to study for a week. At the end of the week, you will roll against your INT to learn it."})," ",A&&e.jsx(ie,{message:A})," ",!$e&&ja.length===0&&!A&&e.jsx("p",{className:"text-center text-gray-500 italic py-4",children:"There are no new magic schools available for you to learn."})," ",e.jsxs("div",{className:"max-h-72 overflow-y-auto space-y-2 border rounded p-3 bg-gray-50",children:[" ",ja.map(J=>e.jsxs("label",{className:`flex items-start space-x-3 p-3 rounded border cursor-pointer ${(me==null?void 0:me.id)===J.id?"bg-blue-100 border-blue-300 ring-2 ring-blue-400":"bg-white hover:bg-blue-50 border-gray-200"}`,children:[" ",e.jsx("input",{type:"radio",name:"learnSchool",checked:(me==null?void 0:me.id)===J.id,onChange:()=>Ue(J),className:"h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mt-1 flex-shrink-0"})," ",e.jsxs("div",{className:"flex-grow",children:[" ",e.jsx("p",{className:"font-semibold",children:J.name})," ",e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:J.description})," "]})," "]},J.id))," "]})," ",e.jsxs("div",{className:"flex justify-between pt-2",children:[" ",e.jsxs(M,{type:"button",variant:"secondary",onClick:()=>{S("selectStudyType"),j(null)},children:[" ",e.jsx(vs,{className:"w-4 h-4 mr-1"})," Back "]})," ",e.jsxs(M,{onClick:()=>S("studyMagicRollSchool"),disabled:!me||b,loading:b,children:[" Begin Study ",e.jsx(Qe,{className:"w-4 h-4 ml-1"})," "]})," "]})," "]});case"studyMagicRollSchool":if(!me||!t)return e.jsx(ie,{message:"Error: No magic school selected or character data missing."});const va=ke(t.attributes).INT,wa=!!G;return e.jsxs("div",{className:"space-y-4",children:[" ",e.jsxs("h4",{className:"font-medium text-gray-800",children:["Study Session: Learn ",me.name]})," ",e.jsxs("div",{className:"p-4 border rounded bg-gray-50 text-center",children:[" ",e.jsx("p",{className:"text-lg font-semibold",children:me.name})," ",e.jsxs("p",{className:"text-gray-600",children:["You must roll greater than your Intelligence (",va,") on a D20 to succeed."]})," "]})," ",G&&e.jsxs("div",{className:`p-3 rounded border text-center ${G.includes("Success")?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"}`,children:[" ",G," "]})," ",p&&e.jsx(ie,{message:p})," ",A&&e.jsx(ie,{message:A})," ",e.jsxs("div",{className:"flex justify-center gap-4 pt-2",children:[" ",!wa&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(M,{onClick:cn,disabled:b,loading:b,children:[" ",e.jsx(be,{className:"w-4 h-4 mr-1"})," Roll (D20 vs ",">"," ",va,") "]})," ",e.jsxs(M,{variant:"outline",onClick:dn,disabled:b,loading:b,children:[" ",e.jsx(Pe,{className:"w-4 h-4 mr-1"})," Succeed Manually "]})," "]})," ",wa&&e.jsxs(M,{onClick:fa,disabled:b,loading:b,children:[" Finish ",e.jsx(ds,{className:"w-4 h-4 ml-1"})," "]})," "]})," ",b&&e.jsxs("div",{className:"text-center text-sm text-blue-600 flex items-center justify-center gap-1",children:[e.jsx(Ye,{className:"w-4 h-4 animate-spin"})," Saving..."]})," "]});case"finished":return e.jsxs("div",{className:"text-center space-y-4 p-6 bg-green-50 rounded border border-green-200",children:[" ",e.jsx(ds,{className:"w-12 h-12 text-green-500 mx-auto"})," ",e.jsx("h4",{className:"text-xl font-semibold text-green-800",children:"Session Ended & Advancement Complete!"})," ",e.jsx("p",{className:"text-gray-700",children:"Character data has been updated. Marked skills for this session have been cleared."})," ",e.jsx(M,{onClick:a,children:" Done "})," "]});default:const yn=N;return e.jsxs("p",{children:["Unknown step: ",yn]})}},hn=()=>{if(!d||!f)return null;const{skillName:X}=f,te=as(X);return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50",children:[" ",e.jsxs("div",{className:"bg-white rounded-lg max-w-sm w-full p-6 shadow-xl",children:[" ",e.jsxs("h4",{className:"text-lg font-semibold text-gray-800",children:["Manual Advancement for ",e.jsx("span",{className:"text-blue-600",children:X})]})," ",e.jsxs("p",{className:"text-sm text-gray-600 mt-2 mb-4",children:[" A success is counted when the D20 roll is ",e.jsx("span",{className:"font-bold",children:"greater than"})," the skill's current level of ",e.jsx("span",{className:"font-bold",children:te}),". "]})," ",e.jsxs("div",{className:"flex flex-col gap-3",children:[" ",e.jsxs(M,{onClick:()=>pa(!0),disabled:b,loading:b,className:"w-full",children:[" ",e.jsx($n,{className:"w-4 h-4 mr-2"})," Success "]})," ",e.jsxs(M,{onClick:()=>pa(!1),disabled:b,loading:b,variant:"outline",className:"w-full",children:[" ",e.jsx(On,{className:"w-4 h-4 mr-2"})," Failure "]})," "]})," ",e.jsxs("div",{className:"mt-4 text-center",children:[" ",e.jsx("button",{onClick:()=>v(!1),className:"text-xs text-gray-500 hover:text-gray-700",children:"Cancel"})," "]})," "]})," "]})};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:[e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4 sticky top-0 bg-white z-10",children:[e.jsxs("h3",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(Os,{className:"w-6 h-6 text-blue-600"}),"Character Advancement"]}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600","aria-label":"Close advancement modal",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"p-6",children:xn()})]}),hn()]})}function fo({character:s}){const{toggleDiceRoller:a}=ze(),{setDeathRollState:t,adjustStat:r,isSaving:n}=Se(),[l,o]=i.useState(!1),[c,x]=i.useState(null),g=s.death_rolls_passed??0,m=s.death_rolls_failed??0,b=s.is_rallied??!1,p=s.attributes.CON,h=s.attributes.WIL,d=g>=3,v=m>=3,f=y=>{o(!1);const w=y.results[0].value,L=y.isCritical&&y.isSuccess,E=y.isCritical&&!y.isSuccess,P=y.isSuccess;let k=g,R=m;L?(k+=2,x(`Rolled ${w} (Dragon! +2 Successes)`)):E?(R+=2,x(`Rolled ${w} (Demon! +2 Failures)`)):P?(k+=1,x(`Rolled ${w} (Success vs CON ${p})`)):(R+=1,x(`Rolled ${w} (Failure vs CON ${p})`)),t(k,R,b),a()},u=y=>{o(!1);const w=y.results[0].value;y.isSuccess?(t(g,m,!0),x(`Rallied! (Rolled ${w} vs WIL ${h} w/ Bane)`)):(t(g,m,!1),x(`Rally Failed (Rolled ${w} vs WIL ${h} w/ Bane)`)),a()},N=y=>{o(!1);const w=y.results[0].value;x(`Recovered ${w} HP!`),r("current_hp",w),a()},S=()=>{l||d||v||(o(!0),x(null),a({rollMode:"deathRoll",targetValue:p,description:`Death Save (d20 vs CON ${p})`,onRollComplete:f}))},A=()=>{l||b||d||v||(o(!0),x(null),a({rollMode:"rallyRoll",targetValue:h,requiresBane:!0,description:`Rally Self (d20 vs WIL ${h}, Bane)`,onRollComplete:u}))},j=()=>{l||!d||v||(o(!0),x(null),a({rollMode:"recoveryRoll",description:"Recovery Roll (1d6 HP)",onRollComplete:N}))},q=y=>{if(d||v||n)return;const w=Math.max(0,Math.min(3,g+y));t(w,m,b)},C=y=>{if(d||v||n)return;const w=Math.max(0,Math.min(3,m+y));t(g,w,b)},_=(y,w,L,E,P,k)=>e.jsxs("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[e.jsx(E,{className:`w-4 h-4 sm:w-5 sm:h-5 ${P}`}),e.jsxs("span",{className:"font-medium text-xs sm:text-sm w-16 sm:w-20",children:[y,":"]}),e.jsxs("div",{className:"flex space-x-1 items-center",children:[e.jsx("button",{onClick:()=>k(-1),disabled:w===0||d||v||n,className:"p-0.5 text-xs bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300",title:`Decrease ${y}`,children:e.jsx(Wt,{className:"w-3 h-3"})}),[...Array(L)].map((R,O)=>e.jsx("div",{className:`w-3 h-3 sm:w-4 sm:h-4 rounded-full border ${O<w?y==="Successes"?"bg-green-500 border-green-600":"bg-red-500 border-red-600":"bg-gray-200 border-gray-300"}`},O)),e.jsx("button",{onClick:()=>k(1),disabled:w===L||d||v||n,className:"p-0.5 text-xs bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300",title:`Increase ${y}`,children:e.jsx(ye,{className:"w-3 h-3"})})]})]});return e.jsxs("div",{className:"p-3 rounded-lg shadow bg-red-50 border border-red-300 space-y-2",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-1 text-sm text-red-700",children:[e.jsx(is,{className:"w-4 h-4 text-red-600 animate-pulse"}),"DYING (",s.current_hp," HP)"]}),e.jsxs("div",{className:"space-y-1",children:[_("Successes",g,3,gs,"text-green-500",q),_("Failures",m,3,xs,"text-red-500",C)]}),c&&e.jsx("p",{className:"text-xs text-center text-gray-700 italic",children:c}),b&&!d&&!v&&e.jsxs("p",{className:"text-xs text-center text-yellow-800 bg-yellow-100 p-1 rounded border border-yellow-200 flex items-center justify-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," Rallied! Can act, but still dying."]}),e.jsx("div",{className:"pt-1 space-y-2",children:v?e.jsx("div",{className:"text-center font-bold text-lg text-red-800 p-2 bg-red-200 rounded",children:"CHARACTER DIED"}):d?e.jsxs(M,{onClick:j,disabled:l||n,loading:l||n,className:"w-full bg-green-600 hover:bg-green-700 text-white",size:"sm",children:[e.jsx(Yt,{className:"w-4 h-4 mr-1"})," Roll Recovery (1d6 HP)"]}):e.jsxs(e.Fragment,{children:[e.jsxs(M,{onClick:S,disabled:l||n,loading:l||n,className:"w-full bg-red-600 hover:bg-red-700 text-white",size:"sm",children:[e.jsx(is,{className:"w-4 h-4 mr-1"})," Roll Death Save (d20)"]}),e.jsxs("div",{className:"relative group",children:[e.jsxs(M,{onClick:A,disabled:l||n||b,loading:l||n,className:`w-full text-black ${b?"bg-gray-400 cursor-not-allowed":"bg-yellow-500 hover:bg-yellow-600"}`,size:"sm",children:[e.jsx(xr,{className:"w-4 h-4 mr-1"})," ",b?"Rallied!":"Attempt Rally (Self)"]}),!b&&e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-60 p-2 text-xs text-white bg-black rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none",children:["Roll d20 vs WIL (",h,") with Bane. Success lets you act while dying.",e.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 bottom-[-4px] w-2 h-2 bg-black rotate-45"})]})]})]})}),n&&e.jsx("div",{className:"text-xs text-center text-blue-600 italic mt-1",children:"Saving..."})]})}function bo(){const s=Se(r=>r.activeStatusMessage),a=Se(r=>r.clearActiveStatusMessage),t=Se(r=>r.saveError);return i.useEffect(()=>{if(s){const r=setTimeout(()=>{a()},5e3);return()=>clearTimeout(r)}},[s,a]),!s&&!t?null:e.jsxs("div",{className:"fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none w-full max-w-sm px-4 sm:px-0",children:[t&&e.jsxs("div",{className:"pointer-events-auto flex items-start gap-3 bg-white border border-red-200 text-red-800 px-4 py-3 rounded-xl shadow-xl shadow-red-900/10 animate-in slide-in-from-top-5 fade-in duration-300",children:[e.jsx("div",{className:"p-1.5 bg-red-100 rounded-full shrink-0",children:e.jsx(he,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{className:"flex-col flex grow",children:[e.jsx("span",{className:"font-bold text-xs uppercase tracking-wider opacity-80 text-red-600 mb-0.5",children:"Error"}),e.jsx("span",{className:"text-sm font-medium leading-tight",children:t})]})]}),s&&e.jsxs("div",{className:"pointer-events-auto flex items-center gap-3 bg-indigo-900 text-white px-4 py-3 rounded-xl shadow-2xl shadow-indigo-900/20 animate-in slide-in-from-top-5 fade-in duration-300 border border-indigo-700/50 backdrop-blur-sm",children:[e.jsx("div",{className:"p-1.5 bg-indigo-500/30 rounded-full shrink-0",children:e.jsx(Pe,{className:"w-5 h-5 text-yellow-300"})}),e.jsxs("div",{className:"flex flex-col mr-2 grow",children:[e.jsx("span",{className:"font-bold text-[10px] uppercase tracking-wider text-indigo-300 mb-0.5",children:"System"}),e.jsx("span",{className:"text-sm font-medium leading-tight",children:s})]}),e.jsx("button",{onClick:a,className:"p-1.5 text-indigo-300 hover:text-white hover:bg-white/10 rounded-full transition-colors shrink-0",children:e.jsx(xe,{className:"w-4 h-4"})})]})]})}const Rt=({label:s,value:a})=>e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:s}),e.jsx("dd",{className:"text-base text-gray-900",children:a||e.jsx("span",{className:"text-gray-400 italic",children:"N/A"})})]}),Tt=({label:s,children:a,icon:t})=>e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2",children:[e.jsx(t,{className:"w-4 h-4 text-gray-500"}),s]}),a]});function yo({onClose:s}){const{character:a,updateCharacterData:t,isSaving:r,saveError:n}=Se(),[l,o]=i.useState("bio"),[c,x]=i.useState(!1),[g,m]=i.useState(!1),[b,p]=i.useState(!1),h=i.useRef(null),[d,v]=i.useState(""),[f,u]=i.useState(""),[N,S]=i.useState(""),[A,j]=i.useState(""),[q,C]=i.useState(""),[_,y]=i.useState(!1),w=()=>{a&&(v(a.portrait_url||""),u(a.appearance||""),S(a.memento||""),j(a.flaw||""),C(a.notes||""))};i.useEffect(()=>{w()},[a]),i.useEffect(()=>{const R=O=>{h.current&&!h.current.contains(O.target)&&p(!1)};return document.addEventListener("mousedown",R),()=>document.removeEventListener("mousedown",R)},[]);const L=async R=>{a&&(await t(R),x(!1),m(!1),y(!1))},E=()=>{w(),x(!1),m(!1)},P=()=>e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"absolute top-0 right-0",ref:h,children:[e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>p(!b),children:e.jsx(Qt,{className:"w-5 h-5"})}),b&&e.jsx("div",{className:"origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:e.jsxs("div",{className:"py-1",role:"menu","aria-orientation":"vertical",children:[e.jsxs("button",{onClick:()=>{x(!0),p(!1)},className:"w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",role:"menuitem",children:[e.jsx(zn,{className:"w-4 h-4"})," Edit Bio Details"]}),e.jsxs("button",{onClick:()=>{m(!0),p(!1)},className:"w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100",role:"menuitem",children:[e.jsx(Ea,{className:"w-4 h-4"})," Edit Portrait URL"]})]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-6 p-4 border rounded-lg shadow-sm bg-slate-50",children:[e.jsx("div",{className:"w-full md:w-1/3 flex-shrink-0",children:g?e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"portraitUrl",className:"block text-sm font-medium text-gray-700",children:"Portrait URL"}),e.jsx("input",{id:"portraitUrl",type:"text",value:d,onChange:R=>v(R.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",placeholder:"https://..."}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(M,{variant:"secondary",size:"sm",onClick:()=>{m(!1),w()},children:"Cancel"}),e.jsx(M,{size:"sm",onClick:()=>L({portrait_url:d}),disabled:r,children:r?"...":"Save"})]})]}):d?e.jsx("img",{src:d,alt:"Character Portrait",className:"w-full h-auto object-cover rounded-md border",onError:R=>{R.currentTarget.src="https://via.placeholder.com/150/CCCCCC/FFFFFF?text=Invalid+Image"}}):e.jsxs("button",{onClick:()=>m(!0),className:"w-full h-48 border-2 border-dashed rounded-md flex flex-col items-center justify-center text-gray-500 hover:bg-gray-100 hover:border-gray-400 transition-colors",children:[e.jsx(Ea,{className:"w-8 h-8 mb-2"}),e.jsx("span",{children:"Add Portrait"})]})}),e.jsxs("div",{className:"flex-grow space-y-4",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 border-b pb-2",children:a==null?void 0:a.name}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(Rt,{label:"Kin",value:a==null?void 0:a.kin}),e.jsx(Rt,{label:"Profession",value:a==null?void 0:a.profession}),e.jsx(Rt,{label:"Age",value:a==null?void 0:a.age})]}),c?e.jsxs(e.Fragment,{children:[e.jsx(Tt,{label:"Appearance",icon:Ls,children:e.jsx("textarea",{value:f,onChange:R=>u(R.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md",placeholder:"A brief description..."})}),e.jsx(Tt,{label:"Memento",icon:Ze,children:e.jsx("input",{type:"text",value:N,onChange:R=>S(R.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",placeholder:"A cherished item..."})}),e.jsx(Tt,{label:"Flaw",icon:Hn,children:e.jsx("input",{type:"text",value:A,onChange:R=>j(R.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md",placeholder:"A personal weakness..."})})]}):e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-600",children:"Appearance"}),e.jsx("p",{className:"text-gray-800 text-sm",children:f||e.jsx("i",{className:"text-gray-500",children:"Not set."})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-600",children:"Memento"}),e.jsx("p",{className:"text-gray-800 text-sm",children:N||e.jsx("i",{className:"text-gray-500",children:"Not set."})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-600",children:"Flaw"}),e.jsx("p",{className:"text-gray-800 text-sm",children:A||e.jsx("i",{className:"text-gray-500",children:"Not set."})})]})]})]})]}),c&&e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx(M,{variant:"secondary",onClick:E,children:"Cancel"}),e.jsx(M,{icon:Ae,onClick:()=>L({appearance:f,memento:N,flaw:A}),disabled:r,children:r?"Saving...":"Save Changes"})]})]}),k=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-end mb-4 gap-2",children:_?e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"secondary",onClick:()=>{C((a==null?void 0:a.notes)||""),y(!1)},children:"Cancel"}),e.jsx(M,{onClick:()=>L({notes:q}),disabled:r,icon:Ae,children:r?"Saving...":"Save Backstory"})]}):e.jsx(M,{onClick:()=>y(!0),icon:Jt,children:"Edit Backstory"})}),_?e.jsx("textarea",{value:q,onChange:R=>C(R.target.value),rows:15,className:"w-full px-3 py-2 border border-gray-300 rounded-md",placeholder:"Write your character's life story here..."}):e.jsx("div",{className:"p-4 bg-gray-50 rounded-md border min-h-[200px]",children:q?e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:q}):e.jsx("p",{className:"text-gray-500 italic",children:"No backstory has been written yet."})})]});return a?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",onClick:s,children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl h-[80vh] flex flex-col",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Character Biography"}),e.jsx("p",{className:"text-sm text-gray-500",children:"View and edit personal details and history."})]}),e.jsx(M,{variant:"ghost",size:"icon",onClick:s,"aria-label":"Close modal",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"border-b border-gray-200 px-6",children:e.jsxs("nav",{className:"-mb-px flex space-x-8","aria-label":"Tabs",children:[e.jsxs("button",{onClick:()=>o("bio"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${l==="bio"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(os,{className:"w-5 h-5"})," Bio"]}),e.jsxs("button",{onClick:()=>o("backstory"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${l==="backstory"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(Je,{className:"w-5 h-5"})," Backstory"]})]})}),e.jsxs("div",{className:"p-6 overflow-y-auto flex-1",children:[n&&e.jsxs("div",{className:"mb-4 p-3 bg-red-100 border border-red-300 text-red-800 rounded-md flex items-center gap-2",children:[e.jsx(bs,{className:"w-5 h-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Save Error"}),e.jsx("p",{className:"text-sm",children:n})]})]}),l==="bio"?P():k()]})]})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-3xl h-[80vh] flex items-center justify-center",children:[e.jsx(oe,{}),e.jsx("span",{className:"ml-2",children:"Loading character data..."})]})})}const qs={actions:{title:"Actions",icon:Je,sections:[{title:"Common Actions",items:[{title:"Dash",description:"Doubles your movement rate for the round."},{title:"Pick Up Item",description:"Pick up an item within 2 meters or from your inventory."},{title:"Equip/Unequip",description:"Change your equipped armor, helmet, or weapons."},{title:"Break Down Door",description:"Use your action to damage a door or obstacle."},{title:"Pick Lock",description:"Requires a SLEIGHT OF HAND roll (bane without lockpicks)."},{title:"Use Item",description:"Use a potion or other consumable item."},{title:"Activate Ability",description:"Use one of your innate or heroic abilities."},{title:"Cast Spell",description:"Casting a spell typically counts as your action."},{title:"Helping",description:"Grant another character a boon on a roll by helping them."}]},{title:"Free Actions",items:[{title:"Draw Weapon",description:"Draw, exchange, or put away a weapon kept at hand."},{title:"Change Position",description:"Drop prone or stand up from being prone."},{title:"Drop Item",description:"Drop an item you are holding onto the ground."},{title:"Shout",description:"Say or shout a few words."}]}]},combat:{title:"Combat",icon:Bt,sections:[{title:"Attack Actions",items:[{title:"Melee Attack",description:"Attack an enemy within 2 meters (4m for long weapons)."},{title:"Ranged Attack",description:"Use a ranged weapon against targets within its range."},{title:"Parry",description:"A reaction to negate a melee or ranged attack (requires a shield for ranged). Replaces your next action."},{title:"Dodge",description:"A reaction to avoid a melee or ranged attack. Replaces your next action."},{title:"Durability",description:"If your parry succeeds, the enemys attack hits your weapon or shield, and you suffer no damage. How-ever, if the damage exceeds your weapons durability, the weapon is damaged and cannot be used until it is repaired with a CRAFTING roll."}]},{title:"Special Attacks",items:[{title:"Find Weak Spot",description:"Take a bane on your attack. If you hit, the enemy is treated as unarmored."},{title:"Topple",description:"Opposed roll (your weapon skill vs enemy EVADE) to knock an enemy prone."},{title:"Disarm",description:"Opposed roll (your weapon skill vs enemy's) to make them drop their weapon."},{title:"Grapple",description:"Opposed BRAWLING roll to trap an enemy. Both you and the enemy fall to the ground."},{title:"Shove",description:"If your STR bonus is higher than the enemy's, you can push them 2 meters on a successful hit."}]},{title:"Sneak Attack & Ambush",items:[{title:"Sneak Attack",description:"If you approach undetected, roll Sneaking (with a bane if moving within 2 meters). On failure, youre noticed and initiative is drawn. On success, the attack is surprising: you pick initiative, gain a boon on the attack, and the target cannot dodge or parry. With a Subtle weapon, damage increases by one die. Sneak attacks are always made by a single attacker against a single target."},{title:"Ambush",description:"A sneak attack made from hiding. Each victim rolls Awareness (with a bane if attackers are well prepared). Those who fail draw initiative cards from the bottom of the deck (#10 and up) at random."}]},{title:"Damage Types & Armor",items:[{title:"Leather/Studded",description:"Gains a +2 bonus to its armor rating against Bludgeoning damage."},{title:"Chainmail",description:"Gains a +2 bonus to its armor rating against Slashing damage."}]}]},health:{title:"Health",icon:us,sections:[{title:"Healing & Resting",items:[{title:"First Aid",description:"Use the HEALING skill to save a dying character at zero HP."},{title:"Rally",description:"Use PERSUASION to get an ally at 0 HP back into the fight."},{title:"Round Rest",description:"(10 sec) Recover D6 WP. Once per shift."},{title:"Stretch Rest",description:"(15 min) Heal D6 HP (2D6 with a Healer), recover D6 WP, and heal one condition. Once per shift."},{title:"Shift Rest",description:"(6 hours) In a safe location, recover all HP & WP and heal all conditions."}]},{title:"Severe Injuries",description:"If you are reduced to zero HP but survive, you may suffer a severe injury. The healing time is halved with medical care (a successful HEALING roll each shift).",items:[{title:"Broken Nose (D6 Days)",description:"Bane on all AWARENESS rolls."},{title:"Scarred Face (2D6 Days)",description:"Bane on all PERFORMANCE and PERSUASION rolls."},{title:"Broken Ribs (D6 Days)",description:"Bane on all skills based on STR or AGL."},{title:"Deep Wounds (2D6 Days)",description:"Bane on STR/AGL skills. Every roll against such a skill inflicts D6 damage."},{title:"Broken Leg (3D6 Days)",description:"Your movement rate is halved."}]}]},journeys:{title:"Journeys",icon:hr,sections:[{title:"Wilderness Travel",items:[{title:"Pathfinder",description:"In pathless terrain, one character must be the pathfinder."},{title:"Hunger",description:"You must eat at least one ration of food per day. After one day without food you become famished and cannot heal HP, WP, or conditions except through magic."},{title:"Bushcraft Roll",description:"The pathfinder must make a BUSHCRAFT roll every shift to find the way. Failure results in a mishap."},{title:"Rolling a Dragon",description:"The pathfinder finds a shortcut, doubling the distance covered in the shift."},{title:"Difficult Terrain",description:"If the terrain is difficult (swamp, dense jungle), the BUSHCRAFT roll gets a bane."}]},{title:"Mishaps (Examples)",items:[{title:"Fog",description:"Distance covered this shift is halved."},{title:"Lost",description:"The party makes no progress this shift and must roll again to find the way."},{title:"Sprained Ankle",description:"A random character suffers D6 damage."},{title:"Savage Animal",description:"A wild animal feels threatened and attacks the party."},{title:"Quicksand",description:"The ground collapses! Everyone must make a BUSHCRAFT roll to avoid sinking."}]}]}};function jo({onClose:s}){const[a,t]=i.useState("actions"),r=qs[a].icon,n=()=>{const l=qs[a];return e.jsx("div",{className:"space-y-8",children:l.sections.map(o=>e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-lg mb-3 text-gray-800 border-b pb-2",children:o.title}),o.description&&e.jsx("p",{className:"text-sm text-gray-600 mb-4 italic",children:o.description}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2",children:o.items.map((c,x)=>e.jsx("div",{className:`p-3 rounded-md ${Math.floor(x/2)%2===0?"bg-gray-50":"bg-white"}`,children:e.jsxs("p",{className:"text-gray-700",children:[e.jsxs("span",{className:"font-bold text-gray-900",children:[c.title,":"]})," ",c.description]})},c.title))})]},o.title))})};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full flex flex-col max-h-[90vh] shadow-xl",children:[e.jsxs("div",{className:"sticky top-0 bg-white flex justify-between items-center px-6 pt-6 pb-4 border-b z-20",children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(r,{className:"w-6 h-6 text-indigo-600"})," Player Aid"]}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"sticky top-[73px] bg-white flex border-b z-10",children:Object.keys(qs).map(l=>{const o=qs[l].icon,c=a===l;return e.jsxs("button",{onClick:()=>t(l),className:`flex-1 flex items-center justify-center gap-2 p-3 text-sm font-medium transition-colors ${c?"border-b-2 border-indigo-600 text-indigo-600 bg-indigo-50":"text-gray-500 hover:bg-gray-100 hover:text-gray-700"}`,children:[e.jsx(o,{className:"w-4 h-4"}),e.jsx("span",{children:qs[l].title})]},l)})}),e.jsx("div",{className:"overflow-y-auto p-6",children:n()})]})})}function As({content:s,className:a=""}){return e.jsx("div",{className:"bg-amber-100 p-6 rounded-lg shadow-lg",children:e.jsx(Ns,{remarkPlugins:[Ss],rehypePlugins:[ks,vl],className:`prose prose-xl max-w-none font-cinzel ${a}`,components:{h1:({node:t,...r})=>e.jsx("h1",{className:"text-4xl font-bold text-brown-800 border-b-2 border-brown-500 pb-2 mb-4",...r}),h2:({node:t,...r})=>e.jsx("h2",{className:"text-3xl font-bold text-brown-700 border-b pb-2 mb-3",...r}),h3:({node:t,...r})=>e.jsx("h3",{className:"text-2xl font-bold text-brown-600 mb-2",...r}),table:({node:t,...r})=>e.jsx("table",{className:"border-collapse border border-brown-300 my-4",...r}),th:({node:t,...r})=>e.jsx("th",{className:"border border-brown-300 px-4 py-2 bg-amber-200",...r}),td:({node:t,...r})=>e.jsx("td",{className:"border border-brown-300 px-4 py-2",...r}),blockquote:({node:t,...r})=>e.jsx("blockquote",{className:"border-l-4 border-amber-600 pl-4 my-4 italic bg-amber-50 py-2 pr-4",...r}),code:({node:t,inline:r,...n})=>r?e.jsx("code",{className:"bg-amber-200 px-1 rounded",...n}):e.jsx("code",{className:"block bg-amber-200 p-4 rounded my-4 overflow-x-auto",...n})},children:s})})}function rs({icon:s,label:a,onClick:t}){return e.jsx("button",{type:"button",onClick:t,title:a,className:"p-1.5 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded transition-all",children:e.jsx(s,{size:16})})}const vo=({character:s})=>{const[a,t]=i.useState([]),[r,n]=i.useState(!0),[l,o]=i.useState(null),[c,x]=i.useState(null),[g,m]=i.useState(!1),b=i.useRef(null),p=i.useCallback(async()=>{n(!0),o(null);try{const{data:N,error:S}=await H.from("notes").select("id, title, content, created_at, updated_at").eq("character_id",s.id).order("created_at",{ascending:!1});if(S)throw S;t(N||[])}catch(N){o(N instanceof Error?N.message:"Failed to load notes.")}finally{n(!1)}},[s.id]);i.useEffect(()=>{p()},[p]);const h=(N,S="")=>{const A=b.current;if(!A||!c)return;const j=A.selectionStart,q=A.selectionEnd,C=A.value,_=C.substring(0,j),y=C.substring(j,q),w=C.substring(q),L=_+N+y+S+w;x(E=>E?{...E,content:L}:null),setTimeout(()=>{A.focus();const E=j+N.length+y.length+S.length;A.setSelectionRange(E,E)},0)},d=()=>{h(`
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |
`)},v=async N=>{var A;if(!((A=N.title)!=null&&A.trim())){alert("Title is required.");return}const S={...N,character_id:s.id,user_id:s.user_id,updated_at:new Date().toISOString()};try{const{id:j,created_at:q,...C}=S,{error:_}=await H.from("notes").upsert(C,{onConflict:"id"});if(_)throw _;x(null),m(!1),await p()}catch(j){console.error("Error saving note:",j),alert(j instanceof Error?`Failed to save note: ${j.message}`:"An unknown error occurred.")}},f=async N=>{if(window.confirm("Are you sure you want to delete this note?"))try{const{error:S}=await H.from("notes").delete().eq("id",N);if(S)throw S;await p()}catch(S){alert(S instanceof Error?`Failed to delete note: ${S.message}`:"An unknown error occurred.")}},u=()=>{x({title:"",content:""}),m(!1)};return r?e.jsx("div",{className:"p-4",children:e.jsx(oe,{size:"sm"})}):l?e.jsx("div",{className:"p-4",children:e.jsx(ie,{message:l})}):e.jsxs("div",{className:"bg-white p-4 rounded-lg border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-2 text-gray-700",children:[e.jsx(ms,{className:"w-5 h-5 text-yellow-600"})," Character Notes"]}),e.jsx(M,{size:"xs",icon:ye,onClick:u,children:"New Note"})]}),e.jsx("div",{className:"space-y-2",children:a.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic text-center py-4",children:"No notes for this character yet."}):a.map(N=>e.jsxs("div",{className:"p-3 rounded-md border border-gray-100 hover:bg-gray-50 flex justify-between items-center transition-colors",children:[e.jsxs("div",{children:[e.jsx("button",{onClick:()=>x(N),className:"text-sm font-bold text-gray-800 hover:text-blue-600 text-left block",children:N.title}),e.jsx("span",{className:"text-xs text-gray-400",children:new Date(N.created_at).toLocaleDateString()})]}),e.jsx(M,{variant:"danger_outline",size:"xs",icon:Le,onClick:()=>f(N.id)})]},N.id))}),c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-3xl w-full p-6 shadow-xl flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 border-b pb-2",children:[e.jsx("h4",{className:"text-lg font-semibold",children:c.id?"Edit Note":"New Note"}),e.jsx("button",{onClick:()=>x(null),children:e.jsx(xe,{className:"w-6 h-6 text-gray-500 hover:text-gray-800"})})]}),e.jsxs("div",{className:"overflow-y-auto flex-grow space-y-4 pr-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-1",children:"Title"}),e.jsx("input",{type:"text",placeholder:"Note Title",value:c.title||"",onChange:N=>x(S=>S?{...S,title:N.target.value}:null),className:"w-full font-bold text-lg p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-end mb-1",children:[e.jsxs("label",{className:"block text-sm font-bold text-gray-700",children:["Content ",e.jsx("span",{className:"text-xs font-normal text-gray-400",children:"(Markdown)"})]}),e.jsx("button",{type:"button",onClick:()=>m(!g),className:"text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium",children:g?e.jsxs(e.Fragment,{children:[e.jsx(Zt,{size:14})," Edit"]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:14})," Preview"]})})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden border-gray-300 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all",children:[!g&&e.jsxs("div",{className:"flex items-center gap-1 p-2 bg-gray-50 border-b border-gray-200 overflow-x-auto",children:[e.jsx(rs,{icon:Xt,label:"Bold",onClick:()=>h("**","**")}),e.jsx(rs,{icon:ea,label:"Italic",onClick:()=>h("*","*")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(rs,{icon:sa,label:"Heading",onClick:()=>h("# ","")}),e.jsx(rs,{icon:ta,label:"Quote",onClick:()=>h("> ","")}),e.jsx(rs,{icon:gt,label:"Code Block",onClick:()=>h("```\n","\n```")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(rs,{icon:ft,label:"Bullet List",onClick:()=>h("- ","")}),e.jsx(rs,{icon:aa,label:"Numbered List",onClick:()=>h("1. ","")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(rs,{icon:bt,label:"Link",onClick:()=>h("[","](url)")}),e.jsx(rs,{icon:ra,label:"Table",onClick:d})]}),g?e.jsx("div",{className:"p-4 h-[400px] overflow-y-auto prose prose-sm max-w-none bg-gray-50/50",children:e.jsx(As,{content:c.content||"*No content*"})}):e.jsx("textarea",{ref:b,placeholder:"Write your note here...",value:c.content||"",onChange:N=>x(S=>S?{...S,content:N.target.value}:null),className:"w-full p-3 h-[400px] font-mono text-sm outline-none resize-none bg-white"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6 border-t pt-4",children:[e.jsx(M,{variant:"outline",onClick:()=>x(null),children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:()=>v(c),children:"Save Note"})]})]})})]})},er=({label:s,icon:a,currentValue:t,maxValue:r,onDecrement:n,onIncrement:l,isSaving:o,colorClass:c})=>{const x=r>0?t/r*100:0;return e.jsxs("div",{className:"p-3 rounded-lg shadow bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-semibold flex items-center gap-1.5 text-sm",children:[e.jsx(a,{className:`w-4 h-4 ${s==="HP"?"text-red-600":"text-blue-600"}`})," ",s]}),e.jsxs("span",{className:"text-sm font-medium",children:[t," / ",r]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:n,className:"p-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 disabled:opacity-50",disabled:o||t<=0,title:`Decrease ${s}`,children:e.jsx(Wt,{className:"w-3 h-3"})}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:`${c} h-2.5 rounded-full transition-all`,style:{width:`${x}%`}})}),e.jsx("button",{onClick:l,className:"p-1 text-xs bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 disabled:opacity-50",disabled:o||t>=r,title:`Increase ${s}`,children:e.jsx(ye,{className:"w-3 h-3"})})]})]})};function wo({}){var I,B,Y,Q,D,G,$;Be();const{toggleDiceRoller:s}=ze(),{character:a,fetchCharacter:t,adjustStat:r,toggleCondition:n,performRest:l,isLoading:o,error:c,isSaving:x,saveError:g}=Se(),[m,b]=i.useState(!1),[p,h]=i.useState(!1),[d,v]=i.useState(!1),[f,u]=i.useState(!1),[N,S]=i.useState(!1),[A,j]=i.useState(!1),[q,C]=i.useState(!1),[_,y]=i.useState(!1),[w,L]=i.useState("equipment");if(o)return e.jsx("div",{className:"p-4 text-center",children:"Loading character..."});if(c)return e.jsxs("div",{className:"p-4 text-center text-red-500",children:["Error loading character: ",c]});if(!a)return e.jsx("div",{className:"p-4 text-center",children:"Character data not available."});const E=Z=>{n(Z)},P=async Z=>{h(!1),await l(Z,Z==="stretch"?_:void 0),y(!1)},k=(Z,ee,re,K)=>{var le;const W=ee??10,se=((le=a.conditions)==null?void 0:le[K])??!1;return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"p-4 bg-gray-800 rounded-lg text-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-medium",children:Z}),e.jsx("span",{className:"text-xl",children:W})]}),e.jsx("div",{className:"text-sm h-5",children:(Z==="STR"||Z==="AGL")&&W>12&&e.jsxs("div",{className:"text-blue-400",children:["Damage Bonus: ",W<=15?"+D4":"+D6"]})})]}),e.jsx("button",{onClick:()=>E(K),className:`absolute -bottom-3 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-full text-xs font-medium transition-colors ${se?"bg-red-600 text-white hover:bg-red-700":"bg-gray-200 text-gray-700 hover:bg-gray-300"} ${x?"opacity-50":""}`,disabled:x,title:`Toggle ${K}`,children:K.toUpperCase().substring(0,3)})]})},R=()=>p?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(Aa,{className:"w-6 h-6"})," Choose Rest Type"]}),e.jsx("button",{onClick:()=>{h(!1),y(!1)},className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("button",{onClick:()=>P("shift"),className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",disabled:x,children:x?"Resting...":"Take Shift Rest"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[e.jsx("strong",{children:"Shift Rest (~6 hours):"})," Requires a safe location. Recovers all HP & WP, heals all standard conditions."]})]}),e.jsxs("div",{children:[e.jsx("button",{onClick:()=>P("stretch"),className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50",disabled:x||((a==null?void 0:a.current_hp)??0)<=0,children:x?"Resting...":"Take Stretch Rest"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[e.jsx("strong",{children:"Stretch Rest (~15 mins):"})," Heal ",_?"2d6":"1d6"," HP, recover 1d6 WP, heal one condition. Cannot be taken while dying."]})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:Z=>y(Z.target.checked),className:"rounded border-gray-300"}),e.jsx("span",{children:"Healer present for Stretch Rest"})]})}),e.jsxs("div",{children:[e.jsx("button",{onClick:()=>P("round"),className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50",disabled:x,children:x?"Resting...":"Take Round Rest"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[e.jsx("strong",{children:"Round Rest (~10 secs):"})," Recover 1d6 WP. No HP recovery."]})]})]}),x&&e.jsx("div",{className:"mt-4 text-sm text-center text-gray-500",children:"Saving..."}),g&&e.jsxs("div",{className:"mt-4 text-sm text-center text-red-500",children:["Error: ",g]})]})}):null,O=()=>{var ee;const Z=Object.keys((a==null?void 0:a.skill_levels)||{});return((ee=a==null?void 0:a.profession)==null?void 0:ee.endsWith("Mage"))||Z.some(re=>["ELEMENTALISM","ANIMISM","MENTALISM"].includes(re.toUpperCase()))},z=(a==null?void 0:a.current_hp)??0,F=(a==null?void 0:a.current_wp)??0,U=(a==null?void 0:a.max_hp)??10,T=(a==null?void 0:a.max_wp)??10;return e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-start gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:a.name}),e.jsxs("p",{className:"text-gray-600 text-lg",children:[a.kin," ",a.profession," - Age: ",a.age]})]}),e.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>j(!0),className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm",children:[e.jsx(Bn,{className:"w-4 h-4"})," Bio"]}),e.jsxs("button",{onClick:()=>u(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm",children:[e.jsx(fs,{className:"w-4 h-4"})," Inventory"]}),e.jsxs("button",{onClick:()=>h(!0),className:"flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 text-sm",children:[e.jsx(Aa,{className:"w-4 h-4"})," Rest"]}),e.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-2 px-4 py-2 bg-yellow-500 text-black rounded-lg hover:bg-yellow-600 text-sm",children:[e.jsx(ht,{className:"w-4 h-4"})," Session"]}),e.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm",children:[e.jsx(Un,{className:"w-4 h-4"})," Actions"]})]})]}),e.jsx(bo,{}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-4 gap-y-6",children:[k("STR",(I=a.attributes)==null?void 0:I.STR,e.jsx(Gn,{}),"exhausted"),k("CON",(B=a.attributes)==null?void 0:B.CON,e.jsx(us,{}),"sickly"),k("AGL",(Y=a.attributes)==null?void 0:Y.AGL,e.jsx(Wn,{}),"dazed"),k("INT",(Q=a.attributes)==null?void 0:Q.INT,e.jsx(or,{}),"angry"),k("WIL",(D=a.attributes)==null?void 0:D.WIL,e.jsx(Pe,{}),"scared"),k("CHA",(G=a.attributes)==null?void 0:G.CHA,e.jsx(Kn,{}),"disheartened")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-start",children:[e.jsxs("div",{className:"md:col-span-6 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("button",{onClick:()=>v(!0),className:"flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm",children:[e.jsx(Gs,{className:"w-4 h-4"})," Skills"]}),O()&&e.jsxs("button",{onClick:()=>b(!0),className:"flex items-center gap-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm",children:[e.jsx(Es,{className:"w-4 h-4"})," Spells"]})]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-gray-800 text-white rounded-lg text-sm self-start",children:[e.jsx("span",{className:"font-medium",children:"Movement:"}),e.jsxs("span",{className:"font-bold text-lg",children:[Ii(a.kin,($=a.attributes)==null?void 0:$.AGL),"m"]})]})]}),e.jsxs("div",{className:"md:col-span-6 grid grid-cols-1 sm:grid-cols-2 gap-4",children:[z>0?e.jsx(er,{label:"HP",icon:Yt,currentValue:z,maxValue:U,onDecrement:()=>r("current_hp",-1),onIncrement:()=>r("current_hp",1),isSaving:x,colorClass:"bg-red-500"}):e.jsx(fo,{character:a}),e.jsx(er,{label:"WP",icon:Pe,currentValue:F,maxValue:T,onDecrement:()=>r("current_wp",-1),onIncrement:()=>r("current_wp",1),isSaving:x,colorClass:"bg-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsxs("nav",{className:"-mb-px flex space-x-6","aria-label":"Tabs",children:[e.jsxs("button",{onClick:()=>L("equipment"),className:`flex items-center gap-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${w==="equipment"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Me,{className:"w-5 h-5"})," Equipment"]}),e.jsxs("button",{onClick:()=>L("abilities"),className:`flex items-center gap-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${w==="abilities"?"border-orange-500 text-orange-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Vt,{className:"w-5 h-5"})," Heroic Abilities"]}),e.jsxs("button",{onClick:()=>L("notes"),className:`flex items-center gap-2 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${w==="notes"?"border-yellow-500 text-yellow-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:[e.jsx(ms,{className:"w-5 h-5"})," Notes"]})]})}),e.jsxs("div",{className:"mt-4",children:[w==="equipment"&&e.jsx(no,{character:a}),w==="abilities"&&e.jsx(co,{}),w==="notes"&&e.jsx(vo,{character:a})]})]}),A&&e.jsx(yo,{onClose:()=>j(!1)}),d&&e.jsx(qi,{onClose:()=>v(!1)}),m&&e.jsx(Bi,{onClose:()=>b(!1)}),f&&e.jsx(Zi,{onClose:()=>u(!1)}),N&&e.jsx(go,{character:a,onClose:()=>{S(!1),a!=null&&a.id&&(a!=null&&a.user_id)&&t(a.id,a.user_id)}}),q&&e.jsx(jo,{onClose:()=>C(!1)}),R(),x&&e.jsx("div",{className:"fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md text-sm z-50 animate-pulse",children:" Saving... "}),g&&e.jsxs("div",{className:"fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-md text-sm z-50",children:[" Save Error: ",g," "]})]})}const No=({combatant:s})=>{var f;const{setInitiativeForCombatant:a,updateCombatant:t,isSaving:r,character:n}=Se(),[l,o]=i.useState(((f=s.initiative_roll)==null?void 0:f.toString())??"");i.useEffect(()=>{var u;o(((u=s.initiative_roll)==null?void 0:u.toString())??"")},[s.initiative_roll]);const c=()=>{const u=parseInt(l,10);!isNaN(u)&&u>=1&&u<=10&&a(s.id,u)},x=()=>{t(s.id,{has_acted:!s.has_acted})},g=s.character_id===(n==null?void 0:n.id),m=!!s.character_id,b=s.has_acted||!1,h=!m&&s.current_hp===0,d=m&&s.current_hp===0;let v=m?"border-teal-600 bg-teal-50":"border-orange-700 bg-orange-50";return h?v="border-stone-400 bg-stone-200 opacity-70":b&&(v="border-stone-300 bg-stone-100 opacity-70 grayscale"),e.jsxs("div",{className:`relative p-3 rounded-lg border-l-4 shadow-sm transition-all ${v}`,children:[h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-0 opacity-20",children:e.jsx("span",{className:"text-3xl font-black uppercase -rotate-12 text-black",children:"Defeated"})}),e.jsxs("div",{className:"relative z-10 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:`font-bold ${b||h?"text-stone-500 line-through":"text-stone-900"}`,children:s.display_name}),d&&e.jsxs("span",{className:"text-xs font-bold text-red-600 flex items-center gap-1",children:[e.jsx(is,{size:12})," DYING"]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm font-mono bg-white/50 px-2 py-1 rounded",children:[e.jsx(us,{className:`w-3 h-3 ${s.current_hp===0?"text-stone-400":"text-red-600"}`}),e.jsxs("span",{children:[s.current_hp," / ",s.max_hp]})]})]}),e.jsxs("div",{className:"relative z-10 mt-3 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:(!s.initiative_roll||g)&&!h?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",value:l,onChange:u=>o(u.target.value),placeholder:"#",className:"w-12 px-1 py-0.5 text-center border rounded text-sm font-bold",min:"1",max:"10",disabled:r}),!s.initiative_roll&&e.jsx(M,{onClick:c,size:"xs",variant:"secondary",disabled:r,children:"Set"})]}):e.jsx("div",{className:"w-8 h-8 bg-white border-2 border-stone-800 rounded flex items-center justify-center font-serif font-bold text-lg shadow-sm",children:s.initiative_roll})}),(g||!m)&&!h&&e.jsxs(M,{onClick:x,size:"xs",variant:b?"ghost":"outline",className:b?"text-stone-500":"text-stone-800 border-stone-400 bg-white",children:[b?e.jsx(na,{size:14,className:"mr-1"}):e.jsx(mt,{size:14,className:"mr-1"}),b?"Recover":"Flip / Reaction"]})]})]})};function Gr(){const{character:s,activeEncounter:a,encounterCombatants:t,isLoadingEncounter:r,fetchActiveEncounter:n}=Se(),[l,o]=i.useState(!1);if(i.useEffect(()=>{if(!(s!=null&&s.party_id)||!(s!=null&&s.id))return;const g=s.party_id,m=s.id,b=H.channel(`party-encounter-updates-${g}`),p=()=>{console.log("Syncing encounter data..."),n(g,m)};return b.on("postgres_changes",{event:"*",schema:"public",table:"encounters",filter:`party_id=eq.${g}`},p).on("postgres_changes",{event:"*",schema:"public",table:"encounter_combatants"},p).subscribe(),()=>{H.removeChannel(b)}},[s,n]),!s)return null;const c=(a==null?void 0:a.status)==="active",x=[...t].sort((g,m)=>{const b=g.initiative_roll??1e3,p=m.initiative_roll??1e3;return b!==p?b-p:(g.display_name??"").localeCompare(m.display_name??"")});return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`fixed bottom-4 right-4 p-4 rounded-full shadow-lg text-white transition-all duration-200 z-40 hover:scale-105 ${c?"bg-red-700 hover:bg-red-800 ring-2 ring-red-400 animate-pulse-slow":"bg-blue-600 hover:bg-blue-700"}`,onClick:()=>o(!l),children:c?e.jsx(be,{size:24}):e.jsx(Vn,{size:24})}),l&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex justify-end z-30 backdrop-blur-sm",onClick:()=>o(!1),children:e.jsxs("div",{className:"bg-stone-100 w-full max-w-sm h-full shadow-2xl flex flex-col border-l border-stone-300",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-stone-800 text-white shadow-md",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold font-serif tracking-wide",children:c?"Combat":"Party Chat"}),c&&e.jsxs("span",{className:"text-xs text-green-400 uppercase font-bold",children:["Round ",a.current_round]})]}),e.jsx("button",{onClick:()=>o(!1),className:"text-stone-400 hover:text-white",children:e.jsx(xe,{size:24})})]}),e.jsx("div",{className:"flex-grow p-4 overflow-y-auto space-y-4 bg-[url('/parchment-bg.png')] bg-repeat",children:r&&!a?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(Ye,{className:"w-8 h-8 animate-spin text-stone-500"})}):a?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-3 rounded shadow-sm border border-stone-200",children:[e.jsx("h3",{className:"font-bold text-lg text-stone-800",children:a.name}),e.jsx("p",{className:"text-xs text-stone-500",children:a.description||"No description"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex justify-between items-end border-b border-stone-300 pb-1",children:e.jsx("h4",{className:"font-bold text-stone-600 uppercase text-xs tracking-wider",children:"Initiative Track"})}),x.length>0?x.map(g=>e.jsx(No,{combatant:g},g.id)):e.jsx("p",{className:"text-sm text-stone-500 italic text-center py-4",children:"The battlefield is empty."})]})]}):e.jsx("div",{className:"text-stone-500 text-center mt-10 italic",children:"The party is resting."})})]})})]})}function ko(){const{id:s}=la(),{user:a}=Ce(),{character:t,isLoading:r,error:n,fetchCharacter:l,setCharacter:o}=Se();return i.useEffect(()=>{(async()=>{s&&(a!=null&&a.id)?await l(s,a.id):(o(null),console.warn("CharacterPage: Character ID or User ID is missing. Cannot load character."))})()},[s,a==null?void 0:a.id,l,o]),r?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(oe,{size:"lg"})}):n?e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:n})}):t?e.jsxs(e.Fragment,{children:[e.jsx(wo,{}),e.jsx(Gr,{})]}):e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:"Character not found, does not exist, or you may not have permission to view it."})})}function ua(s){return wl(s,{extensions:[kl()],htmlExtensions:[Nl()]})}function So(s){return`<div class="monster-block">${ua(s)}</div>`}function Co(s){return`<div class="note-block">${ua(s)}</div>`}function _o(s){return`<div class="spell-block">${ua(s)}</div>`}function Hs(){return s=>{Yn(s,"code",a=>{var n;const t=(n=a.lang)==null?void 0:n.toLowerCase();let r;switch(t){case"monster":r=So(a.value);break;case"note":r=Co(a.value);break;case"spell":r=_o(a.value);break}r&&(a.type="html",a.value=r)})}}function Eo({content:s,className:a=""}){return e.jsx("div",{className:`phb ${a}`,children:e.jsx(Ns,{remarkPlugins:[Ss,Hs],rehypePlugins:[ks],children:s})})}const Ao=`\`\`\`\`markdown
\`\`\`monster
## Monster Name
*Size type (tag), alignment*
___
- **Armor Class** 10
- **Hit Points** 10 (3d6)
- **Speed** 30 ft.
___
|STR|DEX|CON|INT|WIS|CHA|
|:---:|:---:|:---:|:---:|:---:|:---:|
|10 (+0)|10 (+0)|10 (+0)|10 (+0)|10 (+0)|10 (+0)|
___
- **Senses** passive Perception 10
- **Languages** --
- **Challenge** 1 (200 XP)
___
***Trait Name.*** Trait description.
### Actions
***Action Name.*** *Attack Style:* +0 to hit, reach 5 ft., one target. *Hit:* 1 (1d4) damage type.
\`\`\`
\`\`\`\``,Mo="````markdown\n```note\nYour content here. Use standard markdown for paragraphs, lists, etc.\n```\n````",Lo="````markdown\n```spell\n#### Spell Name\n*level School*\n___\n- **Casting Time:** 1 Action\n- **Range:** 60 feet\n- **Components:** V, S, M (a pinch of salt)\n- **Duration:** Instantaneous\n___\nSpell description goes here.\n\n***At Higher Levels.*** When you cast this spell...\n```\n````",Ro={name:"monsterBlock",keyCommand:"monsterBlock",buttonProps:{"aria-label":"Insert Monster Block"},icon:e.jsx(Me,{size:12}),execute:(s,a)=>{a.replaceSelection(Ao)}},To={name:"noteBlock",keyCommand:"noteBlock",buttonProps:{"aria-label":"Insert Note Block"},icon:e.jsx(ms,{size:12}),execute:(s,a)=>{a.replaceSelection(Mo)}},Io={name:"spellBlock",keyCommand:"spellBlock",buttonProps:{"aria-label":"Insert Spell Block"},icon:e.jsx(Je,{size:12}),execute:(s,a)=>{a.replaceSelection(Lo)}};function Do({entry:s,onClose:a,onSave:t}){const[r,n]=i.useState(s),[l,o]=i.useState(!1),c=async()=>{o(!0);try{await t(r)}finally{o(!1)}};return e.jsxs("div",{className:"fixed inset-0 bg-white z-50 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"border-b p-4 flex items-center justify-between bg-white flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(M,{variant:"secondary",icon:Kt,onClick:a,children:"Back"}),e.jsxs("h2",{className:"text-xl font-bold",children:["Editing: ",r.title]})]}),e.jsx(M,{variant:"primary",icon:Ae,onClick:c,loading:l,children:"Save"})]}),e.jsx("div",{className:"p-4 border-b bg-gray-50 flex-shrink-0",children:e.jsxs("div",{className:"max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:r.title,onChange:x=>n({...r,title:x.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsx("input",{type:"text",value:r.category,onChange:x=>n({...r,category:x.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md"})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden","data-color-mode":"light",children:e.jsx(qt,{height:"100%",value:r.content,onChange:x=>{n({...r,content:x||""})},previewOptions:{style:{backgroundColor:"transparent",padding:0},wrapper:({children:x})=>e.jsx("div",{className:"phb",children:x}),components:{markdown:x=>e.jsx(Ns,{remarkPlugins:[Ss,Hs],rehypePlugins:[ks],...x})}},commands:[jr,vr,wr,Nr,Cs,kr,Sr,Cr,_r,Cs,Er,Ar,Cs,Ro,To,Io]})})]})}function Po(){const{user:s,isAdmin:a}=Ce(),t=Fe(),[r,n]=i.useState(""),[l,o]=i.useState(null),[c,x]=i.useState(null),[g,m]=i.useState([]),[b,p]=i.useState(new Set),{data:h=[],isLoading:d,error:v}=we({queryKey:["compendiumEntries"],queryFn:oi});i.useEffect(()=>{const C=localStorage.getItem("compendium_bookmarks");if(C)try{m(JSON.parse(C))}catch(_){console.error("Failed to parse bookmarks",_)}},[]);const f=C=>{const _=C.content.replace(/[#*`]/g,"").slice(0,120)+"...";m(y=>{const L=y.some(E=>E.id===C.id)?y.filter(E=>E.id!==C.id):[...y,{...C,preview:_}];return localStorage.setItem("compendium_bookmarks",JSON.stringify(L)),L})},u=C=>{p(_=>{const y=new Set(_);return y.has(C)?y.delete(C):y.add(C),y})},N=ge({mutationFn:async C=>{const _={title:C.title,content:C.content,category:C.category};if(C.id){const{error:y}=await H.from("compendium").update(_).eq("id",C.id);if(y)throw y}else{const{error:y}=await H.from("compendium").insert([{..._,created_by:s==null?void 0:s.id}]);if(y)throw y}},onSuccess:()=>{t.invalidateQueries({queryKey:["compendiumEntries"]}),x(null)},onError:C=>console.error("Save error:",C)}),S=i.useMemo(()=>{if(!r)return h;const C=r.toLowerCase();return h.filter(_=>{var y;return _.title.toLowerCase().includes(C)||((y=_.category)==null?void 0:y.toLowerCase().includes(C))})},[h,r]),A=i.useMemo(()=>{const C=S.reduce((_,y)=>{const w=y.category||"Uncategorized";return _[w]||(_[w]=[]),_[w].push(y),_},{});return Object.entries(C).sort(([_],[y])=>_.localeCompare(y))},[S]),j=()=>{x({id:void 0,title:"New Entry",content:`# New Entry
Write your content here...`,category:"General",created_by:s==null?void 0:s.id})};if(d)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(oe,{size:"lg"})});if(v)return e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:v.message})});const q=C=>g.some(_=>_.id===C);return e.jsxs("div",{className:"flex h-[calc(100vh-6rem)] bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"w-80 bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 font-bold text-gray-800 cursor-pointer hover:text-indigo-600 transition-colors",onClick:()=>o(null),children:[e.jsx(Qn,{className:"w-5 h-5"}),e.jsx("span",{children:"Compendium"})]}),a()&&e.jsx(M,{variant:"ghost",size:"icon_sm",onClick:j,title:"Create New Entry",children:e.jsx(ye,{className:"w-5 h-5 text-indigo-600"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Search...",value:r,onChange:C=>{n(C.target.value),C.target.value},className:"w-full pl-9 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2",children:A.length===0?e.jsx("p",{className:"text-center text-gray-400 text-sm py-8",children:"No entries found."}):e.jsx("div",{className:"space-y-1",children:A.map(([C,_])=>{const y=r?!0:b.has(C);return e.jsxs("div",{className:"select-none",children:[e.jsxs("button",{onClick:()=>u(C),className:"w-full flex items-center justify-between px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[y?e.jsx(Ms,{size:14,className:"text-gray-400"}):e.jsx(Qe,{size:14,className:"text-gray-400"}),C]}),e.jsx("span",{className:"text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded",children:_.length})]}),y&&e.jsx("div",{className:"mt-1 ml-2 space-y-0.5 border-l-2 border-gray-200 pl-2",children:_.map(w=>e.jsxs("button",{onClick:()=>o(w),className:`
                              w-full text-left px-3 py-2 text-sm rounded-md transition-all flex items-center justify-between group
                              ${(l==null?void 0:l.id)===w.id?"bg-white text-indigo-700 font-medium shadow-sm ring-1 ring-indigo-100":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"}
                            `,children:[e.jsx("span",{className:"truncate",children:w.title}),q(w.id)&&e.jsx(kt,{size:12,className:"text-indigo-400 fill-indigo-400 shrink-0"})]},w.id))})]},C)})})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto bg-white relative",children:l?e.jsxs("div",{className:"max-w-4xl mx-auto min-h-full flex flex-col",children:[e.jsxs("div",{className:"sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-gray-100 px-8 py-4 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-indigo-600 uppercase tracking-wide mb-1",children:l.category}),e.jsx("h1",{className:"text-2xl font-extrabold text-gray-900",children:l.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>f(l),className:q(l.id)?"text-indigo-600 bg-indigo-50":"text-gray-400",title:q(l.id)?"Remove Bookmark":"Bookmark",children:q(l.id)?e.jsx(kt,{className:"fill-current w-5 h-5"}):e.jsx(Jn,{className:"w-5 h-5"})}),a()&&e.jsx(M,{variant:"secondary",size:"sm",icon:Vs,onClick:()=>x(l),children:"Edit"})]})]}),e.jsx("div",{className:"p-8",children:e.jsx(Eo,{content:l.content})}),e.jsxs("div",{className:"mt-auto p-8 border-t border-gray-50 text-center text-gray-400 text-xs",children:["Entry Title: ",l.title]})]}):e.jsxs("div",{className:"p-8 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-10 pt-10",children:[e.jsx("div",{className:"w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Gs,{size:40})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Compendium"}),e.jsx("p",{className:"text-gray-500",children:"Select a topic from the sidebar or browse your bookmarks below."})]}),e.jsxs("div",{className:"mb-6 flex items-center gap-2 pb-2 border-b border-gray-200",children:[e.jsx(kt,{size:18,className:"text-indigo-600"}),e.jsx("h2",{className:"font-bold text-gray-800",children:"Quick Access"})]}),g.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:g.map(C=>e.jsxs("div",{onClick:()=>o(h.find(_=>_.id===C.id)||C),className:"bg-white border border-gray-200 rounded-lg p-4 cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all group relative",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h3",{className:"font-bold text-gray-800 group-hover:text-indigo-700",children:C.title}),e.jsx("span",{className:"text-[10px] uppercase font-bold text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded",children:C.category})]}),e.jsx("p",{className:"text-xs text-gray-500 line-clamp-3 leading-relaxed",children:C.preview}),e.jsxs("div",{className:"mt-3 flex items-center text-xs text-indigo-600 font-medium opacity-0 group-hover:opacity-100 transition-opacity",children:["Read Entry ",e.jsx(Qe,{size:14,className:"ml-1"})]})]},C.id))}):e.jsx("div",{className:"text-center py-12 border-2 border-dashed border-gray-200 rounded-lg bg-gray-50",children:e.jsx("p",{className:"text-gray-400 text-sm",children:"You haven't bookmarked any entries yet."})})]})}),c&&e.jsx(Do,{entry:c,onClose:()=>x(null),onSave:async C=>{await N.mutateAsync(C)}})]})}async function qo(s,a){if(!s)return[];let t=H.from("parties").select(`
    id,
    name,
    description,
    created_by,
    created_at,
    members:party_members!left (
      characters!inner (
        *
      )
    )
  `);a?t=t.eq("created_by",s):t=t.eq("members.characters.user_id",s);const{data:r,error:n}=await t.order("created_at",{ascending:!1});if(n)throw console.error("Error fetching parties:",n),new Error(n.message||"Failed to fetch parties");return(r||[]).map(o=>({...o,members:(o.members||[]).map(c=>c.characters?Rs(c.characters):null).filter(c=>!!c)}))}async function Wr(s){if(!s)return[];const{data:a,error:t}=await H.from("party_members").select("character_id");if(t)throw console.error("Error fetching party member IDs:",t),new Error(t.message||"Failed to fetch member data");const r=(a||[]).map(c=>c.character_id);let n=H.from("characters").select("*").eq("user_id",s);r.length>0&&(n=n.not("id","in",`(${r.join(",")})`));const{data:l,error:o}=await n;if(o)throw console.error("Error fetching available characters:",o),new Error(o.message||"Failed to fetch available characters");return(l||[]).map(Rs)}async function Fo(s){if(!s)return null;const a=`
    id,
    name,
    description,
    created_by,
    created_at,
    invite_code,
    members:party_members (
      characters (
        id,
        user_id,
        name,
        kin,
        profession,
        attributes,
        max_hp,
        current_hp,
        max_wp,
        current_wp,
        skill_levels,
        spells,
        heroic_ability,
        equipment,
        conditions,
        weak_spot 
      )
    )
  `,{data:t,error:r}=await H.from("parties").select(a).eq("id",s).single();if(r)throw console.error("Error fetching party by ID:",r),r.code==="PGRST116"?new Error("Party not found"):new Error(r.message||"Failed to fetch party");return t?{...t,members:(t.members||[]).map(l=>l.characters?Rs(l.characters):null).filter(l=>!!l)}:null}async function Kr(s,a){const{error:t}=await H.from("party_members").delete().match({party_id:s,character_id:a});if(t)throw console.error("Error removing party member:",t),new Error(t.message||"Failed to remove party member");const{error:r}=await H.from("characters").update({party_id:null}).eq("id",a);r&&console.error("Error clearing character party link:",r)}async function $o(s){const{error:a}=await H.from("parties").delete().eq("id",s);if(a)throw console.error("Error deleting party:",a),new Error(a.message||"Failed to delete party")}function Oo(){const{user:s,isDM:a}=Ce(),t=Be(),r=Fe(),[n,l]=i.useState(!1),[o,c]=i.useState(""),[x,g]=i.useState([]),{data:m=[],isLoading:b,error:p}=we({queryKey:["parties",s==null?void 0:s.id,a()],queryFn:()=>qo(s==null?void 0:s.id,a()),enabled:!!s}),{data:h=[],isLoading:d,error:v}=we({queryKey:["availableCharacters",s==null?void 0:s.id],queryFn:()=>Wr(s==null?void 0:s.id),enabled:!!s&&n}),f=b||n&&d,u=(p==null?void 0:p.message)||(v==null?void 0:v.message)||null,N=ge({mutationFn:async({name:A,characterIds:j})=>{if(!A.trim())throw new Error("Party name is required");if(!s)throw new Error("User not authenticated");const{data:q,error:C}=await H.from("parties").insert([{name:A,created_by:s.id}]).select().single();if(C)throw C;if(!q)throw new Error("Party creation failed");if(j.length>0){const _=j.map(w=>({party_id:q.id,character_id:w})),{error:y}=await H.from("party_members").insert(_);if(y)throw await H.from("parties").delete().eq("id",q.id),y}return q},onSuccess:()=>{r.invalidateQueries({queryKey:["parties",s==null?void 0:s.id,a()]}),r.invalidateQueries({queryKey:["availableCharacters",s==null?void 0:s.id]}),c(""),g([]),l(!1)}}),S=()=>{N.mutate({name:o,characterIds:x})};return f&&!n?e.jsx("div",{className:"p-8 flex justify-center",children:e.jsx(oe,{size:"lg"})}):u&&!n?e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:u})}):e.jsxs("div",{className:"p-6 max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Adventure Parties"})]}),a()&&e.jsx(M,{variant:"primary",icon:ye,onClick:()=>l(!0),disabled:n,children:"Create Party"})]}),u&&!N.error&&!n&&e.jsx("div",{className:"mb-6",children:e.jsx(ie,{message:u})}),n&&e.jsxs("div",{className:"mb-6 bg-white rounded-lg shadow-md p-6 border border-blue-200",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Create New Party"}),N.error&&e.jsx("div",{className:"mb-4",children:e.jsx(ie,{message:N.error.message})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"partyName",className:"block text-sm font-medium text-gray-700 mb-1",children:"Party Name"}),e.jsx("input",{type:"text",id:"partyName",value:o,onChange:A=>c(A.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter party name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Initial Characters (Optional)"}),d?e.jsx(oe,{}):v?e.jsx(ie,{message:v.message}):h.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-60 overflow-y-auto p-2 border rounded-md",children:h.map(A=>e.jsx("div",{className:`p-3 border rounded-lg cursor-pointer ${x.includes(A.id||"")?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,onClick:()=>{A.id&&g(j=>j.includes(A.id)?j.filter(q=>q!==A.id):[...j,A.id])},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4 text-gray-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:A.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[A.kin," ",A.profession]})]})]})},A.id))}):e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No available characters to add."})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(M,{variant:"secondary",onClick:()=>l(!1),disabled:N.isPending,children:"Cancel"}),e.jsx(M,{variant:"primary",onClick:S,loading:N.isPending,disabled:!o.trim()||N.isPending,children:"Create Party"})]})]})]}),!n&&(m.length>0?e.jsx("div",{className:"grid gap-6",children:m.map(A=>e.jsxs("div",{onClick:()=>t(`/party/${A.id}`),className:"bg-white rounded-lg shadow-md p-6 hover:shadow-lg hover:border-blue-400 border border-transparent transition-all cursor-pointer",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:A.name}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[A.members.map(j=>e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg bg-gray-50",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-5 h-5 text-gray-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:j.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[j.kin," ",j.profession]})]})]})},j.id)),A.members.length===0&&e.jsx("p",{className:"text-sm text-gray-500 italic col-span-full",children:"No members yet."})]})]},A.id))}):e.jsx(Ft,{icon:De,title:"No Adventure Parties",description:a()?"You haven't created any parties yet.":"You're not currently in any adventure parties.",action:a()?e.jsx(M,{variant:"primary",icon:ye,onClick:()=>l(!0),children:"Create Your First Party"}):void 0}))]})}function zo(){const{user:s,isDM:a}=Ce(),[t,r]=i.useState([]),[n,l]=i.useState([]),[o,c]=i.useState([]),[x,g]=i.useState("view"),[m,b]=i.useState(null),[p,h]=i.useState(!0),[d,v]=i.useState(null),[f,u]=i.useState(null),[N,S]=i.useState(!1),A=i.useRef(null),[j,q]=i.useState(""),[C,_]=i.useState("all"),[y,w]=i.useState(""),[L,E]=i.useState(""),[P,k]=i.useState(""),[R,O]=i.useState(""),z=($,Z="")=>{const ee=A.current;if(!ee)return;const re=ee.selectionStart,K=ee.selectionEnd,W=ee.value,se=W.substring(0,re),le=W.substring(re,K),je=W.substring(K),pe=se+$+le+Z+je;E(pe),setTimeout(()=>{ee.focus();const de=re+$.length+le.length+Z.length;ee.setSelectionRange(de,de)},0)},F=()=>{z(`
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |
`)},U=i.useCallback(()=>{w(""),E(""),k(""),O(""),u(null),S(!1)},[]),T=()=>{U(),g("create"),b(null)},I=$=>{b($),w($.title),E($.content),k($.character_id||""),O($.party_id||""),g("edit"),u(null),S(!1)},B=()=>{g("view"),U(),x==="create"&&b(null)},Y=i.useCallback(async()=>{if(s){h(!0),v(null);try{const{data:$}=await H.from("characters").select("id, name").eq("user_id",s.id);if(l($||[]),a()){const{data:K}=await H.from("parties").select("id, name").eq("created_by",s.id);c(K||[])}let Z=H.from("notes").select(`
        *,
        character:characters(name),
        party:parties(name)
      `).eq("user_id",s.id);const{data:ee,error:re}=await Z.order("created_at",{ascending:!1});if(re)throw re;r(ee||[])}catch($){console.error("Load error:",$),v("Failed to load notes.")}finally{h(!1)}}},[s,a]);i.useEffect(()=>{Y()},[Y]);const Q=async()=>{if(!s)return;if(!y.trim()){u("Title is required.");return}if(P&&R){u("Please link to either a Character OR a Party, not both.");return}const $={title:y.trim(),content:L,user_id:s.id,character_id:P||null,party_id:R||null,updated_at:new Date().toISOString()};try{let Z=null;if(x==="edit"&&m){const{data:ee,error:re}=await H.from("notes").update($).eq("id",m.id).select("*, character:characters(name), party:parties(name)").single();if(re)throw re;Z=ee}else{const{data:ee,error:re}=await H.from("notes").insert([$]).select("*, character:characters(name), party:parties(name)").single();if(re)throw re;Z=ee}await Y(),B(),Z&&b(Z)}catch{u("Failed to save note.")}},D=async $=>{if(window.confirm("Delete this note?"))try{await H.from("notes").delete().eq("id",$),await Y(),(m==null?void 0:m.id)===$&&b(null),x==="edit"&&B()}catch{v("Failed to delete note.")}},G=t.filter($=>{const Z=($.title+$.content).toLowerCase().includes(j.toLowerCase()),ee=C==="all"||C==="personal"&&!$.character_id&&!$.party_id||C==="character"&&!!$.character_id||C==="party"&&!!$.party_id;return Z&&ee});return p&&t.length===0?e.jsx("div",{className:"h-96 flex justify-center items-center",children:e.jsx(oe,{})}):e.jsxs("div",{className:"flex h-[calc(100vh-100px)] bg-white border rounded-xl overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"w-full md:w-1/3 lg:w-1/4 border-r border-gray-200 flex flex-col bg-gray-50",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 bg-white",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2 text-gray-800",children:[e.jsx(Gs,{className:"w-5 h-5 text-blue-600"})," My Notes"]}),e.jsx(M,{size:"sm",onClick:T,icon:ye,children:"New"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Search...",className:"w-full pl-9 pr-3 py-1.5 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 outline-none",value:j,onChange:$=>q($.target.value)})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ks,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsxs("select",{className:"w-full pl-9 pr-8 py-1.5 text-sm border rounded-md appearance-none bg-white focus:ring-2 focus:ring-blue-500 outline-none",value:C,onChange:$=>_($.target.value),children:[e.jsx("option",{value:"all",children:"All Notes"}),e.jsx("option",{value:"personal",children:"Personal"}),e.jsx("option",{value:"character",children:"Character Links"}),e.jsx("option",{value:"party",children:"Party Links"})]}),e.jsx(Ms,{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 w-3 h-3 pointer-events-none"})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:G.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx(ms,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No notes found."})]}):G.map($=>e.jsxs("div",{onClick:()=>{b($),g("view")},className:`
                   p-3 rounded-lg cursor-pointer border transition-all group
                   ${(m==null?void 0:m.id)===$.id?"bg-white border-blue-500 shadow-sm ring-1 ring-blue-100 z-10":"bg-white border-gray-200 hover:border-blue-300 hover:shadow-sm"}
                 `,children:[e.jsx("h4",{className:`font-semibold text-sm mb-1 ${(m==null?void 0:m.id)===$.id?"text-blue-700":"text-gray-800"}`,children:$.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[$.character&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-purple-50 text-purple-700 text-[10px] font-medium border border-purple-100",children:[e.jsx(os,{size:10})," ",$.character.name]}),$.party&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-green-50 text-green-700 text-[10px] font-medium border border-green-100",children:[e.jsx(De,{size:10})," ",$.party.name]}),!$.character&&!$.party&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 text-[10px] font-medium border border-gray-200",children:[e.jsx(Ls,{size:10})," Personal"]})]})]},$.id))})]}),e.jsx("div",{className:"flex-1 bg-white p-6 overflow-y-auto",children:x==="create"||x==="edit"?e.jsxs("div",{className:"max-w-2xl mx-auto animate-in fade-in slide-in-from-bottom-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 pb-2 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:x==="edit"?"Edit Note":"New Note"}),e.jsx("button",{onClick:B,className:"text-gray-400 hover:text-gray-600",children:e.jsx(xe,{size:24})})]}),f&&e.jsxs("div",{className:"mb-4 p-3 bg-red-50 text-red-700 text-sm rounded flex items-center gap-2",children:[e.jsx(he,{size:16}),f]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-1",children:"Title"}),e.jsx("input",{className:"w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none",value:y,onChange:$=>w($.target.value),placeholder:"Note Title",autoFocus:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-1",children:"Character Link (Opt)"}),e.jsxs("select",{className:"w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-gray-100 disabled:text-gray-400",value:P,onChange:$=>{k($.target.value),$.target.value&&O("")},disabled:!!R,children:[e.jsx("option",{value:"",children:"None"}),n.map($=>e.jsx("option",{value:$.id,children:$.name},$.id))]})]}),a()&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-1",children:"Party Link (Opt)"}),e.jsxs("select",{className:"w-full p-2 border rounded bg-white focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-gray-100 disabled:text-gray-400",value:R,onChange:$=>{O($.target.value),$.target.value&&k("")},disabled:!!P,children:[e.jsx("option",{value:"",children:"None"}),o.map($=>e.jsx("option",{value:$.id,children:$.name},$.id))]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-end mb-1",children:[e.jsxs("label",{className:"block text-sm font-bold text-gray-700",children:["Content ",e.jsx("span",{className:"text-xs font-normal text-gray-400",children:"(Markdown)"})]}),e.jsx("button",{type:"button",onClick:()=>S(!N),className:"text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium",children:N?e.jsxs(e.Fragment,{children:[e.jsx(Zt,{size:14})," Edit"]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:14})," Preview"]})})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden border-gray-300 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all",children:[!N&&e.jsxs("div",{className:"flex items-center gap-1 p-2 bg-gray-50 border-b border-gray-200 overflow-x-auto",children:[e.jsx(ns,{icon:Xt,label:"Bold",onClick:()=>z("**","**")}),e.jsx(ns,{icon:ea,label:"Italic",onClick:()=>z("*","*")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ns,{icon:sa,label:"Heading",onClick:()=>z("# ","")}),e.jsx(ns,{icon:ta,label:"Quote",onClick:()=>z("> ","")}),e.jsx(ns,{icon:gt,label:"Code Block",onClick:()=>z("```\n","\n```")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ns,{icon:ft,label:"Bullet List",onClick:()=>z("- ","")}),e.jsx(ns,{icon:aa,label:"Numbered List",onClick:()=>z("1. ","")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ns,{icon:bt,label:"Link",onClick:()=>z("[","](url)")}),e.jsx(ns,{icon:ra,label:"Table",onClick:F})]}),N?e.jsx("div",{className:"p-4 h-96 overflow-y-auto prose prose-sm max-w-none bg-gray-50/50",children:e.jsx(As,{content:L||"*No content*"})}):e.jsx("textarea",{ref:A,className:"w-full p-3 h-96 font-mono text-sm outline-none resize-none bg-white",value:L,onChange:$=>E($.target.value),placeholder:"Write your notes here..."})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(M,{variant:"ghost",onClick:B,children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:Q,children:"Save Note"})]})]})]}):m?e.jsxs("div",{className:"max-w-3xl mx-auto animate-in fade-in duration-200",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6 border-b pb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:m.title}),e.jsxs("div",{className:"flex gap-2 text-sm",children:[m.character&&e.jsxs("span",{className:"bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full font-medium",children:["Character: ",m.character.name]}),m.party&&e.jsxs("span",{className:"bg-green-100 text-green-800 px-2 py-0.5 rounded-full font-medium",children:["Party: ",m.party.name]}),!m.character&&!m.party&&e.jsx("span",{className:"bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-medium",children:"Personal Note"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{variant:"secondary",size:"sm",icon:Vs,onClick:()=>I(m),children:"Edit"}),e.jsx(M,{variant:"danger_outline",size:"sm",icon:Le,onClick:()=>D(m.id),children:"Delete"})]})]}),e.jsx("div",{className:"prose prose-blue max-w-none text-gray-700 min-h-[200px]",children:e.jsx(As,{content:m.content})}),e.jsxs("div",{className:"mt-12 pt-4 border-t text-xs text-gray-400 text-center",children:["Created ",new Date(m.created_at).toLocaleDateString()]})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(ms,{className:"w-8 h-8 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-600",children:"Select a note to read"}),e.jsx("p",{className:"text-sm mb-6",children:"Or create a new one to get started."}),e.jsx(M,{variant:"primary",icon:ye,onClick:T,children:"Create Note"})]})})]})}function ns({icon:s,label:a,onClick:t}){return e.jsx("button",{type:"button",onClick:t,title:a,className:"p-1.5 text-gray-600 hover:text-blue-600 hover:bg-white hover:shadow-sm rounded transition-all",children:e.jsx(s,{size:16})})}const Ho=Ie.object({email:Ie.string().email({message:"Invalid email address"}),password:Ie.string().min(1,{message:"Password is required"})}),Bo=Ie.object({username:Ie.string().min(3,{message:"Username must be at least 3 characters long"}).max(50,{message:"Username cannot exceed 50 characters"}),email:Ie.string().email({message:"Invalid email address"}),password:Ie.string().min(8,{message:"Password must be at least 8 characters long"}),confirmPassword:Ie.string(),role:Ie.enum(["player","dm"],{required_error:"Please select a role"})}).refine(s=>s.password===s.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),Uo=Ie.object({currentPassword:Ie.string().min(1,"Current password is required"),newPassword:Ie.string().min(8,"New password must be at least 8 characters"),confirmNewPassword:Ie.string()}).refine(s=>s.newPassword===s.confirmNewPassword,{message:"New passwords don't match",path:["confirmNewPassword"]});function Go(){const[s,a]=i.useState(""),[t,r]=i.useState(""),[n,l]=i.useState(""),[o,c]=i.useState(null),[x,g]=i.useState(null),[m,b]=i.useState(!1),[p,h]=i.useState({}),{updateUserPassword:d}=Ce(),v=async f=>{f.preventDefault(),c(null),g(null),h({});const u=Uo.safeParse({currentPassword:s,newPassword:t,confirmPassword:n});if(!u.success){const N={};u.error.errors.forEach(S=>{const A=S.path[0];A?N[A]=S.message:c(S.message)}),h(N),!o&&Object.keys(N).length>0&&c("Please fix the errors in the form.");return}b(!0);try{const{currentPassword:N,newPassword:S}=u.data;await d(N,S),g("Password updated successfully!"),a(""),r(""),l("")}catch(N){console.error("Password update error:",N),c(N instanceof Error?N.message:"Failed to update password.")}finally{b(!1)}};return e.jsxs("form",{onSubmit:v,className:"space-y-6",children:[e.jsx("h3",{className:"text-lg font-medium leading-6 text-gray-900",children:"Change Password"}),o&&e.jsx("div",{className:"rounded-md bg-red-50 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(he,{className:"h-5 w-5 text-red-400","aria-hidden":"true"})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm font-medium text-red-800",children:o})})]})}),x&&e.jsx("div",{className:"rounded-md bg-green-50 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(gs,{className:"h-5 w-5 text-green-400","aria-hidden":"true"})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm font-medium text-green-800",children:x})})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current-password",className:"block text-sm font-medium text-gray-700",children:"Current Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(zs,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"current-password",name:"currentPassword",type:"password",autoComplete:"current-password",required:!0,value:s,onChange:f=>a(f.target.value),className:`pl-10 block w-full shadow-sm sm:text-sm border rounded-md px-3 py-2 ${p.currentPassword?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}`})]}),p.currentPassword&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:p.currentPassword})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-password",className:"block text-sm font-medium text-gray-700",children:"New Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(zs,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"new-password",name:"newPassword",type:"password",autoComplete:"new-password",required:!0,value:t,onChange:f=>r(f.target.value),className:`pl-10 block w-full shadow-sm sm:text-sm border rounded-md px-3 py-2 ${p.newPassword?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}`})]}),p.newPassword&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:p.newPassword})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"confirm-password",className:"block text-sm font-medium text-gray-700",children:"Confirm New Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(zs,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"confirm-password",name:"confirmPassword",type:"password",autoComplete:"new-password",required:!0,value:n,onChange:f=>l(f.target.value),className:`pl-10 block w-full shadow-sm sm:text-sm border rounded-md px-3 py-2 ${p.confirmPassword?"border-red-500 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}`})]}),p.confirmPassword&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:p.confirmPassword})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{type:"submit",variant:"primary",loading:m,disabled:m,children:"Update Password"})})]})}async function Vr(s){if(!s)return console.error("getUserProfile: No user ID provided."),null;try{const{data:a,error:t,status:r}=await H.from("users").select("id, username, first_name, last_name, avatar_url, bio").eq("id",s).single();if(t){if(r===406||t.code==="PGRST116")return console.warn(`No profile found for user ID: ${s}. This might be expected.`),null;throw console.error("Error fetching user profile:",t.message),new Error(`Failed to fetch user profile: ${t.message}`)}return a}catch(a){throw console.error("Unexpected error in getUserProfile:",a),a instanceof Error?a:new Error("An unknown error occurred while fetching the user profile.")}}async function Wo(s,a){if(!s)throw new Error("updateUserProfile: No user ID provided.");if(!a||Object.keys(a).length===0)throw new Error("updateUserProfile: No updates provided.");const t={username:a.username,first_name:a.first_name,last_name:a.last_name,avatar_url:a.avatar_url,bio:a.bio};if(Object.keys(t).forEach(r=>{const n=r;t[n]===void 0&&delete t[n]}),Object.keys(t).length===0){console.warn("updateUserProfile: No valid fields to update after filtering.");const r=await Vr(s);if(!r)throw new Error("Could not retrieve current profile after filtering updates.");return r}try{const{data:r,error:n}=await H.from("users").update({...t,updated_at:new Date().toISOString()}).eq("id",s).select("id, username, first_name, last_name, avatar_url, bio").single();if(n)throw console.error("Error updating user profile:",n.message),n.code==="23505"?n.message.includes("users_username_key")?new Error(`Failed to update profile: Username '${t.username}' is already taken.`):new Error(`Failed to update profile: ${n.details||"A unique value constraint was violated."}`):new Error(`Failed to update user profile: ${n.message}`);if(!r)throw new Error("Failed to update user profile: No data returned.");return r}catch(r){throw console.error("Unexpected error in updateUserProfile:",r),r instanceof Error?r:new Error("An unknown error occurred while updating the user profile.")}}async function Ko(s){if(!s)throw new Error("updateUserAuthEmail: No new email provided.");if(!/\S+@\S+\.\S+/.test(s))throw new Error("updateUserAuthEmail: Invalid email format provided.");try{const{data:a,error:t}=await H.auth.updateUser({email:s});if(t)throw console.error("Error updating user auth email:",t.message),t.message.includes("User not found")||t.status===404?new Error("Failed to initiate email update: Could not find the current user."):t.message.includes("Email rate limit exceeded")?new Error("Failed to initiate email update: Please wait before trying again."):t.message.includes("same as the existing email")?new Error("The new email address is the same as the current one."):new Error(`Failed to initiate email update: ${t.message}`);console.log("User auth email update initiated. Verification required.",a)}catch(a){throw console.error("Unexpected error in updateUserAuthEmail:",a),a instanceof Error?a:new Error("An unknown error occurred while updating the user's email.")}}function sr(){var C;const{user:s,session:a}=Ce(),[t,r]=i.useState(null),[n,l]=i.useState({first_name:"",last_name:"",username:"",avatar_url:"",bio:""}),[o,c]=i.useState(""),[x,g]=i.useState(""),[m,b]=i.useState(!0),[p,h]=i.useState(!1),[d,v]=i.useState(null),[f,u]=i.useState(null),N=i.useCallback(async _=>{var y,w,L;b(!0),v(null),u(null);try{const E=await Vr(_.id),P=_.email??"";E?(r(E),l({first_name:E.first_name??"",last_name:E.last_name??"",username:E.username??((y=_.user_metadata)==null?void 0:y.username)??"",avatar_url:E.avatar_url??"",bio:E.bio??""})):(console.warn("User profile not found in 'users' table, initializing form with defaults/metadata."),l({first_name:"",last_name:"",username:((w=_.user_metadata)==null?void 0:w.username)??"",avatar_url:"",bio:""})),c(P),g(P)}catch(E){console.error("Failed to load profile:",E),v(E instanceof Error?E.message:"Failed to load profile data.");const P=(s==null?void 0:s.email)??"";c(P),g(P),l({first_name:"",last_name:"",username:((L=s==null?void 0:s.user_metadata)==null?void 0:L.username)??"",avatar_url:"",bio:""})}finally{b(!1)}},[]);i.useEffect(()=>{s?N(s):(b(!1),r(null),l({first_name:"",last_name:"",username:"",avatar_url:"",bio:""}),c(""),g(""),v(null),u(null))},[s,N]);const S=_=>{const{name:y,value:w}=_.target;l(L=>({...L,[y]:w})),v(null),u(null)},A=_=>{c(_.target.value),v(null),u(null)},j=async _=>{var P;if(_.preventDefault(),!s){v("You must be logged in to update your profile.");return}h(!0),v(null),u(null);let y=!1,w=!1,L="",E=!1;try{const k={},R=t??{username:((P=s.user_metadata)==null?void 0:P.username)??"",first_name:null,last_name:null,avatar_url:null,bio:null};if(n.first_name!==(R.first_name??"")&&(k.first_name=n.first_name),n.last_name!==(R.last_name??"")&&(k.last_name=n.last_name),n.username!==(R.username??"")&&(k.username=n.username),n.avatar_url!==(R.avatar_url??"")&&(k.avatar_url=n.avatar_url),n.bio!==(R.bio??"")&&(k.bio=n.bio),Object.keys(k).length>0){E=!0;const z=await Wo(s.id,k);r(F=>F?{...F,...z}:z),l({first_name:z.first_name??"",last_name:z.last_name??"",username:z.username??"",avatar_url:z.avatar_url??"",bio:z.bio??""}),y=!0}else y=!0;const O=o.trim();if(O!==x){if(!O)throw new Error("Email cannot be empty.");E=!0,await Ko(O),w=!0,L=" Email update initiated. Please check both your current and new email addresses for a verification link to complete the change."}if(E){let z="";y&&Object.keys(k).length>0&&(z+="Profile fields updated successfully."),z+=L,u(z.trim())}else u("No changes were detected.")}catch(k){console.error("Failed to update profile:",k);const R=k instanceof Error?k.message:"An unknown error occurred during update.";v(R)}finally{h(!1)}},q=_=>{var L;const y=_.currentTarget;y.style.display="none";const w=(L=y.parentElement)==null?void 0:L.querySelector(".fallback-icon");w&&(w.style.display="flex")};return m?e.jsx("div",{className:"flex justify-center items-center h-40",children:e.jsx(oe,{})}):!s||!a?e.jsx("p",{className:"text-center text-red-600",children:"Please log in to view or edit your profile."}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Profile Settings"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-6 mb-8",children:[e.jsx("div",{className:"relative w-24 h-24",children:e.jsxs("div",{className:"w-full h-full rounded-full bg-gray-200 flex items-center justify-center overflow-hidden border",children:[n.avatar_url&&e.jsx("img",{src:n.avatar_url,alt:"Profile",className:"w-full h-full object-cover",onError:q,style:{display:"block"}},n.avatar_url),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center fallback-icon",style:{display:n.avatar_url?"none":"flex"},children:e.jsx(os,{className:"w-12 h-12 text-gray-400"})})]})}),e.jsxs("div",{className:"flex-grow w-full sm:w-auto",children:[e.jsx("h3",{className:"font-medium text-lg text-center sm:text-left",children:n.username||((C=s==null?void 0:s.user_metadata)==null?void 0:C.username)||"User"}),e.jsxs("p",{className:"text-sm text-gray-600 flex items-center justify-center sm:justify-start gap-1",children:[e.jsx(ia,{className:"w-4 h-4"}),o||"No email set"]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{htmlFor:"avatar_url",className:"block text-xs font-medium text-gray-600 mb-1",children:"Avatar URL"}),e.jsx("input",{id:"avatar_url",name:"avatar_url",type:"url",value:n.avatar_url??"",onChange:S,placeholder:"https://example.com/avatar.png",className:"w-full px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"})]})]})]}),e.jsxs("form",{onSubmit:j,className:"space-y-6",children:[f&&e.jsxs("div",{className:"p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg flex items-start gap-2",role:"alert",children:[e.jsx(gs,{className:"w-5 h-5 mt-px flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Success!"})," ",f]})]}),d&&e.jsxs("div",{className:"p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg flex items-start gap-2",role:"alert",children:[e.jsx(he,{className:"w-5 h-5 mt-px flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Error!"})," ",d]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"first_name",className:"block text-sm font-medium text-gray-700 mb-1",children:"First Name"}),e.jsx("input",{id:"first_name",name:"first_name",type:"text",value:n.first_name??"",onChange:S,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"last_name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Last Name"}),e.jsx("input",{id:"last_name",name:"last_name",type:"text",value:n.last_name??"",onChange:S,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email Address"}),e.jsx("input",{id:"email",name:"email",type:"email",value:o,onChange:A,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed","aria-describedby":"email-description"}),e.jsx("p",{id:"email-description",className:"text-xs text-gray-500 mt-1",children:"Changing your email requires verification via links sent to both addresses."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 mb-1",children:"Username"}),e.jsx("input",{id:"username",name:"username",type:"text",value:n.username??"",onChange:S,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Must be unique. Used for display and potentially logging in."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 mb-1",children:"Bio"}),e.jsx("textarea",{id:"bio",name:"bio",value:n.bio??"",onChange:S,rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"Tell us a little about yourself..."})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(M,{type:"submit",variant:"primary",icon:Ae,loading:p,disabled:p||m,children:"Save Changes"})})]})]}),e.jsxs("div",{className:"border-t pt-8 mt-12",children:[e.jsx("h3",{className:"text-lg font-semibold mb-6",children:"Change Password"}),e.jsx(Go,{})]})]})}function Vo(){const[s,a]=i.useState("system"),[t,r]=i.useState("medium"),[n,l]=i.useState(!1),[o,c]=i.useState(!1),x=async g=>{g.preventDefault(),c(!0),await new Promise(m=>setTimeout(m,1e3)),c(!1)};return e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Appearance Settings"}),e.jsxs("form",{onSubmit:x,className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-4",children:"Theme"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>a("light"),className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${s==="light"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:[e.jsx(Zn,{className:"w-6 h-6 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Light"})]}),e.jsxs("button",{type:"button",onClick:()=>a("dark"),className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${s==="dark"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:[e.jsx(Xn,{className:"w-6 h-6 text-blue-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Dark"})]}),e.jsxs("button",{type:"button",onClick:()=>a("system"),className:`p-4 border rounded-lg flex flex-col items-center gap-2 ${s==="system"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:[e.jsx(el,{className:"w-6 h-6 text-gray-500"}),e.jsx("span",{className:"text-sm font-medium",children:"System"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Font Size"}),e.jsxs("select",{value:t,onChange:g=>r(g.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:g=>l(g.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Reduce motion"})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Minimize animations and transitions"})]}),e.jsxs("div",{className:"p-6 border rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Preview"}),e.jsx("div",{className:`p-4 rounded-lg ${s==="dark"?"bg-gray-800 text-white":"bg-white text-gray-900"}`,children:e.jsx("p",{className:`${t==="small"?"text-sm":t==="large"?"text-lg":"text-base"}`,children:"This is how your content will look with the selected theme and font size."})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{type:"submit",variant:"primary",icon:Ae,loading:o,children:"Save Changes"})})]})]})}function Yo(){const[s,a]=i.useState({email:{newMessage:!0,partyInvite:!0,sessionScheduled:!0,systemUpdates:!1},desktop:{newMessage:!0,partyInvite:!0,sessionScheduled:!0,diceRolls:!0},sounds:{enabled:!0,volume:80,diceRolls:!0,notifications:!0}}),[t,r]=i.useState(!1),n=async l=>{l.preventDefault(),r(!0),await new Promise(o=>setTimeout(o,1e3)),r(!1)};return e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Notification Settings"}),e.jsxs("form",{onSubmit:n,className:"space-y-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ia,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Email Notifications"})]}),e.jsx("div",{className:"space-y-3",children:Object.entries(s.email).map(([l,o])=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:c=>a({...s,email:{...s.email,[l]:c.target.checked}}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:l.replace(/([A-Z])/g," $1").replace(/^./,c=>c.toUpperCase())})]},l))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(sl,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Desktop Notifications"})]}),e.jsx("div",{className:"space-y-3",children:Object.entries(s.desktop).map(([l,o])=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:c=>a({...s,desktop:{...s.desktop,[l]:c.target.checked}}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:l.replace(/([A-Z])/g," $1").replace(/^./,c=>c.toUpperCase())})]},l))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(tl,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Sound Settings"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.sounds.enabled,onChange:l=>a({...s,sounds:{...s.sounds,enabled:l.target.checked}}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Enable Sounds"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm text-gray-700 mb-1",children:["Volume (",s.sounds.volume,"%)"]}),e.jsx("input",{type:"range",min:"0",max:"100",value:s.sounds.volume,onChange:l=>a({...s,sounds:{...s.sounds,volume:parseInt(l.target.value)}}),className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.sounds.diceRolls,onChange:l=>a({...s,sounds:{...s.sounds,diceRolls:l.target.checked}}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Dice Roll Sounds"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.sounds.notifications,onChange:l=>a({...s,sounds:{...s.sounds,notifications:l.target.checked}}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Notification Sounds"})]})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{type:"submit",variant:"primary",icon:Ae,loading:t,children:"Save Changes"})})]})]})}const Qo=[{value:"en",label:"English"},{value:"et",label:"Estonian"},{value:"fi",label:"Finnish"},{value:"sv",label:"Swedish"}],Jo=[{value:"Europe/Tallinn",label:"Europe/Tallinn (UTC+2)"},{value:"Europe/Helsinki",label:"Europe/Helsinki (UTC+2)"},{value:"Europe/Stockholm",label:"Europe/Stockholm (UTC+1)"},{value:"UTC",label:"UTC"}],Zo=[{value:"DD/MM/YYYY",label:"DD/MM/YYYY"},{value:"MM/DD/YYYY",label:"MM/DD/YYYY"},{value:"YYYY-MM-DD",label:"YYYY-MM-DD"}],Xo=[{value:"24h",label:"24-hour (14:30)"},{value:"12h",label:"12-hour (2:30 PM)"}];function ec(){const[s,a]=i.useState({language:"en",timeZone:"Europe/Tallinn",dateFormat:"DD/MM/YYYY",timeFormat:"24h",firstDayOfWeek:1,useMetricSystem:!0}),[t,r]=i.useState(!1),n=async c=>{c.preventDefault(),r(!0),await new Promise(x=>setTimeout(x,1e3)),r(!1)},l=new Date,o=new Intl.DateTimeFormat("en-GB",{dateStyle:"full",timeStyle:"long",timeZone:s.timeZone}).format(l);return e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:"Localization Settings"}),e.jsxs("form",{onSubmit:n,className:"space-y-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(al,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Language & Region"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Interface Language"}),e.jsx("select",{value:s.language,onChange:c=>a({...s,language:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:Qo.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Time Zone"}),e.jsx("select",{value:s.timeZone,onChange:c=>a({...s,timeZone:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:Jo.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(dr,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Date & Time Format"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date Format"}),e.jsx("select",{value:s.dateFormat,onChange:c=>a({...s,dateFormat:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:Zo.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Time Format"}),e.jsx("select",{value:s.timeFormat,onChange:c=>a({...s,timeFormat:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:Xo.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"First Day of Week"}),e.jsxs("select",{value:s.firstDayOfWeek,onChange:c=>a({...s,firstDayOfWeek:parseInt(c.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:1,children:"Monday"}),e.jsx("option",{value:0,children:"Sunday"})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(xt,{className:"w-5 h-5 text-gray-500"}),e.jsx("h3",{className:"font-medium",children:"Measurement System"})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.useMetricSystem,onChange:c=>a({...s,useMetricSystem:c.target.checked}),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"Use Metric System"})]})})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Preview"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Current date and time: ",o]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{type:"submit",variant:"primary",icon:Ae,loading:t,children:"Save Changes"})})]})]})}function sc({onClose:s,onUserCreated:a}){const[t,r]=i.useState(""),[n,l]=i.useState(""),[o,c]=i.useState("player"),[x,g]=i.useState(null),[m,b]=i.useState(!1),[p,h]=i.useState(!1),[d,v]=i.useState(null),[f,u]=i.useState(!1),[N,S]=i.useState([]),[A,j]=i.useState(!1),[q,C]=i.useState(null),_=async()=>{j(!0),C(null);const{data:L,error:E}=await H.from("users").select("*");E?C(E.message):S(L),j(!1)};i.useEffect(()=>{_()},[]);const y=async L=>{L.preventDefault(),g(null),h(!0);try{const E=Math.random().toString(36).slice(-12),{data:P,error:k}=await H.auth.signUp({email:t,password:E,options:{data:{username:n}}});if(k)throw k;if(!P.user)throw new Error("Failed to create user");const{error:R}=await H.from("users").update({role:o}).eq("id",P.user.id);if(R)throw R;const O=new URL(window.location.origin);O.searchParams.set("email",t),O.searchParams.set("password",E),v(O.toString()),b(!0),a(),_()}catch(E){g(E instanceof Error?E.message:"Failed to create user")}finally{h(!1)}},w=async()=>{if(d)try{await navigator.clipboard.writeText(d),u(!0),setTimeout(()=>u(!1),2e3)}catch{g("Failed to copy link to clipboard")}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full",children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Create New User"}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),x&&e.jsxs("div",{className:"mb-6 flex items-start gap-2 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx(he,{className:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-700",children:x})]}),m&&d?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("h3",{className:"font-medium text-green-800 mb-2",children:"User Created Successfully!"}),e.jsx("p",{className:"text-sm text-green-700",children:"Share the following link with the user to let them sign in:"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:d,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50"}),e.jsx(M,{variant:"secondary",icon:f?ds:oa,onClick:w,children:f?"Copied!":"Copy"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{variant:"primary",onClick:s,children:"Done"})})]}):e.jsxs("form",{onSubmit:y,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",required:!0,value:t,onChange:L=>r(L.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Username"}),e.jsx("input",{type:"text",required:!0,value:n,onChange:L=>l(L.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),e.jsxs("select",{value:o,onChange:L=>c(L.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"player",children:"Player"}),e.jsx("option",{value:"dm",children:"Dungeon Master"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(M,{variant:"secondary",onClick:s,children:"Cancel"}),e.jsx(M,{type:"submit",variant:"primary",icon:os,loading:p,children:"Create User"})]})]})]}),e.jsxs("div",{className:"p-6 border-t",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Created Users"}),A?e.jsx("p",{children:"Loading users..."}):q?e.jsxs("p",{className:"text-red-600",children:["Error loading users: ",q]}):N.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Username"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Created At"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Account Status"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:N.map(L=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:L.username}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:L.email}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:L.role}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:new Date(L.created_at).toLocaleString()}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:L.account_status||"N/A"})]},L.id))})]})}):e.jsx("p",{children:"No users found."})]})]})})}function tc(){const[s,a]=i.useState([]),[t,r]=i.useState(!0),[n,l]=i.useState(null),[o,c]=i.useState(""),[x,g]=i.useState("all"),[m,b]=i.useState(!1),p=i.useCallback(async()=>{r(!0),l(null);try{const{data:u,error:N}=await H.from("users").select("id, email, username, role, created_at, last_login, first_name, last_name, is_active").order("created_at",{ascending:!1});if(N)throw N;a(u||[])}catch(u){console.error("Error fetching users:",u),l(`Failed to load users: ${u.message||"Unknown error"}`),a([])}finally{r(!1)}},[]);i.useEffect(()=>{p()},[p]);const h=()=>{b(!1),p()},d=s.filter(u=>{const N=o.toLowerCase(),S=u.username&&u.username.toLowerCase().includes(N)||u.email&&u.email.toLowerCase().includes(N)||u.first_name&&u.first_name.toLowerCase().includes(N)||u.last_name&&u.last_name.toLowerCase().includes(N),A=x==="all"||u.role&&u.role.toLowerCase()===x.toLowerCase();return S&&A}),v=u=>{const N=u==null?void 0:u.toLowerCase();return N==="admin"?"bg-purple-100 text-purple-800":N==="dm"||N==="dungeon master"?"bg-blue-100 text-blue-800":N==="player"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"},f=u=>u.username?u.username:u.first_name&&u.last_name?`${u.first_name} ${u.last_name}`:u.first_name?u.first_name:u.email.split("@")[0];return e.jsxs("div",{className:"space-y-6 p-4 md:p-6 bg-white shadow-lg rounded-xl",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h3",{className:"text-2xl font-semibold text-gray-800",children:"User Management"}),e.jsx(M,{variant:"primary",icon:ye,onClick:()=>b(!0),className:"w-full sm:w-auto",children:"Create User"})]}),n&&e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg shadow-sm",children:[e.jsx(he,{className:"w-6 h-6 text-red-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-800",children:"Error Loading Users"}),e.jsx("p",{className:"text-sm text-red-700",children:n})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 pb-4 border-b border-gray-200",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(Te,{className:"absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Search by name, email, username...",value:o,onChange:u=>c(u.target.value),className:"w-full pl-11 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-colors",disabled:t})]}),e.jsxs("div",{className:"relative md:min-w-[200px]",children:[e.jsx(Ks,{className:"absolute left-3.5 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsxs("select",{value:x,onChange:u=>g(u.target.value),className:"w-full pl-11 pr-8 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white shadow-sm transition-colors",disabled:t,children:[e.jsx("option",{value:"all",children:"All Roles"}),e.jsx("option",{value:"player",children:"Players"}),e.jsx("option",{value:"dm",children:"Dungeon Masters"}),e.jsx("option",{value:"admin",children:"Administrators"})]}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-700",children:e.jsx("svg",{className:"fill-current h-4 w-4",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"})})})]})]}),t&&s.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading users..."})]}):!t&&s.length===0&&!n?e.jsxs("div",{className:"text-center py-10 px-4",children:[e.jsx(Users,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h4",{className:"text-xl font-semibold text-gray-700 mb-1",children:"No Users Found"}),e.jsx("p",{className:"text-gray-500",children:"There are currently no users to display. Try creating one!"})]}):e.jsx("div",{className:"overflow-x-auto shadow-md rounded-lg border border-gray-200",children:e.jsxs("table",{className:"w-full min-w-[700px]",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"User"}),e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Last Login"}),e.jsx("th",{className:"px-5 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:d.map(u=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-5 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold",children:[u.first_name?u.first_name.charAt(0).toUpperCase():u.email.charAt(0).toUpperCase(),u.last_name?u.last_name.charAt(0).toUpperCase():u.username?u.username.charAt(0).toUpperCase():""]}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:f(u)}),e.jsx("div",{className:"text-xs text-gray-500",children:u.email})]})]})}),e.jsx("td",{className:"px-5 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${v(u.role||"N/A")}`,children:u.role?u.role.charAt(0).toUpperCase()+u.role.slice(1):"N/A"})}),e.jsx("td",{className:"px-5 py-4 whitespace-nowrap",children:u.is_active===void 0||u.is_active===null?e.jsx("span",{className:"text-xs text-gray-500",children:"Unknown"}):u.is_active?e.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800",children:[e.jsx(gs,{className:"w-3.5 h-3.5 mr-1.5"})," Active"]}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800",children:[e.jsx(xs,{className:"w-3.5 h-3.5 mr-1.5"})," Inactive"]})}),e.jsx("td",{className:"px-5 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(u.created_at).toLocaleDateString()}),e.jsx("td",{className:"px-5 py-4 whitespace-nowrap text-sm text-gray-500",children:u.last_login?new Date(u.last_login).toLocaleString():"Never"}),e.jsx("td",{className:"px-5 py-4 whitespace-nowrap text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"icon",size:"sm",title:"Edit User",className:"text-gray-500 hover:text-blue-600",children:e.jsx(Jt,{className:"w-4 h-4"})}),e.jsx(M,{variant:"icon",size:"sm",title:"Delete User",className:"text-gray-500 hover:text-red-600",children:e.jsx(Le,{className:"w-4 h-4"})})]})})]},u.id))})]})}),d.length===0&&!t&&s.length>0&&e.jsxs("div",{className:"text-center py-10 px-4",children:[e.jsx(Te,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h4",{className:"text-xl font-semibold text-gray-700 mb-1",children:"No Users Match Your Search"}),e.jsx("p",{className:"text-gray-500",children:"Try adjusting your search term or role filter."})]}),m&&e.jsx(sc,{onClose:()=>b(!1),onUserCreated:h})]})}function ac({entry:s,onChange:a}){const[t,r]=i.useState(s),[n,l]=i.useState({gold:0,silver:0,copper:0}),[o,c]=i.useState([]);i.useEffect(()=>{if(r(s),s.cost){const m=s.cost.split(",").map(p=>p.trim()),b={gold:0,silver:0,copper:0};m.forEach(p=>{p.includes("gold")?b.gold=parseInt(p.replace("gold","").trim())||0:p.includes("silver")?b.silver=parseInt(p.replace("silver","").trim())||0:p.includes("copper")&&(b.copper=parseInt(p.replace("copper","").trim())||0)}),l(b)}c(s.features||[])},[s]);const x=(m,b)=>{const p=parseInt(b)||0,h={...n,[m]:p};l(h),a("cost",`${h.gold} gold, ${h.silver} silver, ${h.copper} copper`)},g=m=>{const b=o.filter((p,h)=>h!==m);c(b),a("features",b)};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{type:"text",value:t.name||"",onChange:m=>a("name",m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsxs("select",{value:t.category||"",onChange:m=>a("category",m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500",children:[e.jsx("option",{value:"",children:"Select Category"}),e.jsx("option",{value:"ARMOR & HELMETS",children:"Armor & Helmets"}),e.jsx("option",{value:"MELEE WEAPONS",children:"Melee Weapons"}),e.jsx("option",{value:"RANGED WEAPONS",children:"Ranged Weapons"}),e.jsx("option",{value:"CLOTHES",children:"Clothes"}),e.jsx("option",{value:"MUSICAL INSTRUMENTS",children:"Musical Instruments"}),e.jsx("option",{value:"TRADE GOODS",children:"Trade Goods"}),e.jsx("option",{value:"STUDIES & MAGIC",children:"Studies & Magic"}),e.jsx("option",{value:"LIGHT SOURCES",children:"Light Sources"}),e.jsx("option",{value:"TOOLS",children:"Tools"}),e.jsx("option",{value:"CONTAINERS",children:"Containers"}),e.jsx("option",{value:"MEDICINE",children:"Medicine"}),e.jsx("option",{value:"SERVICES",children:"Services"}),e.jsx("option",{value:"HUNTING & FISHING",children:"Hunting & Fishing"}),e.jsx("option",{value:"MEANS OF TRAVEL",children:"Means of Travel"}),e.jsx("option",{value:"ANIMALS",children:"Animals"})]})]}),(t.category==="ARMOR & HELMETS"||t.category==="MELEE WEAPONS"||t.category==="RANGED WEAPONS")&&e.jsxs("div",{className:"p-3 border rounded-md bg-white space-y-4",children:[e.jsx("h3",{className:"text-md font-semibold text-gray-800 border-b pb-2",children:"Weapon/Armor Stats"}),t.category==="ARMOR & HELMETS"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Armor Rating"}),e.jsx("input",{type:"number",value:t.armor_rating||"",onChange:m=>a("armor_rating",parseInt(m.target.value)),className:"w-full px-3 py-2 border rounded-md"})]}),(t.category==="MELEE WEAPONS"||t.category==="RANGED WEAPONS")&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Grip"}),e.jsxs("select",{value:t.grip||"1H",onChange:m=>a("grip",m.target.value),className:"w-full px-3 py-2 border rounded-md",children:[e.jsx("option",{value:"1H",children:"1H"}),e.jsx("option",{value:"2H",children:"2H"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"STR Requirement"}),e.jsx("input",{type:"number",value:t.strength_requirement||"",onChange:m=>a("strength_requirement",parseInt(m.target.value)),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Range"}),e.jsx("input",{type:"text",value:t.range||"",onChange:m=>a("range",m.target.value),placeholder:"Enter range value or STR",className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Damage"}),e.jsx("input",{type:"text",value:t.damage||"",onChange:m=>a("damage",m.target.value),placeholder:"e.g. D6, D8, 2D8",className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Durability"}),e.jsx("input",{type:"number",value:t.durability||"",onChange:m=>a("durability",parseInt(m.target.value)),className:"w-full px-3 py-2 border rounded-md"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cost"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("div",{className:"flex",children:[e.jsx("input",{type:"number",value:n.gold,onChange:m=>x("gold",m.target.value),className:"w-full px-3 py-2 border rounded-l-md",placeholder:"0"}),e.jsx("span",{className:"inline-flex items-center px-3 border border-l-0 rounded-r-md bg-gray-100 text-gray-700",children:"Gold"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("input",{type:"number",value:n.silver,onChange:m=>x("silver",m.target.value),className:"w-full px-3 py-2 border rounded-l-md",placeholder:"0"}),e.jsx("span",{className:"inline-flex items-center px-3 border border-l-0 rounded-r-md bg-gray-100 text-gray-700",children:"Silver"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("input",{type:"number",value:n.copper,onChange:m=>x("copper",m.target.value),className:"w-full px-3 py-2 border rounded-l-md",placeholder:"0"}),e.jsx("span",{className:"inline-flex items-center px-3 border border-l-0 rounded-r-md bg-gray-100 text-gray-700",children:"Copper"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supply"}),e.jsxs("select",{value:t.supply||"",onChange:m=>a("supply",m.target.value),className:"w-full px-3 py-2 border rounded-md",children:[e.jsx("option",{value:"",children:"Select Supply"}),e.jsx("option",{value:"Common",children:"Common"}),e.jsx("option",{value:"Uncommon",children:"Uncommon"}),e.jsx("option",{value:"Rare",children:"Rare"}),e.jsx("option",{value:"Unique",children:"Unique"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Weight"}),e.jsx("input",{type:"number",value:t.weight||"",onChange:m=>a("weight",parseFloat(m.target.value)),className:"w-full px-3 py-2 border rounded-md",min:"0",step:"0.1"})]}),e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"equippable",type:"checkbox",checked:!!t.equippable,onChange:m=>a("equippable",m.target.checked),className:"h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsx("label",{htmlFor:"equippable",className:"ml-2 block text-sm font-medium text-gray-800",children:"Equippable"})]}),t.equippable&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Encumbrance Bonus"}),e.jsx("input",{type:"number",value:t.encumbrance_modifier||"",onChange:m=>a("encumbrance_modifier",parseInt(m.target.value)||0),className:"w-full px-3 py-2 border rounded-md",placeholder:"e.g., 2 for a backpack",min:"0"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Increases carrying capacity by this amount when equipped."})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Effect/Description"}),e.jsx("textarea",{value:t.effect||"",onChange:m=>a("effect",m.target.value.toUpperCase()),rows:3,className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Features"}),e.jsxs("div",{className:"p-2 border rounded-md bg-white",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:o.map((m,b)=>e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-md px-2 py-1 text-sm",children:[e.jsx("span",{children:m}),e.jsx("button",{type:"button",onClick:()=>g(b),className:"ml-2 text-red-500 hover:text-red-700",children:e.jsx(rl,{className:"w-4 h-4"})})]},b))}),e.jsx("input",{type:"text",onKeyDown:m=>{if(m.key==="Enter"&&m.currentTarget.value.trim()){m.preventDefault();const b=m.currentTarget.value.trim().toUpperCase(),p=[...o,b];c(p),a("features",p),m.currentTarget.value=""}},className:"mt-2 w-full px-3 py-2 border rounded-md",placeholder:"Add feature and press Enter..."})]})]})]})}const rc=({entry:s,onChange:a})=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{type:"text",value:s.name||"",onChange:t=>a("name",t.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:s.description||"",onChange:t=>a("description",t.target.value),rows:3,className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Heroic Ability"}),e.jsx("input",{type:"text",value:s.heroic_ability||"",onChange:t=>a("heroic_ability",t.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Abilities"}),(s.abilities||[]).map((t,r)=>e.jsxs("div",{className:"flex gap-2 items-center mb-1",children:[e.jsx("input",{type:"text",placeholder:"Ability Description",value:t.description||"",onChange:n=>{const l=[...s.abilities||[]];l[r]={...l[r],description:n.target.value},a("abilities",l)},className:"border rounded-md px-2 py-1 flex-1"}),e.jsx("input",{type:"number",placeholder:"Willpower Points",value:t.willpower_points||0,onChange:n=>{const l=[...s.abilities||[]];l[r]={...l[r],willpower_points:parseInt(n.target.value)},a("abilities",l)},className:"border rounded-md px-2 py-1 w-20",min:"0"}),e.jsx("button",{onClick:()=>{const n=[...s.abilities||[]];n.splice(r,1),a("abilities",n)},className:"text-red-600",children:"Remove"})]},r)),e.jsx("button",{onClick:()=>{const t=[...s.abilities||[],{description:"",willpower_points:0}];a("abilities",t)},className:"mt-2 text-blue-600",children:"Add Ability"})]})]}),nc=({onClose:s,onSave:a,loading:t,error:r})=>{const[n,l]=i.useState(""),[o,c]=i.useState(""),[x,g]=i.useState(""),[m,b]=i.useState(""),p=()=>{if(!n||!x){alert("School Name and Key Attribute are required.");return}const h={name:n,description:o,key_attribute:x,base_skills:m.split(",").map(d=>d.trim()).filter(Boolean)};a(h)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-lg w-full p-6 flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Create New Magic School"}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700",children:e.jsx(xe,{className:"w-6 h-6"})})]}),r&&e.jsx("p",{className:"text-red-600 bg-red-100 p-2 rounded-md",children:r}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"School Name"}),e.jsx("input",{type:"text",value:n,onChange:h=>l(h.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:o,onChange:h=>c(h.target.value),rows:3,className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Key Attribute"}),e.jsx("input",{type:"text",value:x,onChange:h=>g(h.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Base Skills (comma-separated)"}),e.jsx("input",{type:"text",value:m,onChange:h=>b(h.target.value),className:"w-full px-3 py-2 border rounded-md",placeholder:"e.g., Awareness, Myths & Legends"})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-4 border-t pt-4",children:[e.jsx(M,{variant:"secondary",onClick:s,disabled:t,children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:p,disabled:t,children:t?"Saving...":"Save School"})]})]})})},lc=({entry:s,onChange:a})=>{const[t,r]=i.useState("skills"),[n,l]=i.useState([]),[o,c]=i.useState(!0),[x,g]=i.useState(null),[m,b]=i.useState([]),[p,h]=i.useState(!0),[d,v]=i.useState(null),[f,u]=i.useState(!1),[N,S]=i.useState(!1),[A,j]=i.useState(null),q=i.useCallback(async()=>{c(!0),g(null);const{data:k,error:R}=await H.from("game_skills").select("id, name, is_magic").order("name");R?(console.error("Error fetching skills:",R),g("Failed to load skills.")):l(k||[]),c(!1)},[]),C=i.useCallback(async()=>{h(!0),v(null);const{data:k,error:R}=await H.from("magic_schools").select("id, name").order("name");R?(console.error("Error fetching magic schools:",R),v("Failed to load magic schools.")):b(k||[]),h(!1)},[]);i.useEffect(()=>{q(),C()},[q,C]);const _=async k=>{S(!0),j(null);const{data:R,error:O}=await H.from("magic_schools").insert([k]).select("id").single();S(!1),O?(console.error("Error creating magic school:",O),j(`Failed to save: ${O.message}`)):(u(!1),await C(),R!=null&&R.id&&a("magic_school_id",R.id))},y=i.useMemo(()=>n.filter(k=>k.is_magic),[n]),w=s.starting_equipment||["","",""],L=s.equipment_description||["","",""],E=(k,R,O)=>{if(R==="equipment"){const z=[...w];z[k]=O,a("starting_equipment",z)}else{const z=[...L];z[k]=O,a("equipment_description",z)}},P=k=>{a("is_magic",k),k||a("associated_skill",null)};return e.jsxs(e.Fragment,{children:[f&&e.jsx(nc,{onClose:()=>u(!1),onSave:_,loading:N,error:A}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{type:"text",value:s.name||"",onChange:k=>a("name",k.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:s.description||"",onChange:k=>a("description",k.target.value),rows:3,className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_magic",type:"checkbox",checked:s.is_magic||!1,onChange:k=>P(k.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("label",{htmlFor:"is_magic",className:"text-sm font-medium text-gray-900",children:"Is this a magic profession?"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"associated_skill",className:"block text-sm font-medium text-gray-700 mb-1",children:"Associated Magic Skill"}),e.jsx("select",{id:"associated_skill",value:s.associated_skill||"",onChange:k=>a("associated_skill",k.target.value||null),className:"w-full px-3 py-2 border rounded-md disabled:bg-gray-200",disabled:!s.is_magic||o||!!x,children:o?e.jsx("option",{children:"Loading..."}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",children:"None"}),y.map(k=>e.jsx("option",{value:k.name,children:k.name},k.id))]})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Key Attribute"}),e.jsx("input",{type:"text",value:s.key_attribute||"",onChange:k=>a("key_attribute",k.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Heroic Ability"}),e.jsx("input",{type:"text",value:s.heroic_ability||"",onChange:k=>a("heroic_ability",k.target.value),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Magic School"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:s.magic_school_id||"",onChange:k=>a("magic_school_id",k.target.value||null),className:"flex-grow w-full px-3 py-2 border rounded-md",disabled:p,children:[e.jsx("option",{value:"",children:"None"}),p&&e.jsx("option",{disabled:!0,children:"Loading schools..."}),d&&e.jsx("option",{disabled:!0,children:d}),!p&&!d&&m.map(k=>e.jsx("option",{value:k.id,children:k.name},k.id))]}),e.jsx(M,{variant:"secondary",icon:ye,onClick:()=>{j(null),u(!0)},disabled:p,children:"Create"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{type:"button",onClick:()=>r("skills"),className:`px-4 py-2 -mb-px font-medium ${t==="skills"?"border-b-2 border-blue-600 text-blue-600":"text-gray-600"}`,children:"Skills"}),e.jsx("button",{type:"button",onClick:()=>r("startingEquipment"),className:`px-4 py-2 -mb-px font-medium ${t==="startingEquipment"?"border-b-2 border-blue-600 text-blue-600":"text-gray-600"}`,children:"Starting Equipment"})]}),t==="skills"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Skills"}),o?e.jsx("p",{children:"Loading..."}):x?e.jsx("p",{className:"text-red-500",children:x}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:n.map(k=>{var R;return e.jsxs("label",{className:"flex items-center gap-1.5",children:[e.jsx("input",{type:"checkbox",checked:((R=s.skills)==null?void 0:R.includes(k.name))??!1,onChange:O=>{const z=new Set(s.skills||[]);O.target.checked?z.add(k.name):z.delete(k.name),a("skills",Array.from(z))}}),e.jsx("span",{className:"text-sm",children:k.name})]},k.id)})})]}),t==="startingEquipment"&&e.jsx("div",{className:"mt-4 space-y-4",children:[0,1,2].map(k=>e.jsxs("div",{className:"border p-3 rounded-md bg-gray-50",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Equipment Option ",k+1]}),e.jsx("input",{type:"text",placeholder:"e.g., Horn or Flute, knife, torch",value:w[k]||"",onChange:R=>E(k,"equipment",R.target.value),className:"w-full px-3 py-2 border rounded-md mb-2"}),e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{placeholder:"e.g., D6 food rations, D8 silver",value:L[k]||"",onChange:R=>E(k,"description",R.target.value),rows:2,className:"w-full px-3 py-2 border rounded-md"})]},k))})]})]})]})},ic=({entry:s,onChange:a})=>{const{skills:t,loading:r,error:n}=qr(),[l,o]=i.useState(!1),[c,x]=i.useState(!1),[g,m]=i.useState({}),b=i.useCallback(()=>{if(r||!t||t.length===0)return;x(!0);const d=s.requirement;let v={};if(ma(d))v=d,console.log("AbilityForm: Initial requirement is already name-based:",d);else if(Xa(d)){console.log("AbilityForm: Initial requirement is UUID-based, converting:",d);const f=new Map(t.map(u=>[u.id,u.name]));for(const[u,N]of Object.entries(d)){const S=f.get(u);S?v[S]=N:console.warn(`AbilityForm: Could not find skill name for UUID ${u} during initialization.`)}console.log("AbilityForm: Converted to name-based requirements:",v)}else typeof d=="string"||d===null||d===void 0?(console.log("AbilityForm: Initial requirement is simple string, null, or undefined:",d),v={}):(console.warn("AbilityForm: Unrecognized requirement format during initialization:",d),v={});m(v),x(!1)},[s.requirement,t,r]);i.useEffect(()=>{b()},[b]),i.useEffect(()=>{a("requirement",g)},[g,a]);const p=(d,v)=>{typeof d=="string"&&m(f=>{const u={...f};return v?u.hasOwnProperty(d)||(u[d]=null):delete u[d],u})},h=(d,v)=>{if(typeof d!="string")return;const f=v===""?null:parseInt(v,10);g.hasOwnProperty(d)&&m(u=>({...u,[d]:isNaN(f)?null:f}))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ability-name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{id:"ability-name",type:"text",value:s.name||"",onChange:d=>a("name",d.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ability-description",className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{id:"ability-description",value:s.description||"",onChange:d=>a("description",d.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ability-willpower_cost",className:"block text-sm font-medium text-gray-700 mb-1",children:"Willpower Cost"}),e.jsx("input",{id:"ability-willpower_cost",type:"number",value:s.willpower_cost===null||s.willpower_cost===void 0?"":s.willpower_cost,onChange:d=>a("willpower_cost",d.target.value===""?null:parseInt(d.target.value,10)),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",min:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ability-profession",className:"block text-sm font-medium text-gray-700 mb-1",children:"Profession (Optional)"}),e.jsx("input",{id:"ability-profession",type:"text",value:s.profession||"",onChange:d=>a("profession",d.target.value||null),placeholder:"Leave blank if applicable to all",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Specify if this ability is restricted to a certain profession."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ability-kin",className:"block text-sm font-medium text-gray-700 mb-1",children:"Kin (Optional)"}),e.jsx("input",{id:"ability-kin",type:"text",value:s.kin||"",onChange:d=>a("kin",d.target.value||null),placeholder:"Leave blank if applicable to all",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Specify if this ability is restricted to a certain kin."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Skill Requirements (Optional)"}),e.jsxs("details",{className:"border border-gray-300 rounded-md shadow-sm overflow-hidden",open:l,onToggle:d=>o(d.target.open),children:[e.jsx("summary",{className:"px-3 py-2 cursor-pointer bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded-t-md",children:Object.keys(g).length>0?`${Object.keys(g).length} skill(s) selected`:"Select required skills..."}),e.jsx("div",{className:"p-4 border-t border-gray-200 max-h-60 overflow-y-auto",children:r||c?e.jsxs("div",{className:"flex justify-center items-center py-4",children:[e.jsx(oe,{size:"md"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"Loading skills..."})]}):n?e.jsx(ie,{message:`Error loading skills: ${n}`}):t.length===0?e.jsx("p",{className:"text-gray-500",children:"No skills available."}):e.jsx("ul",{className:"space-y-2",children:t.map(d=>{const v=d.name,f=g.hasOwnProperty(v),u=g[v];return e.jsxs("li",{className:"flex items-center space-x-3",children:[" ",e.jsx("input",{id:`skill-req-${d.id}`,type:"checkbox",checked:f,onChange:N=>p(v,N.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsxs("label",{htmlFor:`skill-req-${d.id}`,className:"flex-1 text-sm text-gray-700",children:[d.name," ",d.attribute?`(${d.attribute})`:""]}),f&&e.jsx("input",{type:"number",min:"1",placeholder:"Level (Opt.)",value:u??"",onChange:N=>h(v,N.target.value),className:"w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"})]},d.id)})})})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Select skills required for this ability and optionally specify a minimum level. Requirements are now stored by skill name."}),typeof s.requirement=="string"&&s.requirement&&e.jsx("div",{className:"mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded",children:e.jsxs("p",{className:"text-xs text-yellow-700",children:[e.jsx("strong",{children:"Note:"}),' This ability has a non-skill requirement text: "',s.requirement,'". Saving will overwrite this if skills are selected above.']})}),Xa(s.requirement)&&c&&e.jsx("div",{className:"mt-2 p-2 bg-orange-50 border border-orange-200 rounded",children:e.jsx("p",{className:"text-xs text-orange-700",children:"Attempting to convert legacy UUID-based requirements..."})})]}),s.created_at&&e.jsx("div",{className:"mt-4 pt-2 border-t border-gray-200",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["Created: ",new Date(s.created_at).toLocaleString()]})})]})};function Yr(s){return typeof s!="object"||s===null||!s.type?!1:s.type==="logical"?(s.operator==="AND"||s.operator==="OR")&&Array.isArray(s.conditions)&&s.conditions.every(Yr):["spell","school","skill","attribute"].includes(s.type)?typeof s.name=="string":s.type==="anySchool"}function oc({entry:s,onChange:a,magicSchools:t=[]}){const[r,n]=i.useState(""),[l,o]=i.useState(null);i.useEffect(()=>{if(s.prerequisite)try{typeof s.prerequisite=="object"&&s.prerequisite!==null?n(JSON.stringify(s.prerequisite,null,2)):typeof s.prerequisite=="string"&&n(JSON.stringify(JSON.parse(s.prerequisite),null,2))}catch{n(s.prerequisite)}else n("")},[s.prerequisite]);const c=m=>{const b=m.target.value;if(n(b),b.trim()===""){a("prerequisite",null),o(null);return}try{const p=JSON.parse(b);Yr(p)?(a("prerequisite",JSON.stringify(p)),o(null)):o("Invalid prerequisite JSON structure. Please check the format.")}catch{o("Invalid JSON. Please ensure correct JSON syntax.")}},x=m=>{const{name:b,value:p,type:h}=m.target;let d=p;h==="number"&&m.target instanceof HTMLInputElement&&(d=p===""?null:parseInt(p,10),isNaN(d)&&(d=null)),b==="school_id"&&p===""&&(d=null),a(b,d)},g=m=>{const{name:b,checked:p}=m.target;a(b,p?"yes":"none")};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700",children:"Name"}),e.jsx("input",{type:"text",name:"name",id:"name",value:s.name||"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("textarea",{name:"description",id:"description",rows:3,value:s.description||"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"school_id",className:"block text-sm font-medium text-gray-700",children:"Magic School"}),e.jsxs("select",{name:"school_id",id:"school_id",value:s.school_id??"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white",children:[e.jsx("option",{value:"",children:"General"}),t.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rank",className:"block text-sm font-medium text-gray-700",children:"Rank (0 for Trick)"}),e.jsx("input",{type:"number",name:"rank",id:"rank",min:"0",max:"5",value:s.rank??0,onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"casting_time",className:"block text-sm font-medium text-gray-700",children:"Casting Time"}),e.jsx("input",{type:"text",name:"casting_time",id:"casting_time",value:s.casting_time||"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"range",className:"block text-sm font-medium text-gray-700",children:"Range"}),e.jsx("input",{type:"text",name:"range",id:"range",value:s.range||"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"duration",className:"block text-sm font-medium text-gray-700",children:"Duration"}),e.jsx("input",{type:"text",name:"duration",id:"duration",value:s.duration||"",onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"willpower_cost",className:"block text-sm font-medium text-gray-700",children:"Willpower Cost"}),e.jsx("input",{type:"number",name:"willpower_cost",id:"willpower_cost",min:"0",value:s.willpower_cost??0,onChange:x,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"dice",className:"block text-sm font-medium text-gray-700",children:"Dice"}),e.jsx("input",{type:"text",name:"dice",id:"dice",value:s.dice||"",onChange:x,placeholder:"e.g., D6, 2D8",className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),e.jsxs("div",{className:"flex items-center h-11",children:[e.jsx("input",{type:"checkbox",name:"power_level",id:"power_level",checked:s.power_level==="yes",onChange:g,className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"power_level",className:"ml-2 block text-sm font-medium text-gray-700",children:"Has Power Levels?"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"prerequisite",className:"block text-sm font-medium text-gray-700",children:"Learning Prerequisite (JSON or leave empty)"}),e.jsx("textarea",{name:"prerequisite",id:"prerequisite",rows:6,value:r,onChange:c,placeholder:'JSON for learning, e.g., {"type": "spell", "name": "Light"}. Leave empty for no prerequisite.',className:`mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none sm:text-sm ${l?"border-red-500 focus:border-red-500 focus:ring-red-500":"border-gray-300 focus:border-blue-500 focus:ring-blue-500"}`}),l&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:l}),e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Use JSON format for learning prerequisites. Examples: ",e.jsx("br",{}),e.jsx("code",{children:'{"type": "anySchool"}'})," ",e.jsx("br",{}),e.jsx("code",{children:'{"type": "spell", "name": "Example Spell"}'})," ",e.jsx("br",{}),e.jsx("code",{children:'{"type": "logical", "operator": "AND", "conditions": [...]}'})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"requirement",className:"block text-sm font-medium text-gray-700",children:"Casting Requirement (Text or leave empty)"}),e.jsx("textarea",{name:"requirement",id:"requirement",rows:3,value:s.requirement||"",onChange:x,placeholder:"e.g., Requires a free hand, or Verbal component only. Leave empty if none.",className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Describe any requirements for casting the spell (e.g., components, conditions)."})]})]})}const cc=({entry:s,onChange:a})=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"skill-name",className:"block text-sm font-medium text-gray-700 mb-1",children:"Skill Name"}),e.jsx("input",{id:"skill-name",type:"text",value:s.name||"",onChange:t=>a("name",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"skill-description",className:"block text-sm font-medium text-gray-700 mb-1",children:"Description (Optional)"}),e.jsx("textarea",{id:"skill-description",value:s.description||"",onChange:t=>a("description",t.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("input",{id:"is_magic_skill",type:"checkbox",checked:s.is_magic||!1,onChange:t=>a("is_magic",t.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"is_magic_skill",className:"text-sm font-medium text-gray-900",children:"Is this a magic skill?"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Check if this skill is related to magic or spellcasting."})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"skill-attribute",className:"block text-sm font-medium text-gray-700 mb-1",children:"Key Attribute (Optional)"}),e.jsx("input",{id:"skill-attribute",type:"text",value:s.attribute||"",onChange:t=>a("attribute",t.target.value||null),placeholder:"e.g., STR, AGL, WIL...",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"The primary attribute associated with this skill."})]}),s.created_at&&e.jsx("div",{className:"mt-4 pt-2 border-t border-gray-200",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["Created: ",new Date(s.created_at).toLocaleString()]})})]}),dc=["Small","Normal","Large","Huge","Swarm"],tr=()=>({FEROCITY:0,SIZE:"Normal",MOVEMENT:0,ARMOR:0,HP:0}),mc=()=>({id:crypto.randomUUID(),roll_values:"",name:"",description:"",effects:[]}),uc=()=>({id:crypto.randomUUID(),roll_values:"",name:"",description:""});function xc({entry:s,onChange:a}){const[t,r]=i.useState({...s,stats:s.stats||tr(),attacks:(s.attacks||[]).map(p=>({...p,id:p.id||crypto.randomUUID(),effects:(p.effects||[]).map(h=>({...h,id:h.id||crypto.randomUUID()}))}))});i.useEffect(()=>{r({...s,stats:s.stats||tr(),attacks:(s.attacks||[]).map(p=>({...p,id:p.id||crypto.randomUUID(),effects:(p.effects||[]).map(h=>({...h,id:h.id||crypto.randomUUID()}))}))})},[s]);const n=i.useCallback((p,h)=>{const d={...t,[p]:h};r(d),a(p,h)},[t,a]),l=i.useCallback((p,h)=>{const d={...t.stats,[p]:h};n("stats",d)},[t.stats,n]),o=i.useCallback(()=>{const p=[...t.attacks,mc()];n("attacks",p)},[t.attacks,n]),c=i.useCallback((p,h,d)=>{const v=[...t.attacks];v[p]={...v[p],[h]:d},n("attacks",v)},[t.attacks,n]),x=i.useCallback(p=>{const h=t.attacks.filter((d,v)=>v!==p);n("attacks",h)},[t.attacks,n]),g=i.useCallback(p=>{const h=[...t.attacks];h[p].effects=[...h[p].effects||[],uc()],n("attacks",h)},[t.attacks,n]),m=i.useCallback((p,h,d,v)=>{const f=[...t.attacks];f[p].effects&&(f[p].effects[h]={...f[p].effects[h],[d]:v},n("attacks",f))},[t.attacks,n]),b=i.useCallback((p,h)=>{const d=[...t.attacks];d[p].effects&&(d[p].effects=d[p].effects.filter((v,f)=>f!==h),n("attacks",d))},[t.attacks,n]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Name"}),e.jsx("input",{type:"text",value:t.name||"",onChange:p=>n("name",p.target.value),className:"w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsx("input",{type:"text",value:t.category||"",onChange:p=>n("category",p.target.value),placeholder:"e.g., Beast, Undead, Humanoid",className:"w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:t.description||"",onChange:p=>n("description",p.target.value),rows:4,className:"w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"p-4 border rounded-md shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3 text-gray-800",children:"Statistics"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ferocity"}),e.jsx("input",{type:"number",value:t.stats.FEROCITY,onChange:p=>l("FEROCITY",parseInt(p.target.value,10)||0),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Size"}),e.jsx("select",{value:t.stats.SIZE,onChange:p=>l("SIZE",p.target.value),className:"w-full px-3 py-2 border rounded-md",children:dc.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Movement"}),e.jsx("input",{type:"number",value:t.stats.MOVEMENT,onChange:p=>l("MOVEMENT",parseInt(p.target.value,10)||0),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Armor"}),e.jsx("input",{type:"number",value:t.stats.ARMOR,onChange:p=>l("ARMOR",parseInt(p.target.value,10)||0),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"HP"}),e.jsx("input",{type:"number",value:t.stats.HP,onChange:p=>l("HP",parseInt(p.target.value,10)||0),className:"w-full px-3 py-2 border rounded-md"})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Effects Summary"}),e.jsx("textarea",{value:t.effectsSummary||"",onChange:p=>n("effectsSummary",p.target.value),rows:3,placeholder:"Describe any special effects or abilities here...",className:"w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"p-4 border rounded-md shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Attacks (D6 Rollable Table)"}),e.jsx(M,{variant:"secondary",size:"sm",icon:Us,onClick:o,children:"Add Attack"})]}),t.attacks.length===0&&e.jsx("p",{className:"text-gray-500",children:'No attacks defined. Click "Add Attack" to create one.'}),t.attacks.map((p,h)=>e.jsxs("div",{className:"p-3 border rounded-md mb-4 bg-gray-50",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-2",children:[e.jsx("input",{type:"text",placeholder:"Roll Values (e.g., 1, 2-3)",value:p.roll_values,onChange:d=>c(h,"roll_values",d.target.value),className:"px-3 py-2 border rounded-md"}),e.jsx("input",{type:"text",placeholder:"Attack Name",value:p.name,onChange:d=>c(h,"name",d.target.value),className:"md:col-span-2 px-3 py-2 border rounded-md"})]}),e.jsx("textarea",{placeholder:"Attack Description",value:p.description,onChange:d=>c(h,"description",d.target.value),rows:2,className:"w-full px-3 py-2 border rounded-md mb-2"}),e.jsxs("div",{className:"ml-4 mt-2 p-3 border-l-2 border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h4",{className:"text-md font-semibold text-gray-700",children:"Effects (Optional D6 Table)"}),e.jsx(M,{variant:"outline",size:"xs",icon:Us,onClick:()=>g(h),children:"Add Effect"})]}),p.effects.length===0&&e.jsx("p",{className:"text-gray-500",children:'No effects for this attack. Click "Add Effect" to create one.'}),p.effects.map((d,v)=>e.jsxs("div",{className:"p-2 border rounded-md mb-2 bg-white",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 mb-1",children:[e.jsx("input",{type:"text",placeholder:"Roll (e.g., 1-2)",value:d.roll_values,onChange:f=>m(h,v,"roll_values",f.target.value),className:"px-2 py-1 border rounded-md text-sm"}),e.jsx("input",{type:"text",placeholder:"Effect Name",value:d.name,onChange:f=>m(h,v,"name",f.target.value),className:"md:col-span-2 px-2 py-1 border rounded-md text-sm"})]}),e.jsx("textarea",{placeholder:"Effect Description",value:d.description,onChange:f=>m(h,v,"description",f.target.value),rows:1,className:"w-full px-2 py-1 border rounded-md text-sm"}),e.jsx("div",{className:"text-right mt-1",children:e.jsx(M,{variant:"danger",size:"xs",icon:Le,onClick:()=>b(h,v),children:"Remove Effect"})})]},d.id))]}),e.jsx("div",{className:"text-right",children:e.jsx(M,{variant:"danger",size:"sm",icon:Le,onClick:()=>x(h),children:"Remove Attack"})})]},p.id))]})]})}const It=({title:s,items:a,onAdd:t,onRemove:r,onUpdate:n})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:s}),a.map((l,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:l,onChange:c=>n(o,c.target.value),className:"w-full px-3 py-2 border rounded-md flex-grow",placeholder:`Enter ${s.replace(/s$/,"").toLowerCase()}...`}),e.jsx(M,{variant:"danger",size:"sm",icon:Le,onClick:()=>r(o),"aria-label":`Remove ${s.slice(0,-1)}`})]},o)),e.jsxs(M,{variant:"secondary",size:"sm",icon:ye,onClick:t,children:["Add ",s.replace(/s$/,"")]})]}),hc=({entry:s,onChange:a})=>{const t=(r,n,l,o)=>{const c=[...s[r]||[]];switch(n){case"add":c.push("");break;case"remove":l!==void 0&&c.splice(l,1);break;case"update":l!==void 0&&o!==void 0&&(c[l]=o);break}a(r,c)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio-name",className:"block text-sm font-medium text-gray-700",children:"Set Name"}),e.jsx("input",{id:"bio-name",type:"text",value:s.name||"",onChange:r=>a("name",r.target.value),className:"mt-1 w-full px-3 py-2 border rounded-md",placeholder:"e.g., General, Human Commoner, Elven Ranger"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"A unique name for this collection of bio options."})]}),e.jsx(It,{title:"Appearance Options",items:s.appearance||[],onAdd:()=>t("appearance","add"),onRemove:r=>t("appearance","remove",r),onUpdate:(r,n)=>t("appearance","update",r,n)}),e.jsx(It,{title:"Mementos",items:s.mementos||[],onAdd:()=>t("mementos","add"),onRemove:r=>t("mementos","remove",r),onUpdate:(r,n)=>t("mementos","update",r,n)}),e.jsx(It,{title:"Flaws / Weak Spots",items:s.flaws||[],onAdd:()=>t("flaws","add"),onRemove:r=>t("flaws","remove",r),onUpdate:(r,n)=>t("flaws","update",r,n)})]})};function pc(s){const[a,t]=i.useState([]),[r,n]=i.useState(!0),[l,o]=i.useState(null),[c,x]=i.useState(s),g=i.useCallback(d=>{switch(d){case"spells":return"game_spells";case"items":return"game_items";case"abilities":return"heroic_abilities";case"kin":return"kin";case"profession":return"professions";case"skills":return"game_skills";case"monsters":return"monsters";case"bio":return"bio_data";default:throw console.error(`Invalid data category passed to getTableName: ${d}`),new Error(`Invalid data category: ${d}`)}},[]),m=i.useCallback(async d=>{n(!0),o(null);let v;try{v=g(d),console.log(`[useGameData] Attempting to load category: ${d}, using table: ${v}`);let f=H.from(v);d==="spells"?f=f.select(`
                *,
                magic_schools ( name )
              `):f=f.select("*"),f=f.order("name"),console.log(`[useGameData] Executing query for table: ${v}`);const{data:u,error:N}=await f;if(N)throw console.error(`[useGameData] Supabase fetch error for ${v}:`,N),N;const S=(u||[]).map(A=>{var q;let j={...A};if(d==="spells"&&(j.magic_schools=(q=A.magic_schools)==null?void 0:q.name),d==="abilities"&&typeof A.requirement=="string")try{j.requirement=JSON.parse(A.requirement)}catch{}return j});console.log(`[useGameData] Loaded ${S.length} entries for ${d} from ${v}`),t(S)}catch(f){const u=v||d;console.error(`[useGameData] Error in loadEntries for ${u}:`,f);const N=(f==null?void 0:f.message)||`Failed to load ${u}`,S=f!=null&&f.details?`: ${f.details}`:"";o(`${N}${S}`),t([])}finally{n(!1)}},[g]),b=i.useCallback(async(d,v,f,u)=>{let N="";try{u(null),n(!0),N=g(d);const{id:S,...A}=v;let j={...A};if(!j.name||String(j.name).trim()==="")throw new Error(`Cannot save ${d} without a name.`);if(d==="abilities"&&(j.willpower_cost=j.willpower_cost===""||j.willpower_cost===void 0?null:Number(j.willpower_cost),typeof j.requirement=="object"&&j.requirement!==null?Object.keys(j.requirement).length>0?j.requirement=JSON.stringify(j.requirement):j.requirement=null:(j.requirement===""||j.requirement===void 0)&&(j.requirement=null),j.kin=j.kin||null,j.profession=j.profession||null),d==="spells"&&(j.rank=Number(j.rank??0),j.willpower_cost=Number(j.willpower_cost??0),j.school_id=j.school_id||null,j.requirement=j.requirement||null),d==="skills"&&(j.attribute=j.attribute||null),d==="monsters"){const _=v;if(j.stats=_.stats||{FEROCITY:0,SIZE:"Normal",MOVEMENT:0,ARMOR:0,HP:0},j.attacks=_.attacks||[],Array.isArray(j.attacks)&&(j.attacks=j.attacks.map(y=>{const{id:w,effects:L,...E}=y;return Array.isArray(L)&&(E.effects=L.map(P=>{const{id:k,...R}=P;return R})),E})),!S){const{data:y,error:w}=await H.auth.getSession();if(w||!y.session)throw new Error("User not authenticated. Cannot save monster.");j.created_by=y.session.user.id}}console.log(`[useGameData] Saving entry to ${N} (ID: ${S||"new"}):`,j);let q=null,C=null;if(S){const{data:_,error:y}=await H.from(N).update(j).eq("id",S).select().single();q=y,C=_}else{const{data:_,error:y}=await H.from(N).insert([j]).select().single();q=y,C=_}if(q)throw console.error(`[useGameData] Supabase Save Error (${N}):`,q),q;C?(console.log(`[useGameData] Save operation successful for ${d} (ID: ${C.id})`),f(C)):(console.warn(`[useGameData] Save operation for ${d} (ID: ${S||"new"}) did not return data. Using input data for callback.`),f({...v,id:S||(C==null?void 0:C.id)})),await m(d)}catch(S){const A=N||d,j=(S==null?void 0:S.message)||(typeof S=="string"?S:"An unexpected error occurred during save."),q=S!=null&&S.details?` (Details: ${S.details})`:"",C=S!=null&&S.code?` (Code: ${S.code})`:"",_=`Error saving ${A}: ${j}${q}${C}`;console.error(`[useGameData] Error in handleSave for ${A}:`,S),u(_)}finally{n(!1)}},[g,m]),p=i.useCallback(async(d,v)=>{if(!window.confirm(`Are you sure you want to delete this ${d} entry (ID: ${v})? This action cannot be undone.`))return;let f="";try{o(null),n(!0),f=g(d),console.log(`[useGameData] Deleting entry from ${f}, ID: ${v}`);const{error:u}=await H.from(f).delete().eq("id",v);if(u)throw console.error(`[useGameData] Error deleting from ${f}:`,u),u;console.log(`[useGameData] Delete successful for ID: ${v} in ${d}`),await m(d)}catch(u){const N=f||d,S=(u==null?void 0:u.message)||"An unexpected error occurred during deletion.",A=u!=null&&u.details?` (Details: ${u.details})`:"",j=u!=null&&u.code?` (Code: ${u.code})`:"",q=`Error deleting ${N}: ${S}${A}${j}`;console.error(`[useGameData] Error in handleDelete for ${N}:`,u),o(q)}finally{n(!1)}},[g,m]),h=i.useCallback(d=>{console.log(`[useGameData] Switching category from ${c} to ${d}`),x(d),m(d)},[c,m]);return i.useEffect(()=>{console.log(`[useGameData] Initial load effect for category: ${s}`);try{g(s),m(s)}catch(d){console.error(`[useGameData] Invalid initial category: ${s}`,d),o(`Invalid initial category: ${s}`),n(!1)}},[s,g,m]),{entries:a,loading:r,error:l,activeCategory:c,switchCategory:h,handleSave:b,handleDelete:p}}const gc=[{id:"items",label:"Items",icon:qe},{id:"spells",label:"Spells",icon:dt},{id:"abilities",label:"Abilities",icon:Me},{id:"kin",label:"Kin",icon:De},{id:"profession",label:"Professions",icon:nl},{id:"skills",label:"Skills",icon:ll},{id:"monsters",label:"Monsters",icon:is},{id:"bio",label:"Bio Options",icon:il}],ar=s=>{try{if(ma(s)){const a=Object.entries(s);return a.length===0?"None":a.map(([t,r])=>`${t}${r!==null?` (Lvl ${r})`:""}`).join(", ")||"None"}if(typeof s=="string"&&s)return s;if(typeof s=="object"&&s!==null){const a=Object.keys(s);if(a.length>0)return/^[0-9a-fA-F]{8}-/.test(a[0])?`${a.length} skill(s) (Legacy UUIDs)`:a.length===1&&typeof s[a[0]]=="object"?`Requirement: ${a[0]} (Invalid Format)`:`${a.length} requirement(s) (Unknown format)`}return"None"}catch(a){return console.error("Error formatting requirement:",s,a),"Error: Invalid Format"}},fc=()=>{const[s,a]=i.useState(null),[t,r]=i.useState(""),[n,l]=i.useState(null),[o,c]=i.useState(""),[x,g]=i.useState([]),[m,b]=i.useState([]),[p,h]=i.useState([]),{entries:d,loading:v,error:f,handleSave:u,handleDelete:N,switchCategory:S,activeCategory:A}=pc("items"),j=i.useCallback(async(k,R)=>{const{data:O,error:z}=await H.from(k).select("category");z?console.error(`Error fetching ${k} categories:`,z):O&&R([...new Set(O.map(F=>F.category).filter(Boolean))])},[]),q=i.useCallback(async()=>{const{data:k,error:R}=await H.from("magic_schools").select("id, name").order("name");R?console.error("Error fetching magic schools:",R):k&&b(k)},[]);i.useEffect(()=>{c(""),A==="items"?j("game_items",g):A==="spells"?q():A==="monsters"&&j("monsters",h)},[A,j,q]);const C=i.useCallback(()=>{a(null),l(null),A==="items"&&j("game_items",g),A==="monsters"&&j("monsters",h)},[A,j]),_=i.useCallback(async()=>{if(!s)return;let k=s;if(A==="spells"){const{magic_schools:R,...O}=s;k=O}await u(A,k,C,l)},[s,A,u,C]),y=i.useCallback(async k=>{k&&window.confirm("Are you sure you want to delete this entry?")&&(await N(A,k),A==="items"&&j("game_items",g),A==="monsters"&&j("monsters",h))},[A,N,j]),w=i.useCallback((k,R)=>{a(O=>O?{...O,[k]:R}:null)},[]),L=i.useCallback(()=>{l(null);let k={name:""};switch(A){case"spells":k={...k,description:"",rank:1,school_id:null,casting_time:"",range:"",duration:"",willpower_cost:0};break;case"items":k={...k,description:"",category:"",cost:0,weight:0};break;case"abilities":k={...k,description:"",willpower_cost:null,requirement:{},profession:null,kin:null};break;case"kin":k={...k,description:"",key_attribute:"",typical_profession:"",kin_abilities:[]};break;case"profession":k={...k,description:"",key_attribute:"",skills:[]};break;case"skills":k={...k,description:"",attribute:null};break;case"monsters":k={name:"",description:"",category:"",stats:{FEROCITY:0,SIZE:"Normal",MOVEMENT:0,ARMOR:0,HP:10},attacks:[]};break;case"bio":k={name:"",appearance:[],mementos:[],flaws:[]};break}a(k)},[A]),E=i.useMemo(()=>d.filter(k=>{var O,z,F,U;if(!((O=k.name)==null?void 0:O.toLowerCase().includes(t.toLowerCase())))return!1;if(o){if(A==="items")return((z=k.category)==null?void 0:z.toLowerCase())===o.toLowerCase();if(A==="spells"){if(o==="General")return!k.school_id;const T=m.find(I=>I.id===k.school_id);return((F=T==null?void 0:T.name)==null?void 0:F.toLowerCase())===o.toLowerCase()}if(A==="monsters")return((U=k.category)==null?void 0:U.toLowerCase())===o.toLowerCase()}return!0}),[d,t,o,A,m]),P=i.useCallback(()=>{a(null),l(null)},[]);return{editingEntry:s,setEditingEntry:a,searchTerm:t,setSearchTerm:r,saveError:n,setSaveError:l,selectedSubCategory:o,setSelectedSubCategory:c,itemCategories:x,magicSchools:m,monsterCategories:p,entries:d,loading:v,loadError:f,handleSave:_,handleDelete:y,switchCategory:S,activeCategory:A,handleFieldChange:w,createNewEntry:L,filteredEntries:E,closeModal:P}},bc=({activeCategory:s,switchCategory:a,loading:t})=>e.jsx("div",{className:"flex gap-2 border-b border-gray-200 overflow-x-auto pb-1 no-scrollbar",children:gc.map(({id:r,label:n,icon:l})=>e.jsxs("button",{onClick:()=>a(r),className:`
                    px-4 py-2.5 text-sm font-medium rounded-t-lg flex items-center gap-2 whitespace-nowrap transition-colors
                    ${s===r?"bg-white border-x border-t border-gray-200 text-indigo-600 border-b-white -mb-px relative z-10":"text-gray-500 hover:text-gray-800 hover:bg-gray-50"}
                `,disabled:t,children:[e.jsx(l,{className:"w-4 h-4"}),n]},r))}),yc=({searchTerm:s,setSearchTerm:a,activeCategory:t,loading:r,currentSubCategories:n,selectedSubCategory:l,setSelectedSubCategory:o})=>e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6 p-1",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:`Search ${t}...`,value:s,onChange:c=>a(c.target.value),className:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-shadow",disabled:r})]}),n.length>0&&e.jsxs("div",{className:"relative flex-1 sm:flex-none sm:w-56",children:[e.jsx(Ks,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsxs("select",{value:l,onChange:c=>o(c.target.value),className:"w-full pl-9 pr-8 py-2 border border-gray-300 rounded-lg text-sm appearance-none bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none cursor-pointer",disabled:r,children:[e.jsxs("option",{value:"",children:["All ",t==="spells"?"Schools":"Categories"]}),n.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500",children:e.jsx("svg",{className:"fill-current h-4 w-4",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"})})})]})]}),jc=({columns:s,entries:a,onEdit:t,onDelete:r,loading:n,activeCategory:l,searchTerm:o,selectedSubCategory:c,loadError:x})=>e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden shadow-sm bg-white",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-[600px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200",children:[s.map(g=>e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider",children:g.header},g.header)),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:a.map(g=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[s.map(m=>e.jsx("td",{className:`px-4 py-3 text-sm text-gray-700 align-top ${m.className||""}`,title:m.titleAccessor?m.titleAccessor(g):void 0,children:m.accessor(g)},m.header)),e.jsx("td",{className:"px-4 py-3 text-sm align-top text-right whitespace-nowrap",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(M,{variant:"secondary",size:"sm",icon:Vs,onClick:()=>t(g),disabled:!g.id,children:"Edit"}),e.jsx(M,{variant:"danger_outline",size:"sm",icon:Le,onClick:()=>g.id&&r(g.id),disabled:!g.id||n,children:"Delete"})]})})]},g.id||g.name))})]})}),a.length===0&&!n&&!x&&e.jsxs("div",{className:"text-center py-12 bg-white",children:[e.jsx("div",{className:"text-gray-400 mb-2",children:o||c?e.jsx(Te,{className:"w-8 h-8 mx-auto opacity-20"}):e.jsx(ye,{className:"w-8 h-8 mx-auto opacity-20"})}),e.jsx("p",{className:"text-gray-500 text-sm",children:o||c?`No ${l} found matching your filters.`:`No entries found for '${l}'.`})]})]}),vc=({entry:s,onClose:a,onSave:t,loading:r,activeCategory:n,saveError:l,onFieldChange:o,magicSchools:c})=>{const x=i.useCallback(()=>{if(!s)return null;switch(n){case"spells":return e.jsx(oc,{entry:s,onChange:o,magicSchools:c});case"items":return e.jsx(ac,{entry:s,onChange:o});case"abilities":return e.jsx(ic,{entry:s,onChange:o});case"kin":return e.jsx(rc,{entry:s,onChange:o});case"profession":return e.jsx(lc,{entry:s,onChange:o});case"skills":return e.jsx(cc,{entry:s,onChange:o});case"monsters":return e.jsx(xc,{entry:s,onChange:o});case"bio":return e.jsx(hc,{entry:s,onChange:o});default:return e.jsx("p",{className:"text-gray-500 italic text-center py-8",children:"No form available for this category."})}},[s,n,o,c]);return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex justify-between items-center px-6 py-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 capitalize",children:s.id?`Edit ${n}`:`New ${n}`}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-1 rounded-full transition-colors",children:e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto p-6",children:[l&&e.jsx("div",{className:"mb-6",children:e.jsx(ie,{message:l})}),x()]}),e.jsxs("div",{className:"flex justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl",children:[e.jsx(M,{variant:"ghost",onClick:a,disabled:r,children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:t,disabled:r,children:r?"Saving...":s.id?"Update":"Create"})]})]})})};function Qr(){const{editingEntry:s,setEditingEntry:a,searchTerm:t,setSearchTerm:r,saveError:n,setSaveError:l,selectedSubCategory:o,setSelectedSubCategory:c,itemCategories:x,magicSchools:g,monsterCategories:m,entries:b,loading:p,loadError:h,handleSave:d,handleDelete:v,switchCategory:f,activeCategory:u,handleFieldChange:N,createNewEntry:S,filteredEntries:A,closeModal:j}=fc(),q=i.useMemo(()=>u==="items"?x.sort():u==="spells"?["General",...g.map(_=>_.name)].sort():u==="monsters"?m.sort():[],[u,x,g,m]),C=i.useMemo(()=>{const _=[{header:"Name",accessor:w=>e.jsx("span",{className:"font-medium text-gray-900",children:w.name})}],y="text-sm text-gray-500 max-w-xs truncate";switch(u){case"spells":return[..._,{header:"School",accessor:w=>{if(!w.school_id)return e.jsx("span",{className:"text-gray-400 italic",children:"General"});const L=g.find(E=>E.id===w.school_id);return e.jsx("span",{className:"text-indigo-600 font-medium",children:(L==null?void 0:L.name)||"Unknown"})}},{header:"Rank",accessor:w=>w.rank===0?e.jsx("span",{className:"px-2 py-0.5 bg-gray-100 rounded text-xs",children:"Trick"}):`Rank ${w.rank}`},{header:"Cost",accessor:w=>`${w.willpower_cost} WP`}];case"items":return[..._,{header:"Category",accessor:w=>e.jsx("span",{className:"capitalize",children:w.category})},{header:"Cost",accessor:w=>`${w.cost}g`},{header:"Weight",accessor:w=>w.weight}];case"abilities":return[..._,{header:"Cost",accessor:w=>w.willpower_cost?`${w.willpower_cost} WP`:e.jsx("span",{className:"text-gray-400",children:"-"})},{header:"Requirement",accessor:w=>ar(w.requirement),className:y,titleAccessor:w=>ar(w.requirement)}];case"kin":return[..._,{header:"Key Attribute",accessor:w=>e.jsx("span",{className:"font-mono text-xs bg-gray-100 px-2 py-1 rounded",children:w.key_attribute})},{header:"Typical Profession",accessor:w=>w.typical_profession}];case"profession":return[..._,{header:"Key Attribute",accessor:w=>e.jsx("span",{className:"font-mono text-xs bg-gray-100 px-2 py-1 rounded",children:w.key_attribute})},{header:"Skills",accessor:w=>Array.isArray(w.skills)?w.skills.join(", "):"",className:y}];case"skills":return[..._,{header:"Attribute",accessor:w=>w.attribute?e.jsx("span",{className:"font-mono text-xs bg-gray-100 px-2 py-1 rounded",children:w.attribute}):e.jsx("span",{className:"text-gray-400",children:"-"})},{header:"Description",accessor:w=>w.description,className:y,titleAccessor:w=>w.description||""}];case"monsters":return[..._,{header:"Category",accessor:w=>e.jsx("span",{className:"capitalize",children:w.category})},{header:"HP",accessor:w=>{var L;return e.jsx("span",{className:"font-bold text-red-600",children:(L=w.stats)==null?void 0:L.HP})}},{header:"Armor",accessor:w=>{var L;return(L=w.stats)==null?void 0:L.ARMOR}},{header:"Size",accessor:w=>{var L;return(L=w.stats)==null?void 0:L.SIZE}}];case"bio":return[..._,{header:"Appearance",accessor:w=>`${(w.appearance||[]).length} options`},{header:"Mementos",accessor:w=>`${(w.mementos||[]).length} options`},{header:"Flaws",accessor:w=>`${(w.flaws||[]).length} options`}];default:return _}},[u,g]);return e.jsxs("div",{className:"max-w-7xl mx-auto p-4 md:p-8 space-y-8 min-h-[calc(100vh-4rem)]",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-gray-200 pb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 tracking-tight",children:"Game Data"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage core rules, items, and compendium data."})]}),e.jsx(M,{variant:"primary",icon:ye,onClick:S,disabled:p,className:"shadow-sm",children:"Add Entry"})]}),h&&e.jsx(ie,{message:`Error loading data: ${h}`}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-4 pt-2 border-b border-gray-200",children:e.jsx(bc,{activeCategory:u,switchCategory:f,loading:p})}),e.jsx("div",{className:"p-4 bg-white border-b border-gray-100",children:e.jsx(yc,{searchTerm:t,setSearchTerm:r,activeCategory:u,loading:p,currentSubCategories:q,selectedSubCategory:o,setSelectedSubCategory:c})}),e.jsx("div",{children:p&&!b.length?e.jsx("div",{className:"flex justify-center items-center h-64 text-gray-400",children:e.jsxs("p",{children:["Loading ",u,"..."]})}):e.jsx(jc,{columns:C,entries:A,onEdit:_=>{l(null),a(_)},onDelete:v,loading:p,activeCategory:u,searchTerm:t,selectedSubCategory:o,loadError:h})})]}),s&&e.jsx(vc,{entry:s,onClose:j,onSave:d,loading:p,activeCategory:u,saveError:n,onFieldChange:N,magicSchools:g})]})}function wc(){const{user:s}=Ce(),[a,t]=i.useState(!1),[r,n]=i.useState(null),[l,o]=i.useState(""),[c,x]=i.useState(""),[g,m]=i.useState(""),[b,p]=i.useState(null),[h,d]=i.useState(!1),v=async f=>{f.preventDefault();try{if(!l.trim()||!c.trim()||!g.trim()){p("All fields are required");return}if(!s){p("You must be logged in to create or edit entries");return}if(r){const{error:u}=await H.from("compendium").update({title:l,content:c,category:g}).eq("id",r);if(u)throw u}else{const{error:u}=await H.from("compendium").insert([{title:l,content:c,category:g,created_by:s.id}]);if(u)throw u}o(""),x(""),m(""),t(!1),n(null)}catch(u){p(u instanceof Error?u.message:"Failed to save entry")}};return e.jsx("div",{className:"bg-white p-6 rounded-lg shadow",children:e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:l,onChange:f=>o(f.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category"}),e.jsx("input",{type:"text",value:g,onChange:f=>m(f.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Content"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>d(!1),className:`p-2 rounded-lg ${h?"text-gray-600 hover:bg-gray-100":"bg-blue-100 text-blue-700"}`,children:e.jsx(gt,{className:"w-5 h-5"})}),e.jsx("button",{type:"button",onClick:()=>d(!0),className:`p-2 rounded-lg ${h?"bg-blue-100 text-blue-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(pt,{className:"w-5 h-5"})})]})]}),h?e.jsx("div",{className:"min-h-[300px] p-4 border border-gray-300 rounded-md bg-white overflow-auto",children:e.jsx(As,{content:c})}):e.jsx("textarea",{value:c,onChange:f=>x(f.target.value),rows:12,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono",placeholder:`# Heading 1
## Heading 2

Regular text with **bold** and *italic* formatting.

> Blockquote for important notes

| Table | Header |
|--------|---------|
| Cell 1 | Cell 2 |`})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:()=>{t(!1),n(null),o(""),x(""),m(""),d(!1)},className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(Ae,{className:"w-5 h-5"}),r?"Update Entry":"Save Entry"]})]})]})})}function Nc(){const[s,a]=i.useState("users"),t=()=>{switch(s){case"users":return e.jsx(tc,{});case"gameData":return e.jsx(Qr,{});case"compendium":return e.jsx(wc,{});default:return null}},r=[{key:"users",label:"Users",Icon:yt}];return e.jsxs("div",{className:"",children:[r.length>0&&e.jsx("nav",{className:"border-b",children:e.jsx("ul",{className:"flex -mb-px",children:r.map(({key:n,label:l,Icon:o})=>e.jsx("li",{className:"mr-6",children:e.jsxs("button",{onClick:()=>a(n),className:s===n?"flex items-center py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-semibold":"flex items-center py-2 px-4 text-gray-600 hover:text-gray-800 hover:border-b-2 hover:border-gray-300",children:[e.jsx(o,{className:"w-5 h-5 mr-2"}),l]})},n))})}),e.jsx("div",{className:"mt-6 bg-white p-6 rounded-lg shadow",children:t()})]})}const nt=[{id:"profile",label:"Profile",icon:os,description:"Manage your personal information",category:"account"},{id:"game-data",label:"Game Data",icon:qe,description:"Edit spells, items, and monsters",adminOnly:!0,category:"admin"},{id:"admin",label:"Admin Panel",icon:Me,description:"User management and system logs",adminOnly:!0,category:"admin"}];function kc(){const{isAdmin:s}=Ce(),[a,t]=i.useState("profile");i.useEffect(()=>{const o=nt.find(c=>c.id===a);o!=null&&o.adminOnly&&!s()&&t("profile")},[a,s]);const r=o=>{const c=nt.find(x=>x.id===o);c&&(!c.adminOnly||s())&&t(o)},n=()=>{if(["admin","game-data"].includes(a)&&!s())return e.jsx(ca,{to:"/settings",replace:!0});switch(a){case"profile":return e.jsx(sr,{});case"appearance":return e.jsx(Vo,{});case"notifications":return e.jsx(Yo,{});case"localization":return e.jsx(ec,{});case"game-data":return e.jsx(Qr,{});case"admin":return e.jsx(Nc,{});default:return e.jsx(sr,{})}},l=nt.find(o=>o.id===a);return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8 min-h-[calc(100vh-4rem)]",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx(it,{className:"w-8 h-8 text-indigo-600"}),"Settings"]}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Manage your account preferences and system configurations."})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"w-full lg:w-72 flex-shrink-0 space-y-8",children:[e.jsx("nav",{className:"space-y-1",children:nt.filter(o=>!o.adminOnly||s()).map(o=>{const c=a===o.id;return e.jsxs("button",{onClick:()=>r(o.id),className:`
                      w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200
                      ${c?"bg-white text-indigo-600 shadow-sm ring-1 ring-indigo-100":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"}
                    `,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(o.icon,{size:20,className:c?"text-indigo-600":"text-gray-400"}),e.jsx("span",{children:o.label})]}),c&&e.jsx(Qe,{size:16,className:"text-indigo-400"})]},o.id)})}),s()&&e.jsxs("div",{className:"px-4 py-3 bg-indigo-50 rounded-xl border border-indigo-100",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-800 font-bold text-xs uppercase tracking-wide mb-1",children:[e.jsx(Me,{size:12})," Admin Access"]}),e.jsx("p",{className:"text-xs text-indigo-600",children:"You have elevated privileges."})]})]}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"border-b border-gray-100 px-6 py-5 bg-gray-50/50",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:l==null?void 0:l.label}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:l==null?void 0:l.description})]}),e.jsx("div",{className:"p-6",children:n()})]})})]})]})}function Sc(){const[s,a]=i.useState(!0),[t,r]=i.useState(""),[n,l]=i.useState(""),[o,c]=i.useState(""),[x,g]=i.useState(""),[m,b]=i.useState("player"),[p,h]=i.useState(null),[d,v]=i.useState(null),[f,u]=i.useState({}),[N,S]=i.useState(!1),[A,j]=i.useState(navigator.onLine),{signIn:q,signUp:C}=Ce(),_=Be(),y=Ht();i.useEffect(()=>{var R;(R=y.state)!=null&&R.message&&(v(y.state.message),_(y.pathname,{replace:!0,state:{}}))},[y,_]),i.useEffect(()=>{const R=()=>j(!0),O=()=>j(!1);return window.addEventListener("online",R),window.addEventListener("offline",O),()=>{window.removeEventListener("online",R),window.removeEventListener("offline",O)}},[]);const w=()=>{r(""),l(""),c(""),g(""),b("player"),h(null),v(null),u({})},L=()=>{a(!s),w()},E=async()=>{const R=Ho.safeParse({email:t.trim(),password:n});if(!R.success){const O={};return R.error.errors.forEach(z=>{z.path[0]&&(O[String(z.path[0])]=z.message)}),u(O),h("Please fix the errors in the form."),!1}try{S(!0);const{email:O,password:z}=R.data;return await q(O,z),!0}catch(O){return h(O instanceof Error?O.message:"Login failed. Please try again."),!1}finally{S(!1)}},P=async()=>{const R=Bo.safeParse({username:o.trim(),email:t.trim(),password:n,confirmPassword:x,role:m});if(!R.success){const O={};return R.error.errors.forEach(z=>{z.path[0]&&(O[String(z.path[0])]=z.message)}),u(O),h("Please fix the errors in the form."),!1}try{S(!0);const{email:O,password:z,username:F,role:U}=R.data;return await C(O,z,F,U),v("Registration successful! Please check your email to verify your account before logging in."),a(!0),w(),r(O),!0}catch(O){return h(O instanceof Error?O.message:"Signup failed. Please try again."),!1}finally{S(!1)}},k=async R=>{if(R.preventDefault(),h(null),v(null),u({}),!A){h("No internet connection");return}s?await E():await P()};return e.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-md w-full space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(Me,{className:"mx-auto h-12 w-12 text-blue-600"}),e.jsx("h2",{className:"mt-6 text-3xl font-bold text-gray-900",children:s?"Log in to DragonBane":"Create your DragonBane Account"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:s?"Enter your details to access your account":"Fill in the details to register"})]}),!A&&e.jsx("div",{className:"mb-6 rounded-md bg-yellow-50 p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"h-5 w-5 text-yellow-400 mr-2"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-yellow-800",children:"No internet connection"}),e.jsx("p",{className:"mt-2 text-sm text-yellow-700",children:"Please check your internet connection and try again."})]})]})}),p&&e.jsx("div",{className:"rounded-md bg-red-50 p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"h-5 w-5 text-red-400 mr-2"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:s?"Login Error":"Signup Error"}),e.jsx("p",{className:"mt-2 text-sm text-red-700",children:p})]})]})}),d&&e.jsx("div",{className:"rounded-md bg-green-50 p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"h-5 w-5 text-green-400 mr-2"})," ",e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-green-800",children:"Success"}),e.jsx("p",{className:"mt-2 text-sm text-green-700",children:d})]})]})}),e.jsxs("form",{className:"mt-8 space-y-6",onSubmit:k,noValidate:!0,children:[e.jsxs("div",{className:"space-y-4",children:[!s&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700",children:"Username"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(os,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"username",name:"username",type:"text",required:!0,autoComplete:"username",value:o,onChange:R=>c(R.target.value),className:`pl-10 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${f.username?"border-red-500":"border-gray-300"}`,placeholder:"Choose a username",disabled:N})]}),f.username&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.username})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700",children:"Email address"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ia,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"email",name:"email",type:"email",required:!0,autoComplete:"email",value:t,onChange:R=>r(R.target.value),className:`pl-10 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${f.email?"border-red-500":"border-gray-300"}`,placeholder:"Enter email address",disabled:N})]}),f.email&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.email})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(zs,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"password",name:"password",type:"password",required:!0,autoComplete:s?"current-password":"new-password",value:n,onChange:R=>l(R.target.value),className:`pl-10 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${f.password?"border-red-500":"border-gray-300"}`,placeholder:"Enter password",disabled:N})]}),f.password&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.password})]}),!s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium text-gray-700",children:"Confirm Password"}),e.jsxs("div",{className:"mt-1 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(zs,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"confirmPassword",name:"confirmPassword",type:"password",required:!0,autoComplete:"new-password",value:x,onChange:R=>g(R.target.value),className:`pl-10 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${f.confirmPassword?"border-red-500":"border-gray-300"}`,placeholder:"Confirm password",disabled:N})]}),f.confirmPassword&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.confirmPassword})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Register as"}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4",children:[e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",className:"form-radio text-blue-600",name:"role",value:"player",checked:m==="player",onChange:()=>b("player"),disabled:N}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Player"})]}),e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"radio",className:"form-radio text-blue-600",name:"role",value:"dm",checked:m==="dm",onChange:()=>b("dm"),disabled:N}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Dungeon Master (DM)"})]})]}),f.role&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:f.role})]})]})]}),e.jsx(M,{type:"submit",variant:"primary",fullWidth:!0,loading:N,disabled:!A||N,icon:s?Ut:yt,iconPosition:"left",children:s?"Log in":"Sign up"})]}),e.jsx("div",{className:"text-sm text-center",children:e.jsx("button",{type:"button",onClick:L,className:"font-medium text-blue-600 hover:text-blue-500 disabled:opacity-50",disabled:N,children:s?"Don't have an account? Sign up":"Already have an account? Log in"})})]})})}const Cc=({type:s})=>e.jsx("span",{className:"font-semibold text-xs uppercase",children:s}),_c={d4:4,d6:6,d8:8,d10:10,d12:12,d20:20};function rr(s){return Math.floor(Math.random()*_c[s])+1}function Ec({className:s}){return e.jsx("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M21 12a9 9 0 1 1-6.219-8.56"})})}function Ac(){const{showDiceRoller:s,toggleDiceRoller:a,currentConfig:t,dicePool:r,addDie:n,removeLastDie:l,clearDicePool:o,isBoonActive:c,isBaneActive:x,setBoon:g,setBane:m,addRollToHistory:b,rollHistory:p,clearHistory:h}=ze(),{markSkillThisSession:d}=Se(),[v,f]=i.useState([]),[u,N]=i.useState([]),[S,A]=i.useState(null),[j,q]=i.useState(!1),[C,_]=i.useState(void 0),[y,w]=i.useState(!1),[L,E]=i.useState(1),[P,k]=i.useState(!1),[R,O]=i.useState("..."),z=i.useRef(null),F=(t==null?void 0:t.rollMode)==="skillCheck",U=(t==null?void 0:t.rollMode)==="deathRoll",T=(t==null?void 0:t.rollMode)==="rallyRoll",I=(t==null?void 0:t.rollMode)==="recoveryRoll",B=(t==null?void 0:t.rollMode)==="advancementRoll";i.useEffect(()=>()=>{z.current&&clearInterval(z.current)},[]),i.useEffect(()=>{!c&&!x&&E(1)},[c,x]);const Y=()=>{x?(m(!1),g(!0),E(1)):c?L<3?E(ee=>ee+1):(g(!1),E(1)):(g(!0),E(1))},Q=()=>{c?(g(!1),m(!0),E(1)):x?L<3?E(ee=>ee+1):(m(!1),E(1)):(m(!0),E(1))},D=i.useCallback(()=>{if(r.length===0)return;k(!0),f([]),N([]),A(null),q(!1),_(void 0);const ee=r.map(de=>({type:de,value:rr(de)}));let re=[],K=ee.reduce((de,me)=>de+me.value,0),W=Number(K),se=!1,le,je=t==null?void 0:t.skillName;if(r.length===1&&r[0]==="d20"){if(c||x){for(let Ue=0;Ue<L;Ue++)re.push({type:"d20",value:rr("d20")});const me=[ee[0].value,...re.map(Ue=>Ue.value)];W=c?Math.min(...me):Math.max(...me),K=W}else W=ee[0].value,K=W;const de=W;de===1&&(se=!0,K="Dragon!",le=!0),de===20&&(se=!0,K="Demon!",le=!1),(t==null?void 0:t.targetValue)!==void 0&&!se&&(F||T||B||U)&&(le=de<=t.targetValue),F&&je&&(de===1||de===20)&&d(je)}else I&&r.length===1&&r[0]==="d6"&&(W=ee[0].value,K=W,le=void 0,se=!1);let pe=0;z.current&&clearInterval(z.current),z.current=setInterval(()=>{if(pe++,O(Math.floor(Math.random()*20)+1),pe>6){z.current&&clearInterval(z.current),k(!1),f(ee),N(re),A(K),O(K),q(se),_(le);const de={description:(t==null?void 0:t.description)||`${r.join(", ")} Roll`,dicePool:[...r],results:ee,boonResults:re.length>0?re:void 0,finalOutcome:K,isBoon:c,isBane:x,targetValue:t==null?void 0:t.targetValue,isSuccess:le,isCritical:se,skillName:je};b(de),t!=null&&t.onRollComplete&&t.onRollComplete(de),t!=null&&t.onRoll&&t.onRoll({total:W})}},60)},[r,c,x,L,t,b,d,I,F,T,B,U]);if(i.useEffect(()=>{s||(f([]),N([]),A(null),O("..."),q(!1),_(void 0),w(!1),k(!1),z.current&&clearInterval(z.current))},[s]),!s)return null;const G=()=>t!=null&&t.description?t.description:U?"Death Save (d20 vs CON)":T?"Rally Roll (d20 vs WIL)":I?"Recovery Roll (1d6 HP)":B?"Advancement Roll":F?"Skill Check":"Dice Roller",$=()=>U?e.jsx(is,{className:"w-5 h-5"}):T?e.jsx(xr,{className:"w-5 h-5"}):I?e.jsx(Yt,{className:"w-5 h-5"}):B?e.jsx(Os,{className:"w-5 h-5"}):e.jsx(be,{className:"w-5 h-5"}),Z=P||U||T||I||B;return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-60 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh] border border-gray-200 overflow-hidden transform transition-all scale-100",children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50 flex justify-between items-center text-lg font-bold text-gray-800",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-700",children:[$()," ",G()]}),e.jsx("button",{onClick:()=>a(),className:"text-gray-400 hover:text-gray-700 transition-colors",children:e.jsx(xe,{className:"w-6 h-6"})})]}),e.jsx("div",{className:"p-5 overflow-y-auto flex-grow flex flex-col",children:y?e.jsxs("div",{className:"animate-in slide-in-from-right-4 duration-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3 border-b pb-2",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-500 uppercase tracking-wider",children:"Roll History"}),e.jsxs(M,{onClick:h,variant:"danger",size:"xs",disabled:p.length===0,children:[e.jsx(Le,{className:"w-3 h-3 mr-1"})," Clear"]})]}),p.length===0?e.jsx("p",{className:"text-gray-400 text-center py-8 text-sm italic",children:"No rolls yet."}):e.jsx("ul",{className:"space-y-3 max-h-60 overflow-y-auto pr-2",children:p.map(ee=>e.jsxs("li",{className:"text-sm p-2 rounded bg-gray-50 border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between font-bold text-gray-700 mb-1",children:[e.jsx("span",{children:ee.description}),e.jsx("span",{className:ee.isSuccess?"text-green-600":ee.isSuccess===!1?"text-red-600":"",children:String(ee.finalOutcome)})]}),e.jsxs("div",{className:"text-xs text-gray-500 flex justify-between",children:[e.jsxs("span",{children:[ee.dicePool.join("+")," ",ee.isBoon&&"(Boon)",ee.isBane&&"(Bane)"]}),ee.isCritical&&e.jsx("span",{className:"text-purple-600 font-bold",children:"CRITICAL"})]})]},ee.id))})]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"mb-6 p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 min-h-[80px] flex flex-wrap gap-2 items-center justify-center",children:r.length===0?e.jsx("span",{className:"text-gray-400 text-sm font-medium",children:"Add dice to roll..."}):r.map((ee,re)=>e.jsx("button",{onClick:()=>!Z&&l(),className:`
                        w-12 h-12 rounded-lg flex items-center justify-center shadow-sm transition-all transform hover:scale-105
                        ${Z?"bg-gray-200 cursor-not-allowed opacity-50":"bg-white border border-gray-200 hover:border-red-300 hover:text-red-500"}
                      `,disabled:Z,children:e.jsx(Cc,{type:ee})},re))}),!Z&&e.jsx("div",{className:"grid grid-cols-6 gap-2 mb-6",children:["d4","d6","d8","d10","d12","d20"].map(ee=>e.jsx(M,{onClick:()=>n(ee),variant:"outline",size:"sm",disabled:P,className:"h-10 font-mono text-xs",children:ee},ee))}),r.length===1&&r[0]==="d20"&&!Z&&e.jsxs("div",{className:"flex justify-center gap-4 mb-6",children:[e.jsxs("button",{onClick:Y,className:`
                      relative flex items-center justify-center w-32 py-2 rounded-lg border-2 font-bold text-sm transition-all duration-200
                      ${c?"bg-emerald-600 border-emerald-600 text-white shadow-md scale-105 ring-2 ring-emerald-200 ring-offset-1":"bg-white border-gray-200 text-gray-500 hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50"}
                    `,children:[e.jsx(Ze,{className:`w-4 h-4 mr-2 ${c?"fill-white":""}`}),"Boon ",c&&L>1&&e.jsxs("span",{className:"ml-1 bg-white/20 px-1.5 rounded text-xs",children:["x",L]})]}),e.jsxs("button",{onClick:Q,className:`
                      relative flex items-center justify-center w-32 py-2 rounded-lg border-2 font-bold text-sm transition-all duration-200
                      ${x?"bg-rose-600 border-rose-600 text-white shadow-md scale-105 ring-2 ring-rose-200 ring-offset-1":"bg-white border-gray-200 text-gray-500 hover:border-rose-400 hover:text-rose-600 hover:bg-rose-50"}
                    `,children:[e.jsx(ol,{className:"w-4 h-4 mr-2"}),"Bane ",x&&L>1&&e.jsxs("span",{className:"ml-1 bg-white/20 px-1.5 rounded text-xs",children:["x",L]})]})]}),(P||S!==null)&&e.jsxs("div",{className:`
                  mt-auto mb-2 p-6 rounded-xl text-center transition-all duration-300 transform
                  ${P?"bg-gray-100 scale-95 opacity-80":"bg-indigo-50 border-2 border-indigo-100 scale-100 opacity-100 shadow-inner"}
                `,children:[e.jsx("div",{className:`text-5xl font-black mb-2 ${j?"text-purple-600 animate-bounce":P?"text-gray-400 blur-sm":"text-indigo-900"}`,children:R}),!P&&e.jsxs("div",{className:"animate-in fade-in slide-in-from-bottom-2 duration-300",children:[(t==null?void 0:t.targetValue)!==void 0&&!j&&e.jsxs("p",{className:"text-xs text-gray-500 font-medium uppercase tracking-wide mb-1",children:["Target: ",t.targetValue]}),C===!0&&!j&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-bold",children:[e.jsx(Ze,{size:14,className:"fill-current"})," Success"]}),C===!1&&!j&&e.jsxs("div",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-100 text-red-700 text-sm font-bold",children:[e.jsx(xe,{size:14})," Failure"]}),u.length>0&&e.jsxs("p",{className:"text-xs text-indigo-400 mt-2",children:["Rolls: [",v[0].value,", ",u.map(ee=>ee.value).join(", "),"]",e.jsx("br",{}),e.jsx("span",{className:"font-semibold",children:c?"Took Lowest":"Took Highest"})]})]})]})]})}),e.jsxs("div",{className:"p-4 border-t flex justify-between items-center bg-gray-50",children:[e.jsxs("div",{children:[e.jsxs(M,{onClick:()=>w(!y),variant:"ghost",size:"sm",className:"text-gray-500 hover:text-gray-800",children:[e.jsx(pr,{className:"w-4 h-4 mr-1"})," ",y?"Back to Roller":"History"]}),!y&&!Z&&r.length>0&&e.jsx(M,{onClick:o,variant:"ghost",size:"sm",className:"ml-2 text-red-400 hover:text-red-600 hover:bg-red-50",children:"Clear"})]}),!y&&e.jsx(M,{onClick:D,disabled:r.length===0||P,size:"lg",className:`w-32 shadow-lg transition-all ${P?"bg-indigo-400 cursor-wait":"bg-indigo-600 hover:bg-indigo-700 hover:scale-105"}`,children:P?e.jsx(Ec,{className:"w-5 h-5 animate-spin mx-auto"}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-5 h-5 mr-2"})," Roll"]})})]})]})})}function Mc({children:s}){const{user:a,isLoading:t}=Ce(),r=Ht();return console.log("--- PrivateRoute Decision ---",{isLoading:t,user:a?`User ID: ${a.id}`:null}),t?e.jsx("div",{className:"flex h-screen w-full items-center justify-center",children:e.jsx("p",{className:"text-xl text-gray-600",children:"Loading Session..."})}):a?e.jsx(e.Fragment,{children:s}):e.jsx(ca,{to:"/login",state:{from:r},replace:!0})}function Lc({textToCopy:s}){const[a,t]=i.useState(!1),r=async()=>{try{await navigator.clipboard.writeText(s),t(!0),setTimeout(()=>t(!1),2e3)}catch(n){console.error("Failed to copy text: ",n)}};return e.jsx(M,{variant:"ghost",size:"icon",onClick:r,"aria-label":a?"Copied":"Copy to clipboard",children:a?e.jsx(ds,{className:"w-5 h-5 text-green-500"}):e.jsx(oa,{className:"w-5 h-5 text-gray-500"})})}const Rc=({member:s,isDM:a,onRemove:t,onView:r})=>{const n=Math.min(100,Math.max(0,s.current_hp/s.attributes.CON*100)),l=Math.min(100,Math.max(0,s.current_wp/s.attributes.WIL*100)),o=Object.entries(s.conditions).filter(([x,g])=>g),c=s.name.slice(0,2).toUpperCase();return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col h-full group",children:[e.jsxs("div",{className:"p-5 border-b border-gray-50 flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-lg border-2 border-white shadow-sm",children:c}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-lg leading-tight",children:s.name}),e.jsxs("p",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:[s.kin," ",s.profession]})]})]}),e.jsx(M,{variant:"ghost",size:"icon_sm",onClick:()=>r(s.id),title:"View Character Sheet",children:e.jsx(Ls,{className:"w-5 h-5 text-gray-400 hover:text-indigo-600"})})]}),e.jsxs("div",{className:"p-5 space-y-5 flex-grow",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs font-bold mb-1",children:[e.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(us,{className:"w-3 h-3 text-red-500 fill-red-500"})," Health"]}),e.jsxs("span",{className:s.current_hp===0?"text-red-600":"text-gray-700",children:[s.current_hp," / ",s.attributes.CON]})]}),e.jsx("div",{className:"h-2 w-full bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-red-500 transition-all duration-500",style:{width:`${n}%`}})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs font-bold mb-1",children:[e.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(Pe,{className:"w-3 h-3 text-blue-500 fill-blue-500"})," Willpower"]}),e.jsxs("span",{className:"text-gray-700",children:[s.current_wp," / ",s.attributes.WIL]})]}),e.jsx("div",{className:"h-2 w-full bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 transition-all duration-500",style:{width:`${l}%`}})})]})]}),o.length>0?e.jsx("div",{className:"flex flex-wrap gap-1.5",children:o.map(([x])=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md bg-red-50 text-red-700 text-[10px] font-bold uppercase border border-red-100",children:[e.jsx(is,{size:10})," ",x]},x))}):e.jsx("div",{className:"text-xs text-gray-400 italic",children:"Healthy and ready."}),e.jsxs("div",{className:"pt-4 border-t border-gray-100",children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-2",children:"Loadout"}),e.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[s.equipment.equipped.armor?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"truncate",children:s.equipment.equipped.armor.name})]}):e.jsxs("div",{className:"flex items-center gap-2 text-gray-400 italic",children:[e.jsx(Me,{className:"w-4 h-4 opacity-50"})," ",e.jsx("span",{children:"No Armor"})]}),s.equipment.equipped.weapons.length>0?s.equipment.equipped.weapons.slice(0,2).map((x,g)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"truncate",children:x.name})]},g)):e.jsxs("div",{className:"flex items-center gap-2 text-gray-400 italic",children:[e.jsx(qe,{className:"w-4 h-4 opacity-50"})," ",e.jsx("span",{children:"Unarmed"})]})]})]})]}),a&&e.jsx("div",{className:"p-3 bg-gray-50 border-t border-gray-100 mt-auto",children:e.jsx(M,{variant:"ghost",className:"w-full text-gray-500 hover:text-red-600 hover:bg-red-50 justify-center",size:"sm",icon:gr,onClick:()=>t(s.id,s.name),children:"Remove from Party"})})]})};function Tc({party:s,isDM:a,currentUserId:t,onUpdate:r}){const n=Be(),l=Fe(),o=async(g,m)=>{if(window.confirm(`Are you sure you want to remove ${m} from the party?`))try{await Kr(s.id,g),l.invalidateQueries({queryKey:["party",s.id]}),r()}catch(b){console.error("Failed to remove member:",b),alert("Failed to remove member. Please try again.")}},x=a&&t===s.created_by;return s.members.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4",children:e.jsx(De,{className:"w-8 h-8 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Waiting for Adventurers"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1 max-w-sm text-center",children:"Share the party code with your players to have them join the roster."})]}):e.jsx("div",{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:s.members.map(g=>e.jsx(Rc,{member:g,isDM:x,onRemove:o,onView:m=>n(`/character/${m}`)},g.id))})})}function Ic({partyId:s}){const{user:a}=Ce(),[t,r]=i.useState([]),[n,l]=i.useState([]),[o,c]=i.useState(null),[x,g]=i.useState("view"),[m,b]=i.useState(""),[p,h]=i.useState(""),[d,v]=i.useState(""),[f,u]=i.useState(!1),N=i.useRef(null),[S,A]=i.useState("all"),[j,q]=i.useState(""),[C,_]=i.useState(!0),[y,w]=i.useState(null),[L,E]=i.useState(null),[P,k]=i.useState(!1),R=(D,G="")=>{const $=N.current;if(!$)return;const Z=$.selectionStart,ee=$.selectionEnd,re=$.value,K=re.substring(0,Z),W=re.substring(Z,ee),se=re.substring(ee),le=K+D+W+G+se;h(le),setTimeout(()=>{$.focus();const je=Z+D.length+W.length+G.length;$.setSelectionRange(je,je)},0)},O=()=>{R(`
| Header 1 | Header 2 |
| -------- | -------- |
| Cell 1   | Cell 2   |
`)},z=i.useCallback(()=>{b(""),h(""),v(S!=="all"?S:""),E(null),u(!1)},[S]),F=()=>{z(),g("create"),c(null)},U=D=>{c(D),g("edit"),b(D.title),h(D.content),v(D.category),E(null),u(!1)},T=()=>{g("view"),z(),x==="create"&&c(null)},I=i.useCallback(async()=>{if(s){_(!0),w(null);try{const{data:D,error:G}=await H.from("notes").select("*").eq("party_id",s).order("created_at",{ascending:!1});if(G)throw G;r(D||[]);const $=Array.from(new Set((D==null?void 0:D.map(Z=>Z.category).filter(Boolean))||[]));if(l($.sort()),o){const Z=D==null?void 0:D.find(ee=>ee.id===o.id);c(Z||null)}}catch(D){console.error("Error loading party notes:",D),w(D instanceof Error?D.message:"Failed to load party notes")}finally{_(!1)}}},[s,o]);i.useEffect(()=>{I()},[s]);const B=async()=>{if(!a){E("You must be logged in to save notes.");return}if(!m.trim()){E("Title is required.");return}if(!d.trim()){E("Category is required.");return}k(!0),E(null);const D={title:m.trim(),content:p||"",category:d.trim(),party_id:s,user_id:a.id,updated_at:new Date().toISOString()};try{let G=null;if(x==="edit"&&o){const{data:$,error:Z}=await H.from("notes").update(D).eq("id",o.id).select().single();if(Z)throw Z;G=$}else{const{data:$,error:Z}=await H.from("notes").insert([D]).select().single();if(Z)throw Z;G=$}await I(),g("view"),G&&c(G)}catch(G){console.error("Save error:",G),E(G instanceof Error?G.message:"Failed to save note.")}finally{k(!1)}},Y=async D=>{if(window.confirm("Are you sure you want to delete this note?"))try{const{error:G}=await H.from("notes").delete().eq("id",D);if(G)throw G;c(null),g("view"),await I()}catch(G){console.error("Delete error:",G),w(G instanceof Error?G.message:"Failed to delete note.")}},Q=t.filter(D=>{const G=j.toLowerCase(),$=D.title.toLowerCase().includes(G)||D.content.toLowerCase().includes(G)||D.category.toLowerCase().includes(G),Z=S==="all"||D.category===S;return $&&Z});return C&&t.length===0?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(oe,{size:"lg"})}):e.jsxs("div",{className:"flex flex-col md:flex-row h-[calc(100vh-140px)] bg-gray-50 border-t border-gray-200",children:[e.jsxs("div",{className:"w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 space-y-3 bg-white z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Gs,{className:"w-5 h-5 text-indigo-600"})," ",e.jsx("span",{children:"Notes"})]}),e.jsx(M,{size:"sm",onClick:F,icon:ye,children:"New"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Search...",value:j,onChange:D=>q(D.target.value),className:"w-full pl-9 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ks,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none"}),e.jsxs("select",{value:S,onChange:D=>A(D.target.value),className:"w-full pl-9 pr-8 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white cursor-pointer",children:[e.jsx("option",{value:"all",children:"All Categories"}),n.map(D=>e.jsx("option",{value:D,children:D},D))]}),e.jsx(Ms,{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4 pointer-events-none"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50",children:[y&&e.jsxs("div",{className:"p-3 mb-2 bg-red-50 text-red-700 text-sm rounded-md flex gap-2",children:[e.jsx(he,{className:"w-4 h-4 mt-0.5"})," ",y]}),Q.length===0?e.jsxs("div",{className:"text-center py-12 px-4 text-gray-400",children:[e.jsx(Ls,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{className:"text-sm",children:j?"No matches found.":"No notes created yet."})]}):Q.map(D=>e.jsxs("div",{onClick:()=>{c(D),g("view")},className:`p-3 rounded-lg cursor-pointer border transition-all group relative ${(o==null?void 0:o.id)===D.id?"bg-white border-indigo-500 shadow-sm ring-1 ring-indigo-500 z-10":"bg-white border-gray-200 hover:border-indigo-300 hover:shadow-sm"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("h3",{className:`font-semibold text-sm truncate pr-2 ${(o==null?void 0:o.id)===D.id?"text-indigo-700":"text-gray-800"}`,children:D.title}),e.jsx("span",{className:"text-[10px] text-gray-400 whitespace-nowrap",children:new Date(D.created_at).toLocaleDateString()})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsxs("span",{className:`text-[10px] font-medium px-1.5 py-0.5 rounded-full flex items-center gap-1 truncate max-w-[150px] ${(o==null?void 0:o.id)===D.id?"bg-indigo-100 text-indigo-700":"bg-gray-100 text-gray-600"}`,children:[e.jsx(Ma,{size:10})," ",D.category]})})]},D.id))]})]}),e.jsx("div",{className:"flex-1 bg-white overflow-y-auto p-6 md:p-8 h-full",children:x==="create"||x==="edit"?e.jsxs("div",{className:"max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-2 duration-300",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 pb-4 border-b border-gray-100",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:x==="edit"?"Edit Note":"Create New Note"}),e.jsx("button",{onClick:T,className:"text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(xe,{size:24})})]}),L&&e.jsxs("div",{className:"bg-red-50 text-red-700 p-4 rounded-lg mb-6 flex items-center gap-3 border border-red-100",children:[e.jsx(he,{size:20}),e.jsx("p",{className:"text-sm font-medium",children:L})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:"Title"}),e.jsx("input",{type:"text",value:m,onChange:D=>b(D.target.value),className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none",placeholder:"e.g. The Goblin King's Weakness",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:"Category"}),e.jsx("input",{type:"text",list:"categories",value:d,onChange:D=>v(D.target.value),className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none",placeholder:"e.g. Lore"}),e.jsx("datalist",{id:"categories",children:n.map(D=>e.jsx("option",{value:D},D))})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-end mb-1.5",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700",children:["Content ",e.jsx("span",{className:"text-xs font-normal text-gray-400",children:"(Markdown)"})]}),e.jsx("button",{type:"button",onClick:()=>u(!f),className:"text-xs flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium",children:f?e.jsxs(e.Fragment,{children:[e.jsx(Zt,{size:14})," Edit"]}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:14})," Preview"]})})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden border-gray-300 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 transition-all",children:[!f&&e.jsxs("div",{className:"flex items-center gap-1 p-2 bg-gray-50 border-b border-gray-200 overflow-x-auto",children:[e.jsx(ls,{icon:Xt,label:"Bold",onClick:()=>R("**","**")}),e.jsx(ls,{icon:ea,label:"Italic",onClick:()=>R("*","*")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ls,{icon:sa,label:"Heading",onClick:()=>R("# ","")}),e.jsx(ls,{icon:ta,label:"Quote",onClick:()=>R("> ","")}),e.jsx(ls,{icon:gt,label:"Code Block",onClick:()=>R("```\n","\n```")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ls,{icon:ft,label:"Bullet List",onClick:()=>R("- ","")}),e.jsx(ls,{icon:aa,label:"Numbered List",onClick:()=>R("1. ","")}),e.jsx("div",{className:"w-px h-4 bg-gray-300 mx-1"}),e.jsx(ls,{icon:bt,label:"Link",onClick:()=>R("[","](url)")}),e.jsx(ls,{icon:ra,label:"Table",onClick:O})]}),f?e.jsx("div",{className:"p-4 h-96 overflow-y-auto prose prose-sm max-w-none bg-gray-50/50",children:e.jsx(As,{content:p||"*No content*"})}):e.jsx("textarea",{ref:N,value:p,onChange:D=>h(D.target.value),className:"w-full p-4 h-96 font-mono text-sm outline-none resize-none bg-white",placeholder:`# Section Header
Write your notes here...`})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsx(M,{variant:"ghost",onClick:T,children:"Cancel"}),e.jsx(M,{variant:"primary",icon:Ae,onClick:B,isLoading:P,disabled:!m||!d,children:"Save Note"})]})]})]}):o?e.jsxs("div",{className:"max-w-4xl mx-auto animate-in fade-in duration-300",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-start gap-4 mb-8 pb-6 border-b border-gray-100",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-3",children:o.title}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center text-sm",children:[e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 font-medium border border-indigo-100",children:[e.jsx(Ma,{size:14})," ",o.category]}),e.jsxs("span",{className:"text-gray-400",children:["Last updated: ",new Date(o.updated_at).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{variant:"secondary",size:"sm",icon:Vs,onClick:()=>U(o),children:"Edit"}),e.jsx(M,{variant:"danger_outline",size:"sm",icon:Le,onClick:()=>Y(o.id),children:"Delete"})]})]}),e.jsx("div",{className:"prose prose-indigo max-w-none text-gray-700",children:e.jsx(As,{content:o.content||"*No content provided.*"})})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400",children:[e.jsx("div",{className:"w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6",children:e.jsx(ms,{className:"w-10 h-10 text-gray-300"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-600 mb-2",children:"Select a Note"}),e.jsx("p",{className:"max-w-xs text-center mb-8 text-gray-500",children:"Choose a note from the sidebar or create a new one."}),e.jsx(M,{variant:"primary",onClick:F,icon:ye,children:"Create New Note"})]})})]})}function ls({icon:s,label:a,onClick:t}){return e.jsx("button",{type:"button",onClick:t,title:a,className:"p-1.5 text-gray-600 hover:text-indigo-600 hover:bg-white hover:shadow-sm rounded transition-all",children:e.jsx(s,{size:16})})}async function Dc(s){if(!s)return console.warn("fetchTasks called without partyId"),[];const{data:a,error:t}=await H.from("party_tasks").select("*").eq("party_id",s).order("created_at",{ascending:!1});if(t)throw console.error("Error fetching tasks:",t),new Error(t.message||"Failed to fetch tasks");return a||[]}async function Pc(s,a){if(!a)throw new Error("User must be authenticated to create a task.");if(!s.party_id)throw new Error("Party ID is required to create a task.");if(!s.title||s.title.trim()==="")throw new Error("Task title cannot be empty.");const{data:t,error:r}=await H.from("party_tasks").insert({party_id:s.party_id,title:s.title,description:s.description,created_by_user_id:a.id,status:"open"}).select().single();if(r)throw console.error("Error creating task:",r),new Error(r.message||"Failed to create task");if(!t)throw new Error("Task creation did not return data.");return t}async function qc(s,a){if(!s)throw new Error("Task ID is required to update a task.");const t={...a};a.status&&(a.status==="completed"?t.completed_at=new Date().toISOString():a.status==="open"&&(t.completed_at=null));const{data:r,error:n}=await H.from("party_tasks").update(t).eq("id",s).select().single();if(n)throw console.error("Error updating task:",n),new Error(n.message||"Failed to update task");if(!r)throw new Error("Task update did not return data.");return r}async function Fc(s){if(!s)throw new Error("Task ID is required to delete a task.");const{error:a}=await H.from("party_tasks").delete().eq("id",s);if(a)throw console.error("Error deleting task:",a),new Error(a.message||"Failed to delete task")}function $c(){const s=Be(),{setGlobalError:a}=Lr(),t=i.useCallback((l,o)=>{const c=l instanceof Error?l.message:String(l);_s.handleError(l,{action:o==null?void 0:o.action,additionalData:{critical:o==null?void 0:o.critical}}),(o==null?void 0:o.showError)!==!1&&a(c),o!=null&&o.redirect&&s(o.redirect),o!=null&&o.critical&&s("/error",{state:{error:c}})},[s,a]),r=i.useCallback((l,o)=>{_s.handleAuthError(l,{action:o==null?void 0:o.action});const c=l instanceof Error?l.message:String(l);a(c),s((o==null?void 0:o.redirect)||"/login")},[s,a]),n=i.useCallback((l,o)=>{_s.handleNetworkError(l,{action:o==null?void 0:o.action}),a("Network error. Please check your connection and try again."),o!=null&&o.retry&&setTimeout(o.retry,1e3)},[a]);return{handleError:t,handleAuthError:r,handleNetworkError:n}}const nr=({task:s,onToggle:a,onDelete:t,canManage:r})=>{const n=s.status==="completed";return e.jsxs("div",{className:`
      group relative flex items-start p-4 rounded-xl border transition-all
      ${n?"bg-green-50/50 border-green-200 opacity-80 hover:opacity-100":"bg-white border-gray-200 shadow-sm hover:shadow-md hover:border-indigo-200"}
    `,children:[e.jsx("button",{onClick:()=>a(s),className:`mt-0.5 mr-4 flex-shrink-0 transition-colors ${n?"text-green-600 hover:text-green-700":"text-gray-400 hover:text-indigo-600"}`,"aria-label":n?"Mark as incomplete":"Mark as completed",children:n?e.jsx(Bs,{size:24}):e.jsx(dl,{size:24})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsx("h3",{className:`font-semibold text-gray-900 ${n?"line-through text-gray-500":""}`,children:s.title}),s.description&&e.jsx("p",{className:`mt-1 text-sm leading-relaxed ${n?"text-gray-400 line-through decoration-gray-300":"text-gray-600"}`,children:s.description}),e.jsxs("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-400 font-medium",children:[e.jsxs("span",{children:["Added ",new Date(s.created_at).toLocaleDateString()]}),n&&s.completed_at&&e.jsxs("span",{className:"text-green-700 bg-green-100 px-2 py-0.5 rounded-full",children:["Completed ",new Date(s.completed_at).toLocaleDateString()]})]})]}),r&&e.jsx("button",{onClick:()=>t(s.id),className:"opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg absolute top-2 right-2",title:"Delete Task",children:e.jsx(Le,{size:18})})]})};function Oc({partyId:s,isDM:a}){const{user:t}=Ce(),r=Fe(),{handleError:n}=$c(),[l,o]=i.useState(""),[c,x]=i.useState(""),[g,m]=i.useState(!1),[b,p]=i.useState(null),{data:h,isLoading:d,error:v}=we({queryKey:["partyTasks",s],queryFn:()=>Dc(s),enabled:!!s}),f=ge({mutationFn:_=>Pc(_,t),onSuccess:()=>{r.invalidateQueries({queryKey:["partyTasks",s]}),o(""),x(""),m(!1),p(null)},onError:_=>n(_,{action:"creating task"})}),u=ge({mutationFn:({taskId:_,updates:y})=>qc(_,y),onSuccess:()=>r.invalidateQueries({queryKey:["partyTasks",s]}),onError:_=>n(_,{action:"updating task"})}),N=ge({mutationFn:_=>Fc(_),onSuccess:()=>r.invalidateQueries({queryKey:["partyTasks",s]}),onError:_=>n(_,{action:"deleting task"})}),S=_=>{if(_.preventDefault(),!l.trim()){p("Task title is required.");return}f.mutate({party_id:s,title:l.trim(),description:c.trim()||void 0})},A=_=>{window.confirm("Delete this task permanently?")&&N.mutate(_)},j=_=>a||_.created_by_user_id===(t==null?void 0:t.id),q=(h==null?void 0:h.filter(_=>_.status!=="completed"))||[],C=(h==null?void 0:h.filter(_=>_.status==="completed"))||[];return d?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-gray-500",children:[e.jsx(oe,{size:"lg"}),e.jsx("p",{className:"mt-3",children:"Loading tasks..."})]}):v?e.jsx(ie,{message:`Failed to load tasks: ${v.message}`}):e.jsxs("div",{className:"max-w-4xl mx-auto p-6 h-full overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-end mb-8 border-b pb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(cl,{className:"w-8 h-8 text-indigo-600"}),"Quest Log"]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Track your party's objectives and quests."})]}),a&&!g&&e.jsx(M,{onClick:()=>m(!0),icon:ye,variant:"primary",children:"New Task"})]}),a&&g&&e.jsxs("div",{className:"mb-8 bg-white rounded-xl border border-indigo-100 shadow-sm p-5 animate-in fade-in slide-in-from-top-2",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Add New Quest / Task"}),e.jsx("button",{onClick:()=>m(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(xe,{size:20})})]}),b&&e.jsx(ie,{message:b,onClose:()=>p(null),className:"mb-4"}),e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsx("div",{children:e.jsx("input",{autoFocus:!0,type:"text",placeholder:"Task Title (e.g., 'Investigate the Old Ruins')",className:"w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-medium",value:l,onChange:_=>o(_.target.value)})}),e.jsx("div",{children:e.jsx("textarea",{rows:2,placeholder:"Details (optional)...",className:"w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none text-sm",value:c,onChange:_=>x(_.target.value)})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(M,{type:"button",variant:"ghost",onClick:()=>m(!1),children:"Cancel"}),e.jsx(M,{type:"submit",loading:f.isPending,icon:ye,children:"Add Task"})]})]})]}),(h==null?void 0:h.length)===0&&!g?e.jsxs("div",{className:"text-center py-16 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50/50",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(bs,{className:"w-8 h-8 text-indigo-400"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"No active quests"}),e.jsx("p",{className:"text-gray-500 mt-1 max-w-sm mx-auto",children:a?"Your quest log is empty. Add a task to guide your players.":"The Dungeon Master hasn't assigned any quests yet."}),a&&e.jsx(M,{onClick:()=>m(!0),variant:"outline",className:"mt-6",children:"Create First Task"})]}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Gt,{className:"w-4 h-4 text-indigo-600"}),e.jsxs("h3",{className:"text-sm font-bold text-gray-500 uppercase tracking-wider",children:["Active (",q.length,")"]})]}),e.jsx("div",{className:"space-y-3",children:q.length>0?q.map(_=>e.jsx(nr,{task:_,onToggle:y=>u.mutate({taskId:y.id,updates:{status:"completed"}}),onDelete:A,canManage:j(_)},_.id)):e.jsx("p",{className:"text-center py-8 text-gray-400 italic bg-gray-50 rounded-lg border border-dashed",children:"No active tasks."})})]}),C.length>0&&e.jsxs("section",{className:"opacity-75 hover:opacity-100 transition-opacity",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 mt-8 pt-8 border-t border-gray-100",children:[e.jsx(Ws,{className:"w-4 h-4 text-green-600"}),e.jsxs("h3",{className:"text-sm font-bold text-gray-500 uppercase tracking-wider",children:["Completed (",C.length,")"]})]}),e.jsx("div",{className:"space-y-3",children:C.map(_=>e.jsx(nr,{task:_,onToggle:y=>u.mutate({taskId:y.id,updates:{status:"open"}}),onDelete:A,canManage:j(_)},_.id))})]})]})]})}const zc=({onClose:s,allItems:a,onAssignLoot:t})=>{const[r,n]=i.useState(""),[l,o]=i.useState(new Map),[c,x]=i.useState(!1),g=i.useMemo(()=>{if(!r.trim())return[];const h=r.toLowerCase();return a.filter(d=>d.name.toLowerCase().includes(h)).slice(0,50)},[r,a]),m=(h,d)=>{if(d<=0)return;const v=new Map(l),f=v.get(h.id);v.set(h.id,{item:h,quantity:((f==null?void 0:f.quantity)||0)+d}),o(v),n("")},b=h=>{const d=new Map(l);d.delete(h),o(d)},p=async()=>{l.size!==0&&(x(!0),await t(Array.from(l.values())),x(!1),s())};return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[60] backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden border border-gray-200 animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"Assign Loot to Party"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Search items on the left, review loot on the right."})]}),e.jsx("button",{onClick:s,className:"p-1.5 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors",children:e.jsx(xe,{size:20})})]}),e.jsxs("div",{className:"flex-grow flex flex-col md:flex-row overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col border-r border-gray-200 bg-white",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{autoFocus:!0,type:"text",placeholder:"Search item database...",value:r,onChange:h=>n(h.target.value),className:"w-full pl-9 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"})]})}),e.jsx("div",{className:"flex-grow overflow-y-auto p-2 space-y-1 bg-gray-50/50",children:g.length>0?g.map(h=>e.jsxs("div",{className:"p-3 bg-white border border-gray-200 rounded-lg shadow-sm flex items-center gap-3 hover:border-blue-300 transition-colors group",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm text-gray-900 truncate",children:h.name}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:h.category||"Item"})]}),e.jsxs("form",{className:"flex items-center gap-2",onSubmit:d=>{d.preventDefault();const v=d.currentTarget.elements.namedItem("qty");m(h,parseInt(v.value)||1),v.value="1"},children:[e.jsx("input",{type:"number",name:"qty",defaultValue:1,min:"1",className:"w-12 py-1 px-1 text-center border rounded text-sm",onClick:d=>d.currentTarget.select()}),e.jsx(M,{type:"submit",size:"xs",variant:"secondary",icon:ye,children:"Add"})]})]},h.id)):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400 p-8 text-center",children:[e.jsx(Te,{size:32,className:"mb-2 opacity-20"}),e.jsx("p",{className:"text-sm",children:"Type to search for items..."})]})})]}),e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col bg-gray-50",children:[e.jsx("div",{className:"p-3 bg-blue-50 border-b border-blue-100 flex justify-between items-center",children:e.jsxs("h4",{className:"font-bold text-blue-900 text-sm uppercase tracking-wide",children:["Pending Loot (",l.size,")"]})}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2",children:l.size===0?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-lg m-4",children:[e.jsx(fs,{size:32,className:"mb-2 opacity-20"}),e.jsx("p",{className:"text-sm",children:"No items added yet."})]}):Array.from(l.values()).map(({item:h,quantity:d})=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm animate-in slide-in-from-left-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"w-8 h-8 bg-blue-100 text-blue-700 rounded flex items-center justify-center font-bold text-xs",children:[d,"x"]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:h.name}),e.jsx("p",{className:"text-xs text-gray-500",children:h.category})]})]}),e.jsx("button",{onClick:()=>b(h.id),className:"text-gray-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded transition-colors",children:e.jsx(Le,{size:16})})]},h.id))})]})]}),e.jsxs("div",{className:"p-4 border-t bg-white flex justify-end gap-3",children:[e.jsx(M,{variant:"ghost",onClick:s,children:"Cancel"}),e.jsx(M,{variant:"primary",onClick:p,disabled:l.size===0||c,icon:ye,children:c?"Adding...":"Add Items to Party"})]})]})})};function Hc({partyId:s,members:a,isDM:t}){var O,z,F,U;const r=Fe(),[n,l]=i.useState([]),[o,c]=i.useState(!0),[x,g]=i.useState(null),[m,b]=i.useState(""),[p,h]=i.useState("all"),[d,v]=i.useState(""),[f,u]=i.useState([]),[N,S]=i.useState([]),[A,j]=i.useState(!1),[q,C]=i.useState(!1),{data:_=[]}=we({queryKey:["gameItems"],queryFn:Ys,staleTime:1/0});i.useEffect(()=>{y()},[s]);async function y(){c(!0);try{const[T,I]=await Promise.all([H.from("party_inventory").select("*").eq("party_id",s),H.from("party_inventory_log").select("*").eq("party_id",s).order("timestamp",{ascending:!1}).limit(50)]);if(T.error)throw T.error;l(T.data||[]),S(I.data||[])}catch(T){g(T instanceof Error?T.message:"Failed to load data")}finally{c(!1)}}const w=async T=>{try{g(null),await Promise.all(T.map(async({item:I,quantity:B})=>{const Y=n.find(Q=>Q.name===I.name);Y?await H.from("party_inventory").update({quantity:Y.quantity+B}).eq("id",Y.id):await H.from("party_inventory").insert([{party_id:s,name:I.name,quantity:B,category:I.category,description:I.description||I.effect}]),await H.from("party_inventory_log").insert([{party_id:s,item_name:I.name,quantity:B,from_type:"party",from_id:"DM",to_type:"party",to_id:s}])})),await y()}catch{g("Failed to assign loot.")}},L=async()=>{var I;if(!d||f.length===0)return;const T=a.find(B=>B.id===d);if(T)try{for(const B of f){const Y=n.find($=>$.id===B);if(!Y)continue;Y.quantity>1?await H.from("party_inventory").update({quantity:Y.quantity-1}).eq("id",Y.id):await H.from("party_inventory").delete().eq("id",Y.id);const Q=((I=T.equipment)==null?void 0:I.inventory)||[],D=Q.findIndex($=>$.name===Y.name),G=[...Q];if(D>=0)G[D]={...G[D],quantity:G[D].quantity+1};else{const $=_.find(Z=>Z.name===Y.name);G.push({name:Y.name,quantity:1,category:Y.category||($==null?void 0:$.category),description:Y.description||($==null?void 0:$.description)})}await H.from("characters").update({equipment:{...T.equipment,inventory:G}}).eq("id",T.id),await H.from("party_inventory_log").insert([{party_id:s,item_name:Y.name,quantity:1,from_type:"party",from_id:s,to_type:"character",to_id:T.id}])}await y(),r.invalidateQueries({queryKey:["character",T.id]}),u([])}catch{g("Transfer failed.")}},E=async T=>{var B;const I=a.find(Y=>Y.id===d);if(!(!I||!T.name))try{const Y=[...((B=I.equipment)==null?void 0:B.inventory)||[]],Q=Y.findIndex(G=>G.name===T.name);if(Q===-1)return;Y[Q].quantity>1?Y[Q].quantity-=1:Y.splice(Q,1),await H.from("characters").update({equipment:{...I.equipment,inventory:Y}}).eq("id",I.id);const D=n.find(G=>G.name===T.name);D?await H.from("party_inventory").update({quantity:D.quantity+1}).eq("id",D.id):await H.from("party_inventory").insert([{party_id:s,name:T.name,quantity:1,category:T.category,description:T.description}]),await H.from("party_inventory_log").insert([{party_id:s,item_name:T.name,quantity:1,from_type:"character",from_id:I.id,to_type:"party",to_id:s}]),await y(),r.invalidateQueries({queryKey:["character",I.id]})}catch{g("Transfer failed.")}},P=["all",...new Set(n.map(T=>T.category).filter(Boolean))],k=n.filter(T=>T.name.toLowerCase().includes(m.toLowerCase())&&(p==="all"||T.category===p)),R=a.find(T=>T.id===d);return e.jsxs(e.Fragment,{children:[q&&e.jsx(zc,{onClose:()=>C(!1),allItems:_,onAssignLoot:w}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]",children:[e.jsxs("div",{className:"lg:col-span-7 flex flex-col bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 flex flex-wrap justify-between items-center gap-4 bg-white z-10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-indigo-100 p-2 rounded-lg text-indigo-600",children:e.jsx(De,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"Party Stash"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[n.length," Items total"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[t&&e.jsx(M,{size:"sm",variant:"primary",icon:ye,onClick:()=>C(!0),children:"Add Loot"}),e.jsx(M,{size:"sm",variant:"ghost",icon:pr,onClick:()=>j(!A),className:A?"bg-gray-100":""})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 border-b border-gray-200 flex gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{className:"w-full pl-9 pr-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-1 focus:ring-indigo-500 outline-none",placeholder:"Filter items...",value:m,onChange:T=>b(T.target.value)})]}),e.jsx("select",{className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md bg-white outline-none focus:ring-1 focus:ring-indigo-500",value:p,onChange:T=>h(T.target.value),children:P.map(T=>e.jsx("option",{value:T,children:T==="all"?"All Categories":T},T))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50/30",children:o?e.jsx(oe,{}):k.length===0?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400",children:[e.jsx(fs,{size:48,className:"opacity-20 mb-2"}),e.jsx("p",{children:"Stash is empty or no match."})]}):k.map(T=>e.jsxs("div",{onClick:()=>u(I=>I.includes(T.id)?I.filter(B=>B!==T.id):[...I,T.id]),className:`
                      p-3 rounded-lg border cursor-pointer flex justify-between items-center transition-all group
                      ${f.includes(T.id)?"bg-indigo-50 border-indigo-500 shadow-sm ring-1 ring-indigo-500":"bg-white border-gray-200 hover:border-indigo-300 hover:shadow-sm"}
                    `,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded flex items-center justify-center font-bold text-xs ${f.includes(T.id)?"bg-indigo-200 text-indigo-800":"bg-gray-100 text-gray-600"}`,children:T.quantity}),e.jsxs("div",{children:[e.jsx("p",{className:`font-medium text-sm ${f.includes(T.id)?"text-indigo-900":"text-gray-900"}`,children:T.name}),T.category&&e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-gray-400 font-bold",children:T.category})]})]}),T.description&&e.jsx("div",{className:"hidden group-hover:block max-w-xs text-xs text-gray-500 truncate ml-4",children:T.description})]},T.id))})]}),e.jsxs("div",{className:"lg:col-span-5 flex flex-col gap-4 h-full",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex-shrink-0",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-2",children:"Transfer Partner"}),e.jsxs("select",{className:"w-full p-2.5 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none",value:d,onChange:T=>v(T.target.value),children:[e.jsx("option",{value:"",children:"Select Character..."}),a.map(T=>e.jsx("option",{value:T.id,children:T.name},T.id))]})]}),R?e.jsxs("div",{className:"flex-1 flex flex-col gap-4 overflow-hidden",children:[e.jsxs("div",{className:`flex-1 bg-white rounded-xl border shadow-sm flex flex-col overflow-hidden ${f.length>0?"border-indigo-300 ring-2 ring-indigo-100":"border-gray-200"}`,children:[e.jsxs("div",{className:"p-3 border-b bg-gray-50 flex justify-between items-center",children:[e.jsxs("h4",{className:"font-bold text-gray-700 text-sm",children:["Give to ",R.name]}),f.length>0&&e.jsxs("span",{className:"bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-bold",children:[f.length," Selected"]})]}),e.jsx("div",{className:"flex-1 p-4 flex flex-col items-center justify-center text-center",children:f.length===0?e.jsx("p",{className:"text-gray-400 text-sm",children:"Select items from the left to transfer."}):e.jsxs("div",{className:"w-full space-y-3",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Transferring ",e.jsx("strong",{children:f.length})," item(s)"]}),e.jsx(M,{className:"w-full",variant:"primary",icon:Dt,onClick:L,children:"Confirm Transfer"})]})})]}),e.jsxs("div",{className:"flex-1 bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b bg-gray-50",children:e.jsxs("h4",{className:"font-bold text-gray-700 text-sm",children:[R.name,"'s Inventory"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50/30",children:((z=(O=R.equipment)==null?void 0:O.inventory)==null?void 0:z.length)===0?e.jsx("div",{className:"h-full flex items-center justify-center text-gray-400 text-sm",children:"Empty Inventory"}):(U=(F=R.equipment)==null?void 0:F.inventory)==null?void 0:U.map((T,I)=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-white border rounded hover:bg-gray-50 group",children:[e.jsxs("span",{className:"text-sm text-gray-800",children:[e.jsx("span",{className:"font-mono text-xs bg-gray-100 px-1.5 py-0.5 rounded mr-2",children:T.quantity}),T.name]}),e.jsx(M,{size:"xs",variant:"secondary",icon:Kt,onClick:()=>E(T),children:"Take"})]},I))})]})]}):e.jsxs("div",{className:"flex-1 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 p-6 text-center",children:[e.jsx(De,{size:48,className:"mb-3 opacity-20"}),e.jsx("p",{className:"font-medium",children:"Select a character above to start transferring items."})]}),A&&e.jsxs("div",{className:"absolute right-0 top-16 bottom-0 w-80 bg-white shadow-2xl border-l border-gray-200 z-20 animate-in slide-in-from-right duration-300 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center bg-gray-50",children:[e.jsx("h3",{className:"font-bold text-gray-800",children:"History"}),e.jsx("button",{onClick:()=>j(!1),children:e.jsx(xe,{size:18,className:"text-gray-400 hover:text-gray-600"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:N.map(T=>e.jsxs("div",{className:"text-xs p-2 bg-gray-50 rounded border border-gray-100",children:[e.jsxs("p",{className:"font-bold text-gray-700",children:[T.item_name," ",e.jsxs("span",{className:"font-normal text-gray-500",children:["x",T.quantity]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-gray-500 mt-1",children:[e.jsx("span",{children:T.from_type==="party"?"Party":"Char"}),e.jsx(Dt,{size:10}),e.jsx("span",{children:T.to_type==="party"?"Party":"Char"})]}),e.jsx("p",{className:"text-[10px] text-gray-400 mt-1",children:new Date(T.timestamp).toLocaleTimeString()})]},T.id))})]})]})]})]})}async function Bc(){const{data:s,error:a}=await H.from("monsters").select("*").order("name");if(a)throw console.error("Error fetching all monsters:",a),a;return s||[]}function Uc(s){const a=Fe();i.useEffect(()=>{if(!s)return;const t=[],r=H.channel(`encounter:${s}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"encounters",filter:`id=eq.${s}`},l=>{console.log("Encounter updated:",l),a.invalidateQueries({queryKey:["encounterDetails",s]})}).subscribe((l,o)=>{l==="SUBSCRIBED"&&console.log(`Subscribed to encounter:${s}`),(l==="CHANNEL_ERROR"||l==="TIMED_OUT")&&console.error(`Encounter channel error for ${s}:`,o)});t.push(r);const n=H.channel(`encounter_combatants:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"encounter_combatants",filter:`encounter_id=eq.${s}`},l=>{console.log("Encounter combatants changed:",l),a.invalidateQueries({queryKey:["encounterCombatants",s]})}).subscribe((l,o)=>{l==="SUBSCRIBED"&&console.log(`Subscribed to encounter_combatants:${s}`),(l==="CHANNEL_ERROR"||l==="TIMED_OUT")&&console.error(`Encounter combatants channel error for ${s}:`,o)});return t.push(n),()=>{console.log(`Unsubscribing from encounter channels for ${s}`),t.forEach(l=>H.removeChannel(l))}},[s,a])}const lr=(s,a)=>{if(!s.monster_id)return[s];const t=s.display_name.replace(/ \(Act \d+\)$/,"");return a.filter(r=>r.monster_id===s.monster_id&&r.display_name.replace(/ \(Act \d+\)$/,"")===t)},Gc=(s,a)=>{let t=[];const r=Math.ceil(Math.max(s,1)/10);for(let n=0;n<r;n++)for(let l=1;l<=10;l++)t.push(l);a.forEach(n=>{const l=t.indexOf(n);l>-1&&t.splice(l,1)});for(let n=t.length-1;n>0;n--){const l=Math.floor(Math.random()*(n+1));[t[n],t[l]]=[t[l],t[n]]}return t},Wc=({stats:s})=>e.jsx("div",{className:"grid grid-cols-3 gap-2 text-xs",children:Object.entries(s).map(([a,t])=>e.jsxs("div",{className:"bg-white/50 p-1 rounded border border-stone-200 flex flex-col items-center",children:[e.jsx("span",{className:"font-bold text-stone-500 uppercase text-[10px] truncate w-full text-center",title:a,children:a.replace(/_/g," ")}),e.jsx("span",{className:"font-mono font-bold text-stone-800",children:String(t)})]},a))});function Kc({description:s,attackName:a}){const{toggleDiceRoller:t}=ze(),r=/(\d*d\d+\s*[+-]?\s*\d*)/gi,n=s.split(r);return e.jsx("p",{className:"text-stone-800 mt-1 leading-relaxed",children:n.map((l,o)=>l.match(r)&&l.match(/[dD]/)?e.jsxs("button",{className:"inline-flex items-center justify-center font-bold text-blue-700 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-1.5 py-0.5 rounded mx-0.5 text-xs transition-colors",onClick:()=>t==null?void 0:t({dice:l.toLowerCase().replace(/\s/g,""),label:`${a} - Damage`}),children:[e.jsx(br,{size:10,className:"mr-1"}),l]},o):e.jsx("span",{children:l},o))})}function Vc({text:s,contextLabel:a}){const{toggleDiceRoller:t}=ze();if(!s)return null;const r=/(\d*d\d+\s*[+-]?\s*\d*)/gi,n=s.split(r),l=o=>o.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");return e.jsx("div",{className:"whitespace-pre-wrap leading-relaxed",children:n.map((o,c)=>{if(o.match(r)&&o.match(/[dD]/))return e.jsxs("button",{className:"inline-flex items-center justify-center font-bold text-blue-700 hover:text-blue-900 bg-blue-100 hover:bg-blue-200 px-1.5 py-0.5 rounded mx-0.5 text-xs transition-colors",onClick:()=>t==null?void 0:t({dice:o.toLowerCase().replace(/\s/g,""),label:`${a} - Effects Roll`}),children:[e.jsx(br,{size:10,className:"mr-1"}),o]},c);const x=l(o);return e.jsx("span",{dangerouslySetInnerHTML:{__html:x}},c)})})}function Yc({entry:s}){var r;const a=n=>new Date(n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(s.type==="round_advanced")return e.jsxs("div",{className:"flex items-center justify-center gap-2 my-2",children:[e.jsx("div",{className:"h-px bg-stone-300 w-10"}),e.jsxs("span",{className:"font-serif font-bold text-stone-600 text-xs uppercase tracking-widest",children:["Round ",s.round]}),e.jsx("div",{className:"h-px bg-stone-300 w-10"})]});let t=null;switch(s.type){case"turn_start":t=e.jsxs("span",{className:"text-stone-600",children:["Turn started: ",e.jsx("strong",{children:s.name})]});break;case"turn_end":t=e.jsxs("span",{className:"text-stone-400 italic",children:["Turn ended: ",s.name]});break;case"hp_change":const n=s.delta<0;t=e.jsxs("span",{className:n?"text-red-700":"text-green-700",children:[e.jsx("strong",{children:s.name})," ",n?`took ${Math.abs(s.delta)} DMG`:`healed ${s.delta} HP`]});break;case"wp_change":const l=s.delta<0;t=e.jsxs("span",{className:"text-blue-700",children:[e.jsx("strong",{children:s.name})," ",l?`spent ${Math.abs(s.delta)} WP`:`recovered ${s.delta} WP`]});break;case"monster_attack":t=e.jsxs("div",{className:"bg-orange-50 p-2 rounded border border-orange-100",children:[e.jsxs("span",{className:"text-orange-800 font-medium flex items-center gap-1",children:[e.jsx(qe,{size:12})," ",s.name,": ",((r=s.attack)==null?void 0:r.name)||"Attack"]}),e.jsxs("div",{className:"text-xs text-stone-600 mt-1 italic",children:["Rolled ",s.roll]})]});break;case"attack_resolve":t=e.jsxs("span",{className:"text-stone-700",children:[e.jsx(Pt,{size:12,className:"inline mr-1"}),e.jsx("strong",{children:s.attacker})," dealt ",s.damage," damage to ",e.jsx("strong",{children:s.target})]});break;default:t=e.jsx("span",{children:s.message||JSON.stringify(s)})}return e.jsxs("div",{className:"flex gap-2 text-sm py-1 border-b border-stone-100 last:border-0",children:[e.jsx("time",{className:"text-xs text-stone-300 font-mono mt-0.5 w-10 shrink-0",children:a(s.ts)}),e.jsx("div",{className:"flex-grow",children:t})]})}function Qc({log:s}){return!s||s.length===0?e.jsx("p",{className:"text-sm text-gray-500 mt-2 px-1",children:"No events have been logged yet."}):e.jsx("div",{className:"space-y-1 divide-y divide-gray-100",children:s.slice().reverse().map((a,t)=>e.jsx(Yc,{entry:a},t))})}function Jc({isOpen:s,onClose:a,attacker:t,targets:r,attackName:n,onConfirm:l}){const[o,c]=i.useState(null),[x,g]=i.useState("");if(!s)return null;const m=!!t.monster_id,p=[...i.useMemo(()=>{const h=new Set;return r.filter(d=>{if(!d.monster_id)return!0;const v=d.display_name.replace(/ \(Act \d+\)$/,""),f=`${d.monster_id}:${v}`;return h.has(f)?!1:(h.add(f),!0)})},[r])].sort((h,d)=>{const v=!!h.monster_id,f=!!d.monster_id;return m?v===f?0:v?1:-1:v===f?0:v?-1:1});return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border border-stone-200 flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"p-4 border-b bg-stone-800 text-white flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-bold font-serif flex items-center gap-2",children:[e.jsx(qe,{className:"w-5 h-5 text-red-400"})," Resolve Action"]}),e.jsxs("p",{className:"text-xs text-stone-400",children:[t.display_name," is acting",n?` using ${n}`:""]})]}),e.jsx("button",{onClick:a,className:"text-stone-400 hover:text-white",children:e.jsx(xs,{size:24})})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto p-4 bg-stone-50 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-bold text-stone-500 uppercase mb-2 flex items-center gap-1",children:[e.jsx(ct,{size:12})," Select Target"]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar",children:p.map(h=>{const d=m&&!h.monster_id||!m&&!!h.monster_id,v=h.current_hp===0,f=h.monster_id?h.display_name.replace(/ \(Act \d+\)$/,""):h.display_name;return e.jsxs("div",{onClick:()=>!v&&c(h.id),className:`p-3 rounded border flex justify-between items-center cursor-pointer transition-all ${o===h.id?"ring-2 ring-red-500 border-red-500 bg-red-50":"bg-white border-stone-200 hover:border-stone-400"} ${v?"opacity-50 grayscale cursor-not-allowed":""}`,children:[e.jsxs("div",{children:[e.jsx("span",{className:`font-bold ${d?"text-red-700":"text-blue-700"}`,children:f}),e.jsxs("div",{className:"text-xs text-stone-500",children:[d?"Enemy":"Ally","  HP: ",h.current_hp,"/",h.max_hp]})]}),o===h.id&&e.jsx(ct,{className:"text-red-600 w-5 h-5 animate-pulse"})]},h.id)})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-stone-500 uppercase mb-2",children:"Damage Amount"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"number",autoFocus:!0,placeholder:"0",className:"flex-grow p-3 text-lg font-bold border rounded shadow-sm focus:ring-2 focus:ring-red-500 outline-none",value:x,onChange:h=>g(h.target.value)})}),e.jsx("p",{className:"text-xs text-stone-400 mt-1",children:"Enter negative number to heal."})]})]}),e.jsxs("div",{className:"p-4 border-t bg-white flex justify-end gap-2",children:[e.jsx(M,{variant:"ghost",onClick:a,children:"Cancel"}),e.jsx(M,{variant:"danger",Icon:qe,disabled:!o||!x,onClick:()=>o&&l(o,parseInt(x)),children:"Apply"})]})]})})}function Zc({isOpen:s,onClose:a,combatants:t,onApply:r}){const[n,l]=i.useState({});i.useEffect(()=>{if(s){const c={};t.forEach(x=>{x.initiative_roll&&(c[x.id]=String(x.initiative_roll))}),l(c)}},[s,t]);const o=()=>{const c=[],x=[];if(t.forEach(g=>{const m=parseInt(n[g.id]);isNaN(m)||(x.push(m),c.push({id:g.id,initiative_roll:m}))}),t.length-c.length>0){const g=Gc(t.length,x);t.forEach(m=>{if(!c.find(b=>b.id===m.id)){const b=g.pop();b&&c.push({id:m.id,initiative_roll:b})}})}r(c)};return s?e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col overflow-hidden border border-stone-200",children:[e.jsxs("div",{className:"p-4 border-b bg-stone-800 text-white flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-bold font-serif flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5"})," Draw Initiative"]}),e.jsx("button",{onClick:a,className:"text-stone-400 hover:text-white",children:e.jsx(xs,{size:24})})]}),e.jsxs("div",{className:"p-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-100",children:["Enter manual values for characters keeping their card (e.g. ",e.jsx("strong",{children:"Veteran"})," talent). Leave blank to draw from deck."]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-4 bg-stone-50 space-y-2",children:t.map(c=>e.jsxs("div",{className:"flex items-center justify-between bg-white p-3 rounded border shadow-sm",children:[e.jsx("span",{className:"font-bold text-stone-800",children:c.display_name}),e.jsx("input",{type:"number",min:"1",max:"10",placeholder:"Auto",className:`w-20 px-2 py-1 text-center border rounded font-mono font-bold ${n[c.id]?"bg-yellow-50 border-yellow-400 text-yellow-900":"bg-white"}`,value:n[c.id]||"",onChange:x=>l(g=>({...g,[c.id]:x.target.value}))})]},c.id))}),e.jsxs("div",{className:"p-4 border-t bg-white flex justify-end gap-2",children:[e.jsx(M,{variant:"ghost",onClick:a,children:"Cancel"}),e.jsx(M,{variant:"primary",Icon:be,onClick:o,children:"Draw & Apply"})]})]})}):null}function Xc({isOpen:s,onClose:a,availablePartyMembers:t,allMonsters:r,onAddParty:n,onAddMonster:l}){var u;const[o,c]=i.useState("party"),[x,g]=i.useState(""),[m,b]=i.useState(null),[p,h]=i.useState(1),[d,v]=i.useState("");if(!s)return null;const f=r?r.filter(N=>N.name.toLowerCase().includes(x.toLowerCase())||N.category&&N.category.toLowerCase().includes(x.toLowerCase())).slice(0,20):[];return e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden border border-stone-200",children:[e.jsxs("div",{className:"p-4 border-b bg-stone-50 flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-bold font-serif text-stone-800",children:"Add Combatants"}),e.jsx("button",{onClick:a,className:"text-stone-400 hover:text-stone-600",children:e.jsx(xs,{size:24})})]}),e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{className:`flex-1 py-3 text-sm font-bold uppercase tracking-wide transition-colors ${o==="party"?"bg-white border-b-2 border-blue-600 text-blue-600":"bg-stone-100 text-stone-500 hover:bg-stone-200"}`,onClick:()=>c("party"),children:"Party Members"}),e.jsx("button",{className:`flex-1 py-3 text-sm font-bold uppercase tracking-wide transition-colors ${o==="monsters"?"bg-white border-b-2 border-orange-600 text-orange-600":"bg-stone-100 text-stone-500 hover:bg-stone-200"}`,onClick:()=>c("monsters"),children:"Monsters & NPCs"})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto p-4 bg-stone-50/50",children:[o==="party"&&e.jsx("div",{className:"space-y-2",children:t.length===0?e.jsx("p",{className:"text-center text-stone-400 py-8 italic",children:"All party members added."}):t.map(N=>e.jsxs("div",{className:"flex items-center justify-between bg-white p-3 rounded border shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-700",children:e.jsx(os,{size:16})}),e.jsx("span",{className:"font-bold text-stone-800",children:N.name})]}),e.jsx(M,{size:"sm",onClick:()=>n(N.id),Icon:Us,children:"Add"})]},N.id))}),o==="monsters"&&e.jsxs("div",{className:"flex flex-col h-full gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-stone-400 w-4 h-4"}),e.jsx("input",{type:"text",placeholder:"Search monsters...",className:"w-full pl-9 pr-4 py-2 border rounded shadow-sm focus:ring-2 focus:ring-orange-500 outline-none",value:x,onChange:N=>g(N.target.value),autoFocus:!0})]}),e.jsxs("div",{className:"flex-grow overflow-hidden flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1 overflow-y-auto border rounded bg-white divide-y",children:f.map(N=>e.jsxs("div",{className:`p-3 cursor-pointer hover:bg-orange-50 ${m===N.id?"bg-orange-50 border-l-4 border-orange-500":""}`,onClick:()=>b(N.id),children:[e.jsx("p",{className:"font-bold text-sm",children:N.name}),e.jsx("p",{className:"text-[10px] text-stone-500",children:N.category})]},N.id))}),m&&e.jsxs("div",{className:"w-full md:w-64 bg-white p-4 border rounded shadow-sm flex flex-col gap-3 flex-shrink-0 h-fit",children:[e.jsx("h4",{className:"font-bold text-stone-800 border-b pb-2",children:(u=r.find(N=>N.id===m))==null?void 0:u.name}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-stone-500 uppercase",children:"Count"}),e.jsx("input",{type:"number",min:"1",className:"w-full p-1.5 border rounded text-sm",value:p,onChange:N=>h(Math.max(1,parseInt(N.target.value)||1))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-stone-500 uppercase",children:"Name (Opt)"}),e.jsx("input",{type:"text",placeholder:"e.g. Boss",className:"w-full p-1.5 border rounded text-sm",value:d,onChange:N=>v(N.target.value)})]}),e.jsx(M,{className:"w-full mt-2",onClick:()=>{l(m,p,d),h(1),v("")},Icon:Us,children:"Add to Fight"})]})]})]})]}),e.jsx("div",{className:"p-3 border-t bg-stone-50 flex justify-end",children:e.jsx(M,{onClick:a,variant:"secondary",children:"Done"})})]})})}function ed({combatant:s,monsterData:a,currentAttack:t,onRollAttack:r,onEndTurn:n,onOpenAttackModal:l}){const o=!!s.monster_id;return e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border-2 border-blue-500 overflow-hidden mb-6 relative animate-in fade-in slide-in-from-top-2",children:[e.jsxs("div",{className:"bg-blue-600 text-white px-4 py-2 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-white text-blue-800 font-bold font-serif w-8 h-8 flex items-center justify-center rounded shadow",children:s.initiative_roll??"-"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg leading-none",children:s.display_name}),e.jsx("span",{className:"text-xs text-blue-100 uppercase tracking-wider font-semibold",children:"Current Turn"})]})]}),e.jsx(M,{size:"sm",variant:"secondary",onClick:n,Icon:na,title:"End turn and automatically flip next card",children:"End Turn (Flip)"})]}),e.jsx("div",{className:"p-4",children:o&&a?e.jsxs("div",{className:"space-y-4",children:[a.stats&&e.jsx(Wc,{stats:a.stats}),a.effectsSummary&&e.jsxs("div",{className:"bg-yellow-50 p-3 rounded border border-yellow-200 text-sm",children:[e.jsx("span",{className:"text-xs font-bold text-yellow-800 uppercase block mb-1",children:"Traits & Effects"}),e.jsx(Vc,{text:a.effectsSummary,contextLabel:a.name})]}),e.jsx("div",{className:"bg-stone-50 rounded-lg border border-stone-200 p-3",children:t?e.jsxs("div",{className:"animate-in fade-in",children:[e.jsx("div",{className:"flex justify-between items-start mb-1",children:e.jsx("span",{className:"text-xs font-bold text-stone-400 uppercase",children:"Active Action (Rolled)"})}),e.jsx("h4",{className:"font-bold text-lg text-red-700 mb-1",children:t.name}),e.jsx(Kc,{description:t.description,attackName:t.name}),e.jsxs("div",{className:"mt-3 pt-2 border-t border-stone-200 flex justify-end gap-2",children:[e.jsx(M,{size:"xs",variant:"outline",Icon:be,onClick:r,children:"Reroll"}),e.jsx(M,{size:"xs",variant:"danger",Icon:Pt,onClick:l,children:"Resolve / Apply"})]})]}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-stone-500 text-sm mb-3 italic",children:"No attack selected."}),e.jsx(M,{size:"md",variant:"danger",Icon:qe,onClick:r,className:"w-full justify-center shadow-md",children:"Roll Monster Attack"})]})})]}):e.jsxs("div",{className:"text-center py-6 text-stone-500 flex flex-col items-center gap-3",children:[e.jsx("p",{className:"italic",children:"It's a player's turn."}),e.jsx(M,{size:"sm",variant:"outline",Icon:Pt,onClick:l,children:"Record Player Attack"})]})})]})}function sd({combatant:s,isSelected:a,isSwapSource:t,onSelect:r,onSwapRequest:n,onFlipCard:l,onSaveStats:o,statsState:c,setStatsState:x,monsterData:g,onRemove:m,isDM:b}){const p=!!s.monster_id,h=s.has_acted||!1,d=s.initiative_roll??"-",v=p&&s.current_hp===0,f=!p&&s.current_hp===0,u=c.current_hp??"",N=c.current_wp??"";return e.jsxs("div",{className:`relative flex items-center gap-3 p-2 pr-3 rounded-lg border shadow-sm transition-all cursor-pointer overflow-hidden ${v?"bg-stone-200 border-stone-400 opacity-80":h?"bg-stone-100 border-stone-200 opacity-60 grayscale":a?"bg-blue-50 border-blue-400 ring-1 ring-blue-400":"bg-white border-stone-200 hover:border-stone-300 hover:shadow-md"} ${t?"ring-2 ring-purple-500 bg-purple-50 animate-pulse":""}`,onClick:()=>r(s.id),children:[v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-0 overflow-hidden",children:e.jsx("span",{className:"text-stone-400/20 font-black text-4xl uppercase -rotate-12 select-none",children:"Defeated"})}),e.jsx("div",{className:`relative z-10 flex-shrink-0 w-10 h-14 rounded flex items-center justify-center shadow-sm border transition-colors ${v?"bg-red-100 border-red-300 text-red-800":h?"bg-stone-200 border-stone-300 text-stone-400":"bg-white border-stone-800 text-stone-900"}`,children:e.jsx("span",{className:"font-serif font-bold text-xl",children:d})}),e.jsxs("div",{className:"relative z-10 flex-grow min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("div",{className:"min-w-0 flex items-center gap-2",children:[e.jsx("p",{className:`font-bold truncate leading-tight ${h||v?"text-stone-500 line-through":"text-stone-800"}`,children:s.display_name}),e.jsx("span",{className:"text-[10px] uppercase font-bold tracking-wider text-stone-400",children:p?(g==null?void 0:g.name)||"Monster":"Player"}),p&&b&&e.jsx(bt,{size:10,className:"text-stone-300",title:"HP synced across all action cards"})]}),e.jsxs("div",{className:"flex items-center gap-2",onClick:S=>S.stopPropagation(),children:[e.jsxs("div",{className:`flex items-center bg-white border border-stone-200 rounded overflow-hidden shadow-sm ${s.current_hp===0?"ring-2 ring-red-500 border-red-500":""}`,children:[e.jsx("div",{className:`px-1.5 py-1 ${s.current_hp===0?"bg-red-100":"bg-stone-50"} border-r border-stone-200`,children:e.jsx(us,{className:`w-3 h-3 ${s.current_hp===0?"text-red-500":"text-red-600"}`})}),e.jsx("input",{type:"number",className:"w-10 px-1 py-0.5 text-xs text-center font-bold outline-none focus:bg-blue-50",value:u,onChange:S=>x({...c,current_hp:S.target.value}),onBlur:()=>o(s.id)}),e.jsxs("div",{className:"px-1.5 py-0.5 text-[10px] text-stone-400 bg-stone-50 border-l border-stone-200",children:["/",s.max_hp]})]}),e.jsxs("div",{className:"flex items-center bg-white border border-stone-200 rounded overflow-hidden shadow-sm",children:[e.jsx("div",{className:"px-1.5 py-1 bg-stone-50 border-r border-stone-200",children:e.jsx(Pe,{className:"w-3 h-3 text-blue-600"})}),e.jsx("input",{type:"number",className:"w-10 px-1 py-0.5 text-xs text-center font-bold outline-none focus:bg-blue-50",value:N,onChange:S=>x({...c,current_wp:S.target.value}),onBlur:()=>o(s.id)}),s.max_wp!=null&&e.jsxs("div",{className:"px-1.5 py-0.5 text-[10px] text-stone-400 bg-stone-50 border-l border-stone-200",children:["/",s.max_wp]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2 h-6",children:[f&&e.jsxs("div",{className:"flex items-center gap-1 bg-red-50 px-2 py-0.5 rounded border border-red-100",children:[e.jsx(is,{size:10,className:"text-red-500"}),e.jsx("span",{className:"text-[10px] font-bold text-red-700 uppercase",children:"Dying"})]}),v&&e.jsxs("div",{className:"flex items-center gap-1 px-2 py-0.5 rounded bg-stone-700 text-white",children:[e.jsx(is,{size:10}),e.jsx("span",{className:"text-[10px] font-bold uppercase",children:"Defeated"})]}),e.jsxs("div",{className:`flex items-center gap-1 transition-opacity ${h?"opacity-50 hover:opacity-100":""}`,onClick:S=>S.stopPropagation(),children:[!h&&!v&&e.jsx("button",{className:`p-1 rounded transition-colors ${t?"bg-purple-600 text-white":"text-stone-400 hover:text-purple-600 hover:bg-purple-50"}`,title:"Swap Initiative (Wait)",onClick:()=>n(s.id),children:e.jsx(fr,{size:14})}),!v&&e.jsx("button",{className:`p-1 rounded transition-colors ${h?"text-stone-400 hover:bg-stone-200":"text-stone-500 hover:bg-stone-100 hover:text-stone-800"}`,title:h?"Unflip Card":"Flip Card (End Turn/Reaction)",onClick:()=>l(s.id,h),children:h?e.jsx(na,{size:14}):e.jsx(mt,{size:14})}),b&&e.jsxs("button",{className:`p-1 rounded transition-colors flex items-center gap-1 ${v?"bg-red-600 text-white hover:bg-red-700 px-2 shadow-sm":"text-stone-300 hover:text-red-600 hover:bg-red-50"}`,onClick:()=>m(s.id),title:"Remove from Encounter",children:[e.jsx(Le,{size:14}),v&&e.jsx("span",{className:"text-[10px] font-bold uppercase",children:"Remove Corpse"})]})]})]})]})]})}function td({partyId:s,partyMembers:a,isDM:t}){var Ts;const r=Fe(),{toggleDiceRoller:n}=ze(),[l,o]=i.useState(""),[c,x]=i.useState(null),[g,m]=i.useState("details"),[b,p]=i.useState(!1),[h,d]=i.useState(!1),[v,f]=i.useState(!1),[u,N]=i.useState(!1),[S,A]=i.useState(!1),[j,q]=i.useState(""),[C,_]=i.useState({}),[y,w]=i.useState({}),[L,E]=i.useState(null),[P,k]=i.useState(""),[R,O]=i.useState(null),{data:z,isLoading:F}=we({queryKey:["allEncounters",s],queryFn:()=>yi(s),enabled:!!s}),{data:U}=we({queryKey:["allMonsters"],queryFn:Bc}),T=i.useMemo(()=>{var V;return c||((V=z==null?void 0:z[0])==null?void 0:V.id)||null},[c,z]),{data:I}=we({queryKey:["encounterDetails",T],queryFn:()=>T?ji(T):Promise.resolve(null),enabled:!!T}),{data:B}=we({queryKey:["encounterCombatants",T],queryFn:()=>T?Hr(T):Promise.resolve([]),enabled:!!T});Uc(T);const Y=i.useMemo(()=>new Map((U??[]).map(V=>[V.id,V])),[U]),Q=i.useMemo(()=>(B==null?void 0:B.slice().sort((V,ae)=>{const ce=V.initiative_roll??1e3,fe=ae.initiative_roll??1e3;return ce!==fe?ce-fe:(V.display_name??"").localeCompare(ae.display_name??"")}))||[],[B]),D=i.useMemo(()=>Q.find(V=>V.id===L),[Q,L]),G=i.useMemo(()=>D!=null&&D.monster_id?Y.get(D.monster_id):null,[D,Y]),$=i.useMemo(()=>a.filter(V=>!Q.some(ae=>ae.character_id===V.id)),[a,Q]);i.useEffect(()=>{!F&&(!z||z.length===0)&&m("create")},[z,F]),i.useEffect(()=>{I&&q(I.name)},[I]),i.useEffect(()=>{if(!Q)return;const V={};Q.forEach(ae=>{V[ae.id]={current_hp:String(ae.current_hp??0),current_wp:ae.max_wp!=null?String(ae.current_wp??ae.max_wp):String(ae.current_wp??""),initiative_roll:String(ae.initiative_roll||"")}}),_(V)},[Q]),i.useEffect(()=>{if((I==null?void 0:I.status)==="active"&&Q.length>0){const V=Q.find(ae=>ae.id===L);if(!L||V&&(V.has_acted||V.monster_id&&V.current_hp===0)){const ae=Q.find(ce=>!ce.has_acted&&!(ce.monster_id&&ce.current_hp===0));ae&&E(ae.id)}}},[Q,I,L]),i.useEffect(()=>{L&&!Q.find(V=>V.id===L)&&E(null)},[Q,L]);const Z=ge({mutationFn:V=>wi(s,V),onSuccess:V=>{r.invalidateQueries({queryKey:["allEncounters"]}),x(V.id),m("details")}}),ee=ge({mutationFn:Mi,onSuccess:()=>r.invalidateQueries({queryKey:["allEncounters"]})}),re=ge({mutationFn:({id:V,name:ae})=>Ni(V,ae),onSuccess:V=>{r.invalidateQueries({queryKey:["allEncounters"]}),x(V.id)}}),K=ge({mutationFn:({id:V,updates:ae})=>jt(V,ae),onSuccess:()=>{r.invalidateQueries({queryKey:["encounterDetails"]}),A(!1)}}),W=ge({mutationFn:ki,onSuccess:()=>r.invalidateQueries({queryKey:["encounterCombatants"]})}),se=ge({mutationFn:Si,onSuccess:()=>r.invalidateQueries({queryKey:["encounterCombatants"]})}),le=ge({mutationFn:Li,onSuccess:()=>r.invalidateQueries({queryKey:["encounterCombatants"]})}),je=ge({mutationFn:({id:V,updates:ae})=>lt(V,ae),onSuccess:()=>r.invalidateQueries({queryKey:["encounterCombatants"]})}),pe=ge({mutationFn:Ri,onSuccess:()=>{r.invalidateQueries({queryKey:["encounterCombatants"]}),O(null)}}),de=ge({mutationFn:V=>Ci(T,V),onSuccess:()=>r.invalidateQueries({queryKey:["encounterDetails"]})}),me=ge({mutationFn:()=>_i(T),onSuccess:()=>{r.invalidateQueries(),d(!0)}}),Ue=ge({mutationFn:Ei,onSuccess:()=>r.invalidateQueries()}),$e=ge({mutationFn:async()=>{await Ai(T),B&&await Promise.all(B.map(V=>lt(V.id,{has_acted:!1})))},onSuccess:()=>{de.mutate({type:"round_advanced",ts:Date.now(),round:((I==null?void 0:I.current_round)??0)+1}),E(null),d(!0),r.invalidateQueries()}}),hs=V=>{const ae=C[V],ce=Q.find(cs=>cs.id===V);if(!ae||!ce)return;const fe=parseInt(ae.current_hp),Re=parseInt(ae.current_wp),_e={};let Oe=[ce];ce.monster_id&&B&&(Oe=lr(ce,B)),!isNaN(fe)&&fe!==ce.current_hp&&(_e.current_hp=fe,de.mutate({type:"hp_change",ts:Date.now(),who:V,name:ce.display_name,delta:fe-(ce.current_hp||0)})),!isNaN(Re)&&Re!==ce.current_wp&&(_e.current_wp=Re,de.mutate({type:"wp_change",ts:Date.now(),who:V,name:ce.display_name,delta:Re-(ce.current_wp||0)})),Object.keys(_e).length>0&&Oe.forEach(cs=>je.mutate({id:cs.id,updates:_e}))},Ge=(V,ae)=>{var Re;if(!((Re=ae.attacks)!=null&&Re.length))return;const ce=Math.floor(Math.random()*6)+1,fe=ae.attacks.find(_e=>_e.roll_values.split(",").includes(String(ce)));fe&&(w(_e=>({..._e,[V]:fe})),de.mutate({type:"monster_attack",ts:Date.now(),who:V,name:ae.name,roll:ce,attack:{name:fe.name}}))},ys=async V=>{await Promise.all(V.map(ae=>lt(ae.id,{...ae,has_acted:!1}))),d(!1),r.invalidateQueries({queryKey:["encounterCombatants"]}),de.mutate({type:"generic",ts:Date.now(),message:"Initiative drawn."})},We=(V,ae)=>{je.mutate({id:V,updates:{has_acted:!ae}})},Qs=(V,ae)=>{if(!D)return;const ce=Q.find(Oe=>Oe.id===V);if(!ce)return;const Re={current_hp:Math.max(0,ce.current_hp-ae)};let _e=[ce];ce.monster_id&&B&&(_e=lr(ce,B)),_e.forEach(Oe=>je.mutate({id:Oe.id,updates:Re})),de.mutate({type:"attack_resolve",ts:Date.now(),attacker:D.display_name,target:ce.display_name,damage:ae}),f(!1)};return t?F?e.jsx(oe,{}):e.jsxs("div",{className:"p-4 max-w-7xl mx-auto space-y-6",children:[e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-stone-200 sticky top-2 z-30",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold font-serif text-stone-900",children:I?I.name:"Encounters"}),I&&e.jsxs("div",{className:"flex items-center gap-3 text-sm mt-1",children:[e.jsx("span",{className:`px-2 py-0.5 rounded-full font-bold uppercase text-[10px] tracking-wider ${I.status==="active"?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:I.status}),I.status==="active"&&e.jsxs("span",{className:"font-mono font-bold text-stone-600",children:["Round ",I.current_round]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:g==="details"&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"ghost",Icon:Us,onClick:()=>m("create"),children:"New"}),e.jsx(M,{onClick:()=>N(!0),Icon:ft,variant:"secondary",children:"List"}),(I==null?void 0:I.status)==="planning"&&e.jsx(M,{variant:"primary",Icon:ml,onClick:()=>me.mutate(),children:"Start"}),(I==null?void 0:I.status)==="active"&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"primary",Icon:ul,onClick:()=>$e.mutate(),children:"Next Round"}),e.jsx(M,{variant:"outline",Icon:Gt,onClick:()=>Ue.mutate(T),children:"End"})]})]})})]}),g==="create"?e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-sm max-w-md mx-auto text-center",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Start a New Encounter"}),e.jsx("input",{className:"w-full p-3 border rounded-lg mb-4",placeholder:"Name",value:l,onChange:V=>o(V.target.value)}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(M,{variant:"primary",onClick:()=>Z.mutate(l),children:"Create"}),e.jsx(M,{variant:"ghost",onClick:()=>m("details"),children:"Cancel"})]})]}):I?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-4 lg:col-span-1 h-fit lg:sticky lg:top-24",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden",children:[e.jsx("div",{className:"p-3 bg-stone-50 border-b border-stone-200",children:e.jsx("h4",{className:"font-bold text-stone-600 text-sm uppercase",children:"Combat Log"})}),e.jsx("div",{className:"h-64 lg:h-[calc(100vh-300px)] overflow-y-auto p-3 bg-white",children:e.jsx(Qc,{log:I.log||[]})})]}),e.jsxs("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-stone-200",children:[e.jsx("textarea",{className:"w-full text-sm p-2 border rounded bg-yellow-50/50 min-h-[100px]",placeholder:"DM Notes...",value:P,onChange:V=>k(V.target.value)}),e.jsx("div",{className:"mt-2 flex justify-end gap-2",children:e.jsx(M,{size:"sm",variant:"ghost",onClick:()=>A(!0),Icon:Jt,children:"Edit Encounter"})})]})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[R&&e.jsxs("div",{className:"bg-purple-600 text-white p-3 rounded-lg shadow-md flex justify-between items-center animate-pulse",children:[e.jsxs("span",{className:"font-bold flex items-center gap-2",children:[e.jsx(fr,{})," Select swap target..."]}),e.jsx(M,{size:"sm",variant:"secondary",onClick:()=>O(null),children:"Cancel"})]}),S&&e.jsxs("div",{className:"bg-white p-4 rounded-xl shadow mb-4 border border-blue-200",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Edit Details"}),e.jsx("input",{className:"w-full mb-2 p-2 border rounded",value:j,onChange:V=>q(V.target.value)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{size:"sm",onClick:()=>K.mutate({id:T,updates:{name:j}}),children:"Save"}),e.jsx(M,{size:"sm",variant:"ghost",onClick:()=>A(!1),children:"Cancel"})]})]}),I.status==="active"&&D&&e.jsx(ed,{combatant:D,monsterData:G||void 0,currentAttack:y[D.id],onRollAttack:()=>G&&Ge(D.id,G),onEndTurn:()=>We(D.id,!1),onOpenAttackModal:()=>f(!0)}),e.jsxs("div",{className:"bg-stone-100/50 p-4 rounded-xl border border-stone-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"font-bold text-stone-500 uppercase tracking-wider text-sm",children:"Initiative Track"}),e.jsxs("div",{className:"flex gap-2",children:[I.status==="active"&&e.jsx(M,{size:"sm",variant:"outline",Icon:zt,onClick:()=>d(!0),children:"Re-Draw"}),e.jsx(M,{size:"sm",variant:"outline",Icon:yt,onClick:()=>p(!0),children:"Add"})]})]}),e.jsxs("div",{className:"space-y-2",children:[Q.length===0&&e.jsx("p",{className:"text-center py-8 text-stone-400 italic",children:"No combatants added."}),Q.map(V=>e.jsx(sd,{combatant:V,monsterData:Y.get(V.monster_id||""),isSelected:L===V.id,isSwapSource:R===V.id,onSelect:E,onSwapRequest:ae=>R?pe.mutate({id1:R,id2:ae}):O(ae),onFlipCard:We,onSaveStats:hs,onRemove:ae=>le.mutate(ae),statsState:C[V.id]||{current_hp:"",current_wp:""},setStatsState:ae=>_(ce=>({...ce,[V.id]:ae})),isDM:t},V.id))]})]})]})]}):e.jsx("div",{className:"text-center py-12 text-stone-400",children:"No encounter selected."}),e.jsx(Xc,{isOpen:b,onClose:()=>p(!1),partyMembers:a,availablePartyMembers:$,allMonsters:U||[],onAddParty:V=>W.mutate({encounterId:T,characterId:V,initiativeRoll:null}),onAddMonster:(V,ae,ce)=>{var _e;const fe=Y.get(V),Re=((_e=fe==null?void 0:fe.stats)==null?void 0:_e.FEROCITY)||1;for(let Oe=1;Oe<=ae;Oe++){const cs=ae>1?`${ce||(fe==null?void 0:fe.name)} ${Oe}`:ce||(fe==null?void 0:fe.name);for(let Is=1;Is<=Re;Is++)se.mutate({encounterId:T,monsterId:V,customName:Re>1?`${cs} (Act ${Is})`:cs,initiativeRoll:null})}}}),e.jsx(Zc,{isOpen:h,onClose:()=>d(!1),combatants:Q,onApply:ys}),v&&D&&e.jsx(Jc,{isOpen:v,onClose:()=>f(!1),attacker:D,targets:Q.filter(V=>V.id!==D.id),attackName:D.monster_id?(Ts=y[D.id])==null?void 0:Ts.name:void 0,onConfirm:Qs}),u&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl space-y-4 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"All Encounters"}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>N(!1),Icon:xs,children:"Close"})]}),e.jsx("div",{className:"overflow-y-auto space-y-2 border-t pt-4",children:(z??[]).map(V=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-md ${T===V.id?"bg-blue-100":"bg-gray-50"}`,children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:V.name}),e.jsxs("p",{className:"text-sm text-gray-600 capitalize",children:["Status: ",V.status]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{size:"sm",onClick:()=>x(V.id),disabled:T===V.id,children:"Select"}),e.jsx(M,{size:"sm",variant:"outline",Icon:oa,onClick:()=>re.mutate({id:V.id,name:V.name}),children:"Copy"}),e.jsx(M,{size:"sm",variant:"danger",Icon:Le,onClick:()=>ee.mutate(V.id),children:"Del"})]})]},V.id))})]})})]}):e.jsx("div",{className:"p-8 text-center text-stone-500",children:"Only the DM can manage encounters."})}async function ad(){const{data:s,error:a}=await H.from("bio_data").select("flaws").eq("name","WEAKNESS").single();if(a)throw console.error("Error fetching weaknesses:",a),new Error(a.message);return s}const rd=["Did the adventurers explore a new and dangerous location?","Did they overcome a demanding challenge (a monster, trap, or riddle)?","Did they complete an important part of the adventure?","Did they make a discovery that is vital to the story?","Did the player roleplay their character in an exemplary way?","Did the player actively engage with the world and its inhabitants?","Did the player have a good time and contribute to the fun?"],nd=[{title:"Be Generous",description:"Its better to award one too many than one too few. Keep the momentum going!"},{title:"Don't Punish",description:"Never withhold marks for character mistakes or failed rolls. Failure is part of the story."}];function ld({members:s,partyId:a}){const t=Fe(),[r,n]=i.useState(null),[l,o]=i.useState(""),[c,x]=i.useState(""),g=i.useMemo(()=>s.find(f=>f.id===l),[l,s]),{data:m,isLoading:b}=we({queryKey:["weaknesses"],queryFn:ad,enabled:r==="gaveIn"}),p=ge({mutationFn:({characterId:f,flaw:u})=>Or(f,{flaw:u}),onSuccess:()=>{t.invalidateQueries({queryKey:["party",a]}),n(null),o(""),x("")}}),h=()=>{l&&c&&p.mutate({characterId:l,flaw:c})},d=()=>{l&&p.mutate({characterId:l,flaw:null})},v=(m==null?void 0:m.flaws)||[];return e.jsxs("div",{className:"max-w-4xl mx-auto space-y-8 p-6",children:[e.jsxs("div",{className:"text-center space-y-2 mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-100 text-yellow-600 mb-2",children:e.jsx(ht,{size:32})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-900",children:"Session End Cheatsheet"}),e.jsx("p",{className:"text-gray-500 max-w-lg mx-auto",children:"Review the session's progress and award advancement marks to your players."})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"p-4 bg-blue-50/50 border-b border-gray-100 flex items-center gap-2",children:[e.jsx(Ws,{className:"text-blue-600 w-5 h-5"}),e.jsx("h3",{className:"font-bold text-gray-800",children:"Advancement Checklist"})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-6",children:'Ask the group these questions. For every "Yes", each player marks an advancement skill of their choice.'}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8",children:rd.map((f,u)=>e.jsxs("div",{className:"flex gap-3 items-start",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-gray-100 border border-gray-300 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-gray-700 text-sm leading-relaxed",children:f})]},u))})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"p-4 bg-purple-50/50 border-b border-gray-100 flex items-center gap-2",children:[e.jsx(xl,{className:"text-purple-600 w-5 h-5"}),e.jsx("h3",{className:"font-bold text-gray-800",children:"Weaknesses & Flaws"})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-gray-800 font-medium mb-4",children:"Did a character interact significantly with their weakness?"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("button",{onClick:()=>{n("gaveIn"),o("")},className:`flex-1 p-4 rounded-lg border-2 text-left transition-all ${r==="gaveIn"?"border-red-500 bg-red-50 ring-1 ring-red-200":"border-gray-200 hover:border-red-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"font-bold text-red-900 block mb-1",children:"Gave In to Weakness"}),r==="gaveIn"&&e.jsx(gs,{size:20,className:"text-red-600"})]}),e.jsx("p",{className:"text-xs text-red-700",children:"Gain 1 Mark. Must take a new Flaw."})]}),e.jsxs("button",{onClick:()=>{n("overcame"),o("")},className:`flex-1 p-4 rounded-lg border-2 text-left transition-all ${r==="overcame"?"border-green-500 bg-green-50 ring-1 ring-green-200":"border-gray-200 hover:border-green-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"font-bold text-green-900 block mb-1",children:"Overcame Weakness"}),r==="overcame"&&e.jsx(gs,{size:20,className:"text-green-600"})]}),e.jsx("p",{className:"text-xs text-green-700",children:"Gain 2 Marks. Remove current Flaw/Weakness."})]})]}),e.jsxs("div",{className:"transition-all duration-300 ease-in-out",children:[r==="gaveIn"&&e.jsxs("div",{className:"animate-in fade-in slide-in-from-top-2 bg-gray-50 p-5 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4 text-sm text-gray-600",children:[e.jsx(he,{className:"w-5 h-5 text-red-500 flex-shrink-0 mt-0.5"}),e.jsxs("p",{children:["The character succumbed to their weakness. They gain ",e.jsx("strong",{children:"1 Advancement Mark"}),", but suffer a setback. Select a new ",e.jsx("strong",{children:"Flaw"})," for them."]})]}),b?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(Ye,{className:"animate-spin text-gray-400"})}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Character"}),e.jsxs("select",{className:"w-full p-2.5 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-red-500 outline-none",value:l,onChange:f=>o(f.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:"Select character..."}),s.map(f=>e.jsx("option",{value:f.id,children:f.name},f.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"New Flaw"}),e.jsxs("select",{className:"w-full p-2.5 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-red-500 outline-none",value:c,onChange:f=>x(f.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:"Choose flaw..."}),v.map(f=>e.jsx("option",{value:f,children:f},f))]})]}),e.jsx("div",{className:"md:col-span-2 flex justify-end mt-2",children:e.jsx(M,{variant:"danger",onClick:h,disabled:!l||!c||p.isPending,isLoading:p.isPending,children:"Assign Flaw & Close"})})]})]}),r==="overcame"&&e.jsxs("div",{className:"animate-in fade-in slide-in-from-top-2 bg-green-50/50 p-5 rounded-lg border border-green-200",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4 text-sm text-gray-700",children:[e.jsx(Vt,{className:"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Great Roleplaying!"})," The character acted against their nature."]}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1 text-xs text-gray-600",children:[e.jsxs("li",{children:["Gain ",e.jsx("strong",{children:"2 Advancement Marks"}),"."]}),e.jsxs("li",{children:["They have overcome their weakness/flaw. ",e.jsx("strong",{children:"Remove it now."})]}),e.jsx("li",{children:"They must play one full session without a weakness before choosing a new one."})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-end",children:[e.jsxs("div",{className:"flex-grow w-full",children:[e.jsx("label",{className:"block text-xs font-bold text-green-700 uppercase mb-1",children:"Character to Redeem"}),e.jsxs("select",{className:"w-full p-2.5 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-green-500 outline-none",value:l,onChange:f=>o(f.target.value),children:[e.jsx("option",{value:"",disabled:!0,children:"Select character..."}),s.filter(f=>f.flaw).map(f=>e.jsxs("option",{value:f.id,children:[f.name," (Has Flaw)"]},f.id))]}),(g==null?void 0:g.flaw)&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Removing: ",e.jsx("strong",{children:g.flaw})]})]}),e.jsx(M,{className:"w-full md:w-auto bg-green-600 hover:bg-green-700 text-white",onClick:d,disabled:!l||p.isPending,isLoading:p.isPending,children:"Redeem & Remove Flaw"})]}),s.filter(f=>f.flaw).length===0&&e.jsx("p",{className:"text-xs text-gray-500 italic mt-3 text-center",children:"No characters currently have a flaw to remove."})]}),p.isSuccess&&e.jsxs("div",{className:"mt-4 p-3 bg-green-100 text-green-800 text-sm rounded-lg flex items-center gap-2 animate-in fade-in",children:[e.jsx(gs,{size:16})," Update successful!"]}),p.error&&e.jsxs("div",{className:"mt-4 p-3 bg-red-100 text-red-800 text-sm rounded-lg flex items-center gap-2 animate-in fade-in",children:[e.jsx(xs,{size:16})," ",p.error.message]})]})]})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-100 rounded-xl p-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-yellow-800 mb-4 flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5"})," GM Principles"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:nd.map((f,u)=>e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-yellow-900 text-sm uppercase tracking-wide mb-1",children:f.title}),e.jsx("p",{className:"text-yellow-800 text-sm",children:f.description})]},u))})]})]})}const id=async s=>{const{data:a,error:t}=await H.from("story_ideas").select("*").eq("party_id",s).order("created_at",{ascending:!1});if(t)throw new Error(t.message);return a},od=async s=>{const{data:a,error:t}=await H.from("story_ideas").insert([s]).select();if(t)throw new Error(t.message);return a},cd=async(s,a)=>{const{data:t,error:r}=await H.from("story_ideas").update(a).eq("id",s).select();if(r)throw new Error(r.message);return t},dd=async s=>{const{error:a}=await H.from("story_ideas").delete().eq("id",s);if(a)throw new Error(a.message)},md=`\`\`\`monster
## Monster Name
*Size type (tag)*
___
- **Ferocity:** 1
- **Movement:** 12
- **Armor:** 2
- **HP:** 24
___
|STR|CON|AGL|INT|WIL|CHA|
|:---:|:---:|:---:|:---:|:---:|:---:|
|16|14|12|10|14|8|
___
***Trait Name.*** Description of trait (e.g. Immunity to Fire).

### Monster Attacks
| d6 | Attack |
|:---|:---|
| 1 | **Slash:** 2D8 slashing damage. |
| 2 | **Bite:** 3D6 piercing damage. |
| 3 | **Roar:** Fear attack (WIL roll). |
\`\`\``,ud="```note\n#### GM Note\nUse this block for specific rules, descriptions, or secrets that should stand out on the page.\n```",xd=`\`\`\`spell
#### Spell Name
*Rank 1 School*
___
- **Requirement:** Word, Gesture
- **Casting Time:** Action
- **Range:** 10 meters
- **Duration:** Instant
___
Description of the spell effect goes here.
\`\`\``,hd={name:"monsterBlock",keyCommand:"monsterBlock",buttonProps:{"aria-label":"Insert Monster Block"},icon:e.jsx(Me,{size:12}),execute:(s,a)=>{a.replaceSelection(md)}},pd={name:"noteBlock",keyCommand:"noteBlock",buttonProps:{"aria-label":"Insert Note Block"},icon:e.jsx(ms,{size:12}),execute:(s,a)=>{a.replaceSelection(ud)}},gd={name:"spellBlock",keyCommand:"spellBlock",buttonProps:{"aria-label":"Insert Spell Block"},icon:e.jsx(Je,{size:12}),execute:(s,a)=>{a.replaceSelection(xd)}},ir=[jr,vr,wr,Nr,Cs,kr,Sr,Cr,_r,Cs,Er,Ar,Cs,hd,pd,gd];function fd({idea:s,onClick:a,isActive:t}){return e.jsxs("div",{onClick:a,className:`
        p-4 rounded-lg cursor-pointer border transition-all duration-200
        ${t?"bg-indigo-50 border-indigo-500 shadow-sm ring-1 ring-indigo-200":"bg-white border-gray-200 hover:border-indigo-300 hover:shadow-sm"}
      `,children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("h4",{className:`font-bold text-sm truncate pr-2 ${t?"text-indigo-800":"text-gray-800"}`,children:s.prompt||"Untitled Idea"}),e.jsx("span",{className:"text-[10px] text-gray-400 whitespace-nowrap",children:new Date(s.created_at).toLocaleDateString()})]}),e.jsxs("p",{className:"text-xs text-gray-500 line-clamp-2 leading-relaxed",children:[s.response.replace(/[#*`]/g,"").substring(0,100),"..."]})]})}function bd({onKeySubmit:s}){const[a,t]=i.useState("");return e.jsxs("div",{className:"flex flex-col items-center justify-center h-[60vh] bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center max-w-lg mx-auto mt-10",children:[e.jsx("div",{className:"w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-600",children:e.jsx(gl,{size:32})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Configure AI Assistant"}),e.jsx("p",{className:"text-gray-500 mb-8 leading-relaxed",children:"To generate Dragonbane content, this tool uses OpenRouter. Please enter your API key below. It is stored locally in your browser."}),e.jsxs("form",{onSubmit:r=>{r.preventDefault(),a.trim()&&s(a)},className:"w-full flex gap-2",children:[e.jsx("input",{type:"password",value:a,onChange:r=>t(r.target.value),placeholder:"sk-or-...",className:"flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"}),e.jsx(M,{type:"submit",variant:"primary",children:"Save Key"})]}),e.jsxs("p",{className:"text-xs text-gray-400 mt-4",children:["Don't have a key? Visit ",e.jsx("a",{href:"https://openrouter.ai/",target:"_blank",rel:"noreferrer",className:"underline hover:text-indigo-600",children:"OpenRouter.ai"})]})]})}function yd({partyId:s,initialPartyData:a=""}){const{user:t}=Ce(),r=Fe(),[n,l]=i.useState("generate"),[o,c]=i.useState(""),[x,g]=i.useState(""),[m,b]=i.useState(a),[p,h]=i.useState(""),[d,v]=i.useState(""),[f,u]=i.useState(!0),[N,S]=i.useState(""),[A,j]=i.useState(""),[q,C]=i.useState(""),[_,y]=i.useState(!1),[w,L]=i.useState(!1),[E,P]=i.useState(!1),[k,R]=i.useState(""),[O,z]=i.useState(null),[F,U]=i.useState(!1),[T,I]=i.useState("");i.useEffect(()=>{const K=localStorage.getItem("openrouter_api_key");K&&(C(K),y(!0))},[]),i.useEffect(()=>{j(N)},[N]),i.useEffect(()=>{m||b(a)},[a]);const B=K=>{localStorage.setItem("openrouter_api_key",K),C(K),y(!0),L(!1)},{data:Y,isLoading:Q}=we({queryKey:["storyIdeas",s],queryFn:()=>id(s),enabled:_}),D=ge({mutationFn:K=>od(K),onSuccess:K=>{r.invalidateQueries({queryKey:["storyIdeas",s]}),S(""),g(""),l("saved"),K&&K.length>0&&z(K[0])}}),G=ge({mutationFn:K=>dd(K),onSuccess:()=>{r.invalidateQueries({queryKey:["storyIdeas",s]}),z(null)}}),$=ge({mutationFn:({ideaId:K,updates:W})=>cd(K,W),onSuccess:K=>{r.invalidateQueries({queryKey:["storyIdeas",s]}),K&&K.length>0&&z(K[0]),U(!1)}}),Z=()=>{if(!A||!t)return;const K={party_id:s,user_id:t.id,prompt:x||"Generated Idea",response:A,context:{party:m,location:p,npc:d}};D.mutate(K)},ee=async()=>{var K,W;if(!x.trim()){R("Please enter a prompt.");return}if(!q.trim()){R("API Key missing."),L(!0);return}P(!0),R(""),S("");try{let se=`You are a helpful GM assistant for a Dragonbane TTRPG game. Generate creative content based on the following information. CRITICALLY: Format your entire response using markdown suitable for a tool like Homebrewery, but do not include the backticks or labels for the content blocks (like \`\`\`monster or \`\`\`note).

--- Main Prompt ---
${x}`;(x.toLowerCase().includes("monster")||x.toLowerCase().includes("creature"))&&(se+=`

STRICT FORMATTING: Create a Dragonbane monster. Use the Markdown format: 
\`\`\`monster
## Name
*Size type*
___
- **Ferocity:** 1
...
\`\`\`
Include a Monster Attacks table with d6 rolls.`),m.trim()&&(se+=`

--- Context: Party ---
${m}`),p.trim()&&(se+=`

--- Context: Location ---
${p}`),d.trim()&&(se+=`

--- Context: NPCs ---
${d}`);const le=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${q}`,"Content-Type":"application/json"},body:JSON.stringify({model:"google/gemini-2.5-flash",messages:[{role:"user",content:se}],max_tokens:2048,temperature:.75})});if(!le.ok)throw new Error(`API error: ${le.status}`);const pe=((W=(K=(await le.json()).choices[0])==null?void 0:K.message)==null?void 0:W.content)||"No response.";S(pe),j(pe)}catch(se){R(se instanceof Error?se.message:"Generation failed.")}finally{P(!1)}},re=Y==null?void 0:Y.filter(K=>{var W;return(((W=K.prompt)==null?void 0:W.toLowerCase())||"").includes(o.toLowerCase())});return _?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[calc(100vh-150px)]",children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shrink-0",children:[e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("button",{onClick:()=>l("generate"),className:`flex items-center gap-2 pb-3 -mb-3 border-b-2 text-sm font-bold transition-colors ${n==="generate"?"border-indigo-600 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-800"}`,children:[e.jsx(dt,{size:18})," Generator"]}),e.jsxs("button",{onClick:()=>l("saved"),className:`flex items-center gap-2 pb-3 -mb-3 border-b-2 text-sm font-bold transition-colors ${n==="saved"?"border-indigo-600 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-800"}`,children:[e.jsx(Je,{size:18})," Library"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:w?e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 p-1 rounded-lg animate-in fade-in slide-in-from-right-2",children:[e.jsx("input",{type:"password",value:q,onChange:K=>C(K.target.value),className:"bg-white border-none rounded px-2 py-1 text-xs w-32 focus:ring-0",placeholder:"API Key"}),e.jsx(M,{size:"xs",onClick:()=>B(q),children:"Save"}),e.jsx("button",{onClick:()=>L(!1),className:"p-1 text-gray-400 hover:text-gray-600",children:e.jsx(xe,{size:14})})]}):e.jsx(M,{variant:"ghost",size:"icon_sm",onClick:()=>L(!0),title:"Settings",children:e.jsx(it,{size:18,className:"text-gray-400"})})})]}),e.jsxs("div",{className:"flex-grow overflow-hidden bg-gray-50",children:[n==="generate"&&e.jsxs("div",{className:"h-full flex flex-col lg:flex-row",children:[e.jsx("div",{className:"w-full lg:w-1/3 p-6 border-r border-gray-200 bg-white overflow-y-auto",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"What do you need?"}),e.jsx("textarea",{className:"w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none text-sm min-h-[100px]",placeholder:"e.g. 'A trap involving mirrors', 'A stats block for a Giant Spider'",value:x,onChange:K=>g(K.target.value)})]}),e.jsxs("div",{className:"border-t border-gray-100 pt-4",children:[e.jsxs("button",{onClick:()=>u(!f),className:"flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wide hover:text-indigo-600 mb-3",children:[f?e.jsx(Ms,{size:14}):e.jsx(Qe,{size:14})," Context Helpers"]}),f&&e.jsxs("div",{className:"space-y-4 animate-in fade-in slide-in-from-top-1",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Party"}),e.jsx("textarea",{rows:3,className:"w-full p-2 border rounded text-xs",value:m,onChange:K=>b(K.target.value),placeholder:"Characters..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Location"}),e.jsx("textarea",{rows:2,className:"w-full p-2 border rounded text-xs",value:p,onChange:K=>h(K.target.value),placeholder:"Current place..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"NPCs"}),e.jsx("textarea",{rows:2,className:"w-full p-2 border rounded text-xs",value:d,onChange:K=>v(K.target.value),placeholder:"Nearby figures..."})]})]})]}),e.jsx(M,{onClick:ee,disabled:E,className:"w-full",icon:Es,variant:"primary",children:E?"Conjuring...":"Generate"}),k&&e.jsx("div",{className:"p-3 bg-red-50 text-red-600 text-xs rounded border border-red-100",children:k})]})}),e.jsx("div",{className:"w-full lg:w-2/3 bg-gray-50 p-6 flex flex-col h-full overflow-hidden",children:A?e.jsxs("div",{className:"flex flex-col h-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"flex-grow overflow-hidden","data-color-mode":"light",children:e.jsx(qt,{value:A,onChange:K=>j(K||""),height:"100%",visibleDragbar:!1,preview:"preview",commands:ir,previewOptions:{style:{backgroundColor:"transparent",padding:0},wrapper:({children:K})=>e.jsx("div",{className:"phb p-6",children:K}),components:{markdown:K=>e.jsx(Ns,{remarkPlugins:[Ss,Hs],rehypePlugins:[ks],...K})}},className:"h-full border-none"})}),e.jsxs("div",{className:"p-3 border-t bg-gray-50 flex justify-end gap-2 shrink-0",children:[e.jsx(M,{size:"sm",variant:"secondary",onClick:()=>{S(""),j("")},children:"Clear"}),e.jsx(M,{size:"sm",variant:"primary",icon:Ae,onClick:Z,loading:D.isPending,children:"Save to Library"})]})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-xl",children:[e.jsx(hl,{size:48,className:"opacity-20 mb-4"}),e.jsx("p",{className:"text-sm font-medium",children:"AI output will appear here."})]})})]}),n==="saved"&&e.jsxs("div",{className:"h-full flex flex-col lg:flex-row",children:[e.jsxs("div",{className:"w-full lg:w-1/3 border-r border-gray-200 bg-white flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsxs("div",{className:"relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{className:"w-full pl-9 pr-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"Search library...",value:o,onChange:K=>c(K.target.value)})]})}),e.jsx("div",{className:"flex-grow overflow-y-auto p-3 space-y-2 bg-gray-50/50",children:Q?e.jsx("div",{className:"flex justify-center py-10",children:e.jsx(oe,{})}):(re==null?void 0:re.length)===0?e.jsx("div",{className:"text-center py-10 text-gray-400 text-sm",children:"No saved ideas found."}):re==null?void 0:re.map(K=>e.jsx(fd,{idea:K,onClick:()=>{z(K),U(!1)},isActive:(O==null?void 0:O.id)===K.id},K.id))})]}),e.jsx("div",{className:"w-full lg:w-2/3 bg-gray-50 flex flex-col h-full overflow-hidden",children:O?e.jsxs("div",{className:"flex-grow flex flex-col h-full",children:[e.jsxs("div",{className:"bg-white border-b p-4 flex justify-between items-center shrink-0",children:[e.jsxs("div",{className:"min-w-0 mr-4",children:[e.jsx("h3",{className:"font-bold text-gray-900 truncate",children:O.prompt}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Created ",new Date(O.created_at).toLocaleString()]})]}),e.jsx("div",{className:"flex gap-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx(M,{size:"sm",variant:"ghost",onClick:()=>U(!1),children:"Cancel"}),e.jsx(M,{size:"sm",variant:"primary",icon:Ae,onClick:()=>{$.mutate({ideaId:O.id,updates:{response:T}})},loading:$.isPending,children:"Save"})]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{size:"sm",variant:"secondary",icon:pl,onClick:()=>{I(O.response),U(!0)},children:"Edit"}),e.jsx(M,{size:"sm",variant:"danger_outline",icon:Le,onClick:()=>G.mutate(O.id),loading:G.isPending,children:"Delete"})]})})]}),e.jsx("div",{className:"flex-grow overflow-hidden bg-white p-0 h-full",children:F?e.jsx(qt,{value:T,onChange:K=>I(K||""),height:"100%",visibleDragbar:!1,preview:"edit",commands:ir,previewOptions:{style:{backgroundColor:"transparent",padding:0},wrapper:({children:K})=>e.jsx("div",{className:"phb p-8",children:K}),components:{markdown:K=>e.jsx(Ns,{remarkPlugins:[Ss,Hs],rehypePlugins:[ks],...K})}}}):e.jsx("div",{className:"h-full overflow-y-auto p-8",children:e.jsx("div",{className:"phb",children:e.jsx(Ns,{remarkPlugins:[Ss,Hs],rehypePlugins:[ks],children:O.response})})})})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-gray-400",children:[e.jsx(Ls,{size:48,className:"opacity-20 mb-4"}),e.jsx("p",{className:"text-sm font-medium",children:"Select an idea to view details."})]})})]})]})]}):e.jsx(bd,{onKeySubmit:B})}const Jr=i.createContext(void 0);function Zr(){const s=i.useContext(Jr);if(!s)throw new Error("useDropdown must be used within a DropdownMenu");return s}function jd({children:s}){const[a,t]=i.useState(!1),r=i.useRef(null);return i.useEffect(()=>{const n=l=>{r.current&&!r.current.contains(l.target)&&t(!1)};return document.addEventListener("mousedown",n),()=>{document.removeEventListener("mousedown",n)}},[]),e.jsx(Jr.Provider,{value:{isOpen:a,setIsOpen:t},children:e.jsx("div",{className:"relative inline-block text-left",ref:r,children:s})})}function vd({children:s}){const{isOpen:a,setIsOpen:t}=Zr();return e.jsx("button",{type:"button",onClick:r=>{r.stopPropagation(),t(n=>!n)},className:"p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500","aria-expanded":a,"aria-haspopup":"true",children:s||e.jsx(Qt,{className:"w-5 h-5"})})}function wd({children:s}){const{isOpen:a,setIsOpen:t}=Zr();return a?e.jsx("div",{className:"origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",role:"menu","aria-orientation":"vertical","aria-labelledby":"menu-button",children:e.jsx("div",{className:"py-1",role:"none",onClick:()=>t(!1),children:s})}):null}function Nd({onSelect:s,children:a,className:t}){return e.jsx("a",{href:"#",onClick:r=>{r.preventDefault(),s()},className:`flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 ${t}`,role:"menuitem",children:a})}const Fs={npcs:{title:"NPCs",icon:is,sections:[{title:"Typical NPCs",type:"table",headers:["Type","Skills","Abilities","Dmg","HP","WP","Gear"],rows:[["Guard","Awareness 10, Swords 12","","STR +D4","12","","Broadsword, studded leather"],["Cultist","Evade 14, Knives 14","","AGL +D4","12","","Dagger"],["Thief","Evade 12, Knives 12","","AGL +D4","10","","Knife"],["Villager","Brawling 8","","","8","","Wooden club"],["Hunter","Awareness 12, Bows 13","","AGL +D4","13","","Longbow, leather armor"],["Bandit","Bows 12, Evade 10, Swords 12","","","12","","Short sword, short bow"],["Adventurer","Awareness 10, Swords 12","","STR +D4","13","","Broadsword, studded leather"],["Scholar","Languages 13, Myths 13","","","7","","A good book"],["Bandit Chief","Awareness 12, Brawling 15","Berserker, Robust x6","STR +D6","30","16","Heavy warhammer, chainmail"],["Knight Champion","Brawling 14, Swords 16","Defensive, Double Slash","STR +D6","28","26","Longsword, plate, horse"],["Archmage","Magic 15, Staves 13","Master Spellcaster","","22","30","Staff, grimoire"]]},{title:"NPCs and Skills",type:"text",content:"NPCs use skills like PCs, but the GM only rolls for actions that directly affect a player. For other actions, the GM decides the outcome. For an unlisted skill, an NPC's default skill level is 5."},{title:"Attributes for NPCs",type:"text",content:"STR & AGL: Use damage bonus (+D6  17, +D4  14, none  10). WIL: Use max WP if listed, otherwise 10. INT & CHA: Roll against 10."}]},rolling:{title:"Rolling",icon:be,sections:[{title:"Rolling a Dragon",type:"list",items:["You impress everyone around you.","You achieve more than intended.","The action is performed faster than usual."]},{title:"Dragon: Melee Combat",type:"list",items:["Roll double the dice for weapon damage.","Immediately perform a second, free attack against another enemy.","Armor has no effect (piercing damage only, optional rule)."]},{title:"Dragon: Ranged Combat",type:"list",items:["Weapon's damage is doubled (roll twice as many dice).","Armor has no effect (piercing damage only, optional rule)."]},{title:"Rolling a Demon",type:"list",items:["The roll cannot be pushed.","You damage yourself, someone else, or an item.","You make a fool of yourself.","You make a lot of noise."]},{title:"Demon: Melee Combat (d6)",type:"table",headers:["D6","Effect"],rows:[["1","Drop your weapon."],["2","Expose yourself; enemy gets a free attack."],["3","Weapon gets stuck (STR roll to free)."],["4","Accidentally toss your weapon D3+3 meters."],["5","Damage your weapon (bane on use until repaired)."],["6","You hit yourself (roll damage as usual, no bonus)."]]},{title:"Demon: Ranged Combat (d6)",type:"table",headers:["D6","Effect"],rows:[["1","Drop your weapon."],["2","Run out of arrows (re-roll for slings/throwing)."],["3","You hit a valuable item nearby."],["4","You break your weapon (bane on use until repaired)."],["5","Accidentally hit a random friendly target."],["6","You hit yourself (roll damage as usual, no bonus)."]]}]},actions:{title:"Actions",icon:Je,sections:[{title:"Common Actions",type:"definitions",items:{Dash:"Doubles your movement rate for the round.","Melee/Ranged Attack":"Attack an enemy within range.","Parry/Dodge":"A reaction to avoid an attack, replaces your next action.","Pick Up Item":"Pick up an item within 2 meters.","Equip/Unequip Armor":"Don or doff armor/helmets.","First Aid":"HEALING skill to save a dying character.",Rally:"PERSUADE an ally at 0 HP to keep fighting.","Cast Spell":"Counts as an action, including tricks."}},{title:"Free Actions",type:"definitions",items:{"Draw Weapon":"Draw, exchange, or sheathe a weapon.","Change Position":"Drop prone or stand up.","Drop Item":"Drop a held item.",Shout:"Say a few words."}},{title:"Special Attacks",type:"definitions",items:{"Find Weak Spot":"Take a bane on your attack to ignore enemy armor.",Topple:"Opposed roll (weapon skill vs EVADE) to knock an enemy prone.",Disarm:"Opposed roll (weapon skill vs enemy's) to make them drop their weapon.",Grapple:"Opposed BRAWLING roll to trap an enemy.",Shove:"Push an enemy 2m if your STR bonus is higher."}}]},damage:{title:"Damage & Health",icon:us,sections:[{title:"Fear Table (d8)",type:"table",headers:["D8","Effect"],rows:[["1","Enfeebled. Lose 2D6 WP (min 0), become Disheartened."],["2","Shaken. You suffer the Scared condition."],["3","Panting. Become Exhausted."],["4","Pale. You and allies within 10m become Scared."],["5","Scream. Allies hearing this suffer fear attack."],["6","Rage. Must attack source. Become Angry."],["7","Paralyzed. No move/act. Roll WIL to break."],["8","Wild Panic. Dash away. Roll WIL to stop."]]},{title:"Severe Injuries",type:"table",headers:["D20","Injury","Effect"],rows:[["1-2","Broken nose","Bane on AWARENESS. Heal: D6 days."],["3-4","Scarred face","Bane on PERFORMANCE/PERSUASION. Heal: 2D6 days."],["5-6","Teeth lost","PERFORMANCE/PERSUASION reduced by 2."],["7-8","Broken ribs","Bane on STR/AGL skills. Heal: D6 days."],["9-10","Concussion","Bane on INT skills. Heal: D6 days."],["11-12","Deep wounds","Bane on STR/AGL skills, roll causes D6 dmg. Heal: 2D6 days."],["13","Broken leg","Movement halved. Heal: 3D6 days."],["14","Broken arm","No 2H weapons/dual wield, bane on climbing. Heal: 3D6 days."],["15","Severed toe","Movement reduced by 2."],["16","Severed finger","Weapon skills reduced by 1."],["17","Gouged eye","SPOT HIDDEN reduced by 2."],["18","Nightmares","Roll vs Fear to sleep. Heal: 2D6 days."],["19","Changed personality","New Random Weakness."],["20","Amnesia","Forget identity. Heal: D6 days."]]},{title:"Damage Types",type:"definitions",items:{Leather:"+2 AR vs Bludgeoning.",Chainmail:"+2 AR vs Slashing."}},{title:"Resting",type:"definitions",items:{"Round Rest":"10 sec. Recover D6 WP.","Stretch Rest":"15 min. Heal D6 HP, D6 WP, 1 condition.","Shift Rest":"6 hours. Full recovery."}}]},journeys:{title:"Journeys",icon:hr,sections:[{title:"Wilderness Travel",type:"definitions",items:{Pathfinder:"One character must lead in pathless terrain.",Hunger:"Must eat daily or become famished (cannot heal).","Bushcraft Roll":"Pathfinder rolls BUSHCRAFT each shift. Failure causes a mishap.","Dragon Roll":"Pathfinder finds a shortcut, doubling distance covered."}},{title:"Leaving Site (d6)",type:"table",headers:["D6","Consequence"],rows:[["1","Enemies follow."],["2","Enemies reinforce (x2)."],["3","Site looted."],["4-6","Nothing happens."]]}]},mishaps:{title:"Mishaps",icon:he,sections:[{title:"Wilderness Mishaps (d12)",type:"table",headers:["D12","Mishap"],rows:[["1","Fog. Distance halved."],["2","Blocking Terrain. ACROBATICS to proceed."],["3","Torn Clothes."],["4","Lost. No progress."],["5","Dropped Item."],["6","Mosquitoes. Become Angry."],["7","Sprained Ankle. D6 dmg."],["8","Downpour. Roll vs Cold."],["9","Wasps. EVADE or D6 dmg + Cond."],["10","Landslide. EVADE or D10 dmg."],["11","Savage Animal."],["12","Quicksand. BUSHCRAFT or stuck."]]}]}},vt=({text:s})=>{const{toggleDiceRoller:a}=ze();if(!s)return null;const t=/(\b\d*[dD](?:4|6|8|10|12|20|66|100)(?:\s*[+\-]\s*\d+)?\b)/g,r=s.split(t);return e.jsx("span",{children:r.map((n,l)=>{if(n.match(t)){const o=n.toLowerCase().replace(/\s/g,"");return e.jsxs("button",{onClick:()=>a==null?void 0:a({dice:o,label:`GM Screen: ${n}`}),className:"inline-flex items-center justify-center font-bold text-blue-700 bg-blue-100 hover:bg-blue-200 px-1.5 py-0.5 rounded mx-0.5 text-xs transition-colors cursor-pointer",title:`Roll ${n}`,children:[e.jsx(be,{size:10,className:"mr-1"}),n]},l)}return e.jsx("span",{children:n},l)})})},kd=({title:s,children:a})=>e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden break-inside-avoid hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-100",children:e.jsx("h3",{className:"font-bold text-gray-800 text-base",children:s})}),e.jsx("div",{className:"p-4 space-y-4",children:a})]}),Sd=({headers:s,rows:a})=>e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700 uppercase text-xs font-bold",children:e.jsx("tr",{children:s.map(t=>e.jsx("th",{className:"px-3 py-2 whitespace-nowrap",children:t},t))})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.map((t,r)=>e.jsx("tr",{className:"even:bg-gray-50 hover:bg-blue-50 transition-colors",children:t.map((n,l)=>e.jsx("td",{className:"px-3 py-2 text-gray-700",children:e.jsx(vt,{text:n})},l))},r))})]})}),Cd=({items:s})=>e.jsx("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2",children:Object.entries(s).map(([a,t])=>e.jsxs("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[e.jsx("dt",{className:"font-bold text-gray-900 text-xs uppercase tracking-wide mb-1",children:a}),e.jsx("dd",{className:"text-sm text-gray-700 leading-relaxed",children:e.jsx(vt,{text:t})})]},a))}),_d=({items:s})=>e.jsx("ul",{className:"space-y-2",children:s.map((a,t)=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-gray-700",children:[e.jsx("span",{className:"mt-1.5 w-1.5 h-1.5 bg-blue-500 rounded-full flex-shrink-0"}),e.jsx("span",{children:e.jsx(vt,{text:a})})]},t))});function Ed(){const[s,a]=i.useState("npcs"),t=Fs[s]?s:"npcs",r=Object.keys(Fs).map(n=>({id:n,label:Fs[n].title,icon:Fs[n].icon}));return e.jsxs("div",{className:"min-h-screen bg-gray-50/50 p-4 md:p-6 font-sans",children:[e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-2 mb-6 sticky top-2 z-20 overflow-x-auto no-scrollbar",children:e.jsx("nav",{className:"flex gap-1 min-w-max",children:r.map(n=>e.jsxs("button",{onClick:()=>a(n.id),className:`
                flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-bold transition-all
                ${t===n.id?"bg-blue-600 text-white shadow-md":"text-gray-600 hover:bg-gray-100 hover:text-gray-900"}
              `,children:[e.jsx(n.icon,{size:18}),n.label]},n.id))})}),e.jsx("div",{className:"animate-in fade-in duration-300",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 items-start",children:Fs[t].sections.map((n,l)=>e.jsxs(kd,{title:n.title,children:[n.type==="table"&&e.jsx(Sd,{headers:n.headers,rows:n.rows}),n.type==="text"&&e.jsx("p",{className:"text-sm text-gray-700 leading-relaxed",children:e.jsx(vt,{text:n.content})}),n.type==="list"&&e.jsx(_d,{items:n.items}),n.type==="definitions"&&e.jsx(Cd,{items:n.items})]},l))})})]})}function Ad(){const{id:s}=la(),a=Be(),{user:t,isDM:r}=Ce(),n=Fe(),[l,o]=i.useState(!1),[c,x]=i.useState(null),[g,m]=i.useState(null),[b,p]=i.useState("members"),{data:h,isLoading:d,error:v}=we({queryKey:["party",s],queryFn:()=>Fo(s),enabled:!!s}),f=ge({mutationFn:y=>{if(!s)throw new Error("Party ID is missing");return Kr(s,y)},onSuccess:()=>{n.invalidateQueries({queryKey:["party",s]}),n.invalidateQueries({queryKey:["availableCharacters"]}),x(null),m(null)}}),u=ge({mutationFn:()=>{if(!s)throw new Error("Party ID is missing");return $o(s)},onSuccess:()=>{n.invalidateQueries({queryKey:["parties"]}),a("/adventure-party")}}),N=()=>{g&&f.mutate(g.id)},S=()=>{u.mutate()},A=t&&h&&t.id===h.created_by&&r(),j=h!=null&&h.invite_code?`${window.location.origin}/party/join/${h.invite_code}`:"",q=i.useMemo(()=>h!=null&&h.members?h.members.map(y=>`- ${y.name} (${y.kin} ${y.profession})`).join(`
`):"",[h]);if(d)return e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(oe,{size:"lg"})});if(v)return e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:v.message})});if(!h)return e.jsx("div",{className:"p-8",children:e.jsx(ie,{message:"Party not found."})});const _=[{id:"members",label:"Roster",icon:De},{id:"notes",label:"Journal",icon:Ls},{id:"tasks",label:"Quests",icon:fl},{id:"inventory",label:"Stash",icon:mr},{id:"encounter",label:"Combat",icon:Bt,dmOnly:!0},{id:"sessionEnd",label:"Session End",icon:ht,dmOnly:!0},{id:"gmScreen",label:"GM Screen",icon:mt,dmOnly:!0},{id:"storyhelper",label:"Story AI",icon:Es,dmOnly:!0}].filter(y=>!y.dmOnly||A);return e.jsxs("div",{className:"max-w-7xl mx-auto p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden",children:[e.jsxs("div",{className:"p-6 md:p-8 bg-gradient-to-r from-white to-gray-50 border-b border-gray-200",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold text-gray-900 tracking-tight",children:h.name}),e.jsxs("p",{className:"text-gray-500 mt-1 font-medium",children:["A band of ",h.members.length," brave adventurers."]})]}),A&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"secondary",size:"sm",icon:yt,onClick:()=>o(!l),className:l?"bg-blue-50 border-blue-200 text-blue-700":"",children:"Invite"}),e.jsxs(jd,{children:[e.jsx(vd,{children:e.jsx(M,{variant:"outline",size:"icon","aria-label":"Party Settings",children:e.jsx(Qt,{className:"h-5 w-5"})})}),e.jsx(wd,{align:"end",children:e.jsxs(Nd,{onSelect:()=>x("deleteParty"),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"})," Disband Party"]})})]})]})]}),l&&A&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-100 rounded-lg animate-in slide-in-from-top-2 fade-in",children:[e.jsx("h3",{className:"text-sm font-bold text-blue-900 uppercase tracking-wide mb-2",children:"Invite Link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-grow bg-white border border-blue-200 rounded-md px-3 py-2 text-sm text-gray-600 font-mono truncate",children:j}),e.jsx(Lc,{textToCopy:j})]})]})]}),e.jsx("div",{className:"border-b border-gray-200 bg-white overflow-x-auto",children:e.jsx("nav",{className:"flex px-6 min-w-max",children:_.map(y=>e.jsxs("button",{onClick:()=>p(y.id),className:`
                  group flex items-center gap-2 px-4 py-4 text-sm font-medium border-b-2 transition-all
                  ${b===y.id?"border-indigo-600 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300"}
                `,children:[e.jsx(y.icon,{className:`w-4 h-4 ${b===y.id?"text-indigo-600":"text-gray-400 group-hover:text-gray-600"}`}),y.label]},y.id))})})]}),e.jsxs("div",{className:"bg-white shadow-sm border border-gray-200 rounded-xl min-h-[500px] overflow-hidden",children:[b==="members"&&e.jsx("div",{className:"p-6",children:e.jsx(Tc,{party:h,isDM:A,currentUserId:t==null?void 0:t.id,onUpdate:()=>n.invalidateQueries({queryKey:["party",s]})})}),b==="notes"&&e.jsx(Ic,{partyId:s,isDM:A}),b==="tasks"&&e.jsx(Oc,{partyId:s,isDM:A}),b==="inventory"&&e.jsx("div",{className:"p-6",children:e.jsx(Hc,{partyId:s,members:h.members,isDM:A})}),b==="encounter"&&e.jsx(td,{partyId:s,partyMembers:h.members,isDM:A}),b==="sessionEnd"&&e.jsx("div",{className:"p-6",children:e.jsx(ld,{members:h.members,partyId:s})}),b==="gmScreen"&&e.jsx(Ed,{}),b==="storyhelper"&&e.jsx("div",{className:"p-6",children:e.jsx(yd,{partyId:s,initialPartyData:q})})]}),e.jsx($t,{isOpen:c==="removeMember",onClose:()=>x(null),onConfirm:N,title:"Remove Member",description:`Are you sure you want to remove ${g==null?void 0:g.name} from the party?`,confirmText:"Remove",isDestructive:!0,isLoading:f.isPending,icon:e.jsx(gr,{className:"w-6 h-6 text-red-500"})}),e.jsx($t,{isOpen:c==="deleteParty",onClose:()=>x(null),onConfirm:S,title:"Disband Party",description:"Are you sure? This will permanently delete the party and all associated data (notes, tasks, chat). Characters will remain but will be removed from this group.",confirmText:"Disband Permanently",isDestructive:!0,isLoading:u.isPending,icon:e.jsx(mt,{className:"w-6 h-6 text-red-500"})})]})}function Md(){var h;const{inviteCode:s}=la();console.log("Invite Code from URL:",s);const a=Be(),{user:t}=Ce(),r=Fe(),[n,l]=i.useState(""),{data:o=[],isLoading:c,error:x}=we({queryKey:["availableCharacters",t==null?void 0:t.id],queryFn:()=>Wr(t==null?void 0:t.id),enabled:!!t}),g=ge({mutationFn:async d=>{if(!d)throw new Error("Please select a character");if(!s)throw new Error("Invite code is missing");const{data:v,error:f}=await H.rpc("join_party_with_character",{p_invite_code:s,p_character_id:d});if(f)throw f.message.includes("invalid_invite_code")?new Error("This invite link is invalid or has expired."):f.message.includes("character_already_in_a_party")?new Error("This character is already in a party."):f.message.includes("user_already_in_party")?new Error("You are already a member of this party."):f;return v},onSuccess:d=>{const v=d==null?void 0:d.party_id;v?(r.invalidateQueries({queryKey:["parties"]}),r.invalidateQueries({queryKey:["party",v]}),r.invalidateQueries({queryKey:["availableCharacters",t==null?void 0:t.id]}),a(`/party/${v}`)):a("/adventure-party")}}),m=()=>{n&&g.mutate(n)},b=c,p=(x==null?void 0:x.message)||((h=g.error)==null?void 0:h.message);return b?e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:e.jsx(oe,{size:"lg"})}):p?e.jsxs("div",{className:"container mx-auto px-4 py-8 text-center",children:[e.jsx(ie,{message:p}),e.jsx(M,{variant:"secondary",onClick:()=>a("/adventure-party"),className:"mt-4",children:"Back to Parties"})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-12 px-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(De,{className:"w-12 h-12 text-blue-600 mx-auto mb-4"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Join an Adventure"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"You've been invited to join a new party!"})]}),o.length>0?e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-center text-gray-700",children:"Select one of your available characters to join with."}),e.jsx("div",{className:"space-y-3",children:o.map(d=>e.jsxs("div",{onClick:()=>l(d.id),className:`p-4 border rounded-lg cursor-pointer transition-all flex items-center justify-between ${n===d.id?"border-blue-500 bg-blue-50 ring-2 ring-blue-500":"border-gray-200 hover:border-blue-400"}`,children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:d.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[d.kin," ",d.profession]})]}),n===d.id&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center",children:e.jsx(ds,{className:"w-4 h-4 text-white"})})]},d.id))}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(M,{variant:"secondary",onClick:()=>a("/adventure-party"),children:"Cancel"}),e.jsx(M,{variant:"primary",loading:g.isPending,disabled:!n||g.isPending,onClick:m,children:"Join with Selected Character"})]})]}):e.jsxs("div",{className:"text-center py-8 border-t mt-8",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"You don't have any available characters to join with."}),e.jsx(M,{variant:"primary",onClick:()=>a("/"),children:"Create a Character"})]})]})})}function Ld(){return e.jsxs(e.Fragment,{children:[e.jsx("a",{href:"#main-content",className:"sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-white focus:text-blue-600",children:"Skip to main content"}),e.jsxs(La,{children:[e.jsx(He,{path:"/login",element:e.jsx(Sc,{})}),e.jsx(He,{path:"*",element:e.jsx(Mc,{children:e.jsxs(e.Fragment,{children:[e.jsx(Ol,{}),e.jsx("main",{id:"main-content",className:"container mx-auto px-4 py-8",children:e.jsxs(La,{children:[e.jsx(He,{path:"/",element:e.jsx(bi,{})}),e.jsx(He,{path:"/character/:id",element:e.jsx(ko,{})}),e.jsx(He,{path:"/compendium",element:e.jsx(Po,{})}),e.jsx(He,{path:"/adventure-party",element:e.jsx(Oo,{})}),e.jsx(He,{path:"/party/:id",element:e.jsx(Ad,{})}),e.jsx(He,{path:"/party/join/:inviteCode",element:e.jsx(Md,{})}),e.jsx(He,{path:"/notes",element:e.jsx(zo,{})}),e.jsx(He,{path:"/settings",element:e.jsx(kc,{})}),e.jsx(He,{path:"*",element:e.jsx(ca,{to:"/",replace:!0})})]})}),e.jsx(Ac,{}),e.jsx(Gr,{})]})})})]})]})}function Rd(){const{showWarning:s,extendSession:a}=Il();return s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-amber-100 rounded-full",children:e.jsx(xt,{className:"w-6 h-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Session Timeout Warning"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Your session will expire in 30 seconds due to inactivity."})]})]}),e.jsx("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-amber-700",children:'Click "Continue Session" to stay logged in, or your session will end automatically.'})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{variant:"primary",onClick:a,children:"Continue Session"})})]})}):null}function Td(){return e.jsx(bl,{children:e.jsx(Dl,{children:e.jsxs(yr,{client:Ir,children:[e.jsx(_l,{children:e.jsx(Ll,{children:e.jsx(Tl,{children:e.jsx($l,{children:e.jsxs("div",{className:"min-h-screen bg-gray-100",children:[e.jsx(Ld,{}),e.jsx(Rd,{})]})})})})}),!1]})})})}yl(document.getElementById("root")).render(e.jsx(i.StrictMode,{children:e.jsxs(yr,{client:Ir,children:[" ",e.jsx(Td,{})]})}));
